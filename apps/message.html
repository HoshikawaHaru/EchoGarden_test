<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="rgba(0,0,0,0)" />
  <title>EchoGarden · 消息</title>
  <link rel="apple-touch-icon" sizes="512x512" href="assets/icons/icon512.png" />
  <link rel="icon" href="assets/icons/icon512.png" type="image/png" />
  <style>
    :root{
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --bg: #f2f2f7;
      --card: #ffffff;
      --hair: rgba(0,0,0,.08);
      --text: #111111;
      --sub: #666666;
      --tint: #007aff;
      --tint-2: #5856d6;
      --danger: #ff3b30;
      --shadow: 0 1px 0 rgba(0,0,0,.06);
      --radius: 14px;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html,body{height:100%;}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;}

    /* 顶部导航 */
    .nav{position:sticky;top:0;z-index:20;background:var(--bg);box-shadow:0 1px 0 var(--hair);
      padding: calc(8px + var(--safe-top)) 12px 8px;}
    .nav-row{display:flex;align-items:center;justify-content:space-between;gap:8px;}
    .title{font-size:17px;font-weight:700}
    .nav-btn{border:none;background:transparent;font-size:16px;color:var(--tint);padding:8px 10px;border-radius:10px}

    /* 顶部二级标签 */
    .tabs{display:flex;gap:8px;padding:8px 12px 6px;position:sticky;top:calc(52px + var(--safe-top));z-index:15;background:var(--bg)}
    .tab-item{flex:1;text-align:center;padding:10px 12px;font-size:14px;color:#555;background:#fff;border:1px solid var(--hair);border-radius:999px;box-shadow:var(--shadow);cursor:pointer;}
    .tab-item.active{color:#fff;background:var(--tint);border-color:transparent}

    /* 内容区 */
    .content{height:calc(100% - 140px);overflow:auto;-webkit-overflow-scrolling:touch}
    .section{padding:12px}

    /* 卡片 */
    .card{background:var(--card);border:1px solid var(--hair);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
    .card + .card{margin-top:10px}

    /* 列表行 */
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .row-main{min-width:0}
    .row-title{font-weight:600;color:#000}
    .row-sub{font-size:12px;color:var(--sub);margin-top:4px}
    .tag{display:inline-block;border:1px solid var(--hair);border-radius:999px;padding:2px 8px;font-size:12px;margin-left:6px;color:#444;background:#fafafa}

    /* 按钮 */
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 14px;border-radius:12px;border:1px solid var(--hair);background:#fff;color:#111;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--tint);color:#fff;border-color:transparent}
    .btn.accent{background:var(--tint-2);color:#fff;border-color:transparent}
    .btn.danger{background:var(--danger);color:#fff;border-color:transparent}
    .btn.block{display:block;width:100%}
    .btn.mini{padding:6px 8px;border-radius:9px;font-size:12px}

    /* 底部工具条 */
    .toolbar{position:fixed;left:0;right:0;bottom:0;background:rgba(249,249,251,.9);backdrop-filter:saturate(1.8) blur(10px);border-top:1px solid var(--hair);padding-bottom:calc(6px + var(--safe-bottom));z-index:30}
    .toolbar-inner{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;gap:12px}
    .input{flex:1;background:#fff;border:1px solid var(--hair);border-radius:999px;padding:10px 12px;min-height:40px;font-size:14px}
    .send{padding:10px 14px;border-radius:999px;background:var(--tint);color:#fff;border:none;font-weight:700}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:flex-end;z-index:40}
    .modal.show{display:flex}
    .modal-content{width:100%;max-height:85%;background:#fff;border-radius:16px 16px 0 0;overflow:auto}
    .modal-hd{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--hair);padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
    .modal-tt{font-weight:700}
    .modal-bd{padding:14px 16px}

    /* 表单 */
    .form-group{margin-bottom:12px}
    .form-label{display:block;font-size:13px;color:#333;margin-bottom:6px}
    .form-input,.form-select,.form-textarea{width:100%;border:1px solid var(--hair);border-radius:10px;background:#fff;padding:10px 12px;font-size:14px}
    .form-textarea{min-height:88px;resize:vertical}

    /* 空态 */
    .empty{color:#999;text-align:center;padding:24px 8px}

    /* 小红点 Ping */
    .ping{position:absolute;right:-2px;top:-2px;width:8px;height:8px;background:#ff3b30;border-radius:50%}

    /* 容器可见性 */
    [role='tabpanel']{display:none}
    [role='tabpanel'].active{display:block}
  </style>
</head>
<body>
  <!-- 顶部栏 -->
  <header class="nav">
    <div class="nav-row">
      <button class="nav-btn" id="backBtn">‹ 首页</button>
      <div class="title" id="topTitle">消息</div>
      <button class="nav-btn" id="addBtn" aria-label="新建">＋</button>
    </div>
    <!-- Tabs -->
    <div class="tabs" id="tabs">
      <div class="tab-item active msg-tab-item" data-tab="chat">聊天</div>
      <div class="tab-item msg-tab-item" data-tab="events">事件</div>
      <div class="tab-item msg-tab-item" data-tab="moments">朋友圈</div>
      <div class="tab-item msg-tab-item" data-tab="me">我</div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="content" id="main">
    <!-- 聊天Tab -->
    <section id="tab-chat" role="tabpanel" class="active" aria-label="聊天">
      <div class="section">
        <div class="card">
          <div class="row">
            <div class="row-main">
              <div class="row-title">和 Nash 的对话</div>
              <div class="row-sub">最近：周六要不要一起去野餐？</div>
            </div>
            <div>
              <button class="btn mini" onclick="openThread('nash')">进入</button>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="row">
            <div class="row-main">
              <div class="row-title">和 Lily 的对话</div>
              <div class="row-sub">好的～我带水果！</div>
            </div>
            <div>
              <button class="btn mini" onclick="openThread('lily')">进入</button>
            </div>
          </div>
        </div>
        <div class="empty">（此处为角色对话列表，点击进入 message-detail.html）</div>
      </div>
    </section>

    <!-- 事件Tab -->
    <section id="tab-events" role="tabpanel" aria-label="事件">
      <div class="section">
        <h3 style="font-size:15px;color:#111;margin:6px 4px 8px;">我们的约定</h3>
        <div id="evt-contract-list"></div>
        <button id="evt-add-contract" class="btn primary block" style="margin:10px 0 18px;">添加约定</button>

        <h3 style="font-size:15px;color:#111;margin:6px 4px 8px;">我的记事本</h3>
        <div id="evt-notes-list"></div>
        <button id="evt-add-note" class="btn accent block" style="margin:10px 0 18px;">添加记事</button>
      </div>

      <!-- 事件表单 Modal -->
      <div class="modal" id="evtModal" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-modal="true">
          <div class="modal-hd">
            <div class="modal-tt">编辑事件</div>
            <button class="nav-btn" id="evtClose">完成</button>
          </div>
          <div class="modal-bd">
            <form id="evtForm">
              <input type="hidden" id="evtId" />

              <div class="form-group">
                <label class="form-label">类型</label>
                <select id="evtType" class="form-select">
                  <option value="contract">我们的约定</option>
                  <option value="note">我的记事本</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">我的身份（可选）</label>
                <select id="evtIdentity" class="form-select"></select>
              </div>

              <div class="form-group" id="evtCharGroup">
                <label class="form-label">涉及/可见角色（多选，需为所选身份绑定的角色）</label>
                <div id="evtChars" style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;"></div>
              </div>

              <div class="form-group">
                <label class="form-label">事件名称</label>
                <input id="evtTitle" class="form-input" placeholder="如：周六中午野餐 / 生日" required />
              </div>

              <div class="form-group">
                <label class="form-label">事件频次</label>
                <select id="evtFreq" class="form-select">
                  <option value="once">单次</option>
                  <option value="year">年度</option>
                  <option value="month">月度</option>
                  <option value="week">周度</option>
                  <option value="day">日度</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">时间（可选）</label>
                <input id="evtTime" type="datetime-local" class="form-input" />
              </div>

              <div class="form-group" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                <label class="form-label" style="margin:0;min-width:72px;">全天事件</label>
                <input type="checkbox" id="evtAllDay" />
                <span class="row-sub">提醒时刻：</span>
                <input type="time" id="evtAllDayTime" class="form-input" style="max-width:140px" value="09:00" />
                <span class="row-sub">（生日、纪念日等）</span>
              </div>

              <div class="form-group">
                <label class="form-label">后台提示词（选填，留空用系统默认）</label>
                <textarea id="evtPrompt" class="form-textarea" placeholder="如：现在是{title}时间…"></textarea>
              </div>

              <button type="submit" class="btn primary block">保存</button>
            </form>
          </div>
        </div>
      </div>
    </section>

    <!-- 朋友圈Tab（占位） -->
    <section id="tab-moments" role="tabpanel" aria-label="朋友圈">
      <div class="section">
        <div class="empty">朋友圈功能开发中…</div>
      </div>
    </section>

    <!-- 我 Tab（占位） -->
    <section id="tab-me" role="tabpanel" aria-label="我">
      <div class="section">
        <div class="card">
          <div class="row">
            <div class="row-main">
              <div class="row-title">我的身份卡</div>
              <div class="row-sub">点击“＋”可以新建身份卡，或在角色编辑中绑定角色。</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- 底部输入条（聊天页占位） -->
  <footer class="toolbar" id="toolbar" aria-hidden="true" style="display:none;">
    <div class="toolbar-inner">
      <input class="input" id="msgInput" placeholder="说点什么…" />
      <button class="send" id="sendBtn">发送</button>
    </div>
  </footer>

  <script>
    // ===== 简易选择器
    const $ = (sel, root=document)=>root.querySelector(sel);
    const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));

    // ===== 路由返回
    $('#backBtn').addEventListener('click', ()=>{ location.href = 'index.html'; });

    // ===== 顶部 Tabs 切换
    let EG_CURRENT_TAB = 'chat';
    function setTopTitle(t){ $('#topTitle').textContent = t; }

    function switchTab(name){
      EG_CURRENT_TAB = name;
      $$('.msg-tab-item').forEach(el=>el.classList.toggle('active', el.dataset.tab===name));
      $$('#main [role=tabpanel]').forEach(p=>p.classList.toggle('active', p.id===`tab-${name}`));
      setTopTitle(name==='me' ? '我的身份卡' : (name==='events'?'事件':'消息'));
      updateAddButtonForTab();
      // 底部输入条仅聊天页展示
      $('#toolbar').style.display = (name==='chat') ? 'block' : 'none';
    }
    $('#tabs').addEventListener('click', (e)=>{
      const item = e.target.closest('.msg-tab-item');
      if(!item) return;
      switchTab(item.dataset.tab);
    });

    function updateAddButtonForTab(){
      const addBtn=$('#addBtn');
      const map={chat:'新建角色', events:'添加事件', me:'新建身份', moments:'发动态'};
      addBtn.setAttribute('aria-label', map[EG_CURRENT_TAB]||'新建');
    }

    $('#addBtn').addEventListener('click', ()=>{
      if(EG_CURRENT_TAB==='events') EGEvents.openEditor();
      else if(EG_CURRENT_TAB==='chat') alert('角色创建：请在 message-detail.html 内实现');
      else if(EG_CURRENT_TAB==='me') alert('新建身份：开发中');
      else alert('朋友圈发动态：开发中');
    });

    // ===== 聊天入口占位
    function openThread(charId){
      // 真实项目里跳转到 message-detail.html?char=ID
      location.href = 'message-detail.html?char=' + encodeURIComponent(charId);
    }

    // ===== localStorage helpers
    function load(k,df){ try{ const t=localStorage.getItem(k); return t?JSON.parse(t):df; }catch(e){ return df; } }
    function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

    // ===== 初始化：为演示提供最小数据
    (function seed(){
      if(!load('eg_characters_v2', null)){
        save('eg_characters_v2', [
          { id:'nash', name:'Nash', nickname:'Nash', bio:'户外系暖男', backgroundOn:true },
          { id:'lily', name:'Lily', nickname:'Lily', bio:'温柔又笨拙的甜妹', backgroundOn:true }
        ]);
      }
      if(!load('eg_user_identities_v1', null)){
        save('eg_user_identities_v1', [
          { id:'me', name:'我', nickname:'我', boundCharIds:['nash','lily'] }
        ]);
      }
      if(!load('eg_threads_v1', null)){
        save('eg_threads_v1', {});
      }
      // 全局默认全天提醒时刻
      const st = load('eg_settings_v1',{});
      if(!st.allDayFire){ st.allDayFire = '09:00'; save('eg_settings_v1', st); }
    })();

    function getAllDayDefaultTime(){
      const s = load('eg_settings_v1',{});
      return s.allDayFire || '09:00';
    }

    /* ================= 事件引擎（我们的约定/我的记事本） ================= */
    (function(){
      const LS_EVT='eg_events_v1';
      const LS_ID='eg_user_identities_v1';
      const LS_CHAR='eg_characters_v2';

      function uid(){ return 'e_' + Math.random().toString(36).slice(2,8) + Date.now().toString(36).slice(-4); }
      const now = ()=> new Date();

      // 计算下次发生时间（兼容全天：datetimeISO 已带当天触发时刻）
      function nextOccurrence(e){
        if(!e.datetimeISO) return null;
        let dt = new Date(e.datetimeISO);
        while(dt < now()){
          if(e.frequency==='once') break;
          if(e.frequency==='year')  dt.setFullYear(dt.getFullYear()+1);
          else if(e.frequency==='month') dt.setMonth(dt.getMonth()+1);
          else if(e.frequency==='week')  dt.setDate(dt.getDate()+7);
          else if(e.frequency==='day')   dt.setDate(dt.getDate()+1);
          else break;
        }
        if(e.frequency==='once' && dt < now()) return null; // 过期
        return dt;
      }
      function fmtCountdown(dt){
        if(!dt) return '——';
        const ms = dt - now(); if(ms<=0) return '进行中';
        const d = Math.floor(ms/86400000);
        const h = Math.floor((ms%86400000)/3600000);
        const m = Math.floor((ms%3600000)/60000);
        return (d?`${d}天`:'') + (h?`${h}小时`:'') + (d||h?``:`${m}分钟`);
      }

      // 渲染卡片
      const elC = document.getElementById('evt-contract-list');
      const elN = document.getElementById('evt-notes-list');
      function render(){
        const events = load(LS_EVT,[]);
        const ids = load(LS_ID,[]);
        const chars = load(LS_CHAR,[]);
        const idMap = Object.fromEntries(ids.map(x=>[x.id, x]));
        const chMap = Object.fromEntries(chars.map(x=>[x.id, x]));

        function card(e){
          const next = nextOccurrence(e);
          const participants = (e.participants||[]).map(id=>chMap[id]?.nickname||chMap[id]?.name||id).join('、') || '—';
          const idName = e.identityId ? (idMap[e.identityId]?.nickname||idMap[e.identityId]?.name||'我') : '我';
          const allDayTag = e.allDay ? '<span class="tag">全天</span>' : '';
          return `
            <div class="card">
              <div class="row">
                <div class="row-main">
                  <div class="row-title">${e.title||'(未命名)'} ${allDayTag} <small style="color:#666;font-weight:400">· ${idName}</small></div>
                  <div class="row-sub">角色：${participants}</div>
                  <div class="row-sub">频次：${({'once':'单次','year':'年度','month':'月度','week':'周度','day':'日度'})[e.frequency]||'—'}</div>
                  <div class="row-sub">时间：${e.datetimeISO?new Date(e.datetimeISO).toLocaleString():'未填写'}</div>
                  <div class="row-sub" style="color:#111">距离事件还有：<b>${fmtCountdown(next)}</b></div>
                </div>
                <div>
                  <button data-act="edit" data-id="${e.id}" class="btn mini">编辑</button>
                  <button data-act="del"  data-id="${e.id}" class="btn mini danger">删除</button>
                </div>
              </div>
            </div>`;
        }

        const C = events.filter(x=>x.type==='contract').sort((a,b)=>(nextOccurrence(a)||1e15)-(nextOccurrence(b)||1e15));
        const N = events.filter(x=>x.type==='note').sort((a,b)=>(nextOccurrence(a)||1e15)-(nextOccurrence(b)||1e15));
        if(elC) elC.innerHTML = C.length? C.map(card).join('') : '<div class="empty">暂无约定</div>';
        if(elN) elN.innerHTML = N.length? N.map(card).join('') : '<div class="empty">暂无记事</div>';

        (elC||document).querySelectorAll('[data-act="edit"], [data-act="del"]').forEach(btn=>btn.addEventListener('click', onCardBtn));
        (elN||document).querySelectorAll('[data-act="edit"], [data-act="del"]').forEach(btn=>btn.addEventListener('click', onCardBtn));
      }

      function onCardBtn(e){
        const id = e.currentTarget.dataset.id;
        if(e.currentTarget.dataset.act==='del'){
          if(confirm('删除该事件？')){
            const arr=load(LS_EVT,[]).filter(x=>x.id!==id); save(LS_EVT,arr); render();
          }
        }else{
          openEditor(id);
        }
      }

      // 编辑器
      const modal=document.getElementById('evtModal');
      const form=document.getElementById('evtForm');
      const closeBtn=document.getElementById('evtClose');
      const addC=document.getElementById('evt-add-contract');
      const addN=document.getElementById('evt-add-note');

      function fillIdentityAndChars(identityId, participants){
        const ids = load(LS_ID,[]); const chars = load(LS_CHAR,[]);
        // 身份下拉
        const sel=document.getElementById('evtIdentity');
        sel.innerHTML = '<option value="">（不指定）</option>' + ids.map(u=>`<option value="${u.id}">${u.nickname||u.name||'我'}</option>`).join('');
        if(identityId) sel.value = identityId;
        // 角色（只展示该身份绑定的）
        const targetId = sel.value || ids[0]?.id;
        const bound = (ids.find(u=>u.id===targetId)?.boundCharIds)||[];
        const box=document.getElementById('evtChars');
        box.innerHTML = bound.map(cid=>{
          const c = chars.find(x=>x.id===cid); const name = c?.nickname||c?.name||cid;
          const checked = participants && participants.includes(cid) ? 'checked' : '';
          return `<label style="display:flex;gap:6px;align-items:center;background:#f7f7f7;border:1px solid var(--hair);border-radius:8px;padding:8px;">
            <input type="checkbox" value="${cid}" ${checked}/>
            <span>${name}</span>
          </label>`;
        }).join('') || '<div class="row-sub">该身份暂未绑定角色</div>';
        sel.onchange = ()=> fillIdentityAndChars(sel.value, collectChecked());
      }
      function collectChecked(){
        return Array.from(document.querySelectorAll('#evtChars input[type=checkbox]:checked')).map(x=>x.value);
      }

      function openEditor(id){
        const all=load(LS_EVT,[]); const one=all.find(x=>x.id===id)||{id:uid(),type:'contract',title:'',frequency:'once',datetimeISO:'',participants:[],identityId:'',promptTemplate:'',allDay:false,allDayTime:getAllDayDefaultTime()};
        document.getElementById('evtId').value=one.id;
        document.getElementById('evtType').value=one.type||'contract';
        document.getElementById('evtTitle').value=one.title||'';
        document.getElementById('evtFreq').value=one.frequency||'once';
        document.getElementById('evtTime').value= one.datetimeISO ? new Date(one.datetimeISO).toISOString().slice(0,16) : '';
        document.getElementById('evtPrompt').value=one.promptTemplate||'';
        document.getElementById('evtAllDay').checked = !!one.allDay;
        document.getElementById('evtAllDayTime').value = one.allDayTime || getAllDayDefaultTime();
        fillIdentityAndChars(one.identityId, one.participants);
        document.getElementById('evtIdentity').value = one.identityId||'';
        modal.classList.add('show');
      }
      function closeEditor(){ modal.classList.remove('show'); }
      closeBtn?.addEventListener('click', closeEditor);
      modal?.addEventListener('click', e=>{ if(e.target===modal) closeEditor(); });
      addC?.addEventListener('click', ()=>openEditor());
      addN?.addEventListener('click', ()=>{ openEditor(); document.getElementById('evtType').value='note'; });

      function dateOnlyFromInput(){
        const v = document.getElementById('evtTime').value || '';
        return v ? v.slice(0,10) : '';
      }

      form?.addEventListener('submit', e=>{
        e.preventDefault();
        const id = document.getElementById('evtId').value || uid();
        const allDay = !!document.getElementById('evtAllDay').checked;
        const allDayTime = document.getElementById('evtAllDayTime').value || getAllDayDefaultTime();
        let dtISO = '';
        const raw = document.getElementById('evtTime').value || '';
        if(allDay){
          const dOnly = dateOnlyFromInput();
          if(dOnly){ dtISO = new Date(`${dOnly}T${allDayTime}:00`).toISOString(); }
        }else{
          dtISO = raw ? new Date(raw).toISOString() : '';
        }

        const obj = {
          id,
          type: document.getElementById('evtType').value,
          title: document.getElementById('evtTitle').value.trim(),
          frequency: document.getElementById('evtFreq').value,
          datetimeISO: dtISO,
          identityId: document.getElementById('evtIdentity').value || '',
          participants: collectChecked(),
          promptTemplate: document.getElementById('evtPrompt').value.trim(),
          allDay,
          allDayTime,
          lastFiredAtISO: ''
        };
        if(!obj.title){ alert('请填写事件名称'); return; }
        const arr=load(LS_EVT,[]);
        const i=arr.findIndex(x=>x.id===id);
        if(i>=0) arr[i]=Object.assign(arr[i], obj); else arr.push(obj);
        save(LS_EVT,arr); closeEditor(); render();
      });

      // ===== 触发器：前台定时 + 离线补偿 =====
      function buildDefaultPrompt(e, charName, identityName){
        if(e.type==='contract'){
          return `现在是「${e.title}」的约定时间。请以${charName}的语气，给${identityName}发一段自然、不超过3句的问候或行动描述。`;
        }else{
          return `${identityName}今天有「${e.title}」。请以${charName}的语气，给${identityName}发一段自然、不超过3句的关心。`;
        }
      }

      async function fireEvent(e){
        const ids = load(LS_ID,[]); const chars = load(LS_CHAR,[]);
        const identity = e.identityId ? ids.find(x=>x.id===e.identityId) : ids[0];
        const identityName = identity?.nickname||identity?.name||'用户';
        const list = (e.participants||[]).map(cid=>chars.find(c=>c.id===cid)).filter(Boolean);
        const targets = list.filter(c => !!c?.backgroundOn);

        for(const ch of targets){
          const prompt = e.promptTemplate || buildDefaultPrompt(e, (ch.nickname||ch.name||'Ta'), identityName);
          await sendEventPromptToThread(ch.id, identity, prompt, e);
        }

        const arr=load(LS_EVT,[]);
        const i=arr.findIndex(x=>x.id===e.id);
        if(i>=0){
          arr[i].lastFiredAtISO = new Date().toISOString();
          save(LS_EVT,arr);
        }
      }

      async function sendEventPromptToThread(charId, identity, userText, e){
        const threads = load('eg_threads_v1', {});
        const mine = threads[charId] || (threads[charId] = { id:charId, messages:[] });
        // 时间戳写入约定触发时刻（离线补偿时也显得自然）
        mine.messages.push({ role:'user', content:userText, ts: e.datetimeISO ? new Date(e.datetimeISO).getTime() : Date.now(), meta:{from:'event', eventId:e.id} });
        save('eg_threads_v1', threads);
        try{ localStorage.setItem('eg_evt_ping', String(Date.now())); }catch(_){}
      }

      function tick(){
        const arr = load(LS_EVT,[]);
        for(const e of arr){
          const next = nextOccurrence(e);
          if(!next) continue;
          const diff = Math.abs(next - new Date());
          if(diff <= 60000){ // 窗口 ±60s
            if(!e.lastFiredAtISO || new Date(e.lastFiredAtISO) < next) fireEvent(e);
          }
        }
        render();
      }

      // 初始化
      render();
      tick();
      setInterval(tick, 30000);

      // 暴露给“＋”按钮
      window.EGEvents = { openEditor };
    })();

    // 默认打开聊天
    switchTab('chat');
  </script>
</body>
</html>
