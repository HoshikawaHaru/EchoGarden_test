<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="rgba(0,0,0,0)">
  <link rel="apple-touch-icon" sizes="512x512" href="../assets/icons/icon512.png">
  <link rel="icon" href="../assets/icons/icon512.png" type="image/png">
  <title>æ¶ˆæ¯</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{--safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px)}
    html,body{width:100%;height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
    .message-app{position:fixed;inset:0;background:#ededed;display:flex;flex-direction:column}
    .msg-navbar{height:calc(44px + env(safe-area-inset-top,20px));padding-top:env(safe-area-inset-top,20px);background:#f7f7f7;border-bottom:.5px solid #d9d9d9;display:flex;align-items:center;justify-content:space-between;padding-left:16px;padding-right:16px;flex-shrink:0}
    .msg-navbar-left{display:flex;align-items:center;gap:12px}
    .msg-back-btn{font-size:20px;cursor:pointer;user-select:none;padding:8px;margin:-8px}
    .msg-navbar-title{font-size:17px;font-weight:600;color:#000}
    .msg-navbar-icon{font-size:22px;cursor:pointer;user-select:none;padding:8px;margin:-8px}
    .msg-chat-list{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;position:relative}
    .msg-chat-item-wrapper{position:relative;overflow:hidden}
    .msg-chat-item{background:#fff;padding:12px 16px;display:flex;gap:12px;border-bottom:.5px solid #e5e5e5;cursor:pointer;position:relative;transition:transform .3s ease;z-index:1}
    .msg-chat-item:active{background:#ececec}
    .msg-chat-avatar{width:48px;height:48px;border-radius:6px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0}
    .msg-chat-avatar img{width:100%;height:100%;border-radius:6px;object-fit:cover}
    .msg-chat-content{flex:1;min-width:0}
    .msg-chat-header{display:flex;justify-content:space-between;margin-bottom:4px}
    .msg-chat-name{font-size:16px;font-weight:500;color:#000}
    .msg-chat-time{font-size:12px;color:#999}
    .msg-chat-preview{font-size:14px;color:#999;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .msg-tabbar{height:calc(50px + env(safe-area-inset-bottom,20px));padding-bottom:env(safe-area-inset-bottom,20px);background:#f7f7f7;border-top:.5px solid #d9d9d9;display:flex;flex-shrink:0}
    .msg-tab-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;user-select:none}
    .msg-tab-icon{font-size:24px;margin-bottom:2px}
    .msg-tab-label{font-size:10px;color:#999}
    .msg-tab-item.active .msg-tab-label{color:#07c160}
    .msg-modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:3000}
    .msg-modal.show{display:flex}
    .msg-modal-content{background:#fff;width:90%;max-width:400px;border-radius:12px;overflow:hidden}
    .msg-modal-header{padding:16px;border-bottom:.5px solid #e5e5e5;display:flex;justify-content:space-between;align-items:center}
    .msg-modal-title{font-size:17px;font-weight:600}
    .msg-modal-close{font-size:24px;color:#999;cursor:pointer;padding:4px}
    .msg-modal-body{padding:20px;max-height:60vh;overflow-y:auto}
    .msg-form-group{margin-bottom:20px}
    .msg-form-label{display:block;font-size:14px;color:#666;margin-bottom:8px}
    .msg-form-input{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px}
    .msg-form-textarea{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px;min-height:100px;resize:vertical;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
    .msg-avatar-upload{width:80px;height:80px;border-radius:8px;border:2px dashed #e5e5e5;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden}
    .msg-avatar-upload img{width:100%;height:100%;object-fit:cover}
    .msg-btn-primary{width:100%;padding:12px;background:#07c160;color:#fff;border:none;border-radius:8px;font-size:16px;cursor:pointer}
    .msg-btn-primary:active{background:#06ad56}
    .msg-swipe-actions{position:absolute;right:0;top:0;bottom:0;display:flex;z-index:0}
    .msg-swipe-action{width:75px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px;cursor:pointer;user-select:none}
    .msg-swipe-action.reset{background:#ff9500}
    .msg-swipe-action.delete{background:#ff3b30}
    #debugBox{position:fixed;left:8px;right:8px;bottom:8px;z-index:9999;background:rgba(0,0,0,.8);color:#0f0;padding:8px;border-radius:6px;font-size:11px;max-height:25vh;overflow:auto;font-family:monospace;white-space:pre-wrap;word-break:break-all;display:none}
  </style>
</head>
<body>
  <div class="message-app">
    <div class="msg-navbar">
      <div class="msg-navbar-left">
        <div class="msg-back-btn" id="backBtn">â—€</div>
        <div class="msg-navbar-title">æ¶ˆæ¯</div>
      </div>
      <div class="msg-navbar-icon" id="addBtn">â•</div>
    </div>
    <div class="msg-chat-list" id="msgChatList"></div>
    <div class="msg-tabbar">
      <div class="msg-tab-item active"><div class="msg-tab-icon">ğŸ’¬</div><div class="msg-tab-label">èŠå¤©</div></div>
      <div class="msg-tab-item"><div class="msg-tab-icon">ğŸ“…</div><div class="msg-tab-label">äº‹ä»¶</div></div>
      <div class="msg-tab-item"><div class="msg-tab-icon">ğŸŒ</div><div class="msg-tab-label">æœ‹å‹åœˆ</div></div>
      <div class="msg-tab-item"><div class="msg-tab-icon">ğŸ‘¤</div><div class="msg-tab-label">æˆ‘</div></div>
    </div>
    <div class="msg-modal" id="msgAddModal">
      <div class="msg-modal-content">
        <div class="msg-modal-header">
          <div class="msg-modal-title">æ·»åŠ è§’è‰²</div>
          <div class="msg-modal-close" id="closeModalBtn">Ã—</div>
        </div>
        <div class="msg-modal-body">
          <form id="msgCharacterForm">
            <div class="msg-form-group">
              <label class="msg-form-label">å¤´åƒ</label>
              <div class="msg-avatar-upload" id="msgAvatarUpload"><span>ğŸ“·</span></div>
              <input type="file" id="msgAvatarInput" accept="image/*" style="display:none">
            </div>
            <div class="msg-form-group">
              <label class="msg-form-label">å§“å</label>
              <input type="text" class="msg-form-input" id="msgCharacterName" placeholder="è¾“å…¥è§’è‰²å§“å" required>
            </div>
            <div class="msg-form-group">
              <label class="msg-form-label">æ˜µç§°</label>
              <input type="text" class="msg-form-input" id="msgCharacterNickname" placeholder="è¾“å…¥è§’è‰²æ˜µç§°">
            </div>
            <div class="msg-form-group">
              <label class="msg-form-label">äººè®¾</label>
              <textarea class="msg-form-textarea" id="msgCharacterBio" placeholder="æè¿°è§’è‰²çš„æ€§æ ¼ã€ç‰¹ç‚¹..." required></textarea>
            </div>
            <button type="submit" class="msg-btn-primary">æ·»åŠ </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <div id="debugBox"></div>

  <script>
  (function(){
    'use strict';
    
    // è°ƒè¯•å·¥å…·
    var debugBox = document.getElementById('debugBox');
    if (!debugBox) {
      debugBox = document.createElement('div');
      debugBox.id = 'debugBox';
      debugBox.style.cssText = 'position:fixed;left:8px;right:8px;bottom:8px;z-index:9999;background:rgba(0,0,0,.8);color:#0f0;padding:8px;border-radius:6px;font-size:11px;max-height:25vh;overflow:auto;font-family:monospace;white-space:pre-wrap;word-break:break-all';
      document.body.appendChild(debugBox);
    }
    
    function log(msg) {
      try {
        var time = new Date().toTimeString().slice(0,8);
        debugBox.innerHTML += time + ' ' + msg + '\n';
        debugBox.scrollTop = debugBox.scrollHeight;
        console.log(msg);
      } catch(e) {
        console.log(msg);
      }
    }
    
    window.onerror = function(msg, url, line) {
      log('ERROR: ' + msg + ' @' + line);
      return true;
    };
    
    log('è„šæœ¬å¼€å§‹æ‰§è¡Œ');
    log('document.readyState: ' + document.readyState);
    
    // æ•°æ®ç®¡ç†
    var STORAGE_KEY = 'eg_characters_v2';
    var msgCharacters = [];
    var touchStartX = 0, touchCurrentX = 0, isSwiping = false;
    
    function loadData() {
      try {
        var stored = localStorage.getItem(STORAGE_KEY);
        log('è¯»å–localStorage: ' + (stored ? stored.length + 'å­—ç¬¦' : 'null'));
        
        if (stored) {
          msgCharacters = JSON.parse(stored);
          log('è§£ææˆåŠŸ: ' + msgCharacters.length + 'ä¸ªè§’è‰²');
        } else {
          msgCharacters = [{
            id: 'nash',
            name: 'Nash',
            nickname: 'Nash',
            bio: 'å¤©çœŸå¼€æœ—çš„å°ç‹ç‹¸',
            avatar: 'ğŸ¦Š',
            lastTime: '12:00'
          }];
          saveData();
          log('åˆå§‹åŒ–Nash');
        }
      } catch(e) {
        log('loadDataé”™è¯¯: ' + e.message);
        msgCharacters = [];
      }
    }
    
    function saveData() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(msgCharacters));
        log('ä¿å­˜æˆåŠŸ: ' + msgCharacters.length + 'ä¸ªè§’è‰²');
      } catch(e) {
        log('saveDataé”™è¯¯: ' + e.message);
      }
    }
    
    function renderList() {
      log('å¼€å§‹æ¸²æŸ“åˆ—è¡¨');
      var list = document.getElementById('msgChatList');
      if (!list) {
        log('ERROR: msgChatListä¸å­˜åœ¨');
        return;
      }
      
      if (msgCharacters.length === 0) {
        list.innerHTML = '<div style="padding:20px;text-align:center;color:#999">æš‚æ— è§’è‰²</div>';
        return;
      }
      
      var html = '';
      for (var i = 0; i < msgCharacters.length; i++) {
        var c = msgCharacters[i];
        var av = c.avatar || 'ğŸ‘¤';
        var avatarHTML = (av.indexOf('data:')===0 || av.indexOf('http')===0) 
          ? '<img src="'+av+'">' 
          : av;
        
        html += '<div class="msg-chat-item-wrapper">'+
          '<div class="msg-swipe-actions">'+
            '<div class="msg-swipe-action reset" data-id="'+c.id+'">é‡ç½®</div>'+
            '<div class="msg-swipe-action delete" data-id="'+c.id+'">åˆ é™¤</div>'+
          '</div>'+
          '<div class="msg-chat-item" data-id="'+c.id+'">'+
            '<div class="msg-chat-avatar">'+avatarHTML+'</div>'+
            '<div class="msg-chat-content">'+
              '<div class="msg-chat-header">'+
                '<div class="msg-chat-name">'+(c.nickname||c.name)+'</div>'+
                '<div class="msg-chat-time">'+(c.lastTime||'')+'</div>'+
              '</div>'+
              '<div class="msg-chat-preview">'+(c.bio||'')+'</div>'+
            '</div>'+
          '</div>'+
        '</div>';
      }
      
      list.innerHTML = html;
      log('æ¸²æŸ“å®Œæˆ: '+msgCharacters.length+'é¡¹');
      bindEvents();
    }
    
    function bindEvents() {
      log('ç»‘å®šäº‹ä»¶');
      
      // èŠå¤©é¡¹ç‚¹å‡»
      var items = document.querySelectorAll('.msg-chat-item');
      for (var i = 0; i < items.length; i++) {
        items[i].addEventListener('click', function() {
          if (Math.abs(touchStartX - touchCurrentX) < 10) {
            var id = this.dataset.id;
            log('æ‰“å¼€èŠå¤©: ' + id);
            // è·³è½¬åˆ°èŠå¤©è¯¦æƒ…é¡µ
            location.href = './message-detail.html?id=' + id;
          }
        });
        
        // è§¦æ‘¸äº‹ä»¶
        items[i].addEventListener('touchstart', function(e) {
          touchStartX = e.touches[0].clientX;
          touchCurrentX = touchStartX;
          isSwiping = false;
        });
        
        items[i].addEventListener('touchmove', function(e) {
          touchCurrentX = e.touches[0].clientX;
          var diff = touchStartX - touchCurrentX;
          if (Math.abs(diff) > 10) isSwiping = true;
          if (diff > 0 && diff < 150) {
            this.style.transform = 'translateX(-' + diff + 'px)';
            this.style.transition = 'none';
          }
        });
        
        items[i].addEventListener('touchend', function(e) {
          var diff = touchStartX - touchCurrentX;
          this.style.transition = 'transform 0.3s ease';
          if (diff > 75) {
            this.style.transform = 'translateX(-150px)';
          } else {
            this.style.transform = 'translateX(0)';
          }
          setTimeout(function(){ isSwiping = false; }, 300);
        });
      }
      
      // åˆ é™¤/é‡ç½®æŒ‰é’®
      var actions = document.querySelectorAll('.msg-swipe-action');
      for (var j = 0; j < actions.length; j++) {
        actions[j].addEventListener('click', function(e) {
          e.stopPropagation();
          var id = this.dataset.id;
          var isDelete = this.classList.contains('delete');
          
          if (isDelete) {
            if (confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) {
              log('åˆ é™¤è§’è‰²: ' + id);
              msgCharacters = msgCharacters.filter(function(c){ return c.id !== id; });
              saveData();
              renderList();
            }
          } else {
            if (confirm('ç¡®å®šé‡ç½®èŠå¤©è®°å½•ï¼Ÿ')) {
              log('é‡ç½®èŠå¤©: ' + id);
              alert('èŠå¤©è®°å½•å·²é‡ç½®');
            }
          }
        });
      }
    }
    
    // æ¨¡æ€æ¡†
    function showModal() {
      log('æ˜¾ç¤ºæ¨¡æ€æ¡†');
      var m = document.getElementById('msgAddModal');
      if (m) m.classList.add('show');
    }
    
    function hideModal() {
      log('éšè—æ¨¡æ€æ¡†');
      var m = document.getElementById('msgAddModal');
      if (m) m.classList.remove('show');
      var f = document.getElementById('msgCharacterForm');
      if (f) f.reset();
      var up = document.getElementById('msgAvatarUpload');
      if (up) up.innerHTML = '<span>ğŸ“·</span>';
    }
    
    // è¿”å›
    function goBack() {
      log('ç‚¹å‡»è¿”å›');
      if (window.closeApp) {
        log('è°ƒç”¨closeApp');
        window.closeApp();
      } else if (history.length > 1) {
        log('history.back');
        history.back();
      } else {
        log('è·³è½¬index');
        location.href = '../index.html';
      }
    }
    
    // åˆå§‹åŒ–å‡½æ•°
    function init() {
      log('initå‡½æ•°å¼€å§‹');
      
      try {
        loadData();
        renderList();
        
        // è¿”å›æŒ‰é’®
        var backBtn = document.getElementById('backBtn');
        if (backBtn) {
          backBtn.addEventListener('click', goBack);
          log('è¿”å›æŒ‰é’®å·²ç»‘å®š');
        } else {
          log('ERROR: è¿”å›æŒ‰é’®ä¸å­˜åœ¨');
        }
        
        // æ·»åŠ æŒ‰é’®
        var addBtn = document.getElementById('addBtn');
        if (addBtn) {
          addBtn.addEventListener('click', showModal);
          log('æ·»åŠ æŒ‰é’®å·²ç»‘å®š');
        } else {
          log('ERROR: æ·»åŠ æŒ‰é’®ä¸å­˜åœ¨');
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        var closeBtn = document.getElementById('closeModalBtn');
        if (closeBtn) {
          closeBtn.addEventListener('click', hideModal);
        }
        
        var modal = document.getElementById('msgAddModal');
        if (modal) {
          modal.addEventListener('click', function(e) {
            if (e.target.id === 'msgAddModal') hideModal();
          });
        }
        
        // å¤´åƒä¸Šä¼ 
        var avatarUpload = document.getElementById('msgAvatarUpload');
        var avatarInput = document.getElementById('msgAvatarInput');
        if (avatarUpload && avatarInput) {
          avatarUpload.addEventListener('click', function() {
            avatarInput.click();
          });
          avatarInput.addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (file) {
              var reader = new FileReader();
              reader.onload = function(ev) {
                avatarUpload.innerHTML = '<img src="'+ev.target.result+'">';
              };
              reader.readAsDataURL(file);
            }
          });
        }
        
        // è¡¨å•æäº¤
        var form = document.getElementById('msgCharacterForm');
        if (form) {
          form.addEventListener('submit', function(e) {
            e.preventDefault();
            log('æäº¤è¡¨å•');
            
            var name = document.getElementById('msgCharacterName').value.trim();
            var nickname = document.getElementById('msgCharacterNickname').value.trim() || name;
            var bio = document.getElementById('msgCharacterBio').value.trim();
            var up = document.getElementById('msgAvatarUpload');
            var img = up ? up.querySelector('img') : null;
            var avatar = img ? img.src : 'ğŸ‘¤';
            
            var newChar = {
              id: String(Date.now()),
              name: name,
              nickname: nickname,
              bio: bio,
              avatar: avatar,
              lastTime: new Date().toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'})
            };
            
            log('æ–°å¢è§’è‰²: ' + newChar.nickname);
            msgCharacters.push(newChar);
            saveData();
            renderList();
            hideModal();
          });
        }
        
        // Tabåˆ‡æ¢
        var tabs = document.querySelectorAll('.msg-tab-item');
        for (var i = 1; i < tabs.length; i++) {
          tabs[i].addEventListener('click', function() {
            alert('åŠŸèƒ½å¼€å‘ä¸­');
          });
        }
        
        log('åˆå§‹åŒ–å®Œæˆ');
        
      } catch(e) {
        log('åˆå§‹åŒ–é”™è¯¯: ' + e.message);
      }
    }
    
    // ç«‹å³æ‰§è¡Œæˆ–ç­‰å¾…DOM
    if (document.readyState === 'loading') {
      log('ç­‰å¾…DOMåŠ è½½');
      document.addEventListener('DOMContentLoaded', function() {
        log('DOMåŠ è½½å®Œæˆ');
        init();
      });
    } else {
      log('DOMå·²å°±ç»ªï¼Œç«‹å³åˆå§‹åŒ–');
      init();
    }
    
  })();
  </script>
</body>
</html>
