<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="rgba(0,0,0,0)">
  <link rel="apple-touch-icon" sizes="512x512" href="../assets/icons/icon512.png">
  <link rel="icon" href="../assets/icons/icon512.png" type="image/png">
  <title>æ¶ˆæ¯</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{--safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px)}
    html,body{width:100%;height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
    .message-app{position:fixed;inset:0;background:#ededed;display:flex;flex-direction:column}
    .msg-navbar{height:calc(44px + env(safe-area-inset-top,20px));padding-top:env(safe-area-inset-top,20px);background:#f7f7f7;border-bottom:.5px solid #d9d9d9;display:flex;align-items:center;justify-content:space-between;padding:0 16px;flex-shrink:0}
    .msg-navbar-left{display:flex;align-items:center;gap:12px}
    .msg-back-btn{font-size:20px;cursor:pointer;user-select:none;padding:8px;margin:-8px}
    .msg-navbar-title{font-size:17px;font-weight:600;color:#000}
    .msg-navbar-icon{font-size:22px;cursor:pointer;user-select:none;padding:8px;margin:-8px}
    .msg-chat-list{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;position:relative}
    .msg-chat-item-wrapper{position:relative;overflow:hidden}
    .msg-chat-item{background:#fff;padding:12px 16px;display:flex;gap:12px;border-bottom:.5px solid #e5e5e5;cursor:pointer;position:relative;transition:transform .3s ease;z-index:1}
    .msg-chat-item:active{background:#ececec}
    .msg-chat-avatar{width:48px;height:48px;border-radius:6px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0}
    .msg-chat-avatar img{width:100%;height:100%;border-radius:6px;object-fit:cover}
    .msg-chat-content{flex:1;min-width:0}
    .msg-chat-header{display:flex;justify-content:space-between;margin-bottom:4px}
    .msg-chat-name{font-size:16px;font-weight:500;color:#000}
    .msg-chat-time{font-size:12px;color:#999}
    .msg-chat-preview{font-size:14px;color:#999;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .msg-tabbar{height:calc(50px + env(safe-area-inset-bottom,20px));padding-bottom:env(safe-area-inset-bottom,20px);background:#f7f7f7;border-top:.5px solid #d9d9d9;display:flex;flex-shrink:0}
    .msg-tab-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;user-select:none}
    .msg-tab-icon{font-size:24px;margin-bottom:2px}
    .msg-tab-label{font-size:10px;color:#999}
    .msg-tab-item.active .msg-tab-label{color:#07c160}
    .msg-modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:3000}
    .msg-modal.show{display:flex}
    .msg-modal-content{background:#fff;width:90%;max-width:400px;border-radius:12px;overflow:hidden}
    .msg-modal-header{padding:16px;border-bottom:.5px solid #e5e5e5;display:flex;justify-content:space-between;align-items:center}
    .msg-modal-title{font-size:17px;font-weight:600}
    .msg-modal-close{font-size:24px;color:#999;cursor:pointer;padding:4px}
    .msg-modal-body{padding:20px;max-height:60vh;overflow-y:auto}
    .msg-form-group{margin-bottom:20px}
    .msg-form-label{display:block;font-size:14px;color:#666;margin-bottom:8px}
    .msg-form-input{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px}
    .msg-form-textarea{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px;min-height:100px;resize:vertical;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
    .msg-avatar-upload{width:80px;height:80px;border-radius:8px;border:2px dashed #e5e5e5;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden}
    .msg-avatar-upload img{width:100%;height:100%;object-fit:cover}
    .msg-btn-primary{width:100%;padding:12px;background:#07c160;color:#fff;border:none;border-radius:8px;font-size:16px;cursor:pointer}
    .msg-btn-primary:active{background:#06ad56}
    .msg-swipe-actions{position:absolute;right:0;top:0;bottom:0;display:flex;z-index:0}
    .msg-swipe-action{width:75px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px;cursor:pointer;user-select:none}
    .msg-swipe-action.reset{background:#ff9500}
    .msg-swipe-action.delete{background:#ff3b30}
    /* ç©ºçŠ¶æ€å¡ç‰‡ */
    .empty-card{margin:18px;color:#666;background:#fff;border-radius:12px;padding:16px;line-height:1.6;border:.5px solid #eee}
    .empty-card button{margin-top:10px;margin-right:8px;padding:8px 12px;border-radius:8px;border:0;background:#07c160;color:#fff}
    .empty-card button.secondary{background:#888}
  </style>
</head>
<body>
  <div class="message-app">
    <div class="msg-navbar">
      <div class="msg-navbar-left">
        <div class="msg-back-btn" id="backBtn">â—€</div>
        <div class="msg-navbar-title">æ¶ˆæ¯</div>
      </div>
      <div class="msg-navbar-icon" id="addBtn">â•</div>
    </div>

    <div class="msg-chat-list" id="msgChatList"></div>

    <div class="msg-tabbar">
      <div class="msg-tab-item active"><div class="msg-tab-icon">ğŸ’¬</div><div class="msg-tab-label">èŠå¤©</div></div>
      <div class="msg-tab-item"><div class="msg-tab-icon">ğŸ“…</div><div class="msg-tab-label">äº‹ä»¶</div></div>
      <div class="msg-tab-item"><div class="msg-tab-icon">ğŸŒ</div><div class="msg-tab-label">æœ‹å‹åœˆ</div></div>
      <div class="msg-tab-item"><div class="msg-tab-icon">ğŸ‘¤</div><div class="msg-tab-label">æˆ‘</div></div>
    </div>

    <!-- æ·»åŠ è§’è‰²å¼¹çª— -->
    <div class="msg-modal" id="msgAddModal">
      <div class="msg-modal-content">
        <div class="msg-modal-header">
          <div class="msg-modal-title">æ·»åŠ è§’è‰²</div>
          <div class="msg-modal-close" id="closeModalBtn">Ã—</div>
        </div>
        <div class="msg-modal-body">
          <form id="msgCharacterForm">
            <div class="msg-form-group">
              <label class="msg-form-label">å¤´åƒ</label>
              <div class="msg-avatar-upload" id="msgAvatarUpload"><span>ğŸ“·</span></div>
              <input type="file" id="msgAvatarInput" accept="image/*" style="display:none">
            </div>
            <div class="msg-form-group">
              <label class="msg-form-label">å§“å</label>
              <input type="text" class="msg-form-input" id="msgCharacterName" placeholder="è¾“å…¥è§’è‰²å§“å" required>
            </div>
            <div class="msg-form-group">
              <label class="msg-form-label">æ˜µç§°</label>
              <input type="text" class="msg-form-input" id="msgCharacterNickname" placeholder="è¾“å…¥è§’è‰²æ˜µç§°">
            </div>
            <div class="msg-form-group">
              <label class="msg-form-label">äººè®¾</label>
              <textarea class="msg-form-textarea" id="msgCharacterBio" placeholder="æè¿°è§’è‰²çš„æ€§æ ¼ã€ç‰¹ç‚¹..." required></textarea>
            </div>
            <button type="submit" class="msg-btn-primary">æ·»åŠ </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
  /* ===== é¡¶å±‚è¡¥ä¸ï¼šç ´ç¼“å­˜/å‚æ•°å·¥å…·/æ—¥å¿— ===== */
  var EG_BUILD = '20251019e';
  (function(){
    var box = document.createElement('div');
    box.id = 'eg-debug';
    box.style.cssText='position:fixed;left:8px;right:8px;bottom:8px;z-index:9999;background:rgba(0,0,0,.6);color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;max-height:30vh;overflow:auto;display:none';
    window.egLog = function(s){ try{ box.style.display='block'; box.innerHTML+='<div>'+s+'</div>'; }catch(e){} };
    window.addEventListener('DOMContentLoaded', function(){ document.body.appendChild(box); });
    window.onerror = function(msg,src,ln,col){ egLog('JSé”™è¯¯ï¼š'+msg+' @'+ln+':'+col); };
  })();
  function qs(k){var m=location.search.match(new RegExp('[?&]'+k+'=([^&]+)'));return m?decodeURIComponent(m[1]):null;}

  (function(){ if (location.search.indexOf('v=') === -1) {
    var sp = new URLSearchParams(location.search); sp.set('v', EG_BUILD);
    location.replace(location.pathname + '?' + sp.toString() + location.hash);
  }})();

  var LS_KEYS = ['characters','msgCharacters','eg_chars'];
  if (qs('reset') === '1') { for (var i=0;i<LS_KEYS.length;i++) try{ localStorage.removeItem(LS_KEYS[i]); }catch(e){} egLog('reset=1 å·²æ¸…ç©ºå†å²æ•°æ®'); }
  var FORCE_MEMORY = (qs('force') === '1');

  function readAny(){ if (FORCE_MEMORY) return {key:'memory', data:null};
    for (var i=0;i<LS_KEYS.length;i++){ try{ var raw=localStorage.getItem(LS_KEYS[i]); if(raw){ var data=JSON.parse(raw); if(Array.isArray(data)) return {key:LS_KEYS[i], data:data}; } }catch(e){ egLog('è¯»å– '+LS_KEYS[i]+' å¤±è´¥:'+e); } }
    return {key:LS_KEYS[0], data:null};
  }
  function writeToAll(list){ if (FORCE_MEMORY) return;
    var s = JSON.stringify(list||[]); for (var i=0;i<LS_KEYS.length;i++){ try{ localStorage.setItem(LS_KEYS[i], s);}catch(e){ egLog('å†™å…¥ '+LS_KEYS[i]+' å¤±è´¥:'+e); } }
  }

  /* ===== ä¸šåŠ¡è„šæœ¬ ===== */
  var msgCharacters = [];
  var touchStartX = 0, touchCurrentX = 0, isSwiping = false, currentSwipedId = null;

  function normalizeCharacters(arr){
    if (!arr || !arr.length) return [];
    return arr.map(function(c){
      c = c || {};
      var id   = (c.id != null) ? String(c.id) : String(Date.now() + Math.random());
      var name = (c.name || c.nickname) ? String(c.name || c.nickname) : 'æœªå‘½å';
      var nick = (c.nickname || c.name) ? String(c.nickname || c.name) : 'æœªå‘½å';
      var bio  = c.bio ? String(c.bio) : '';
      var av   = (typeof c.avatar === 'string' && c.avatar) ? c.avatar : 'ğŸ‘¤';
      var last = c.lastTime ? String(c.lastTime) : new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'});
      return { id:id, name:name, nickname:nick, bio:bio, avatar:av, lastTime:last };
    });
  }
  function seedPresets(){
    return [{ id:'nash', name:'Nash', nickname:'Nash', bio:'å¤©çœŸå¼€æœ—çš„å°ç‹ç‹¸', avatar:'ğŸ¦Š',
      lastTime:new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}) }];
  }
  function initData(){
    var got = readAny(), arr = got.data;
    if (!arr || !arr.length) {
      msgCharacters = seedPresets();
    } else {
      msgCharacters = normalizeCharacters(arr);
      var has=false; for (var i=0;i<msgCharacters.length;i++){ var c=msgCharacters[i]; if (c.id==='nash'||(c.name==='Nash'&&c.nickname==='Nash')){has=true;break;} }
      if (!has) msgCharacters.unshift(seedPresets()[0]);
    }
    writeToAll(msgCharacters);
    egLog('init å®Œæˆï¼š'+msgCharacters.length+' æ¡ï¼›æºkey='+got.key+'ï¼›build='+EG_BUILD+(FORCE_MEMORY?'ï¼›forceå†…å­˜æ¨¡å¼':'')); 
  }
  function saveData(){ writeToAll(msgCharacters); }

  function renderChatList(){
    var list = document.getElementById('msgChatList');
    if (!list) return;

    if (!msgCharacters || msgCharacters.length === 0) {
      list.innerHTML = '<div class="empty-card">è¿˜æ²¡æœ‰ä¼šè¯ï½<br>å¯èƒ½æ˜¯ç¼“å­˜é‡Œæœ‰æ—§æ•°æ®æˆ–è„šæœ¬æœªæ›´æ–°ã€‚ä½ å¯ä»¥ï¼š<br>1ï¼‰ç‚¹ä¸‹é¢â€œé‡æ–°æ³¨å…¥ Nashâ€<br>2ï¼‰æˆ–æ¸…ç©ºä¸€æ¬¡æ•°æ®<br><br><button id="btn-seed">é‡æ–°æ³¨å…¥ Nash</button><button class="secondary" id="btn-reset">æ¸…ç©ºæ•°æ®</button></div>';
      var seedBtn = document.getElementById('btn-seed');
      var resetBtn = document.getElementById('btn-reset');
      if (seedBtn) seedBtn.onclick = function(){ msgCharacters = seedPresets(); saveData(); renderChatList(); };
      if (resetBtn) resetBtn.onclick = function(){ for (var i=0;i<LS_KEYS.length;i++) try{ localStorage.removeItem(LS_KEYS[i]); }catch(e){} msgCharacters = seedPresets(); saveData(); renderChatList(); };
      return;
    }

    list.innerHTML = msgCharacters.map(function(char){
      var av = (typeof char.avatar === 'string' && char.avatar) ? char.avatar : 'ğŸ‘¤';
      var avatarHTML = (av.indexOf('data:')===0 || av.indexOf('http')===0) ? '<img src="'+av+'">' : av;
      return (
        '<div class="msg-chat-item-wrapper" id="wrapper-'+char.id+'">'+
          '<div class="msg-swipe-actions">'+
            '<div class="msg-swipe-action reset" data-action="reset" data-id="'+char.id+'">é‡ç½®</div>'+
            '<div class="msg-swipe-action delete" data-action="delete" data-id="'+char.id+'">åˆ é™¤</div>'+
          '</div>'+
          '<div class="msg-chat-item" id="item-'+char.id+'" data-id="'+char.id+'">'+
            '<div class="msg-chat-avatar">'+avatarHTML+'</div>'+
            '<div class="msg-chat-content">'+
              '<div class="msg-chat-header">'+
                '<div class="msg-chat-name">'+char.nickname+'</div>'+
                '<div class="msg-chat-time">'+char.lastTime+'</div>'+
              '</div>'+
              '<div class="msg-chat-preview">'+char.bio+'</div>'+
            '</div>'+
          '</div>'+
        '</div>'
      );
    }).join('');
    bindChatItemEvents();
  }

  function bindChatItemEvents(){
    Array.prototype.forEach.call(document.querySelectorAll('.msg-chat-item'), function(item){
      item.addEventListener('click', function(){ if (Math.abs(touchStartX - touchCurrentX) > 10) return; openChat(this.dataset.id); });
      item.addEventListener('touchstart', handleTouchStart);
      item.addEventListener('touchmove', handleTouchMove);
      item.addEventListener('touchend', handleTouchEnd);
    });
    Array.prototype.forEach.call(document.querySelectorAll('.msg-swipe-action'), function(btn){
      btn.addEventListener('click', function(e){ e.stopPropagation(); var act=this.dataset.action,id=this.dataset.id; if(act==='reset') resetChat(id); else if (act==='delete') deleteChat(id); });
    });
  }

  function openChat(id){ alert('èŠå¤©åŠŸèƒ½å¼€å‘ä¸­ï¼Œè§’è‰²ID: ' + id); }
  function handleTouchStart(e){ touchStartX=e.touches[0].clientX; touchCurrentX=touchStartX; isSwiping=false; }
  function handleTouchMove(e){ var item=e.currentTarget; touchCurrentX=e.touches[0].clientX; var diff=touchStartX-touchCurrentX; if (Math.abs(diff)>10) isSwiping=true; if (diff>0&&diff<150){ item.style.transform='translateX(-'+diff+'px)'; item.style.transition='none'; } }
  function handleTouchEnd(e){ var item=e.currentTarget,id=item.dataset.id,diff=touchStartX-touchCurrentX; item.style.transition='transform .3s ease'; if (diff>75){ item.style.transform='translateX(-150px)'; currentSwipedId=id; Array.prototype.forEach.call(document.querySelectorAll('.msg-chat-item'), function(el){ if (el.dataset.id!==id) el.style.transform='translateX(0)'; }); } else { item.style.transform='translateX(0)'; } setTimeout(function(){ isSwiping=false; },300); }
  function resetChat(id){ if (confirm('ç¡®å®šè¦é‡ç½®ä¸è¯¥è§’è‰²çš„èŠå¤©è®°å½•å—ï¼Ÿ')){ alert('èŠå¤©è®°å½•å·²é‡ç½®'); closeSwipe(id);} }
  function deleteChat(id){ if (confirm('ç¡®å®šè¦åˆ é™¤è¯¥è§’è‰²å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ¢å¤ï¼')){ msgCharacters = msgCharacters.filter(function(c){return c.id!==id}); saveData(); renderChatList(); } }
  function closeSwipe(id){ var item=document.getElementById('item-'+id); if (item) item.style.transform='translateX(0)'; currentSwipedId=null; }

  function showAddModal(){ var m=document.getElementById('msgAddModal'); if (m) m.classList.add('show'); }
  function hideAddModal(){ var m=document.getElementById('msgAddModal'); if (m) m.classList.remove('show'); var f=document.getElementById('msgCharacterForm'); if (f) f.reset(); var up=document.getElementById('msgAvatarUpload'); if (up) up.innerHTML='<span>ğŸ“·</span>'; }
  function previewAvatar(e){ var file=e.target.files[0]; if (!file) return; var reader=new FileReader(); reader.onload=function(ev){ var up=document.getElementById('msgAvatarUpload'); if (up) up.innerHTML='<img src="'+ev.target.result+'">'; }; reader.readAsDataURL(file); }
  function addCharacter(e){ e.preventDefault(); var name=document.getElementById('msgCharacterName').value.trim(); var nickname=(document.getElementById('msgCharacterNickname').value.trim())||name; var bio=document.getElementById('msgCharacterBio').value.trim(); var up=document.getElementById('msgAvatarUpload'); var img=up?up.querySelector('img'):null; var avatar=img?img.src:'ğŸ‘¤'; var newChar={id:String(Date.now()),name:name,nickname:nickname,bio:bio,avatar:avatar,lastTime:new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})}; msgCharacters.push(newChar); saveData(); renderChatList(); hideAddModal(); }
  function goBack(){ if (window.closeApp) window.closeApp(); else if ((document.referrer&&document.referrer.indexOf('index.html')>=0)||history.length>1) history.back(); else location.href='../index.html'; }

  document.addEventListener('DOMContentLoaded', function(){
    initData();
    renderChatList();
    var backBtn=document.getElementById('backBtn'); if (backBtn) backBtn.addEventListener('click', goBack);
    var addBtn=document.getElementById('addBtn'); if (addBtn) addBtn.addEventListener('click', showAddModal);
    var closeModalBtn=document.getElementById('closeModalBtn'); if (closeModalBtn) closeModalBtn.addEventListener('click', hideAddModal);
    var modal=document.getElementById('msgAddModal'); if (modal) modal.addEventListener('click', function(e){ if (e.target.id==='msgAddModal') hideAddModal(); });
    var avatarUpload=document.getElementById('msgAvatarUpload'); var avatarInput=document.getElementById('msgAvatarInput');
    if (avatarUpload && avatarInput){ avatarUpload.addEventListener('click', function(){ avatarInput.click(); }); avatarInput.addEventListener('change', previewAvatar); }
    var form=document.getElementById('msgCharacterForm'); if (form) form.addEventListener('submit', addCharacter);
    Array.prototype.forEach.call(document.querySelectorAll('.msg-tab-item'), function(tab,idx){ if(idx!==0) tab.addEventListener('click', function(){ alert('åŠŸèƒ½å¼€å‘ä¸­'); }); });
  });
  </script>
</body>
</html>
