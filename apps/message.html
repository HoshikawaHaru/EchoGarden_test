<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="rgba(0,0,0,0)">
  <link rel="apple-touch-icon" sizes="512x512" href="../assets/icons/icon512.png">
  <link rel="icon" href="../assets/icons/icon512.png" type="image/png">
  <title>æ¶ˆæ¯</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{--safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px)}
    html,body{width:100%;height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
    .message-app{position:fixed;inset:0;background:#ededed;display:flex;flex-direction:column}

    /* é¡¶æ  */
    .msg-navbar{
      position:relative;
      height:calc(44px + var(--safe-top));
      padding:0 12px; padding-top:var(--safe-top);
      background:#f7f7f7; border-bottom:.5px solid #d9d9d9;
      display:flex; align-items:center; gap:12px;
      flex-shrink:0;
    }
    .msg-navbar-left{ display:flex; align-items:center; gap:8px; z-index:2; }
    .msg-back-btn{ font-size:20px; cursor:pointer; user-select:none; padding:8px; margin:-8px; color:#333; }
    .msg-navbar-icon{ font-size:22px; cursor:pointer; user-select:none; padding:8px; margin:-8px; color:#333; z-index:2; }
    .msg-navbar-center{ flex:1; display:flex; align-items:center; justify-content:center; pointer-events:none; }
    .msg-navbar-title{ font-size:17px; font-weight:600; color:#000; }

    /* èŠå¤©åˆ—è¡¨ */
    .msg-chat-list{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;position:relative;touch-action:pan-y}
    .msg-chat-item-wrapper{position:relative;overflow:hidden}
    .msg-chat-item{background:#fff;padding:12px 16px;display:flex;gap:12px;border-bottom:.5px solid #e5e5e5;cursor:pointer;position:relative;transition:transform .3s ease;z-index:1}
    .msg-chat-item:active{background:#ececec}
    .msg-chat-avatar{width:48px;height:48px;border-radius:6px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0}
    .msg-chat-avatar img{width:100%;height:100%;border-radius:6px;object-fit:cover}
    .msg-chat-content{flex:1;min-width:0}
    .msg-chat-header{display:flex;justify-content:space-between;margin-bottom:4px}
    .msg-chat-name{font-size:16px;font-weight:500;color:#000}
    .msg-chat-time{font-size:12px;color:#999}
    .msg-chat-preview{font-size:14px;color:#999;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    /* Tabbar */
    .msg-tabbar{height:calc(50px + var(--safe-bottom));padding-bottom:var(--safe-bottom);background:#f7f7f7;border-top:.5px solid #d9d9d9;display:flex;flex-shrink:0}
    .msg-tab-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;user-select:none}
    .msg-tab-icon{font-size:24px;margin-bottom:2px}
    .msg-tab-label{font-size:10px;color:#999}
    .msg-tab-item.active .msg-tab-label{color:#07c160}

    /* æ·»åŠ è§’è‰² Modalï¼ˆèŠå¤©Tabï¼‰ */
    .msg-modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:3000}
    .msg-modal.show{display:flex}
    .msg-modal-content{background:#fff;width:90%;max-width:400px;border-radius:12px;overflow:hidden}
    .msg-modal-header{padding:16px;border-bottom:.5px solid #e5e5e5;display:flex;justify-content:space-between;align-items:center}
    .msg-modal-title{font-size:17px;font-weight:600}
    .msg-modal-close{font-size:24px;color:#999;cursor:pointer;padding:4px}
    .msg-modal-body{padding:20px;max-height:60vh;overflow-y:auto}
    .msg-form-group{margin-bottom:20px}
    .msg-form-label{display:block;font-size:14px;color:#666;margin-bottom:8px}
    .msg-form-input{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px}
    .msg-form-textarea{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px;min-height:100px;resize:vertical;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
    .msg-avatar-upload{width:80px;height:80px;border-radius:8px;border:2px dashed #e5e5e5;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden}
    .msg-avatar-upload img{width:100%;height:100%;object-fit:cover}
    .msg-btn-primary{width:100%;padding:12px;background:#07c160;color:#fff;border:none;border-radius:8px;font-size:16px;cursor:pointer}
    .msg-btn-primary:active{background:#06ad56}
    .msg-swipe-actions{position:absolute;right:0;top:0;bottom:0;display:flex;z-index:0}
    .msg-swipe-action{width:75px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px;cursor:pointer;user-select:none}
    .msg-swipe-action.reset{background:#ff9500}
    .msg-swipe-action.delete{background:#ff3b30}

    #debugBox{position:fixed;left:8px;right:8px;bottom:8px;z-index:9999;background:rgba(0,0,0,.8);color:#0f0;padding:8px;border-radius:6px;font-size:11px;max-height:25vh;overflow:auto;font-family:monospace;white-space:pre-wrap;word-break:break-all;display:none}

    /* ===== æˆ‘ï¼ˆèº«ä»½å¡ï¼‰Tabï¼ˆå‚ç›´å±…ä¸­ + ä¸‹æ‹‰å¤šé€‰ + æŒ‡ç¤ºç‚¹ï¼‰ ===== */
    :root{ --bg:#f2f2f7; --card-bg:#fff; --muted:#666; --hair:#ddd; --tint:#1677ff; --ok:#34c759; --warn:#ff3b30; }

/* æˆ‘ï¼ˆèº«ä»½å¡ï¼‰Tabï¼šå‚ç›´å±…ä¸­æ˜¾ç¤º"å¡ç‰‡ + æŒ‡ç¤ºç‚¹"æ•´ä½“ */
#tab-me{
  flex:1;
  min-height:0;
  display:none;
  background:var(--bg);
  position:relative;
}

/* è¿™ä¸ªå®¹å™¨è´Ÿè´£æŠŠ"å¡ç‰‡+æŒ‡ç¤ºç‚¹"æ•´ä½“åœ¨å¯ç”¨ç©ºé—´å†…å‚ç›´å±…ä¸­ */
.id-wrap{
  position:absolute;
  top:50%;
  left:0;
  right:0;
  transform:translateY(-50%);
  display:flex; 
  flex-direction:column; 
  align-items:center;
}

/* æ¨ªå‘èµ°é©¬ç¯ */
.id-carousel{
  flex:0 0 auto;
  width:100%;
  max-width:100%;
  overflow-x:auto; 
  overflow-y:visible;
  scroll-snap-type:x mandatory;
  display:flex; 
  gap:18px; 
  padding:0 clamp(16px, 5vw, 32px);
  align-items:flex-start;
  -webkit-overflow-scrolling:touch;
}

/* å¡ç‰‡ */
.id-card{
  flex:0 0 clamp(320px, 88vw, 680px);
  scroll-snap-align:center;
  background:var(--card-bg); border-radius:16px; padding:16px 16px 18px;
  box-shadow:0 6px 18px rgba(0,0,0,.06);
  display:grid; grid-template-columns:92px 1fr; grid-auto-rows:min-content; gap:12px 16px;
}

/* æŒ‡ç¤ºç‚¹ */
.dots{ height:30px; display:flex; align-items:center; justify-content:center; gap:8px; margin-top:10px; }
.dot{ width:6px; height:6px; border-radius:999px; background:#ddd; transition:all .25s; }
.dot.active{ width:22px; height:6px; border-radius:4px; background:#999; }

    .id-avatar{ width:92px; height:92px; border-radius:14px; background:#eee; overflow:hidden; display:flex; align-items:center; justify-content:center; font-size:44px; cursor:pointer; user-select:none;}
    .id-avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .id-meta{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .id-meta h3{ margin:0 0 4px; font-size:18px; color:#000;}
    .badge{ font-size:11px; padding:2px 6px; border-radius:999px; background:#e8f5e9; color:#0a8f27; border:0.5px solid #bfe8c7; margin-left:6px; }
    .meta-right{ display:flex; gap:6px; align-items:center; }
    .mini{ height:28px; padding:0 10px; border:0; border-radius:8px; background:#efefef; font-size:12px; cursor:pointer; user-select:none;}
    .mini:active{ filter:brightness(.95); }

    .id-field{ grid-column:1 / -1; }
    .label{ font-size:13px; color:#000; margin:4px 0; }
    .input, .textarea{ width:100%; color:#000; background:#fff; border:1px solid #e5e5ea; border-radius:10px; padding:10px 12px; font:inherit; }
    .textarea{ min-height:120px; resize:vertical; }
    .input[readonly], .textarea[readonly]{ background:#f7f7f7; color:#000; }

    .bind-section{ grid-column:1 / -1; }
    .bind-title{ font-size:13px; color:#000; margin:6px 0 8px; }

    /* ä¸‹æ‹‰å¤šé€‰ */
    .bind-combo{ position:relative; display:block; }
    .combo-btn{
      height:36px; padding:0 12px; border:1px solid #e5e5ea; border-radius:10px; background:#fff; font:inherit;
      display:inline-flex; align-items:center; gap:6px;
    }
    .combo-panel{
      position:absolute; left:0; right:0; top:calc(100% + 6px);
      background:#fff; border:1px solid #e5e5ea; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.08);
      padding:8px; max-height:240px; overflow:auto; z-index:20; display:none;
    }
    .combo-panel.show{ display:block; }
    .combo-opt{ display:flex; align-items:center; gap:8px; padding:8px; border-radius:8px; }
    .combo-opt:hover{ background:#f7f7f7; }
    .combo-opt .av{ width:18px;height:18px;border-radius:50%;overflow:hidden;display:inline-flex;align-items:center;justify-content:center;background:#eee;font-size:12px;}
    .combo-opt .av img{ width:100%;height:100%;object-fit:cover;display:block; }
    .combo-opt small{ color:#999; }

    .card-actions{ grid-column:1 / -1; display:flex; gap:10px; margin-top:2px; }
    .btn{ flex:1; height:36px; border:0; border-radius:10px; background:#ededed; }
    .btn.primary{ background:var(--ok); color:#fff; }
    .btn.warn{ background:var(--warn); color:#fff; }
  </style>
</head>
<body>
  <div class="message-app">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="msg-navbar">
      <div class="msg-navbar-left">
        <div class="msg-back-btn" id="backBtn">&lsaquo;</div>
      </div>
      <div class="msg-navbar-center"><div id="topTitle" class="msg-navbar-title">æ¶ˆæ¯</div></div>
      <div class="msg-navbar-icon" id="addBtn" aria-label="æ–°å»º">â•</div>
    </div>

    <!-- èŠå¤©Tab å†…å®¹é¢æ¿ -->
    <div class="msg-chat-list" id="msgChatList"></div>

    <!-- äº‹ä»¶Tab å†…å®¹é¢æ¿ -->
<section id="tab-events" role="tabpanel" aria-label="äº‹ä»¶" style="display:none;overflow:auto;-webkit-overflow-scrolling:touch;">
  <div style="padding:12px">
    <!-- æˆ‘ä»¬çš„çº¦å®š -->
    <h3 style="font-size:15px;color:#111;margin:6px 4px 8px;">æˆ‘ä»¬çš„çº¦å®š</h3>
    <div id="evt-contract-list"></div>
    <button id="evt-add-contract" class="msg-btn-primary" style="margin:10px 0 18px;">æ·»åŠ çº¦å®š</button>

    <!-- æˆ‘çš„è®°äº‹æœ¬ -->
    <h3 style="font-size:15px;color:#111;margin:6px 4px 8px;">æˆ‘çš„è®°äº‹æœ¬</h3>
    <div id="evt-notes-list"></div>
    <button id="evt-add-note" class="msg-btn-primary" style="margin:10px 0 18px;background:#5856d6;">æ·»åŠ è®°äº‹</button>
  </div>

  <!-- äº‹ä»¶è¡¨å• Modal -->
  <div class="msg-modal" id="evtModal">
    <div class="msg-modal-content">
      <div class="msg-modal-header">
        <div class="msg-modal-title">ç¼–è¾‘äº‹ä»¶</div>
        <div class="msg-modal-close" id="evtClose">Ã—</div>
      </div>
      <div class="msg-modal-body">
        <form id="evtForm">
          <input type="hidden" id="evtId" />
          <div class="msg-form-group">
            <label class="msg-form-label">ç±»å‹</label>
            <select class="msg-form-input" id="evtType">
              <option value="contract">æˆ‘ä»¬çš„çº¦å®š</option>
              <option value="note">æˆ‘çš„è®°äº‹æœ¬</option>
            </select>
          </div>

          <div class="msg-form-group">
            <label class="msg-form-label">æˆ‘çš„èº«ä»½ï¼ˆå¯é€‰ï¼‰</label>
            <select class="msg-form-input" id="evtIdentity"></select>
          </div>

          <div class="msg-form-group" id="evtCharGroup">
            <label class="msg-form-label">æ¶‰åŠ/å¯è§è§’è‰²ï¼ˆå¤šé€‰ï¼Œéœ€ä¸ºæ‰€é€‰èº«ä»½ç»‘å®šçš„è§’è‰²ï¼‰</label>
            <div id="evtChars" style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;"></div>
          </div>

          <div class="msg-form-group">
            <label class="msg-form-label">äº‹ä»¶åç§°</label>
            <input class="msg-form-input" id="evtTitle" placeholder="å¦‚ï¼šå‘¨å…­ä¸­åˆé‡é¤ / ç”Ÿæ—¥" required />
          </div>

          <div class="msg-form-group">
            <label class="msg-form-label">äº‹ä»¶é¢‘æ¬¡</label>
            <select class="msg-form-input" id="evtFreq">
              <option value="once">å•æ¬¡</option>
              <option value="year">å¹´åº¦</option>
              <option value="month">æœˆåº¦</option>
              <option value="week">å‘¨åº¦</option>
              <option value="day">æ—¥åº¦</option>
            </select>
          </div>

          <div class="msg-form-group">
            <label class="msg-form-label">æ—¶é—´ï¼ˆå¯é€‰ï¼‰</label>
            <input class="msg-form-input" id="evtTime" type="datetime-local" />
          </div>

          <div class="msg-form-group">
            <label class="msg-form-label">åå°æç¤ºè¯ï¼ˆé€‰å¡«ï¼Œç•™ç©ºç”¨ç³»ç»Ÿé»˜è®¤ï¼‰</label>
            <textarea class="msg-form-textarea" id="evtPrompt" placeholder="å¦‚ï¼šç°åœ¨æ˜¯{title}æ—¶é—´â€¦"></textarea>
          </div>

          <button type="submit" class="msg-btn-primary">ä¿å­˜</button>
        </form>
      </div>
    </div>
  </div>
</section>

    <!-- æˆ‘ï¼ˆèº«ä»½å¡ï¼‰Tab å†…å®¹é¢æ¿ -->
    <section id="tab-me" role="tabpanel" aria-label="æˆ‘çš„èº«ä»½">
      <div class="id-wrap">
        <div class="id-carousel" id="idCarousel" aria-live="polite"></div>
        <div class="dots" id="dots"></div>
      </div>
    </section>

    <!-- åº•éƒ¨Tab -->
    <div class="msg-tabbar">
      <div class="msg-tab-item active"><div class="msg-tab-icon">ğŸ’¬</div><div class="msg-tab-label">èŠå¤©</div></div>
      <div class="msg-tab-item"><div class="msg-tab-icon">ğŸ“…</div><div class="msg-tab-label">äº‹ä»¶</div></div>
      <div class="msg-tab-item"><div class="msg-tab-icon">ğŸŒ</div><div class="msg-tab-label">æœ‹å‹åœˆ</div></div>
      <div class="msg-tab-item"><div class="msg-tab-icon">ğŸ‘¤</div><div class="msg-tab-label">æˆ‘</div></div>
    </div>

    <!-- æ·»åŠ è§’è‰² Modalï¼ˆèŠå¤©Tabç”¨ï¼‰ -->
    <div class="msg-modal" id="msgAddModal">
      <div class="msg-modal-content">
        <div class="msg-modal-header">
          <div class="msg-modal-title">æ·»åŠ è§’è‰²</div>
          <div class="msg-modal-close" id="closeModalBtn">Ã—</div>
        </div>
        <div class="msg-modal-body">
          <form id="msgCharacterForm">
            <div class="msg-form-group">
              <label class="msg-form-label">å¤´åƒ</label>
              <div class="msg-avatar-upload" id="msgAvatarUpload"><span>ğŸ“·</span></div>
              <input type="file" id="msgAvatarInput" accept="image/*" style="display:none">
            </div>
            <div class="msg-form-group">
              <label class="msg-form-label">å§“å</label>
              <input type="text" class="msg-form-input" id="msgCharacterName" placeholder="è¾“å…¥è§’è‰²å§“å" required>
            </div>
            <div class="msg-form-group">
              <label class="msg-form-label">æ˜µç§°</label>
              <input type="text" class="msg-form-input" id="msgCharacterNickname" placeholder="è¾“å…¥è§’è‰²æ˜µç§°">
            </div>
            <div class="msg-form-group">
              <label class="msg-form-label">äººè®¾</label>
              <textarea class="msg-form-textarea" id="msgCharacterBio" placeholder="æè¿°è§’è‰²çš„æ€§æ ¼ã€ç‰¹ç‚¹..." required></textarea>
            </div>
            <button type="submit" class="msg-btn-primary">æ·»åŠ </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div id="debugBox"></div>

  <script>
  (function(){
    'use strict';

    /* ========= è°ƒè¯• ========= */
    var debugBox = document.getElementById('debugBox');
    function log(m){ try{var t=new Date().toTimeString().slice(0,8); (debugBox||{}).innerHTML+=(t+' '+m+'\n'); if(debugBox) debugBox.scrollTop=debugBox.scrollHeight;}catch(e){} }

    /* ========= å°å·¥å…· ========= */
    function esc(s){ return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function attr(s){ return String(s ?? '').replace(/"/g,'&quot;'); }
    function text(s){ return String(s ?? ''); }
    function isImg(s){ return typeof s==='string' && (s.startsWith('data:') || s.startsWith('http')); }
    function fileToDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }

    /* ========= è§’è‰²ä»“åº“ï¼ˆèŠå¤©åˆ—è¡¨ä½¿ç”¨ï¼‰ ========= */
    var STORAGE_KEY='eg_characters_v2';
    var msgCharacters=[]; var touchStartX=0, touchCurrentX=0;

    function notifyCharsUpdated(){ try{ localStorage.setItem('eg_evt_chars', String(Date.now())); }catch(_){} window.dispatchEvent(new CustomEvent('eg:charsUpdated')); }
    function loadChars(){
      try{
        var s=localStorage.getItem(STORAGE_KEY);
        msgCharacters = s?JSON.parse(s):[{kind:'char',id:'nash',name:'Nash',nickname:'Nash',bio:'å¤©çœŸå¼€æœ—çš„å°ç‹ç‹¸',avatar:'ğŸ¦Š',lastTime:'12:00'}];
        if(!s) saveChars();
      }catch(e){ msgCharacters=[]; }
    }
    function saveChars(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(msgCharacters)); }catch(e){} notifyCharsUpdated(); }

    function renderList(){
      var list = document.getElementById('msgChatList'); if(!list) return;
      var listData = msgCharacters.filter(c => c && c.kind !== 'identity');
      if (!listData.length) {
        list.innerHTML = '<div style="padding:20px;text-align:center;color:#999">æš‚æ— è§’è‰²</div>';
        return;
      }
      list.innerHTML = listData.map(c => {
        var av = c.avatar || 'ğŸ‘¤';
        var avatarHTML = (typeof av === 'string' && (av.indexOf('data:') === 0 || av.indexOf('http') === 0))
          ? '<img src="'+ av +'">' : av;

        return /* html */ `
          <div class="msg-chat-item-wrapper">
            <div class="msg-swipe-actions">
              <div class="msg-swipe-action reset" data-id="${c.id}">é‡ç½®</div>
              <div class="msg-swipe-action delete" data-id="${c.id}">åˆ é™¤</div>
            </div>
            <div class="msg-chat-item" data-id="${c.id}">
              <div class="msg-chat-avatar">${avatarHTML}</div>
              <div class="msg-chat-content">
                <div class="msg-chat-header">
                  <div class="msg-chat-name">${esc(c.nickname || c.name)}</div>
                  <div class="msg-chat-time">${esc(c.lastTime || '')}</div>
                </div>
                <div class="msg-chat-preview">${esc(c.lastMsg || c.bio || '')}</div>
              </div>
            </div>
          </div>`;
      }).join('');
      bindChatEvents();
    }

    function bindChatEvents(){
      document.querySelectorAll('.msg-chat-item').forEach(el=>{
        el.addEventListener('click', function(){
          if (Math.abs(touchStartX - touchCurrentX) < 10){
            var id=this.dataset.id||'nash'; sessionStorage.setItem('currentChatId', id);
            if (window.openAppPage) window.openAppPage('message-detail.html?id='+encodeURIComponent(id));
            else location.href='message-detail.html?id='+encodeURIComponent(id);
          }
        });
        el.addEventListener('touchstart',e=>{touchStartX=e.touches[0].clientX; touchCurrentX=touchStartX;});
        el.addEventListener('touchmove',e=>{touchCurrentX=e.touches[0].clientX; var d=touchStartX-touchCurrentX; if(d>0&&d<150){ el.style.transform='translateX(-'+d+'px)'; el.style.transition='none'; }});
        el.addEventListener('touchend',()=>{ var d=touchStartX-touchCurrentX; el.style.transition='transform .3s ease'; el.style.transform=d>75?'translateX(-150px)':'translateX(0)'; });
      });
      document.querySelectorAll('.msg-swipe-action').forEach(btn=>{
        btn.addEventListener('click',e=>{
          e.stopPropagation();
          var id=btn.dataset.id; var del=btn.classList.contains('delete');
          if(del){ if(confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')){ msgCharacters=msgCharacters.filter(c=>c.id!==id); saveChars(); renderList(); } }
          else{ if(confirm('ç¡®å®šé‡ç½®èŠå¤©è®°å½•ï¼Ÿ')) alert('èŠå¤©è®°å½•å·²é‡ç½®'); }
        });
      });
    }

    /* ========= æˆ‘ï¼ˆèº«ä»½å¡ï¼‰â€”â€”äº’æ–¥ç»‘å®š + ä¸‹æ‹‰å¤šé€‰ + å³æ—¶ä¿å­˜ ========= */
    (function(){
      const LS_ID='eg_user_identities_v1', LS_CHAR='eg_characters_v2';
      const $=s=>document.querySelector(s); const idCarousel=$('#idCarousel'); const dots=$('#dots');

      function load(k){ try{ return JSON.parse(localStorage.getItem(k)||''); }catch(e){ return null; } }
      function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
      function uid(){ return 'u_' + Math.random().toString(36).slice(2,8) + Date.now().toString(36).slice(-4); }
      function broadcast(){ window.dispatchEvent(new CustomEvent('eg:identitiesUpdated')); localStorage.setItem('eg_evt_ping', String(Date.now())); }

      let identities=load(LS_ID)||[];
      let chars=load(LS_CHAR)||[];
      let editingId = null;   // è®°å½•ç¼–è¾‘ä¸­çš„å¡ç‰‡ï¼Œé‡æ¸²æŸ“åä¿æŒç¼–è¾‘æ€

      if(!Array.isArray(identities)||identities.length===0){
        identities=[{kind:'identity',id:uid(),name:'User',nickname:'æˆ‘',avatar:'ğŸ‘¤',bio:'',boundCharIds:[]}];
        save(LS_ID,identities);
      }

      function ownerOf(charId){
        for(const idt of identities){ if(idt.boundCharIds && idt.boundCharIds.includes(charId)) return idt.id; }
        return identities[0]?.id;
      }

      function refreshBindings(){
        if(!identities.length) return;
        const def=identities[0];
        const allCharIds=(chars||[]).map(c=>c.id);
        const taken=new Set();
        identities.slice(1).forEach(u=>(u.boundCharIds||[]).forEach(cid=>taken.add(cid)));
        def.boundCharIds = allCharIds.filter(cid=>!taken.has(cid));
        save(LS_ID,identities);
      }

      refreshBindings(); render();

      // å¯¼å‡º/å¯¼å…¥
      async function copyText(t){ try{ await navigator.clipboard.writeText(t); return true; }catch(_){ return false; } }
      function isIOS(){ return /iP(hone|ad|od)/.test(navigator.userAgent); }
      async function doExport(){
        const json=JSON.stringify(identities,null,2);
        if(isIOS()){ if(navigator.share){ try{ await navigator.share({title:'eg_user_identities.json', text:json}); return; }catch(_){}} const ok=await copyText(json); alert(ok?'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ˆiOS æ— æ³•ç›´æ¥ä¸‹è½½ï¼‰':'å¤åˆ¶å¤±è´¥'); return; }
        const blob=new Blob([json],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='eg_user_identities.json'; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},1000);
      }
      function doImport(){
        const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
        inp.onchange=async()=>{ const f=inp.files[0]; if(!f) return; try{ const txt=await f.text(); const arr=JSON.parse(txt);
            if(Array.isArray(arr)){ identities=arr.map(n=>({kind:'identity',id:n.id||uid(),name:n.name||'',nickname:n.nickname||'',bio:n.bio||'',avatar:n.avatar||'ğŸ‘¤',boundCharIds:Array.isArray(n.boundCharIds)?n.boundCharIds:[] })); save(LS_ID,identities); refreshBindings(); render(); broadcast(); }
          }catch(e){ alert('å¯¼å…¥å¤±è´¥ï¼šJSON æ ¼å¼é”™è¯¯'); } };
        inp.click();
      }

      // å³ä¸Šè§’â€œï¼‹â€ â†’ æ–°å»ºèº«ä»½å¹¶è¿›å…¥ç¼–è¾‘
      window.openIdentityEditor=function(){
        const u={kind:'identity',id:uid(),name:'',nickname:'',avatar:'ğŸ‘¤',bio:'',boundCharIds:[]};
        identities.push(u); save(LS_ID,identities); refreshBindings(); render(); setTimeout(()=> setCardEditing(u.id,true),0);
      };

      function writeField(uid, key, val){
        const u = identities.find(x => x.id === uid);
        if (!u) return;
        u[key] = val;
        save(LS_ID, identities);   // ç«‹åˆ»è½ç›˜ï¼Œé˜²æ­¢ render ä¸¢å¤±
      }

      function render(){
        if(!idCarousel) return;
        idCarousel.innerHTML = identities.map(renderCard).join('');
        dots.innerHTML = identities.map((_,i)=>`<div class="dot ${i===0?'active':''}"></div>`).join('');
        bindCardEvents();
        idCarousel.addEventListener('scroll', onScrollSnap, {passive:true});
        onScrollSnap(); // åˆå§‹åŒ–ä¸€æ¬¡
        // ä¿æŒç¼–è¾‘æ€
        if (editingId) setCardEditing(editingId, true);
      }

      function renderCard(u){
        const isDefault = identities[0] && identities[0].id===u.id;
        const avHTML = isImg(u.avatar) ? `<img src="${u.avatar}">` : esc(u.avatar || 'ğŸ‘¤');

        const boundCount = (Array.isArray(chars)?chars:[]).filter(c => ownerOf(c.id) === u.id).length;
        const options = (Array.isArray(chars)?chars:[]).map(c=>{
          const ownerId = ownerOf(c.id);
          const active  = ownerId === u.id;
          const face = isImg(c.avatar)?`<img src="${c.avatar}">`:esc(c.avatar||'ğŸ‘¤');
          const ownerName = (ownerId && identities.find(x=>x.id===ownerId))?.nickname || '';
          return `
            <label class="combo-opt" data-char="${c.id}">
              <input type="checkbox" ${active?'checked':''}>
              <span class="av">${face}</span>
              <span>${esc(c.nickname||c.name||c.id)}${active?'':(' <small>ï¼ˆå½’å±ï¼š'+esc(ownerName||'é»˜è®¤')+'ï¼‰</small>')}</span>
            </label>`;
        }).join('');

        return /* html */ `
        <article class="id-card" data-id="${u.id}">
          <div class="id-avatar">${avHTML}</div>
          <div class="id-meta">
            <div>
              <h3>${esc(u.nickname||u.name||'æœªå‘½å')}${isDefault?'<span class="badge">é»˜è®¤</span>':''}</h3>
              <div class="nick" style="font-size:12px;color:#666">${esc(u.name||'')}</div>
            </div>
            <div class="meta-right">
              <button class="mini" data-act="import">å¯¼å…¥</button>
              <button class="mini" data-act="export">å¯¼å‡º</button>
            </div>
          </div>

          <div class="id-field">
            <div class="label">å§“å</div>
            <input class="input" data-k="name" value="${attr(u.name)}" readonly>
          </div>
          <div class="id-field">
            <div class="label">æ˜µç§°</div>
            <input class="input" data-k="nickname" value="${attr(u.nickname)}" readonly>
          </div>
          <div class="id-field">
            <div class="label">è®¾å®š</div>
            <textarea class="textarea" data-k="bio" readonly>${text(u.bio)}</textarea>
          </div>

          <div class="bind-section">
            <div class="bind-title">ç»‘å®šçš„è§’è‰²ï¼ˆäº’æ–¥ï¼šä¸€ä¸ªè§’è‰²ä¸èƒ½ç»‘å®šå¤šä¸ªèº«ä»½ï¼‰</div>
            <div class="bind-combo" data-id="${u.id}">
              <button class="combo-btn" type="button">${boundCount} ä¸ªè§’è‰²å·²ç»‘å®š â–¾</button>
              <div class="combo-panel">${options || 'ï¼ˆæš‚æ— è§’è‰²ï¼Œå¯åœ¨â€œæ¶ˆæ¯â€é¡µæ·»åŠ ï¼‰'}</div>
            </div>
          </div>

          <div class="card-actions">
            <button class="btn" data-act="edit">ç¼–è¾‘</button>
            <button class="btn primary" data-act="save" disabled>ä¿å­˜</button>
            <button class="btn warn" data-act="remove"${isDefault?' disabled':''}>åˆ é™¤</button>
          </div>
        </article>`;
      }

      function setCardEditing(id,on){
        const card=idCarousel.querySelector(`.id-card[data-id="${id}"]`); if(!card) return;
        card.querySelectorAll('.input,.textarea').forEach(el=>{ el.readOnly=!on; });
        const saveBtn=card.querySelector('[data-act="save"]'); const editBtn=card.querySelector('[data-act="edit"]');
        if(saveBtn) saveBtn.disabled=!on; if(editBtn) editBtn.disabled=on;
        editingId = on ? id : null;
      }

      function bindCardEvents(){
        // ä¸‹æ‹‰å¼€åˆ
        idCarousel.querySelectorAll('.bind-combo .combo-btn').forEach(btn=>{
          btn.addEventListener('click', (e)=>{
            e.stopPropagation();
            const panel = btn.nextElementSibling;
            idCarousel.querySelectorAll('.combo-panel.show').forEach(p=>{ if(p!==panel) p.classList.remove('show'); });
            panel.classList.toggle('show');
          });
        });
        document.addEventListener('click', ()=>{ idCarousel.querySelectorAll('.combo-panel.show').forEach(p=>p.classList.remove('show')); });

        // äº’æ–¥å¤é€‰
        idCarousel.querySelectorAll('.combo-panel .combo-opt input[type="checkbox"]').forEach(chk=>{
          chk.addEventListener('change', (e)=>{
            const opt = e.target.closest('.combo-opt');
            const card = e.target.closest('.id-card');
            const targetId = card.dataset.id;
            const charId = opt.dataset.char;
            const defId = identities[0].id;
            const curOwner = ownerOf(charId);

            if (e.target.checked){
              if (curOwner && curOwner !== defId && curOwner !== targetId){
                const owner = identities.find(x=>x.id===curOwner);
                const name = owner?.nickname || owner?.name || 'è¯¥èº«ä»½';
                if (!confirm(`æ­¤è§’è‰²ç»‘å®šäº† ${name} èº«ä»½ï¼Œæ˜¯å¦åˆ‡æ¢ç»‘å®šï¼Ÿ`)){
                  e.target.checked = false; return;
                }
                owner.boundCharIds = (owner.boundCharIds||[]).filter(id=>id!==charId);
              }
              if (targetId !== defId){
                const tar = identities.find(x=>x.id===targetId);
                tar.boundCharIds = tar.boundCharIds || [];
                if (!tar.boundCharIds.includes(charId)) tar.boundCharIds.push(charId);
              }
            }else{
              if (targetId !== defId){
                const tar = identities.find(x=>x.id===targetId);
                tar.boundCharIds = (tar.boundCharIds||[]).filter(id=>id!==charId);
              }else{
                e.target.checked = true; return;
              }
            }

            save(LS_ID,identities);
            refreshBindings();
            render();            // å³æ—¶åˆ·æ–°ï¼ˆä¿æŒç¼–è¾‘/å­—æ®µä¸ä¸¢ï¼‰
            broadcast();
          });
        });

        // å¡ç‰‡æŒ‰é’® & å­—æ®µå³æ—¶ä¿å­˜
        idCarousel.querySelectorAll('.id-card').forEach(card=>{
          const uid=card.dataset.id;

          // è¿›å…¥ç¼–è¾‘
          card.querySelector('[data-act="edit"]').addEventListener('click', ()=> setCardEditing(uid,true));

          // ä¿å­˜ â€”â€” å…ˆé”å®šç½®ç°ï¼Œå†å­˜å‚¨ä¸é‡æ¸²æŸ“ï¼ˆå…³é”®ä¿®å¤ï¼‰
          card.querySelector('[data-act="save"]').addEventListener('click', ()=>{
            const u=identities.find(x=>x.id===uid);
            u.name=card.querySelector('[data-k="name"]').value.trim();
            u.nickname=card.querySelector('[data-k="nickname"]').value.trim();
            u.bio=card.querySelector('[data-k="bio"]').value.trim();

            // ç«‹åˆ»é”å®šå½“å‰å¡ï¼ˆåªè¯» & æŒ‰é’®çŠ¶æ€ï¼‰
            setCardEditing(uid, false);
            editingId = null;

            save(LS_ID,identities);
            render();
            broadcast();
          });

          // åˆ é™¤
          const rm=card.querySelector('[data-act="remove"]');
          rm && rm.addEventListener('click', ()=>{
            if (identities[0] && identities[0].id===uid){ alert('é»˜è®¤èº«ä»½å¡ä¸å¯åˆ é™¤'); return; }
            if (!confirm('ç¡®è®¤åˆ é™¤è¯¥èº«ä»½å¡ï¼Ÿ')) return;
            identities=identities.filter(x=>x.id!==uid); save(LS_ID,identities); refreshBindings(); render(); broadcast();
          });

          // å¯¼å…¥/å¯¼å‡º
          card.querySelector('[data-act="import"]').addEventListener('click', doImport);
          card.querySelector('[data-act="export"]').addEventListener('click', doExport);

          // å¤´åƒï¼ˆä»…ç¼–è¾‘æ€å¯æ”¹ï¼›å³æ—¶ä¿å­˜ï¼‰
          card.querySelector('.id-avatar').addEventListener('click', ()=>{
            const editable = !card.querySelector('.input').readOnly; if(!editable) return;
            const inp=document.createElement('input'); inp.type='file'; inp.accept='image/*';
            inp.onchange=async()=>{ const f=inp.files[0]; if(!f) return; const b64=await fileToDataURL(f);
              writeField(uid, 'avatar', b64); render(); broadcast();
            };
            inp.click();
          });

          // è¾“å…¥æ¡†/æ–‡æœ¬æ¡†ï¼šå³æ—¶ä¿å­˜ï¼Œé˜²æ­¢ç»‘å®šæ—¶ä¸¢å¤±
          card.querySelectorAll('[data-k]').forEach(el=>{
            el.addEventListener('input', ()=>{
              writeField(uid, el.getAttribute('data-k'), el.value);
              const saveBtn=card.querySelector('[data-act="save"]'); if(saveBtn) saveBtn.disabled=false;
            });
          });
        });
      }

      /* æŒ‡ç¤ºç‚¹ï¼šä»¥â€œè§†å£ä¸­å¿ƒæœ€è¿‘çš„å¡ç‰‡â€ä¸ºå½“å‰ */
      function computeActiveIndex(){
        const cards = Array.from(idCarousel.querySelectorAll('.id-card'));
        if (!cards.length) return 0;
        const viewportCenter = idCarousel.scrollLeft + idCarousel.clientWidth / 2;
        let minDist = Infinity, active = 0;
        cards.forEach((card, idx) => {
          const center = card.offsetLeft + card.offsetWidth/2;
          const d = Math.abs(center - viewportCenter);
          if (d < minDist) { minDist = d; active = idx; }
        });
        return active;
      }
      function onScrollSnap(){
        const active = computeActiveIndex();
        const all = dots.querySelectorAll('.dot');
        all.forEach((d,i)=>d.classList.toggle('active', i===active));
      }

      // åŒæ­¥è§’è‰²å˜åŒ–
      function syncChars(){ chars = JSON.parse(localStorage.getItem(LS_CHAR) || '[]'); refreshBindings(); render(); }
      window.addEventListener('eg:charsUpdated', syncChars);
      window.addEventListener('storage', e=>{ if(e.key==='eg_evt_chars') syncChars(); });
    })();

    /* ========= é¡¶æ æ ‡é¢˜ / Tab åˆ‡æ¢ / ï¼‹æŒ‰é’® ========= */
    var EG_CURRENT_TAB='chat';
    function setTopTitle(t){ var el=document.getElementById('topTitle'); if(el) el.textContent=t; }
    function updateAddButtonForTab(){
      var addBtn=document.getElementById('addBtn'); if(!addBtn) return;
      var map={chat:'æ–°å»ºè§’è‰²', me:'æ–°å»ºèº«ä»½', moments:'å‘åŠ¨æ€', events:'æ·»åŠ äº‹ä»¶'};
      addBtn.setAttribute('aria-label', map[EG_CURRENT_TAB]||'æ–°å»º');
    }
function initTabs(){
  const items=document.querySelectorAll('.msg-tab-item');
  const viewChat=document.getElementById('msgChatList');
  const viewEvents=document.getElementById('tab-events');   // â˜…
  const viewMe=document.getElementById('tab-me');

  function show(name){
    EG_CURRENT_TAB=name;
    if(viewChat)   viewChat.style.display   =(name==='chat')   ?'block':'none';
    if(viewEvents) viewEvents.style.display =(name==='events') ?'block':'none';   // â˜…
    if(viewMe)     viewMe.style.display     =(name==='me')     ?'block':'none';
    setTopTitle(name==='me' ? 'æˆ‘çš„èº«ä»½å¡' : (name==='events'?'äº‹ä»¶':'æ¶ˆæ¯'));
    updateAddButtonForTab();
    items.forEach(el=>el.classList.remove('active'));
    if(name==='chat')   items[0]?.classList.add('active');
    if(name==='events') items[1]?.classList.add('active');    // â˜…
    if(name==='me')     items[3]?.classList.add('active');
  }
  items[0]?.addEventListener('click', ()=>show('chat'));
  items[1]?.addEventListener('click', ()=>show('events'));     // â˜…
  items[2]?.addEventListener('click', ()=>alert('æœ‹å‹åœˆï¼šå¼€å‘ä¸­'));
  items[3]?.addEventListener('click', ()=>show('me'));
  show('chat');
  window.EGTab=Object.assign(window.EGTab||{},{show});
}
function updateAddButtonForTab(){
  var addBtn=document.getElementById('addBtn'); if(!addBtn) return;
  var map={chat:'æ–°å»ºè§’è‰²', events:'æ·»åŠ äº‹ä»¶', me:'æ–°å»ºèº«ä»½', moments:'å‘åŠ¨æ€'};
  addBtn.setAttribute('aria-label', map[EG_CURRENT_TAB]||'æ–°å»º');
}
function onGlobalAdd(){
  switch(EG_CURRENT_TAB){
    case 'chat':    showModal(); break;
    case 'events':  window.EGEvents?.openEditor(); break;      // â˜…
    case 'me':      window.openIdentityEditor?.(); break;
    default:        showModal();
  }
}
    /* ================= äº‹ä»¶å¼•æ“ï¼ˆæˆ‘ä»¬çš„çº¦å®š/æˆ‘çš„è®°äº‹æœ¬ï¼‰ ================= */
(function(){
  const LS_EVT='eg_events_v1';
  const LS_ID='eg_user_identities_v1';
  const LS_CHAR='eg_characters_v2';

  function load(k,df){ try{ const t=localStorage.getItem(k); return t?JSON.parse(t):df; }catch(e){ return df; } }
  function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  function uid(){ return 'e_' + Math.random().toString(36).slice(2,8) + Date.now().toString(36).slice(-4); }
  const now = ()=> new Date();

  // è®¡ç®—ä¸‹æ¬¡å‘ç”Ÿæ—¶é—´ï¼ˆæ”¯æŒ once/year/month/week/dayï¼›è‹¥æœªå¡«æ—¶é—´ï¼Œè¿”å› nullï¼‰
  function nextOccurrence(e){
    if(!e.datetimeISO) return null;
    const base = e.lastFiredAtISO ? new Date(e.lastFiredAtISO) : new Date(e.datetimeISO);
    const ref  = e.lastFiredAtISO ? new Date(e.datetimeISO) : new Date(); // é¦–æ¬¡åŸºäºç›®æ ‡ vs ä¹‹ååŸºäº now é€’å¢
    let dt = new Date(e.datetimeISO);
    while(dt < now()){
      if(e.frequency==='once') break;
      if(e.frequency==='year')  dt.setFullYear(dt.getFullYear()+1);
      else if(e.frequency==='month') dt.setMonth(dt.getMonth()+1);
      else if(e.frequency==='week')  dt.setDate(dt.getDate()+7);
      else if(e.frequency==='day')   dt.setDate(dt.getDate()+1);
      else break;
    }
    if(e.frequency==='once' && dt < now()) return null; // è¿‡æœŸ
    return dt;
  }
  function fmtCountdown(dt){
    if(!dt) return 'â€”â€”';
    const ms = dt - now(); if(ms<=0) return 'è¿›è¡Œä¸­';
    const d = Math.floor(ms/86400000);
    const h = Math.floor((ms%86400000)/3600000);
    const m = Math.floor((ms%3600000)/60000);
    return (d?`${d}å¤©`:'') + (h?`${h}å°æ—¶`:'') + (d||h?``:`${m}åˆ†é’Ÿ`);
  }

  // æ¸²æŸ“
  const elC = document.getElementById('evt-contract-list');
  const elN = document.getElementById('evt-notes-list');
  function render(){
    const events = load(LS_EVT,[]);
    const ids = load(LS_ID,[]);
    const chars = load(LS_CHAR,[]);
    const idMap = Object.fromEntries(ids.map(x=>[x.id, x]));
    const chMap = Object.fromEntries(chars.map(x=>[x.id, x]));

    function card(e){
      const next = nextOccurrence(e);
      const participants = (e.participants||[]).map(id=>chMap[id]?.nickname||chMap[id]?.name||id).join('ã€') || 'â€”';
      const idName = e.identityId ? (idMap[e.identityId]?.nickname||idMap[e.identityId]?.name||'æˆ‘') : 'æˆ‘';
      return `
        <div style="background:#fff;border:1px solid #eee;border-radius:12px;padding:12px;margin:8px 0;box-shadow:0 1px 0 rgba(0,0,0,.05)">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div style="font-weight:600;color:#000">${e.title||'(æœªå‘½å)'} <small style="color:#666">Â· ${idName}</small></div>
            <div>
              <button data-act="edit" data-id="${e.id}" class="mini">ç¼–è¾‘</button>
              <button data-act="del"  data-id="${e.id}" class="mini" style="background:#ff3b30;color:#fff">åˆ é™¤</button>
            </div>
          </div>
          <div style="font-size:12px;color:#666;margin-top:6px">è§’è‰²ï¼š${participants}</div>
          <div style="font-size:12px;color:#666;margin-top:4px">é¢‘æ¬¡ï¼š${({'once':'å•æ¬¡','year':'å¹´åº¦','month':'æœˆåº¦','week':'å‘¨åº¦','day':'æ—¥åº¦'})[e.frequency]||'â€”'}</div>
          <div style="font-size:12px;color:#666;margin-top:4px">æ—¶é—´ï¼š${e.datetimeISO?new Date(e.datetimeISO).toLocaleString():'æœªå¡«å†™'}</div>
          <div style="font-size:13px;color:#111;margin-top:8px">è·ç¦»äº‹ä»¶è¿˜æœ‰ï¼š<b>${fmtCountdown(next)}</b></div>
        </div>`;
    }

    const C = events.filter(x=>x.type==='contract').sort((a,b)=>(nextOccurrence(a)||1e15)-(nextOccurrence(b)||1e15));
    const N = events.filter(x=>x.type==='note').sort((a,b)=>(nextOccurrence(a)||1e15)-(nextOccurrence(b)||1e15));
    if(elC) elC.innerHTML = C.length? C.map(card).join('') : '<div style="color:#999;padding:12px">æš‚æ— çº¦å®š</div>';
    if(elN) elN.innerHTML = N.length? N.map(card).join('') : '<div style="color:#999;padding:12px">æš‚æ— è®°äº‹</div>';

    (elC||document).querySelectorAll('[data-act="edit"],[data-act="del"]').forEach(btn=>btn.addEventListener('click', onCardBtn));
    (elN||document).querySelectorAll('[data-act="edit"],[data-act="del"]').forEach(btn=>btn.addEventListener('click', onCardBtn));
  }

  function onCardBtn(e){
    const id = e.currentTarget.dataset.id;
    if(e.currentTarget.dataset.act==='del'){
      if(confirm('åˆ é™¤è¯¥äº‹ä»¶ï¼Ÿ')){
        const arr=load(LS_EVT,[]).filter(x=>x.id!==id); save(LS_EVT,arr); render();
      }
    }else{
      openEditor(id);
    }
  }

  // ç¼–è¾‘å™¨
  const modal=document.getElementById('evtModal');
  const form=document.getElementById('evtForm');
  const closeBtn=document.getElementById('evtClose');
  const addC=document.getElementById('evt-add-contract');
  const addN=document.getElementById('evt-add-note');

  function fillIdentityAndChars(identityId, participants){
    const ids = load(LS_ID,[]); const chars = load(LS_CHAR,[]);
    // èº«ä»½ä¸‹æ‹‰
    const sel=document.getElementById('evtIdentity');
    sel.innerHTML = '<option value="">ï¼ˆä¸æŒ‡å®šï¼‰</option>' + ids.map(u=>`<option value="${u.id}">${u.nickname||u.name||'æˆ‘'}</option>`).join('');
    if(identityId) sel.value = identityId;
    // è§’è‰²ï¼ˆåªå±•ç¤ºè¯¥èº«ä»½ç»‘å®šçš„ï¼‰
    const targetId = sel.value || ids[0]?.id;
    const bound = (ids.find(u=>u.id===targetId)?.boundCharIds)||[];
    const box=document.getElementById('evtChars');
    box.innerHTML = bound.map(cid=>{
      const c = chars.find(x=>x.id===cid); const name = c?.nickname||c?.name||cid;
      const checked = participants && participants.includes(cid) ? 'checked' : '';
      return `<label style="display:flex;gap:6px;align-items:center;background:#f7f7f7;border:1px solid #eee;border-radius:8px;padding:8px;">
        <input type="checkbox" value="${cid}" ${checked}/>
        <span>${name}</span>
      </label>`;
    }).join('') || '<div style="color:#999">è¯¥èº«ä»½æš‚æœªç»‘å®šè§’è‰²</div>';
    sel.onchange = ()=> fillIdentityAndChars(sel.value, collectChecked());
  }
  function collectChecked(){
    return Array.from(document.querySelectorAll('#evtChars input[type=checkbox]:checked')).map(x=>x.value);
  }

  function openEditor(id){
    const all=load(LS_EVT,[]); const one=all.find(x=>x.id===id)||{id:uid(),type:'contract',title:'',frequency:'once',datetimeISO:'',participants:[],identityId:'',promptTemplate:''};
    document.getElementById('evtId').value=one.id;
    document.getElementById('evtType').value=one.type||'contract';
    document.getElementById('evtTitle').value=one.title||'';
    document.getElementById('evtFreq').value=one.frequency||'once';
    document.getElementById('evtTime').value= one.datetimeISO ? new Date(one.datetimeISO).toISOString().slice(0,16) : '';
    document.getElementById('evtPrompt').value=one.promptTemplate||'';
    fillIdentityAndChars(one.identityId, one.participants);
    document.getElementById('evtIdentity').value = one.identityId||'';
    modal.classList.add('show');
  }
  function closeEditor(){ modal.classList.remove('show'); }
  closeBtn?.addEventListener('click', closeEditor);
  modal?.addEventListener('click', e=>{ if(e.target===modal) closeEditor(); });
  addC?.addEventListener('click', ()=>openEditor());
  addN?.addEventListener('click', ()=>{ openEditor(); document.getElementById('evtType').value='note'; });

  form?.addEventListener('submit', e=>{
    e.preventDefault();
    const id = document.getElementById('evtId').value || uid();
    const obj = {
      id,
      type: document.getElementById('evtType').value,
      title: document.getElementById('evtTitle').value.trim(),
      frequency: document.getElementById('evtFreq').value,
      datetimeISO: (document.getElementById('evtTime').value || '') ? new Date(document.getElementById('evtTime').value).toISOString() : '',
      identityId: document.getElementById('evtIdentity').value || '',
      participants: collectChecked(),
      promptTemplate: document.getElementById('evtPrompt').value.trim(),
      lastFiredAtISO: ''
    };
    if(!obj.title){ alert('è¯·å¡«å†™äº‹ä»¶åç§°'); return; }
    const arr=load(LS_EVT,[]);
    const i=arr.findIndex(x=>x.id===id);
    if(i>=0) arr[i]=Object.assign(arr[i], obj); else arr.push(obj);
    save(LS_EVT,arr); closeEditor(); render();
  });

  // ===== è§¦å‘å™¨ï¼šå‰å°å®šæ—¶ + ç¦»çº¿è¡¥å¿ =====
  function buildDefaultPrompt(e, charName, identityName){
    // contract / note çš„ä¸¤ç§é»˜è®¤æç¤º
    if(e.type==='contract'){
      return `ç°åœ¨æ˜¯ã€Œ${e.title}ã€çš„çº¦å®šæ—¶é—´ã€‚è¯·ä»¥${charName}çš„è¯­æ°”ï¼Œç»™${identityName}å‘ä¸€æ®µè‡ªç„¶ã€ä¸è¶…è¿‡3å¥çš„é—®å€™æˆ–è¡ŒåŠ¨æè¿°ã€‚`;
    }else{
      return `${identityName}ä»Šå¤©æœ‰ã€Œ${e.title}ã€ã€‚è¯·ä»¥${charName}çš„è¯­æ°”ï¼Œç»™${identityName}å‘ä¸€æ®µè‡ªç„¶ã€ä¸è¶…è¿‡3å¥çš„å…³å¿ƒã€‚`;
    }
  }
  async function fireEvent(e){
    const ids = load(LS_ID,[]); const chars = load(LS_CHAR,[]);
    const identity = e.identityId ? ids.find(x=>x.id===e.identityId) : ids[0];
    const identityName = identity?.nickname||identity?.name||'ç”¨æˆ·';
    const list = (e.participants||[]).map(cid=>chars.find(c=>c.id===cid)).filter(Boolean);

    // åªå¯¹å¼€å¯â€œåå°æ´»åŠ¨â€çš„è§’è‰²è§¦å‘
    const targets = list.filter(c => !!c?.backgroundOn);

    for(const ch of targets){
      const prompt = e.promptTemplate || buildDefaultPrompt(e, (ch.nickname||ch.name||'Ta'), identityName);
      await sendEventPromptToThread(ch.id, identity, prompt, e); // å†™å…¥å¯¹åº”ä¼šè¯
    }

    // æ ‡è®°å·²è§¦å‘
    const arr=load(LS_EVT,[]);
    const i=arr.findIndex(x=>x.id===e.id);
    if(i>=0){
      arr[i].lastFiredAtISO = new Date().toISOString();
      // å•æ¬¡ï¼šè§¦å‘åè‡ªåŠ¨æ¸…ç†ï¼ˆä¹Ÿå¯æ”¹ä¸ºéšè—ï¼‰
      if(arr[i].frequency==='once') {
        // ä¸ç›´æ¥åˆ ï¼Œä¿ç•™è®°å½•åˆ°ä¸‹ä¸€æ¬¡ render æ—¶è‡ªç„¶æ˜¾ç¤ºâ€œè¿‡æœŸâ€ï¼›å¦‚éœ€åˆ ï¼šarr.splice(i,1);
      }
      save(LS_EVT,arr);
    }
  }

  async function sendEventPromptToThread(charId, identity, userText, e){
    // æŠŠâ€œäº‹ä»¶æ—¶é—´â€å†™è¿› tsï¼Œå¹¶åœ¨ ChatList é‡Œæ›´æ–°æ—¶é—´æ˜¾ç¤º
    const threads = load('eg_threads_v1', {});
    const mine = threads[charId] || (threads[charId] = { id:charId, messages:[] });
    // è¿™é‡Œç›´æ¥è§¦å‘ä¸€è½® LLMï¼šç³»ç»Ÿäººè®¾æ¥è‡ª message-detail çš„ askLLM é€»è¾‘ï¼Œ
    // ä½†åœ¨å½“å‰é¡µæˆ‘ä»¬åªâ€œæ³¨å…¥ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯â€ï¼Œéšåç”±èŠå¤©é¡µè‡ªç„¶ç”Ÿæˆï¼›ä¸ºäº†å³æ—¶æ•ˆæœï¼Œè¿™é‡Œç›´æ¥åˆæˆä¸€æ¡â€œç”¨æˆ·æ¶ˆæ¯ + è§¦å‘ askLLMâ€çš„ç®€ç‰ˆï¼š
    const pseudoUser = `${userText}`;
    mine.messages.push({ role:'user', content:pseudoUser, ts: e.datetimeISO ? new Date(e.datetimeISO).getTime() : Date.now() });
    save('eg_threads_v1', threads);

    try{
      const list = load(LS_CHAR,[]);
      const it = list.find(c => c.id === charId);
      if (it){ it.lastTime = new Date(e.datetimeISO || Date.now()).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}); save(LS_CHAR,list); }
    }catch(_){}

    // å‘ä¸€ä¸ªâ€œè½»è§¦å‘â€ä¿¡å·ç»™èŠå¤©é¡µï¼ˆå®ƒä¼šåœ¨æ‰“å¼€æ—¶æˆ–å‰å°æ—¶æ‹‰å–å¹¶ç»§ç»­ askLLMï¼‰
    try{ localStorage.setItem('eg_evt_ping', String(Date.now())); }catch(_){}
  }

  function tick(){
    const arr = load(LS_EVT,[]);
    for(const e of arr){
      const next = nextOccurrence(e);
      if(!next) continue;
      // è§¦å‘çª—å£ï¼šÂ±60ç§’å†…
      const diff = Math.abs(next - now());
      if(diff <= 60000){
        // æœªè§¦å‘è¿‡ï¼Œæˆ–ä¸‹ä¸€è½®å·²åˆ°è¾¾çª—å£
        if(!e.lastFiredAtISO || new Date(e.lastFiredAtISO) < next) fireEvent(e);
      }
    }
    render(); // åˆ·æ–°å€’è®¡æ—¶
  }

  // åˆå§‹åŒ–
  render();
  // ç¦»çº¿è¡¥å¿ï¼šè¿›å…¥é¡µé¢å…ˆ tick ä¸€æ¬¡
  tick();
  // å‰å°æ¯ 30s åˆ·æ–°/è§¦å‘
  setInterval(tick, 30000);

  // æš´éœ²ç»™â€œï¼‹â€æŒ‰é’®
  window.EGEvents = { openEditor };
})();

    /* ========= æ¨¡æ€æ¡†ä¸åˆå§‹åŒ– ========= */
    function showModal(){ document.getElementById('msgAddModal')?.classList.add('show'); }
    function init(){
      // è¿”å›æŒ‰é’®
      document.getElementById('backBtn')?.addEventListener('click', ()=>{ if(window.closeApp) window.closeApp(); else if(history.length>1) history.back(); else location.href='../index.html'; });

      // è§’è‰²æ•°æ®&æ¸²æŸ“
      loadChars(); renderList();

      // è§’è‰²æ·»åŠ å¼¹æ¡†
      document.getElementById('closeModalBtn')?.addEventListener('click', ()=>document.getElementById('msgAddModal').classList.remove('show'));
      document.getElementById('msgAddModal')?.addEventListener('click', e=>{ if(e.target.id==='msgAddModal') e.currentTarget.classList.remove('show'); });
      var up=document.getElementById('msgAvatarUpload'), inp=document.getElementById('msgAvatarInput');
      if(up&&inp){ up.addEventListener('click',()=>inp.click()); inp.addEventListener('change',e=>{ var f=e.target.files[0]; if(!f) return; var r=new FileReader(); r.onload=ev=>{ up.innerHTML='<img src="'+ev.target.result+'">'; }; r.readAsDataURL(f); }); }
      var form=document.getElementById('msgCharacterForm');
      if(form){
        form.addEventListener('submit',e=>{
          e.preventDefault();
          var name=document.getElementById('msgCharacterName').value.trim();
          var nickname=document.getElementById('msgCharacterNickname').value.trim()||name;
          var bio=document.getElementById('msgCharacterBio').value.trim();
          var img=up?up.querySelector('img'):null; var avatar=img?img.src:'ğŸ‘¤';
          var newChar={kind:'char', id:String(Date.now()), name, nickname, bio, avatar, lastTime:new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})};
          msgCharacters.push(newChar); saveChars(); renderList(); document.getElementById('msgAddModal').classList.remove('show');
        });
      }

      // å³ä¸Šè§’ï¼‹
      var addBtn=document.getElementById('addBtn'); 
      if(addBtn){ addBtn.replaceWith(addBtn.cloneNode(true)); addBtn=document.getElementById('addBtn'); addBtn.addEventListener('click', onGlobalAdd); updateAddButtonForTab(); }

      // Tab
      initTabs();
    }

    if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
  })();
  </script>
</body>
</html>
