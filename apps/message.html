<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="rgba(0,0,0,0)">
  <link rel="apple-touch-icon" sizes="512x512" href="../assets/icons/icon512.png">
  <link rel="icon" href="../assets/icons/icon512.png" type="image/png">
  <title>æ¶ˆæ¯</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{--safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px)}
    html,body{width:100%;height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
    .message-app{position:fixed;inset:0;background:#ededed;display:flex;flex-direction:column}

    /* é¡¶æ  */
    .msg-navbar{height:calc(44px + env(safe-area-inset-top,20px));padding-top:env(safe-area-inset-top,20px);background:#f7f7f7;border-bottom:.5px solid #d9d9d9;display:flex;align-items:center;justify-content:space-between;padding-left:16px;padding-right:16px;flex-shrink:0}
    .msg-navbar-left{display:flex;align-items:center;gap:12px}
    .msg-back-btn{font-size:20px;cursor:pointer;user-select:none;padding:8px;margin:-8px}
    .msg-navbar-title{font-size:17px;font-weight:600;color:#000}
    .msg-navbar-icon{font-size:22px;cursor:pointer;user-select:none;padding:8px;margin:-8px}

    /* èŠå¤©åˆ—è¡¨ï¼ˆèŠå¤©Tabå†…å®¹é¢æ¿ï¼‰ */
    .msg-chat-list{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;position:relative;touch-action: pan-y;}
    .msg-chat-item-wrapper{position:relative;overflow:hidden}
    .msg-chat-item{background:#fff;padding:12px 16px;display:flex;gap:12px;border-bottom:.5px solid #e5e5e5;cursor:pointer;position:relative;transition:transform .3s ease;z-index:1}
    .msg-chat-item:active{background:#ececec}
    .msg-chat-avatar{width:48px;height:48px;border-radius:6px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0}
    .msg-chat-avatar img{width:100%;height:100%;border-radius:6px;object-fit:cover}
    .msg-chat-content{flex:1;min-width:0}
    .msg-chat-header{display:flex;justify-content:space-between;margin-bottom:4px}
    .msg-chat-name{font-size:16px;font-weight:500;color:#000}
    .msg-chat-time{font-size:12px;color:#999}
    .msg-chat-preview{font-size:14px;color:#999;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    /* Tabbar */
    .msg-tabbar{height:calc(50px + env(safe-area-inset-bottom,20px));padding-bottom:env(safe-area-inset-bottom,20px);background:#f7f7f7;border-top:.5px solid #d9d9d9;display:flex;flex-shrink:0}
    .msg-tab-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;user-select:none}
    .msg-tab-icon{font-size:24px;margin-bottom:2px}
    .msg-tab-label{font-size:10px;color:#999}
    .msg-tab-item.active .msg-tab-label{color:#07c160}

    /* æ·»åŠ è§’è‰² Modal */
    .msg-modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:3000}
    .msg-modal.show{display:flex}
    .msg-modal-content{background:#fff;width:90%;max-width:400px;border-radius:12px;overflow:hidden}
    .msg-modal-header{padding:16px;border-bottom:.5px solid #e5e5e5;display:flex;justify-content:space-between;align-items:center}
    .msg-modal-title{font-size:17px;font-weight:600}
    .msg-modal-close{font-size:24px;color:#999;cursor:pointer;padding:4px}
    .msg-modal-body{padding:20px;max-height:60vh;overflow-y:auto}
    .msg-form-group{margin-bottom:20px}
    .msg-form-label{display:block;font-size:14px;color:#666;margin-bottom:8px}
    .msg-form-input{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px}
    .msg-form-textarea{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px;min-height:100px;resize:vertical;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
    .msg-avatar-upload{width:80px;height:80px;border-radius:8px;border:2px dashed #e5e5e5;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden}
    .msg-avatar-upload img{width:100%;height:100%;object-fit:cover}
    .msg-btn-primary{width:100%;padding:12px;background:#07c160;color:#fff;border:none;border-radius:8px;font-size:16px;cursor:pointer}
    .msg-btn-primary:active{background:#06ad56}
    .msg-swipe-actions{position:absolute;right:0;top:0;bottom:0;display:flex;z-index:0}
    .msg-swipe-action{width:75px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px;cursor:pointer;user-select:none}
    .msg-swipe-action.reset{background:#ff9500}
    .msg-swipe-action.delete{background:#ff3b30}

    #debugBox{position:fixed;left:8px;right:8px;bottom:8px;z-index:9999;background:rgba(0,0,0,.8);color:#0f0;padding:8px;border-radius:6px;font-size:11px;max-height:25vh;overflow:auto;font-family:monospace;white-space:pre-wrap;word-break:break-all;display:none}

    /* ===== æˆ‘ï¼ˆèº«ä»½å¡ï¼‰Tab æ ·å¼ï¼ˆå«ä¼¸å±•ä¿®æ­£ï¼‰ ===== */
    :root{ --bg:#f2f2f7; --card-bg:#fff; --muted:#666; --hair:#ddd; --tint:#1677ff; --ok:#34c759; }
    #tab-me{
      position:relative;
      display:flex;      /* çºµå‘å¸ƒå±€ */
      flex:1;            /* â˜… å æ»¡å†…å®¹åŒºé«˜åº¦ */
      min-height:0;      /* â˜… å…è®¸å­å®¹å™¨æ­£ç¡®æ»šåŠ¨ */
      background:var(--bg);
    }
    .me-nav{ position:sticky; top:0; height:calc(44px + var(--safe-top)); padding:0 12px; padding-top:var(--safe-top);
      display:flex; align-items:center; justify-content:space-between; background:var(--bg); z-index:10; border-bottom:0.5px solid var(--hair); }
    .me-title{ font-weight:600; }
    .me-actions{ display:flex; gap:8px; }
    .i-btn{ height:32px; padding:0 12px; border:0; border-radius:10px; background:#eaeaea; }
    .i-btn.primary{ background:var(--ok); color:#fff; }
    .id-carousel{
      flex:1;            /* â˜… ä¼¸å±• */
      min-height:0;      /* â˜… é˜²å¡Œé™· */
      overflow-x:auto; scroll-snap-type:x mandatory; display:flex; gap:16px; padding:16px;
    }
    .id-card{ flex:0 0 calc(100% - 32px); scroll-snap-align:center; background:var(--card-bg); border-radius:16px; padding:16px; box-shadow:0 6px 18px rgba(0,0,0,.06);
      display:grid; grid-template-columns:92px 1fr; grid-auto-rows:min-content; gap:12px 16px; }
    .id-avatar{ width:92px; height:92px; border-radius:14px; background:#eee; overflow:hidden; display:flex; align-items:center; justify-content:center; font-size:44px; cursor:pointer; }
    .id-avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .id-meta h3{ margin:0 0 6px; font-size:18px; }
    .id-meta .nick{ color:var(--muted); font-size:13px; }
    .id-bio{ grid-column:1 / -1; background:#f7f7f7; border-radius:12px; padding:12px; line-height:1.5; min-height:52px; white-space:pre-wrap; word-break:break-word; }
    .bind-section{ grid-column:1 / -1; }
    .bind-title{ font-size:13px; color:var(--muted); margin-bottom:8px; }
    .bind-tags{ display:flex; flex-wrap:wrap; gap:8px; }
    .bind-tag{ padding:8px 10px; border-radius:999px; background:#f2f2f7; font-size:13px; cursor:pointer; user-select:none; border:0.5px solid transparent; display:flex; align-items:center; gap:6px; }
    .bind-tag.active{ background:#e9f0ff; color:var(--tint); border-color:#cfe0ff; }
    .bind-tag .av{ width:16px; height:16px; border-radius:50%; overflow:hidden; display:inline-flex; align-items:center; justify-content:center; font-size:12px; background:#eee; }
    .bind-tag .av img{ width:100%; height:100%; object-fit:cover; display:block; }
    .card-actions{ grid-column:1 / -1; display:flex; gap:10px; margin-top:2px; }
    .btn{ flex:1; height:36px; border:0; border-radius:10px; background:#ededed; }
    .btn.primary{ background:var(--ok); color:#fff; }
    .btn.warn{ background:#ff3b30; color:#fff; }
    .dots{ height:42px; display:flex; align-items:center; justify-content:center; gap:6px; }
    .dot{ width:6px; height:6px; border-radius:50%; background:#ddd; }
    .dot.active{ width:16px; border-radius:4px; background:#999; transition:all .25s; }

    dialog.me-editor{ width:min(560px, 92vw); border:0; border-radius:16px; padding:0; box-shadow:0 16px 40px rgba(0,0,0,.28); }
    .ed-head{ padding:14px 16px; border-bottom:0.5px solid var(--hair); display:flex; justify-content:space-between; align-items:center; }
    .ed-body{ padding:16px; display:grid; grid-template-columns:96px 1fr; gap:12px 16px; }
    .ed-avatar{ width:96px; height:96px; border-radius:14px; background:#eee; overflow:hidden; display:flex; align-items:center; justify-content:center; cursor:pointer; }
    .ed-avatar img{ width:100%; height:100%; object-fit:cover; }
    .ed-fields label{ display:block; font-size:12px; color:var(--muted); margin:8px 0 4px; }
    .ed-fields input, .ed-fields textarea{ width:100%; border:1px solid #e5e5ea; border-radius:10px; padding:10px 12px; font:inherit; background:#fff; }
    .ed-fields textarea{ min-height:96px; resize:vertical; }
    .ed-foot{ padding:12px 16px 16px; display:flex; gap:10px; }
    input[type=file]{ display:none; }
  </style>
</head>
<body>
  <div class="message-app">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="msg-navbar">
      <div class="msg-navbar-left">
        <div class="msg-back-btn" id="backBtn">â—€</div>
        <div class="msg-navbar-title">æ¶ˆæ¯</div>
      </div>
      <div class="msg-navbar-icon" id="addBtn">â•</div>
    </div>

    <!-- èŠå¤©Tab å†…å®¹é¢æ¿ -->
    <div class="msg-chat-list" id="msgChatList"></div>

    <!-- æˆ‘ï¼ˆèº«ä»½å¡ï¼‰Tab å†…å®¹é¢æ¿ -->
    <section id="tab-me" role="tabpanel" aria-label="æˆ‘çš„èº«ä»½">
      <div class="me-nav">
        <div class="me-title">æˆ‘çš„èº«ä»½</div>
        <div class="me-actions">
          <button class="i-btn" id="btnImport">å¯¼å…¥</button>
          <button class="i-btn" id="btnExport">å¯¼å‡º</button>
          <button class="i-btn primary" id="btnAddIdentity">æ–°å»º</button>
        </div>
      </div>
      <div class="id-carousel" id="idCarousel" aria-live="polite"></div>
      <div class="dots" id="dots"></div>
    </section>

    <!-- åº•éƒ¨Tab -->
    <div class="msg-tabbar">
      <div class="msg-tab-item active"><div class="msg-tab-icon">ğŸ’¬</div><div class="msg-tab-label">èŠå¤©</div></div>
      <div class="msg-tab-item"><div class="msg-tab-icon">ğŸ“…</div><div class="msg-tab-label">äº‹ä»¶</div></div>
      <div class="msg-tab-item"><div class="msg-tab-icon">ğŸŒ</div><div class="msg-tab-label">æœ‹å‹åœˆ</div></div>
      <div class="msg-tab-item"><div class="msg-tab-icon">ğŸ‘¤</div><div class="msg-tab-label">æˆ‘</div></div>
    </div>

    <!-- æ·»åŠ è§’è‰² Modal -->
    <div class="msg-modal" id="msgAddModal">
      <div class="msg-modal-content">
        <div class="msg-modal-header">
          <div class="msg-modal-title">æ·»åŠ è§’è‰²</div>
          <div class="msg-modal-close" id="closeModalBtn">Ã—</div>
        </div>
        <div class="msg-modal-body">
          <form id="msgCharacterForm">
            <div class="msg-form-group">
              <label class="msg-form-label">å¤´åƒ</label>
              <div class="msg-avatar-upload" id="msgAvatarUpload"><span>ğŸ“·</span></div>
              <input type="file" id="msgAvatarInput" accept="image/*" style="display:none">
            </div>
            <div class="msg-form-group">
              <label class="msg-form-label">å§“å</label>
              <input type="text" class="msg-form-input" id="msgCharacterName" placeholder="è¾“å…¥è§’è‰²å§“å" required>
            </div>
            <div class="msg-form-group">
              <label class="msg-form-label">æ˜µç§°</label>
              <input type="text" class="msg-form-input" id="msgCharacterNickname" placeholder="è¾“å…¥è§’è‰²æ˜µç§°">
            </div>
            <div class="msg-form-group">
              <label class="msg-form-label">äººè®¾</label>
              <textarea class="msg-form-textarea" id="msgCharacterBio" placeholder="æè¿°è§’è‰²çš„æ€§æ ¼ã€ç‰¹ç‚¹..." required></textarea>
            </div>
            <button type="submit" class="msg-btn-primary">æ·»åŠ </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ç¼–è¾‘èº«ä»½ å¼¹çª— -->
  <dialog class="me-editor" id="meEditor">
    <form method="dialog">
      <div class="ed-head">
        <div style="font-weight:600">ç¼–è¾‘èº«ä»½</div>
        <button class="i-btn" value="close">å…³é—­</button>
      </div>
      <div class="ed-body">
        <label class="ed-avatar" id="edAvatarPick" title="ç‚¹å‡»æ›´æ¢å¤´åƒ">
          <input type="file" id="edAvatarFile" accept="image/*" />
          <span id="edAvatarBox">ğŸ‘¤</span>
        </label>
        <div class="ed-fields">
          <label>å§“å</label>
          <input id="edName" placeholder="ç¤ºä¾‹ï¼šå¤ä¹‹è°£" />
          <label>æ˜µç§°ï¼ˆå¯¹å¤–æ˜¾ç¤ºä¼˜å…ˆï¼‰</label>
          <input id="edNick" placeholder="ç¤ºä¾‹ï¼šYoyo" />
          <label>è®¾å®š / äººè®¾</label>
          <textarea id="edBio" placeholder="åç†æ€§ã€å–œæ¬¢ç”¨æ•°æ®è¯´è¯â€¦â€¦"></textarea>
        </div>
      </div>
      <div class="ed-foot">
        <button class="i-btn" id="btnDelete" type="button">åˆ é™¤</button>
        <button class="i-btn primary" id="btnSave" value="save">ä¿å­˜</button>
      </div>
    </form>
  </dialog>

  <div id="debugBox"></div>

  <script>
  (function(){
    'use strict';
    /* ===== è°ƒè¯•å·¥å…· ===== */
    var debugBox = document.getElementById('debugBox');
    if (!debugBox) { debugBox = document.createElement('div'); debugBox.id = 'debugBox';
      debugBox.style.cssText = 'position:fixed;left:8px;right:8px;bottom:8px;z-index:9999;background:rgba(0,0,0,.8);color:#0f0;padding:8px;border-radius:6px;font-size:11px;max-height:25vh;overflow:auto;font-family:monospace;white-space:pre-wrap;word-break:break-all'; document.body.appendChild(debugBox); }
    function log(msg){ try{ var t=new Date().toTimeString().slice(0,8); debugBox.innerHTML += t+' '+msg+'\n'; debugBox.scrollTop = debugBox.scrollHeight; console.log(msg);}catch(e){console.log(msg);} }
    window.onerror = function(msg, url, line){ log('ERROR: '+msg+' @'+line); return true; };
    log('è„šæœ¬å¼€å§‹æ‰§è¡Œ'); log('document.readyState: '+document.readyState);

    /* ===== è§’è‰²æ•°æ®ï¼ˆä»“åº“ï¼‰ ===== */
    var STORAGE_KEY = 'eg_characters_v2';
    var msgCharacters = [];
    var touchStartX=0, touchCurrentX=0;

    function loadData(){
      try{
        var stored = localStorage.getItem(STORAGE_KEY);
        log('è¯»å–localStorage: ' + (stored ? stored.length + 'å­—ç¬¦' : 'null'));
        if (stored){
          msgCharacters = JSON.parse(stored);
          log('è§£ææˆåŠŸ: '+msgCharacters.length+'ä¸ªè§’è‰²');
        }else{
          msgCharacters = [{
            kind:'char',                 // â˜… æ ‡è®°ä¸ºè§’è‰²
            id:'nash', name:'Nash', nickname:'Nash', bio:'å¤©çœŸå¼€æœ—çš„å°ç‹ç‹¸', avatar:'ğŸ¦Š', lastTime:'12:00'
          }];
          saveData(); log('åˆå§‹åŒ–Nash');
        }
      }catch(e){ log('loadDataé”™è¯¯: '+e.message); msgCharacters=[]; }
    }
    function saveData(){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(msgCharacters)); log('ä¿å­˜æˆåŠŸ: '+msgCharacters.length+'ä¸ªè§’è‰²'); }
      catch(e){ log('saveDataé”™è¯¯: '+e.message); }
    }

    function renderList(){
      log('å¼€å§‹æ¸²æŸ“åˆ—è¡¨');
      var list = document.getElementById('msgChatList');
      if (!list){ log('ERROR: msgChatListä¸å­˜åœ¨'); return; }

      var listData = msgCharacters.filter(function(c){ return c && c.kind !== 'identity'; }); // â˜… åªæ˜¾ç¤ºâ€œè§’è‰²â€
      if (listData.length===0){
        list.innerHTML = '<div style="padding:20px;text-align:center;color:#999">æš‚æ— è§’è‰²</div>';
        return;
      }
      var html='';
      for (var i=0;i<listData.length;i++){
        var c=listData[i]; var av=c.avatar||'ğŸ‘¤';
        var avatarHTML=(av.indexOf('data:')===0||av.indexOf('http')===0)?'<img src="'+av+'">':av;
        html += '<div class="msg-chat-item-wrapper">'+
                  '<div class="msg-swipe-actions">'+
                    '<div class="msg-swipe-action reset" data-id="'+c.id+'">é‡ç½®</div>'+
                    '<div class="msg-swipe-action delete" data-id="'+c.id+'">åˆ é™¤</div>'+
                  '</div>'+
                  '<div class="msg-chat-item" data-id="'+c.id+'">'+
                    '<div class="msg-chat-avatar">'+avatarHTML+'</div>'+
                    '<div class="msg-chat-content">'+
                      '<div class="msg-chat-header">'+
                        '<div class="msg-chat-name">'+(c.nickname||c.name)+'</div>'+
                        '<div class="msg-chat-time">'+(c.lastTime||'')+'</div>'+
                      '</div>'+
                      '<div class="msg-chat-preview">'+(c.lastMsg||c.bio||'')+'</div>'+
                    '</div>'+
                  '</div>'+
                '</div>';
      }
      list.innerHTML = html; log('æ¸²æŸ“å®Œæˆ: '+listData.length+'é¡¹');
      bindEvents();
    }

    function bindEvents(){
      log('ç»‘å®šäº‹ä»¶');
      var items = document.querySelectorAll('.msg-chat-item');
      for (var i=0;i<items.length;i++){
        items[i].addEventListener('click', function(){
          if (Math.abs(touchStartX - touchCurrentX) < 10){
            var id = this.dataset.id || 'nash';
            sessionStorage.setItem('currentChatId', id);
            if (window.openAppPage) window.openAppPage('message-detail.html?id='+encodeURIComponent(id));
            else location.href = 'message-detail.html?id='+encodeURIComponent(id);
          }
        });
        items[i].addEventListener('touchstart', function(e){ touchStartX = e.touches[0].clientX; touchCurrentX = touchStartX; });
        items[i].addEventListener('touchmove', function(e){
          touchCurrentX = e.touches[0].clientX;
          var diff = touchStartX - touchCurrentX;
          if (diff>0 && diff<150){ this.style.transform='translateX(-'+diff+'px)'; this.style.transition='none'; }
        });
        items[i].addEventListener('touchend', function(){
          var diff = touchStartX - touchCurrentX;
          this.style.transition='transform .3s ease';
          this.style.transform = diff>75 ? 'translateX(-150px)' : 'translateX(0)';
        });
      }
      var actions = document.querySelectorAll('.msg-swipe-action');
      for (var j=0;j<actions.length;j++){
        actions[j].addEventListener('click', function(e){
          e.stopPropagation();
          var id = this.dataset.id; var isDelete = this.classList.contains('delete');
          if (isDelete){
            if (confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')){
              log('åˆ é™¤è§’è‰²: '+id);
              msgCharacters = msgCharacters.filter(function(c){ return c.id!==id; });
              saveData(); renderList();
            }
          }else{
            if (confirm('ç¡®å®šé‡ç½®èŠå¤©è®°å½•ï¼Ÿ')){
              log('é‡ç½®èŠå¤©: '+id); alert('èŠå¤©è®°å½•å·²é‡ç½®');
            }
          }
        });
      }
    }

    /* ===== æ¨¡æ€æ¡† ===== */
    function showModal(){ var m=document.getElementById('msgAddModal'); if(m) m.classList.add('show'); }
    function hideModal(){
      var m=document.getElementById('msgAddModal'); if(m) m.classList.remove('show');
      var f=document.getElementById('msgCharacterForm'); if(f) f.reset();
      var up=document.getElementById('msgAvatarUpload'); if(up) up.innerHTML='<span>ğŸ“·</span>';
    }

    /* ===== è¿”å› ===== */
    function goBack(){
      if (window.closeApp) window.closeApp();
      else if (history.length>1) history.back();
      else location.href='../index.html';
    }

    /* ===== æˆ‘ï¼ˆèº«ä»½å¡ï¼‰ç»„ä»¶ï¼ˆå« kind æ ‡è®°ä¸ iOS å¯¼å‡ºä¿®å¤ï¼‰ ===== */
    (function(){
      const LS_ID   = 'eg_user_identities_v1';
      const LS_CHAR = 'eg_characters_v2';
      const LS_META = 'eg_thread_meta_v1';

      const $ = s => document.querySelector(s);
      const idCarousel = $('#idCarousel');
      const dots = $('#dots');
      const meEditor = $('#meEditor');
      const edAvatarBox = $('#edAvatarBox');
      const edAvatarFile = $('#edAvatarFile');
      const edName = $('#edName');
      const edNick = $('#edNick');
      const edBio  = $('#edBio');

      let identities = load(LS_ID) || [];
      let chars = load(LS_CHAR) || [];

      if (!Array.isArray(identities) || identities.length===0){
        const firstBound = (Array.isArray(chars)&&chars[0]) ? [chars[0].id] : [];
        identities = [{ kind:'identity', id: makeUid(), name:'User', nickname:'æˆ‘', avatar:'ğŸ‘¤', bio:'', boundCharIds:firstBound }];
        save(LS_ID, identities);
      }

      render();

      // â€”â€” å¯¼å‡ºï¼ˆiOS åˆ†äº«/å¤åˆ¶å…œåº•ï¼‰ â€”â€”
      function isIOS(){ return /iP(hone|ad|od)/.test(navigator.userAgent); }
      async function copyText(t){ try{ await navigator.clipboard.writeText(t); return true; }catch(_){ return false; } }
      $('#btnExport')?.addEventListener('click', async ()=>{
        const json = JSON.stringify(identities, null, 2);
        if (isIOS()){
          if (navigator.share){ try{ await navigator.share({ title:'eg_user_identities.json', text: json }); return; }catch(_){ /* ç”¨æˆ·å–æ¶ˆ */ } }
          const ok = await copyText(json);
          alert(ok ? 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ˆiOS ç‹¬ç«‹çª—å£æ— æ³•ç›´æ¥ä¸‹è½½ï¼‰' : 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥å‰ªè´´æ¿æƒé™');
          return;
        }
        const blob = new Blob([json], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='eg_user_identities.json';
        document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1500);
      });

      // â€”â€” å¯¼å…¥ â€”â€”
      $('#btnImport')?.addEventListener('click', ()=>{
        const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
        inp.onchange = async ()=>{ const f=inp.files[0]; if(!f) return; try{
            const txt = await f.text(); const arr = JSON.parse(txt);
            if(Array.isArray(arr)){
              identities = arr.map(n=>({ kind:'identity', id:n.id||makeUid(), name:n.name||'', nickname:n.nickname||'', bio:n.bio||'', avatar:n.avatar||'ğŸ‘¤', boundCharIds:Array.isArray(n.boundCharIds)?n.boundCharIds:[] }));
              save(LS_ID, identities); render(); broadcast();
            }
          }catch(e){ alert('å¯¼å…¥å¤±è´¥ï¼šJSON æ ¼å¼é”™è¯¯'); } };
        inp.click();
      });

      // â€”â€” æ–°å»ºèº«ä»½ â€”â€”
      document.getElementById('btnAddIdentity')?.addEventListener('click', ()=> openEditor());

      document.addEventListener('click', function(e){
  if (e.target && e.target.id === 'btnAddIdentity') openEditor();
});
      
      // ç¼–è¾‘å™¨å‡½æ•°å¯¼å‡ºåˆ°å…¨å±€
      window.openIdentityEditor = function(id=null, opt={}){ openEditor(id, opt); };

      // æš´éœ² API
      window.EGIdentities = {
        getAll: ()=> clone(identities),
        getById: id => clone(identities.find(x=>x.id===id)),
        getActiveIdentityFor: (charId)=>{
          const meta = load(LS_META) || {};
          const id = meta[charId]?.activeIdentityId || (identities[0] && identities[0].id);
          return identities.find(x=>x.id===id) || identities[0];
        },
        setActiveIdentityFor: (charId, identityId)=>{
          const meta = load(LS_META) || {}; meta[charId] = meta[charId] || {}; meta[charId].activeIdentityId = identityId; save(LS_META, meta); broadcast();
        }
      };

      function render(){
        if (!idCarousel) return;
        idCarousel.innerHTML = identities.map(renderCard).join('');
        dots.innerHTML = identities.map((_,i)=>`<div class="dot ${i===0?'active':''}"></div>`).join('');
        bindCardEvents();
        idCarousel.addEventListener('scroll', onScrollSnap, {passive:true});
      }
      function renderCard(u){
        const avHTML = isImg(u.avatar) ? `<img src="${u.avatar}">` : escapeHtml(u.avatar || 'ğŸ‘¤');
        const tags = (Array.isArray(chars)?chars:[]).map(c=>{
          const active = u.boundCharIds?.includes(c.id);
          const face = isImg(c.avatar)?`<img src="${c.avatar}">`:escapeHtml(c.avatar||'ğŸ‘¤');
          return `<span class="bind-tag ${active?'active':''}" data-char="${c.id}"><span class="av">${face}</span>${escapeHtml(c.nickname||c.name||c.id)}</span>`;
        }).join('');
        return `
          <article class="id-card" data-id="${u.id}">
            <div class="id-avatar" data-act="pick-avatar">${avHTML}</div>
            <div class="id-meta">
              <h3>${escapeHtml(u.nickname||u.name||'æœªå‘½å')}</h3>
              <div class="nick">${escapeHtml(u.name||'')}</div>
            </div>
            <div class="id-bio">${u.bio ? escapeHtml(u.bio) : 'ï¼ˆç‚¹å‡»ç¼–è¾‘ï¼Œå®Œå–„ä½ çš„è®¾å®šï¼‰'}</div>
            <div class="bind-section">
              <div class="bind-title">ç»‘å®šçš„è§’è‰²ï¼ˆå¤šé€‰ï¼‰</div>
              <div class="bind-tags">${tags || 'ï¼ˆæš‚æ— è§’è‰²ï¼Œå¯åœ¨â€œæ¶ˆæ¯â€é¡µæ·»åŠ ï¼‰'}</div>
            </div>
            <div class="card-actions">
              <button class="btn" data-act="edit">ç¼–è¾‘</button>
              <button class="btn primary" data-act="setDefault">è®¾ä¸ºé»˜è®¤ï¼ˆå¯¹æ‰€æœ‰è§’è‰²ï¼‰</button>
              <button class="btn warn" data-act="remove">åˆ é™¤</button>
            </div>
          </article>`;
      }
      function bindCardEvents(){
        idCarousel.querySelectorAll('.bind-tag').forEach(tag=>{
          tag.addEventListener('click', (e)=>{
            const card = e.target.closest('.id-card'); const uid = card.dataset.id; const charId = tag.dataset.char;
            const u = identities.find(x=>x.id===uid); u.boundCharIds = u.boundCharIds || [];
            const i = u.boundCharIds.indexOf(charId);
            if (i>=0){ u.boundCharIds.splice(i,1); tag.classList.remove('active'); }
            else { u.boundCharIds.push(charId); tag.classList.add('active'); }
            save(LS_ID, identities); broadcast();
          });
        });
        idCarousel.querySelectorAll('.id-card .btn').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const card = btn.closest('.id-card'); const uid = card.dataset.id;
            if (btn.dataset.act==='edit') openEditor(uid);
            if (btn.dataset.act==='setDefault') setDefaultForAll(uid);
            if (btn.dataset.act==='remove') removeIdentity(uid);
          });
        });
        idCarousel.querySelectorAll('.id-avatar').forEach(box=>{
          box.addEventListener('click', ()=>{ const card = box.closest('.id-card'); openEditor(card.dataset.id, {focus:'avatar'}); });
        });
      }

      // ç¼–è¾‘å¼¹çª—
      document.getElementById('btnDelete')?.addEventListener('click', ()=>{ if (editingId) removeIdentity(editingId, {close:true}); });
      document.getElementById('btnSave')?.addEventListener('click', (e)=>{ e.preventDefault(); saveEditor(); meEditor.close('save'); });

      let editingId = null;
      function openEditor(identityId=null, opt={}){
  editingId = identityId; let u;
  if (identityId){ u = identities.find(x=>x.id===identityId); }
  else { u = { kind:'identity', id: makemakeUid(), name:'', nickname:'', avatar:'ğŸ‘¤', bio:'', boundCharIds:[] }; }
        document.getElementById('edName').value = u.name||'';
        document.getElementById('edNick').value = u.nickname||'';
        document.getElementById('edBio').value  = u.bio||'';
        setEditorAvatar(u.avatar);
        meEditor.showModal(); if (opt.focus==='avatar') document.getElementById('edAvatarPick').focus();
        edAvatarFile.onchange = async ()=>{ const f = edAvatarFile.files[0]; if(!f) return; const b64 = await fileToDataURL(f); setEditorAvatar(b64); };
        meEditor.onclose = ()=>{ editingId=null; };
        meEditor.querySelector('form').onsubmit = (ev)=>{ ev.preventDefault(); };
      }
      function saveEditor(){
        const payload = { name: edName.value.trim(), nickname: edNick.value.trim(), bio: edBio.value.trim(), avatar: edAvatarBox.dataset.src||'ğŸ‘¤' };
        if (editingId){ const u = identities.find(x=>x.id===editingId); Object.assign(u, payload); }
        else { identities.push({ kind:'identity', id: makeUid(), ...payload, boundCharIds: [] }); }
        save(LS_ID, identities); render(); broadcast();
      }
      function setEditorAvatar(src){
        edAvatarBox.dataset.src = src;
        edAvatarBox.innerHTML = isImg(src) ? `<img src="${src}" alt="avatar">` : escapeHtml(src||'ğŸ‘¤');
      }
      function setDefaultForAll(uid){
        const meta = load(LS_META) || {}; for (const c of (chars||[])) { meta[c.id] = meta[c.id]||{}; meta[c.id].activeIdentityId = uid; }
        save(LS_META, meta); alert('å·²è®¾ä¸ºæ‰€æœ‰è§’è‰²çš„é»˜è®¤èº«ä»½'); broadcast();
      }
      function removeIdentity(uid, opt={}){
        if (identities.length<=1){ alert('è‡³å°‘ä¿ç•™ä¸€å¼ èº«ä»½å¡'); return; }
        if (!confirm('ç¡®è®¤åˆ é™¤è¯¥èº«ä»½å¡ï¼Ÿå†å²æ¶ˆæ¯çš„æ ‡è®°ä¸ä¼šè¢«ä¿®æ”¹ã€‚')) return;
        identities = identities.filter(x=>x.id!==uid); save(LS_ID, identities);
        const meta = load(LS_META) || {}; for (const k in meta){ if (meta[k]?.activeIdentityId===uid) { meta[k].activeIdentityId = identities[0].id; } } save(LS_META, meta);
        if (opt.close) meEditor.close('del'); render(); broadcast();
      }
      function onScrollSnap(){
        const w = idCarousel.clientWidth; const i = Math.round(idCarousel.scrollLeft / (w+16));
        dots.querySelectorAll('.dot').forEach((d,idx)=>d.classList.toggle('active', idx===i));
      }

      function load(k){ try{ return JSON.parse(localStorage.getItem(k)||''); }catch(e){ return null; } }
      function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
      function makemakeUid(){ return 'u_' + Math.random().toString(36).slice(2,8) + Date.now().toString(36).slice(-4); }
      function isImg(s){ return typeof s==='string' && (s.startsWith('data:') || s.startsWith('http')); }
      function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
      function fileToDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }
      function clone(v){ return JSON.parse(JSON.stringify(v)); }
      function broadcast(){ window.dispatchEvent(new CustomEvent('eg:identitiesUpdated')); localStorage.setItem('eg_evt_ping', String(Date.now())); }
    })();

    var EG_CURRENT_TAB = 'chat';
    /* ===== Tab åˆ‡æ¢ï¼šèŠå¤© / æˆ‘ï¼ˆå…ˆåšè¿™ä¸¤ä¸ªï¼‰ ===== */
    function initTabs(){
      const items = document.querySelectorAll('.msg-tab-item');
      const viewChat = document.getElementById('msgChatList');
      const viewMe   = document.getElementById('tab-me');
      function show(name){
        EG_CURRENT_TAB = name;            // â˜… è®°å½•å½“å‰ Tab
        if (viewChat) viewChat.style.display = (name==='chat') ? 'block' : 'none';
        if (viewMe)   viewMe.style.display   = (name==='me')   ? 'block' : 'none';
        updateAddButtonForTab();          // â˜… åŒæ­¥å³ä¸Šè§’ã€Œï¼‹ã€çš„è¡Œä¸º/æç¤º
        items.forEach(el=>el.classList.remove('active'));
        if (name==='chat') items[0]?.classList.add('active');
        if (name==='me')   items[3]?.classList.add('active');
      }
      items[0]?.addEventListener('click', ()=> show('chat')); // èŠå¤©
      items[1]?.addEventListener('click', ()=> alert('äº‹ä»¶ï¼šå¼€å‘ä¸­'));
      items[2]?.addEventListener('click', ()=> alert('æœ‹å‹åœˆï¼šå¼€å‘ä¸­'));
      items[3]?.addEventListener('click', ()=> show('me'));   // æˆ‘
      show('chat'); // é»˜è®¤
      window.EGTab = Object.assign(window.EGTab||{}, { show });
    }

// ç¡®ä¿ addBtn å·²è·å–åå†è°ƒç”¨
function onGlobalAdd(){
  switch (EG_CURRENT_TAB) {
    case 'chat':    showModal(); break;
    case 'me':      if (typeof window.openIdentityEditor === 'function') window.openIdentityEditor();
                    else alert('æ‰“å¼€èº«ä»½ç¼–è¾‘å™¨å¤±è´¥'); 
                    break;
    case 'moments': alert('å‘åŠ¨æ€ï¼šå¼€å‘ä¸­'); break;
    case 'events':  alert('æ·»åŠ äº‹ä»¶ï¼šå¼€å‘ä¸­'); break;
    default:        showModal();
  }
}

function updateAddButtonForTab(){
  var addBtn = document.getElementById('addBtn');
  if (!addBtn) return;
  var map = { chat:'æ–°å»ºè§’è‰²', me:'æ–°å»ºèº«ä»½', moments:'å‘åŠ¨æ€', events:'æ·»åŠ äº‹ä»¶' };
  addBtn.setAttribute('aria-label', map[EG_CURRENT_TAB] || 'æ–°å»º');
}
    /* ===== åˆå§‹åŒ– ===== */
    function init(){
      try{
        loadData(); renderList();
        var backBtn = document.getElementById('backBtn'); if (backBtn) backBtn.addEventListener('click', goBack);
        var addBtn = document.getElementById('addBtn');   
        if (addBtn) {
          // é˜²æ­¢ä¹‹å‰ç»‘å®šè¿˜åœ¨
  addBtn.replaceWith(addBtn.cloneNode(true));
  addBtn = document.getElementById('addBtn');
  addBtn.addEventListener('click', onGlobalAdd); // â˜… æ ¹æ®å½“å‰ Tab è§¦å‘ä¸åŒåŠŸèƒ½
  updateAddButtonForTab();                       // â˜… åˆå§‹åŒ–ä¸€æ¬¡æ–‡æ¡ˆ/æ— éšœç¢æç¤º
        };
        var closeBtn = document.getElementById('closeModalBtn'); if (closeBtn) closeBtn.addEventListener('click', hideModal);
        var modal = document.getElementById('msgAddModal');
        if (modal){ modal.addEventListener('click', function(e){ if (e.target.id==='msgAddModal') hideModal(); }); }
        var avatarUpload = document.getElementById('msgAvatarUpload');
        var avatarInput  = document.getElementById('msgAvatarInput');
        if (avatarUpload && avatarInput){
          avatarUpload.addEventListener('click', function(){ avatarInput.click(); });
          avatarInput.addEventListener('change', function(e){
            var file = e.target.files[0]; if (!file) return;
            var reader = new FileReader(); reader.onload = function(ev){ avatarUpload.innerHTML = '<img src="'+ev.target.result+'">'; }; reader.readAsDataURL(file);
          });
        }
        var form = document.getElementById('msgCharacterForm');
        if (form){
          form.addEventListener('submit', function(e){
            e.preventDefault();
            var name = document.getElementById('msgCharacterName').value.trim();
            var nickname = document.getElementById('msgCharacterNickname').value.trim() || name;
            var bio = document.getElementById('msgCharacterBio').value.trim();
            var up = document.getElementById('msgAvatarUpload'); var img = up ? up.querySelector('img') : null; var avatar = img ? img.src : 'ğŸ‘¤';
            var newChar = {
              kind:'char',                 // â˜… è§’è‰²æ ‡è®°
              id: String(Date.now()),
              name, nickname, bio, avatar,
              lastTime: new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})
            };
            msgCharacters.push(newChar); saveData(); renderList(); hideModal();
          });
        }
        initTabs();
        log('åˆå§‹åŒ–å®Œæˆ');
      }catch(e){ log('åˆå§‹åŒ–é”™è¯¯: '+e.message); }
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', function(){ init(); });
    }else{ init(); }
  })();
  </script>
</body>
</html>
