<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="rgba(0,0,0,0)">
  <link rel="apple-touch-icon" sizes="512x512" href="../assets/icons/icon512.png">
  <link rel="icon" href="../assets/icons/icon512.png" type="image/png">
  <title>消息</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{--safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px)}
    html,body{width:100%;height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
    .message-app{position:fixed;inset:0;background:#ededed;display:flex;flex-direction:column}

    /* 顶栏 */
    .msg-navbar{
      position:relative;
      height:calc(44px + var(--safe-top));
      padding:0 12px; padding-top:var(--safe-top);
      background:#f7f7f7; border-bottom:.5px solid #d9d9d9;
      display:flex; align-items:center; gap:12px;
      flex-shrink:0;
    }
    .msg-navbar-left{ display:flex; align-items:center; gap:8px; z-index:2; }
    .msg-back-btn{ font-size:20px; cursor:pointer; user-select:none; padding:8px; margin:-8px; color:#333; }
    .msg-navbar-icon{ font-size:22px; cursor:pointer; user-select:none; padding:8px; margin:-8px; color:#333; z-index:2; }
    .msg-navbar-center{ flex:1; display:flex; align-items:center; justify-content:center; pointer-events:none; }
    .msg-navbar-title{ font-size:17px; font-weight:600; color:#000; }

    /* 聊天列表 */
    .msg-chat-list{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;position:relative;touch-action:pan-y}
    .msg-chat-item-wrapper{position:relative;overflow:hidden}
    .msg-chat-item{background:#fff;padding:12px 16px;display:flex;gap:12px;border-bottom:.5px solid #e5e5e5;cursor:pointer;position:relative;transition:transform .3s ease;z-index:1}
    .msg-chat-item:active{background:#ececec}
    .msg-chat-avatar{width:48px;height:48px;border-radius:6px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0}
    .msg-chat-avatar img{width:100%;height:100%;border-radius:6px;object-fit:cover}
    .msg-chat-content{flex:1;min-width:0}
    .msg-chat-header{display:flex;justify-content:space-between;margin-bottom:4px}
    .msg-chat-name{font-size:16px;font-weight:500;color:#000}
    .msg-chat-time{font-size:12px;color:#999}
    .msg-chat-preview{font-size:14px;color:#999;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    /* Tabbar */
    .msg-tabbar{height:calc(50px + var(--safe-bottom));padding-bottom:var(--safe-bottom);background:#f7f7f7;border-top:.5px solid #d9d9d9;display:flex;flex-shrink:0}
    .msg-tab-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;user-select:none}
    .msg-tab-icon{font-size:24px;margin-bottom:2px}
    .msg-tab-label{font-size:10px;color:#999}
    .msg-tab-item.active .msg-tab-label{color:#07c160}

    /* Modal & 表单 */
    .msg-modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:3000}
    .msg-modal.show{display:flex}
    .msg-modal-content{background:#fff;width:90%;max-width:400px;border-radius:12px;overflow:hidden}
    .msg-modal-header{padding:16px;border-bottom:.5px solid #e5e5e5;display:flex;justify-content:space-between;align-items:center}
    .msg-modal-title{font-size:17px;font-weight:600}
    .msg-modal-close{font-size:24px;color:#999;cursor:pointer;padding:4px}
    .msg-modal-body{padding:20px;max-height:60vh;overflow-y:auto}
    .msg-form-group{margin-bottom:20px}
    .msg-form-label{display:block;font-size:14px;color:#666;margin-bottom:8px}
    .msg-form-input{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px}
    .msg-form-textarea{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px;min-height:100px;resize:vertical;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
    .msg-avatar-upload{width:80px;height:80px;border-radius:8px;border:2px dashed #e5e5e5;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden}
    .msg-avatar-upload img{width:100%;height:100%;object-fit:cover}
    .msg-btn-primary{width:100%;padding:12px;background:#07c160;color:#fff;border:none;border-radius:8px;font-size:16px;cursor:pointer}
    .msg-btn-primary:active{background:#06ad56}
    .msg-swipe-actions{position:absolute;right:0;top:0;bottom:0;display:flex;z-index:0}
    .msg-swipe-action{width:75px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px;cursor:pointer;user-select:none}
    .msg-swipe-action.reset{background:#ff9500}
    .msg-swipe-action.delete{background:#ff3b30}

    #debugBox{position:fixed;left:8px;right:8px;bottom:8px;z-index:9999;background:rgba(0,0,0,.8);color:#0f0;padding:8px;border-radius:6px;font-size:11px;max-height:25vh;overflow:auto;font-family:monospace;white-space:pre-wrap;word-break:break-all;display:none}

    /* ===== 我（身份卡）Tab（垂直居中 + 下拉多选 + 指示点） ===== */
    :root{ --bg:#f2f2f7; --card-bg:#fff; --muted:#666; --hair:#ddd; --tint:#1677ff; --ok:#34c759; --warn:#ff3b30; }

    #tab-me{ flex:1; min-height:0; display:none; background:var(--bg); position:relative; }
    .id-wrap{ position:absolute; top:50%; left:0; right:0; transform:translateY(-50%); display:flex; flex-direction:column; align-items:center; }
    .id-carousel{ flex:0 0 auto; width:100%; max-width:100%; overflow-x:auto; overflow-y:visible; scroll-snap-type:x mandatory; display:flex; gap:18px; padding:0 clamp(16px,5vw,32px); align-items:flex-start; -webkit-overflow-scrolling:touch; }
    .id-card{ flex:0 0 clamp(320px,88vw,680px); scroll-snap-align:center; background:var(--card-bg); border-radius:16px; padding:16px 16px 18px; box-shadow:0 6px 18px rgba(0,0,0,.06); display:grid; grid-template-columns:92px 1fr; grid-auto-rows:min-content; gap:12px 16px; }
    .dots{ height:30px; display:flex; align-items:center; justify-content:center; gap:8px; margin-top:10px; }
    .dot{ width:6px; height:6px; border-radius:999px; background:#ddd; transition:all .25s; }
    .dot.active{ width:22px; height:6px; border-radius:4px; background:#999; }

    .id-avatar{ width:92px; height:92px; border-radius:14px; background:#eee; overflow:hidden; display:flex; align-items:center; justify-content:center; font-size:44px; cursor:pointer; user-select:none;}
    .id-avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .id-meta{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .id-meta h3{ margin:0 0 4px; font-size:18px; color:#000;}
    .badge{ font-size:11px; padding:2px 6px; border-radius:999px; background:#e8f5e9; color:#0a8f27; border:.5px solid #bfe8c7; margin-left:6px; }
    .meta-right{ display:flex; gap:6px; align-items:center; }
    .mini{ height:28px; padding:0 10px; border:0; border-radius:8px; background:#efefef; font-size:12px; cursor:pointer; user-select:none;}
    .mini:active{ filter:brightness(.95); }

    .id-field{ grid-column:1 / -1; }
    .label{ font-size:13px; color:#000; margin:4px 0; }
    .input, .textarea{ width:100%; color:#000; background:#fff; border:1px solid #e5e5ea; border-radius:10px; padding:10px 12px; font:inherit; }
    .textarea{ min-height:120px; resize:vertical; }
    .input[readonly], .textarea[readonly]{ background:#f7f7f7; color:#000; }

    .bind-section{ grid-column:1 / -1; }
    .bind-title{ font-size:13px; color:#000; margin:6px 0 8px; }

    .bind-combo{ position:relative; display:block; }
    .combo-btn{ height:36px; padding:0 12px; border:1px solid #e5e5ea; border-radius:10px; background:#fff; font:inherit; display:inline-flex; align-items:center; gap:6px; }
    .combo-panel{ position:absolute; left:0; right:0; top:calc(100% + 6px); background:#fff; border:1px solid #e5e5ea; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.08); padding:8px; max-height:240px; overflow:auto; z-index:20; display:none; }
    .combo-panel.show{ display:block; }
    .combo-opt{ display:flex; align-items:center; gap:8px; padding:8px; border-radius:8px; }
    .combo-opt:hover{ background:#f7f7f7; }
    .combo-opt .av{ width:18px;height:18px;border-radius:50%;overflow:hidden;display:inline-flex;align-items:center;justify-content:center;background:#eee;font-size:12px;}
    .combo-opt .av img{ width:100%;height:100%;object-fit:cover;display:block; }
    .combo-opt small{ color:#999; }

    .card-actions{ grid-column:1 / -1; display:flex; gap:10px; margin-top:2px; }
    .btn{ flex:1; height:36px; border:0; border-radius:10px; background:#ededed; }
    .btn.primary{ background:var(--ok); color:#fff; }
    .btn.warn{ background:var(--warn); color:#fff; }
  </style>
</head>
<body>
  <div class="message-app">
    <!-- 顶部导航 -->
    <div class="msg-navbar">
      <div class="msg-navbar-left">
        <div class="msg-back-btn" id="backBtn">&lsaquo;</div>
      </div>
      <div class="msg-navbar-center"><div id="topTitle" class="msg-navbar-title">消息</div></div>
      <div class="msg-navbar-icon" id="addBtn" aria-label="新建">➕</div>
    </div>

    <!-- 聊天Tab 内容面板 -->
    <div class="msg-chat-list" id="msgChatList"></div>

    <!-- 事件 Tab 内容面板（唯一） -->
    <section id="tab-events" role="tabpanel" aria-label="事件" style="display:none;flex:1;min-height:0;background:#f2f2f7;overflow:auto;-webkit-overflow-scrolling:touch;">
      <div style="padding:12px;">
        <!-- 顶部操作 -->
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
          <button id="evtAddBtn" class="btn" style="background:#07c160;color:#fff;border:0;border-radius:10px;height:36px;padding:0 14px;">新建事件</button>
          <small style="color:#6d6d72;">分区：我们的约定 / 我的记事本</small>
        </div>

        <!-- 我们的约定 -->
        <h3 style="font-size:13px;color:#6d6d72;margin:10px 2px 8px;">我们的约定</h3>
        <div id="evtAgreements"></div>

        <!-- 我的记事本 -->
        <h3 style="font-size:13px;color:#6d6d72;margin:14px 2px 8px;">我的记事本</h3>
        <div id="evtNotes"></div>
      </div>
    </section>

    <!-- 新建/编辑事件 Modal（唯一） -->
    <div class="msg-modal" id="evtModal">
      <div class="msg-modal-content">
        <div class="msg-modal-header">
          <div class="msg-modal-title">事件</div>
          <div class="msg-modal-close" id="evtClose">×</div>
        </div>
        <div class="msg-modal-body">
          <form id="evtForm">
            <div class="msg-form-group">
              <label class="msg-form-label">类型</label>
              <select class="msg-form-input" id="evtType">
                <option value="agreement">我们的约定</option>
                <option value="note">我的记事本</option>
              </select>
            </div>

            <div class="msg-form-group">
              <label class="msg-form-label">我的身份（可选）</label>
              <select class="msg-form-input" id="evtIdentity"></select>
            </div>

            <div class="msg-form-group" id="evtCharsWrap">
              <label class="msg-form-label">涉及角色（多选；约定必选 / 记事本=可见角色）</label>
              <div id="evtCharsBox" style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;"></div>
            </div>

            <div class="msg-form-group">
              <label class="msg-form-label">事件频次</label>
              <select class="msg-form-input" id="evtFreq">
                <option value="once">单次</option>
                <option value="year">年度</option>
                <option value="month">月度</option>
                <option value="week">周度</option>
                <option value="day">日度</option>
              </select>
            </div>

            <div class="msg-form-group">
              <label class="msg-form-label">时间（可选，ISO或 yyyy-MM-dd HH:mm）</label>
              <input id="evtTime" class="msg-form-input" placeholder="2025-10-25 12:00">
            </div>

            <div class="msg-form-group">
              <label class="msg-form-label">事件名称</label>
              <input id="evtName" class="msg-form-input" placeholder="如：去野餐…" required>
            </div>

            <div class="msg-form-group">
              <button type="submit" class="msg-btn-primary">保存</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- 我（身份卡）Tab 内容面板 -->
    <section id="tab-me" role="tabpanel" aria-label="我的身份">
      <div class="id-wrap">
        <div class="id-carousel" id="idCarousel" aria-live="polite"></div>
        <div class="dots" id="dots"></div>
      </div>
    </section>

    <!-- 底部Tab -->
    <div class="msg-tabbar">
      <div class="msg-tab-item active"><div class="msg-tab-icon">💬</div><div class="msg-tab-label">聊天</div></div>
      <div class="msg-tab-item"><div class="msg-tab-icon">📅</div><div class="msg-tab-label">事件</div></div>
      <div class="msg-tab-item"><div class="msg-tab-icon">🌐</div><div class="msg-tab-label">朋友圈</div></div>
      <div class="msg-tab-item"><div class="msg-tab-icon">👤</div><div class="msg-tab-label">我</div></div>
    </div>

    <!-- 添加角色 Modal（聊天Tab用） -->
    <div class="msg-modal" id="msgAddModal">
      <div class="msg-modal-content">
        <div class="msg-modal-header">
          <div class="msg-modal-title">添加角色</div>
          <div class="msg-modal-close" id="closeModalBtn">×</div>
        </div>
        <div class="msg-modal-body">
          <form id="msgCharacterForm">
            <div class="msg-form-group">
              <label class="msg-form-label">头像</label>
              <div class="msg-avatar-upload" id="msgAvatarUpload"><span>📷</span></div>
              <input type="file" id="msgAvatarInput" accept="image/*" style="display:none">
            </div>
            <div class="msg-form-group">
              <label class="msg-form-label">姓名</label>
              <input type="text" class="msg-form-input" id="msgCharacterName" placeholder="输入角色姓名" required>
            </div>
            <div class="msg-form-group">
              <label class="msg-form-label">昵称</label>
              <input type="text" class="msg-form-input" id="msgCharacterNickname" placeholder="输入角色昵称">
            </div>
            <div class="msg-form-group">
              <label class="msg-form-label">人设</label>
              <textarea class="msg-form-textarea" id="msgCharacterBio" placeholder="描述角色的性格、特点..." required></textarea>
            </div>
            <div class="msg-form-group">
  <label class="msg-form-label">允许后台活动</label>
  <label style="display:flex;align-items:center;gap:8px;color:#666;">
    <input type="checkbox" id="msgAllowBg">
    <span>到事件时间时，系统可代表该角色后台行动</span>
  </label>
</div>
            <button type="submit" class="msg-btn-primary">添加</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div id="debugBox"></div>

  <script>
  (function(){
    'use strict';

    /* ========= 调试 ========= */
    var debugBox = document.getElementById('debugBox');
    function log(m){ try{var t=new Date().toTimeString().slice(0,8); (debugBox||{}).innerHTML+=(t+' '+m+'\n'); if(debugBox) debugBox.scrollTop=debugBox.scrollHeight;}catch(e){} }

    /* ========= 小工具 ========= */
    function esc(s){ return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function attr(s){ return String(s ?? '').replace(/"/g,'&quot;'); }
    function text(s){ return String(s ?? ''); }
    function isImg(s){ return typeof s==='string' && (s.startsWith('data:') || s.startsWith('http')); }
    function fileToDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }

    /* ========= 角色仓库（聊天列表使用） ========= */
    var STORAGE_KEY='eg_characters_v2';
    var msgCharacters=[]; var touchStartX=0, touchCurrentX=0;

    function notifyCharsUpdated(){ try{ localStorage.setItem('eg_evt_chars', String(Date.now())); }catch(_){} window.dispatchEvent(new CustomEvent('eg:charsUpdated')); }
    function loadChars(){
      try{
        var s=localStorage.getItem(STORAGE_KEY);
        msgCharacters = s?JSON.parse(s):[{kind:'char',id:'nash',name:'Nash',nickname:'Nash',bio:'天真开朗的小狐狸',avatar:'🦊',lastTime:'12:00'}];
        if(!s) saveChars();
      }catch(e){ msgCharacters=[]; }
    }
    function saveChars(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(msgCharacters)); }catch(e){} notifyCharsUpdated(); }

    function renderList(){
      var list = document.getElementById('msgChatList'); if(!list) return;
      var listData = msgCharacters.filter(c => c && c.kind !== 'identity');
      if (!listData.length) {
        list.innerHTML = '<div style="padding:20px;text-align:center;color:#999">暂无角色</div>';
        return;
      }
      list.innerHTML = listData.map(c => {
        var av = c.avatar || '👤';
        var avatarHTML = (typeof av === 'string' && (av.indexOf('data:') === 0 || av.indexOf('http') === 0))
          ? '<img src="'+ av +'">' : av;

        return /* html */ `
          <div class="msg-chat-item-wrapper">
            <div class="msg-swipe-actions">
              <div class="msg-swipe-action reset" data-id="${c.id}">重置</div>
              <div class="msg-swipe-action delete" data-id="${c.id}">删除</div>
            </div>
            <div class="msg-chat-item" data-id="${c.id}">
              <div class="msg-chat-avatar">${avatarHTML}</div>
              <div class="msg-chat-content">
                <div class="msg-chat-header">
                  <div class="msg-chat-name">${esc(c.nickname || c.name)}</div>
                  <div class="msg-chat-time">${esc(c.lastTime || '')}</div>
                </div>
                <div class="msg-chat-preview">${esc(c.lastMsg || c.bio || '')}</div>
              </div>
            </div>
          </div>`;
      }).join('');
      bindChatEvents();
    }

    function bindChatEvents(){
      document.querySelectorAll('.msg-chat-item').forEach(el=>{
        el.addEventListener('click', function(){
          if (Math.abs(touchStartX - touchCurrentX) < 10){
            var id=this.dataset.id||'nash'; sessionStorage.setItem('currentChatId', id);
            if (window.openAppPage) window.openAppPage('message-detail.html?id='+encodeURIComponent(id));
            else location.href='message-detail.html?id='+encodeURIComponent(id);
          }
        });
        el.addEventListener('touchstart',e=>{touchStartX=e.touches[0].clientX; touchCurrentX=touchStartX;});
        el.addEventListener('touchmove',e=>{touchCurrentX=e.touches[0].clientX; var d=touchStartX-touchCurrentX; if(d>0&&d<150){ el.style.transform='translateX(-'+d+'px)'; el.style.transition='none'; }});
        el.addEventListener('touchend',()=>{ var d=touchStartX-touchCurrentX; el.style.transition='transform .3s ease'; el.style.transform=d>75?'translateX(-150px)':'translateX(0)'; });
      });
      document.querySelectorAll('.msg-swipe-action').forEach(btn=>{
        btn.addEventListener('click',e=>{
          e.stopPropagation();
          var id=btn.dataset.id; var del=btn.classList.contains('delete');
          if(del){ if(confirm('确定删除？')){ msgCharacters=msgCharacters.filter(c=>c.id!==id); saveChars(); renderList(); } }
          else{ if(confirm('确定重置聊天记录？')) alert('聊天记录已重置'); }
        });
      });
    }

    /* ========= 我（身份卡）——互斥绑定 + 下拉多选 + 即时保存 ========= */
    (function(){
      const LS_ID='eg_user_identities_v1', LS_CHAR='eg_characters_v2';
      const $=s=>document.querySelector(s); const idCarousel=$('#idCarousel'); const dots=$('#dots');

      function load(k){ try{ return JSON.parse(localStorage.getItem(k)||''); }catch(e){ return null; } }
      function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
      function uid(){ return 'u_' + Math.random().toString(36).slice(2,8) + Date.now().toString(36).slice(-4); }
      function broadcast(){ window.dispatchEvent(new CustomEvent('eg:identitiesUpdated')); localStorage.setItem('eg_evt_ping', String(Date.now())); }

      let identities=load(LS_ID)||[];
      let chars=load(LS_CHAR)||[];
      let editingId = null;

      if(!Array.isArray(identities)||identities.length===0){
        identities=[{kind:'identity',id:uid(),name:'User',nickname:'我',avatar:'👤',bio:'',boundCharIds:[]}];
        save(LS_ID,identities);
      }

      function ownerOf(charId){
        for(const idt of identities){ if(idt.boundCharIds && idt.boundCharIds.includes(charId)) return idt.id; }
        return identities[0]?.id;
      }

      function refreshBindings(){
        if(!identities.length) return;
        const def=identities[0];
        const allCharIds=(chars||[]).map(c=>c.id);
        const taken=new Set();
        identities.slice(1).forEach(u=>(u.boundCharIds||[]).forEach(cid=>taken.add(cid)));
        def.boundCharIds = allCharIds.filter(cid=>!taken.has(cid));
        save(LS_ID,identities);
      }

      refreshBindings(); render();

      async function copyText(t){ try{ await navigator.clipboard.writeText(t); return true; }catch(_){ return false; } }
      function isIOS(){ return /iP(hone|ad|od)/.test(navigator.userAgent); }
      async function doExport(){
        const json=JSON.stringify(identities,null,2);
        if(isIOS()){ if(navigator.share){ try{ await navigator.share({title:'eg_user_identities.json', text:json}); return; }catch(_){}} const ok=await copyText(json); alert(ok?'已复制到剪贴板（iOS 无法直接下载）':'复制失败'); return; }
        const blob=new Blob([json],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='eg_user_identities.json'; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},1000);
      }
      function doImport(){
        const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
        inp.onchange=async()=>{ const f=inp.files[0]; if(!f) return; try{ const txt=await f.text(); const arr=JSON.parse(txt);
            if(Array.isArray(arr)){ identities=arr.map(n=>({kind:'identity',id:n.id||uid(),name:n.name||'',nickname:n.nickname||'',bio:n.bio||'',avatar:n.avatar||'👤',boundCharIds:Array.isArray(n.boundCharIds)?n.boundCharIds:[] })); save(LS_ID,identities); refreshBindings(); render(); broadcast(); }
          }catch(e){ alert('导入失败：JSON 格式错误'); } };
        inp.click();
      }

      window.openIdentityEditor=function(){
        const u={kind:'identity',id:uid(),name:'',nickname:'',avatar:'👤',bio:'',boundCharIds:[]};
        identities.push(u); save(LS_ID,identities); refreshBindings(); render(); setTimeout(()=> setCardEditing(u.id,true),0);
      };

      function writeField(uid, key, val){
        const u = identities.find(x => x.id === uid);
        if (!u) return;
        u[key] = val;
        localStorage.setItem(LS_ID, JSON.stringify(identities));
      }

      function render(){
        if(!idCarousel) return;
        idCarousel.innerHTML = identities.map(renderCard).join('');
        dots.innerHTML = identities.map((_,i)=>`<div class="dot ${i===0?'active':''}"></div>`).join('');
        bindCardEvents();
        idCarousel.addEventListener('scroll', onScrollSnap, {passive:true});
        onScrollSnap();
        if (editingId) setCardEditing(editingId, true);
      }

      function renderCard(u){
        const isDefault = identities[0] && identities[0].id===u.id;
        const avHTML = isImg(u.avatar) ? `<img src="${u.avatar}">` : esc(u.avatar || '👤');

        const boundCount = (Array.isArray(chars)?chars:[]).filter(c => ownerOf(c.id) === u.id).length;
        const options = (Array.isArray(chars)?chars:[]).map(c=>{
          const ownerId = ownerOf(c.id);
          const active  = ownerId === u.id;
          const face = isImg(c.avatar)?`<img src="${c.avatar}">`:esc(c.avatar||'👤');
          const ownerName = (ownerId && identities.find(x=>x.id===ownerId))?.nickname || '';
          return `
            <label class="combo-opt" data-char="${c.id}">
              <input type="checkbox" ${active?'checked':''}>
              <span class="av">${face}</span>
              <span>${esc(c.nickname||c.name||c.id)}${active?'':(' <small>（归属：'+esc(ownerName||'默认')+'）</small>')}</span>
            </label>`;
        }).join('');

        return `
        <article class="id-card" data-id="${u.id}">
          <div class="id-avatar">${avHTML}</div>
          <div class="id-meta">
            <div>
              <h3>${esc(u.nickname||u.name||'未命名')}${isDefault?'<span class="badge">默认</span>':''}</h3>
              <div class="nick" style="font-size:12px;color:#666">${esc(u.name||'')}</div>
            </div>
            <div class="meta-right">
              <button class="mini" data-act="import">导入</button>
              <button class="mini" data-act="export">导出</button>
            </div>
          </div>

          <div class="id-field">
            <div class="label">姓名</div>
            <input class="input" data-k="name" value="${attr(u.name)}" readonly>
          </div>
          <div class="id-field">
            <div class="label">昵称</div>
            <input class="input" data-k="nickname" value="${attr(u.nickname)}" readonly>
          </div>
          <div class="id-field">
            <div class="label">设定</div>
            <textarea class="textarea" data-k="bio" readonly>${text(u.bio)}</textarea>
          </div>

          <div class="bind-section">
            <div class="bind-title">绑定的角色（互斥：一个角色不能绑定多个身份）</div>
            <div class="bind-combo" data-id="${u.id}">
              <button class="combo-btn" type="button">${boundCount} 个角色已绑定 ▾</button>
              <div class="combo-panel">${options || '（暂无角色，可在“消息”页添加）'}</div>
            </div>
          </div>

          <div class="card-actions">
            <button class="btn" data-act="edit">编辑</button>
            <button class="btn primary" data-act="save" disabled>保存</button>
            <button class="btn warn" data-act="remove"${isDefault?' disabled':''}>删除</button>
          </div>
        </article>`;
      }

      function setCardEditing(id,on){
        const card=idCarousel.querySelector(`.id-card[data-id="${id}"]`); if(!card) return;
        card.querySelectorAll('.input,.textarea').forEach(el=>{ el.readOnly=!on; });
        const saveBtn=card.querySelector('[data-act="save"]'); const editBtn=card.querySelector('[data-act="edit"]');
        if(saveBtn) saveBtn.disabled=!on; if(editBtn) editBtn.disabled=on;
        editingId = on ? id : null;
      }

      function bindCardEvents(){
        idCarousel.querySelectorAll('.bind-combo .combo-btn').forEach(btn=>{
          btn.addEventListener('click', (e)=>{
            e.stopPropagation();
            const panel = btn.nextElementSibling;
            idCarousel.querySelectorAll('.combo-panel.show').forEach(p=>{ if(p!==panel) p.classList.remove('show'); });
            panel.classList.toggle('show');
          });
        });
        document.addEventListener('click', ()=>{ idCarousel.querySelectorAll('.combo-panel.show').forEach(p=>p.classList.remove('show')); });

        idCarousel.querySelectorAll('.combo-panel .combo-opt input[type="checkbox"]').forEach(chk=>{
          chk.addEventListener('change', (e)=>{
            const opt = e.target.closest('.combo-opt');
            const card = e.target.closest('.id-card');
            const targetId = card.dataset.id;
            const charId = opt.dataset.char;
            const defId = identities[0].id;
            const curOwner = (function(){
              for(const idt of identities){ if(idt.boundCharIds && idt.boundCharIds.includes(charId)) return idt.id; }
              return defId;
            })();

            if (e.target.checked){
              if (curOwner && curOwner !== defId && curOwner !== targetId){
                const owner = identities.find(x=>x.id===curOwner);
                const name = owner?.nickname || owner?.name || '该身份';
                if (!confirm(`此角色绑定了 ${name} 身份，是否切换绑定？`)){
                  e.target.checked = false; return;
                }
                owner.boundCharIds = (owner.boundCharIds||[]).filter(id=>id!==charId);
              }
              if (targetId !== defId){
                const tar = identities.find(x=>x.id===targetId);
                tar.boundCharIds = tar.boundCharIds || [];
                if (!tar.boundCharIds.includes(charId)) tar.boundCharIds.push(charId);
              }
            }else{
              if (targetId !== defId){
                const tar = identities.find(x=>x.id===targetId);
                tar.boundCharIds = (tar.boundCharIds||[]).filter(id=>id!==charId);
              }else{
                e.target.checked = true; return;
              }
            }

            localStorage.setItem(LS_ID, JSON.stringify(identities));
            refreshBindings();
            render();
            broadcast();
          });
        });

        idCarousel.querySelectorAll('.id-card').forEach(card=>{
          const uid=card.dataset.id;

          card.querySelector('[data-act="edit"]').addEventListener('click', ()=> setCardEditing(uid,true));

          card.querySelector('[data-act="save"]').addEventListener('click', ()=>{
            const u=identities.find(x=>x.id===uid);
            u.name=card.querySelector('[data-k="name"]').value.trim();
            u.nickname=card.querySelector('[data-k="nickname"]').value.trim();
            u.bio=card.querySelector('[data-k="bio"]').value.trim();
            setCardEditing(uid, false);
            editingId = null;
            localStorage.setItem(LS_ID, JSON.stringify(identities));
            render();
            broadcast();
          });

          const rm=card.querySelector('[data-act="remove"]');
          rm && rm.addEventListener('click', ()=>{
            if (identities[0] && identities[0].id===uid){ alert('默认身份卡不可删除'); return; }
            if (!confirm('确认删除该身份卡？')) return;
            identities=identities.filter(x=>x.id!==uid);
            localStorage.setItem(LS_ID, JSON.stringify(identities));
            refreshBindings(); render(); broadcast();
          });

          card.querySelector('[data-act="import"]').addEventListener('click', doImport);
          card.querySelector('[data-act="export"]').addEventListener('click', doExport);

          card.querySelector('.id-avatar').addEventListener('click', ()=>{
            const editable = !card.querySelector('.input').readOnly; if(!editable) return;
            const inp=document.createElement('input'); inp.type='file'; inp.accept='image/*';
            inp.onchange=async()=>{ const f=inp.files[0]; if(!f) return; const b64=await fileToDataURL(f);
              writeField(uid, 'avatar', b64); render(); broadcast();
            };
            inp.click();
          });

          card.querySelectorAll('[data-k]').forEach(el=>{
            el.addEventListener('input', ()=>{
              writeField(uid, el.getAttribute('data-k'), el.value);
              const saveBtn=card.querySelector('[data-act="save"]'); if(saveBtn) saveBtn.disabled=false;
            });
          });
        });
      }

      function computeActiveIndex(){
        const cards = Array.from(idCarousel.querySelectorAll('.id-card'));
        if (!cards.length) return 0;
        const viewportCenter = idCarousel.scrollLeft + idCarousel.clientWidth / 2;
        let minDist = Infinity, active = 0;
        cards.forEach((card, idx) => {
          const center = card.offsetLeft + card.offsetWidth/2;
          const d = Math.abs(center - viewportCenter);
          if (d < minDist) { minDist = d; active = idx; }
        });
        return active;
      }
      function onScrollSnap(){
        const active = computeActiveIndex();
        const all = dots.querySelectorAll('.dot');
        all.forEach((d,i)=>d.classList.toggle('active', i===active));
      }

      function syncChars(){ chars = JSON.parse(localStorage.getItem(LS_CHAR) || '[]'); refreshBindings(); render(); }
      window.addEventListener('eg:charsUpdated', syncChars);
      window.addEventListener('storage', e=>{ if(e.key==='eg_evt_chars') syncChars(); });
    })();

    /* ========= 事件仓库 / 倒计时 / 触发（唯一版） ========= */
    const LS_EVENTS = 'eg_events_v1';
    const LS_CHARS  = 'eg_characters_v2';
    const LS_IDS    = 'eg_user_identities_v1';
    const LS_THREADS= 'eg_threads_v1';
    const LS_BGQ    = 'eg_bg_queue_v1';

    function loadJSON(k, def){ try{ return JSON.parse(localStorage.getItem(k)||''); }catch(_){ return def; } }
    function saveJSON(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
    function uidEvt(){ return 'e_' + Math.random().toString(36).slice(2,10); }

    function parseTimeToTs(s){
      if(!s) return null;
      const t = s.replace('T',' ').replace(/\//g,'-');
      const iso = t.match(/^\d{4}-\d{2}-\d{2}/) ? t : null;
      const d = iso ? new Date(t.replace(' ', 'T')) : new Date(s);
      const ts = d.getTime();
      return isNaN(ts) ? null : ts;
    }
    function nextOccurrence(ev, fromTs){
      const base = parseTimeToTs(ev.time) ?? Date.now();
      if (ev.freq === 'once') return base;
      const d = new Date(Math.max(base, fromTs || Date.now()));
      if (ev.freq==='day')  { d.setDate(d.getDate() + (parseTimeToTs(ev.time) && fromTs>base ? 1 : 0)); }
      if (ev.freq==='week') { d.setDate(d.getDate() + (parseTimeToTs(ev.time) && fromTs>base ? 7 : 0)); }
      if (ev.freq==='month'){ d.setMonth(d.getMonth()+ (parseTimeToTs(ev.time) && fromTs>base ? 1 : 0)); }
      if (ev.freq==='year') { d.setFullYear(d.getFullYear()+ (parseTimeToTs(ev.time) && fromTs>base ? 1 : 0)); }
      return d.getTime();
    }
    function humanCountdown(ts){
      if (ts==null) return '（未设置时间）';
      const d = ts - Date.now();
      const neg = d<0;
      const sec = Math.abs(Math.floor(d/1000));
      const dd = Math.floor(sec/86400);
      const hh = Math.floor((sec%86400)/3600);
      const mm = Math.floor((sec%3600)/60);
      const ss = sec%60;
      const txt = `${dd}天${hh}小时${mm}分${ss}秒`;
      return neg ? `已过期 ${txt}` : `倒计时：${txt}`;
    }

    function renderEvents(){
      const events = loadJSON(LS_EVENTS, []) || [];
      const ids = loadJSON(LS_IDS, []) || [];
      const chars = loadJSON(LS_CHARS, []) || [];

      const agWrap = document.getElementById('evtAgreements');
      const ntWrap = document.getElementById('evtNotes');

      function whoName(identityId){
        const i = (ids||[]).find(x=>x.id===identityId);
        return i ? (i.nickname||i.name||'我') : '我';
      }
      function charsNames(arr){
        return (arr||[]).map(cid=>{
          const c=chars.find(x=>x.id===cid);
          return c?(c.nickname||c.name||'角色'):('角色');
        }).join('、');
      }

      function row(ev){
        const nextAt = nextOccurrence(ev);
        return `
          <div class="card" style="background:#fff;border-radius:12px;margin:0 0 10px;overflow:hidden;">
            <div class="row" style="padding:12px 12px;">
              <div style="flex:1;">
                <div style="font-size:15px;color:#111;font-weight:600;">${esc(ev.name)}</div>
                <div style="font-size:12px;color:#6d6d72;margin-top:4px;">
                  ${ev.type==='agreement'
                    ? `我的身份：${esc(whoName(ev.identityId))} ・ 角色：${esc(charsNames(ev.charIds||[]))}`
                    : `我的身份：${esc(whoName(ev.identityId))} ・ 可见角色：${esc(charsNames(ev.visibleCharIds||[]))}`
                  } ・ 频次：${ev.freq}
                </div>
                <div data-countdown="${ev.id}" style="font-size:12px;color:#1677ff;margin-top:6px;">${humanCountdown(nextAt)}</div>
              </div>
              <div>
                <button class="mini" data-evtid="${ev.id}" data-act="edit">编辑</button>
                <button class="mini" data-evtid="${ev.id}" data-act="del" style="background:#ff3b30;color:#fff;">删除</button>
              </div>
            </div>
          </div>`;
      }

      const AG = events.filter(x=>x.type==='agreement').sort((a,b)=> (nextOccurrence(a)||Infinity)-(nextOccurrence(b)||Infinity));
      const NT = events.filter(x=>x.type==='note').sort((a,b)=> (nextOccurrence(a)||Infinity)-(nextOccurrence(b)||Infinity));

      agWrap.innerHTML = AG.map(row).join('') || `<div style="padding:10px;color:#999;">暂无</div>`;
      ntWrap.innerHTML = NT.map(row).join('') || `<div style="padding:10px;color:#999;">暂无</div>`;

      document.querySelectorAll('[data-evtid][data-act]').forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.getAttribute('data-evtid');
          const act= btn.getAttribute('data-act');
          if (act==='del'){
            const arr = (loadJSON(LS_EVENTS,[])||[]).filter(x=>x.id!==id);
            saveJSON(LS_EVENTS, arr);
            renderEvents();
          }else if (act==='edit'){
            openEventEditor(id);
          }
        };
      });
    }

    setInterval(()=>{
      document.querySelectorAll('[data-countdown]').forEach(el=>{
        const id=el.getAttribute('data-countdown');
        const ev=(loadJSON(LS_EVENTS,[])||[]).find(x=>x.id===id);
        if(!ev){ el.textContent='已删除'; return; }
        el.textContent = humanCountdown(nextOccurrence(ev));
      });
    }, 1000);

    setInterval(checkAndFireEvents, 30*1000);
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) checkAndFireEvents(); });

    function checkAndFireEvents(){
      const events = loadJSON(LS_EVENTS, []) || [];
      const chars  = loadJSON(LS_CHARS,  []) || [];
      const now = Date.now();
      let changed=false;

      function charAllow(cid){
        const c = chars.find(x=>x.id===cid);
        return !!(c && c.allowBG === true);
      }

      const queue = loadJSON(LS_BGQ, []) || [];

      for (const ev of events){
        const at = nextOccurrence(ev);
        if (at==null) continue;
        const due = now >= at && (!ev.lastFireAt || ev.lastFireAt < at);
        if (!due) continue;

        if (ev.type==='agreement'){
          (ev.charIds||[]).forEach(cid=>{
            if (!charAllow(cid)) return;
            queue.push({
              id: 'q_'+uidEvt(),
              charId: cid,
              prompt: `现在是与你和${ev.identityName||'用户'}约好的「${ev.name}」时间。请以该角色的语气给对方发一段合适的开场问候/提醒。`,
              ts: at
            });
            insertUserSideSystemLine(cid, `（系统）已到约定时间：${ev.name}`, at);
          });
        }else{
          (ev.visibleCharIds||[]).forEach(cid=>{
            if (!charAllow(cid)) return;
            queue.push({
              id: 'q_'+uidEvt(),
              charId: cid,
              prompt: `${ev.identityName||'用户'}曾提到今天是「${ev.name}」。请站在角色视角、以他的性格对${ev.identityName||'用户'}表达合适的关心/祝福（1-3句）。`,
              ts: at
            });
            insertUserSideSystemLine(cid, `（系统）提醒：${ev.name}`, at);
          });
        }

        ev.lastFireAt = at;
        changed=true;
      }

      if (changed) saveJSON(LS_EVENTS, events);
      if (queue.length){ saveJSON(LS_BGQ, queue); localStorage.setItem('eg_bg_queue_ping', String(Date.now())); }
    }

    function insertUserSideSystemLine(charId, text, ts){
      const threads = loadJSON(LS_THREADS, {}) || {};
      const t = threads[charId] || (threads[charId] = {id:charId, messages:[]});
      t.messages.push({ role:'user', content:text, ts: ts||Date.now(), meta:{system:true, auto:true} });
      saveJSON(LS_THREADS, threads);

      const list = loadJSON(LS_CHARS, [])||[];
      const it   = list.find(c=>c.id===charId);
      if (it){ it.lastTime = new Date(ts||Date.now()).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}); saveJSON(LS_CHARS, list); }
    }

    /* ---- 事件编辑器（唯一） ---- */
    let editingEvtId = null;
    function openEventEditor(id){
      const modal = document.getElementById('evtModal');
      const form  = document.getElementById('evtForm');
      const selType = document.getElementById('evtType');
      const selIdt  = document.getElementById('evtIdentity');
      const selFreq = document.getElementById('evtFreq');
      const iptTime = document.getElementById('evtTime');
      const iptName = document.getElementById('evtName');
      const boxChars= document.getElementById('evtCharsBox');

      const ids = loadJSON(LS_IDS, [])||[];
      const chars = loadJSON(LS_CHARS, [])||[];
      const data = loadJSON(LS_EVENTS, [])||[];

      selIdt.innerHTML = `<option value="">（默认身份）</option>` + (ids||[]).map(i=>`<option value="${i.id}">${esc(i.nickname||i.name||'我')}</option>`).join('');

      boxChars.innerHTML = (chars||[]).map(c=>{
        const face = (typeof c.avatar==='string' && (c.avatar.startsWith('http')||c.avatar.startsWith('data:')))? `<img src="${c.avatar}" style="width:18px;height:18px;border-radius:50%;object-fit:cover;">` : (c.avatar||'👤');
        return `<label style="display:flex;align-items:center;gap:8px;background:#fff;border-radius:10px;padding:8px 10px;">
          <input type="checkbox" value="${c.id}"><span>${face}</span><span>${esc(c.nickname||c.name||'角色')}</span></label>`;
      }).join('');

      editingEvtId = id || null;
      let ev = id ? (data.find(x=>x.id===id)||null) : null;
      if (ev){
        selType.value = ev.type;
        selIdt.value  = ev.identityId || '';
        selFreq.value = ev.freq || 'once';
        iptTime.value = ev.time || '';
        iptName.value = ev.name || '';
        const sel = new Set((ev.type==='agreement'?ev.charIds:ev.visibleCharIds)||[]);
        boxChars.querySelectorAll('input[type=checkbox]').forEach(chk=>{ chk.checked = sel.has(chk.value); });
      }else{
        selType.value='agreement'; selIdt.value=''; selFreq.value='once'; iptTime.value=''; iptName.value='';
        boxChars.querySelectorAll('input[type=checkbox]').forEach(chk=>{ chk.checked=false; });
      }

      modal.classList.add('show');
      document.getElementById('evtClose').onclick = ()=> modal.classList.remove('show');

      form.onsubmit = (e)=>{
        e.preventDefault();
        const evts = loadJSON(LS_EVENTS, [])||[];
        const identityId = selIdt.value || null;
        const ids = loadJSON(LS_IDS, [])||[];
        const identityName = (ids.find(x=>x.id===identityId) || ids[0] || {nickname:'我'}).nickname || '我';

        const selected = Array.from(boxChars.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value);
        const obj = {
          id: editingEvtId || uidEvt(),
          type: selType.value, // agreement | note
          identityId,
          identityName,
          charIds: selType.value==='agreement' ? selected : [],
          visibleCharIds: selType.value==='note' ? selected : [],
          freq: selFreq.value,
          time: (iptTime.value||'').trim() || null,
          name: (iptName.value||'').trim(),
          lastFireAt: null
        };
        if (selType.value==='agreement' && (!obj.charIds || obj.charIds.length===0)){
          alert('“我们的约定”需选择涉及角色'); return;
        }

        if (editingEvtId){
          const i = evts.findIndex(x=>x.id===editingEvtId);
          if (i>=0) evts[i]=obj;
        }else{
          evts.push(obj);
        }
        saveJSON(LS_EVENTS, evts);
        modal.classList.remove('show');
        renderEvents();
      };
    }

    /* ========= 顶栏标题 / Tab 切换 / ＋按钮 ========= */
    var EG_CURRENT_TAB='chat';
    function setTopTitle(t){ var el=document.getElementById('topTitle'); if(el) el.textContent=t; }
    function updateAddButtonForTab(){
      var addBtn=document.getElementById('addBtn'); if(!addBtn) return;
      var map={chat:'新建角色', me:'新建身份', moments:'发动态', events:'添加事件'};
      addBtn.setAttribute('aria-label', map[EG_CURRENT_TAB]||'新建');
    }
    function initTabs(){
      const items=document.querySelectorAll('.msg-tab-item');
      const viewChat=document.getElementById('msgChatList');
      const viewMe  =document.getElementById('tab-me');
      const viewEvt =document.getElementById('tab-events');

      function show(name){
        EG_CURRENT_TAB=name;
        if(viewChat) viewChat.style.display = (name==='chat') ? 'block':'none';
        if(viewEvt)  viewEvt.style.display  = (name==='events') ? 'block' : 'none';
        if(viewMe)   viewMe.style.display   = (name==='me') ? 'block':'none';
        setTopTitle(name==='me' ? '我的身份卡' : (name==='events'?'事件':'消息'));
        updateAddButtonForTab();
        items.forEach(el=>el.classList.remove('active'));
        if(name==='chat')   items[0]?.classList.add('active');
        if(name==='events') items[1]?.classList.add('active');
        if(name==='me')     items[3]?.classList.add('active');
      }
      items[0]?.addEventListener('click', ()=>show('chat'));
      items[1]?.addEventListener('click', ()=>{ show('events'); renderEvents(); });
      items[2]?.addEventListener('click', ()=>alert('朋友圈：开发中'));
      items[3]?.addEventListener('click', ()=>show('me'));
      show('chat');
      document.getElementById('evtAddBtn')?.addEventListener('click', ()=>openEventEditor(null));
      window.EGTab=Object.assign(window.EGTab||{},{show});
    }
    function onGlobalAdd(){
      switch(EG_CURRENT_TAB){
        case 'chat':    showModal(); break;
        case 'events':  openEventEditor(null); break;
        case 'me':      window.openIdentityEditor?.(); break;
        default:        showModal();
      }
    }

    /* ========= 模态框与初始化 ========= */
    function showModal(){ document.getElementById('msgAddModal')?.classList.add('show'); }
    function init(){
      document.getElementById('backBtn')?.addEventListener('click', ()=>{ if(window.closeApp) window.closeApp(); else if(history.length>1) history.back(); else location.href='../index.html'; });

      loadChars(); renderList();

      document.getElementById('closeModalBtn')?.addEventListener('click', ()=>document.getElementById('msgAddModal').classList.remove('show'));
      document.getElementById('msgAddModal')?.addEventListener('click', e=>{ if(e.target.id==='msgAddModal') e.currentTarget.classList.remove('show'); });
      var up=document.getElementById('msgAvatarUpload'), inp=document.getElementById('msgAvatarInput');
      if(up&&inp){ up.addEventListener('click',()=>inp.click()); inp.addEventListener('change',e=>{ var f=e.target.files[0]; if(!f) return; var r=new FileReader(); r.onload=ev=>{ up.innerHTML='<img src="'+ev.target.result+'">'; }; r.readAsDataURL(f); }); }
      var form=document.getElementById('msgCharacterForm');
      if(form){
        form.addEventListener('submit',e=>{
          e.preventDefault();
          var name=document.getElementById('msgCharacterName').value.trim();
          var nickname=document.getElementById('msgCharacterNickname').value.trim()||name;
          var bio=document.getElementById('msgCharacterBio').value.trim();
          var img=up?up.querySelector('img'):null; var avatar=img?img.src:'👤';
          var allowBG = document.getElementById('msgAllowBg')?.checked || false;
var newChar={
  kind:'char',
  id:String(Date.now()),
  name,
  nickname,
  bio,
  avatar,
  allowBG,          // ★
  lastMsg:'',       // ★ 用于列表预览
  lastTime:new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})
};
          msgCharacters.push(newChar); saveChars(); renderList(); document.getElementById('msgAddModal').classList.remove('show');
        });
      }

      var addBtn=document.getElementById('addBtn');
      if(addBtn){ addBtn.addEventListener('click', onGlobalAdd); updateAddButtonForTab(); }

      initTabs();
    }

    if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
  })();
  </script>
</body>
</html>
