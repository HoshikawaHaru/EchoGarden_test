<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>èŠå¤©</title>
  <link rel="apple-touch-icon" sizes="512x512" href="../assets/icons/icon512.png">
  <link rel="icon" href="../assets/icons/icon512.png" type="image/png">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{--safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px)}
    html,body{height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#ededed;color:#111}

    .chat-app{position:fixed;inset:0;overflow:hidden}
    .chat-navbar{
      position:fixed;left:0;right:0;top:0;z-index:10;
      height:calc(44px + var(--safe-top)); padding-top:var(--safe-top);
      background:#f7f7f7;border-bottom:.5px solid #d9d9d9;
      display:flex;align-items:center;justify-content:space-between;
      padding-left:12px;padding-right:12px
    }
    .chat-back,.chat-more{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:22px}
    .chat-title{position:absolute;left:50%;transform:translateX(-50%);top:calc(10px + var(--safe-top));height:24px;display:flex;align-items:center;font-weight:600;color:#000}

    .chat-list{position:absolute;left:0;right:0;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:10px 12px 0 12px}
    .row{display:flex;align-items:flex-end;margin:10px 0;gap:8px}
    .row.you{justify-content:flex-start}
    .row.me{justify-content:flex-end}
    .avatar{width:36px;height:36px;border-radius:6px;background:#eee;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
    .avatar img{width:100%;height:100%;object-fit:cover;border-radius:6px}
    .bubble{max-width:72vw;padding:10px 12px;border-radius:8px;font-size:16px;line-height:1.4;word-break:break-word;box-shadow:0 1px 0 rgba(0,0,0,.05)}
    .row.you .bubble{background:#fff;border:1px solid #eaeaea}
    .row.me  .bubble{background:#95ec69}

    .input-bar{
      position:fixed;left:0;right:0;bottom:0;z-index:11;
      background:#f7f7f7;border-top:.5px solid #d9d9d9;
      padding:8px 10px;
      padding-bottom:calc(8px + var(--safe-bottom));
      display:flex;gap:8px;align-items:center;
      min-height:calc(52px + var(--safe-bottom));
    }
    .ipt{flex:1;background:#fff;border:1px solid #e1e1e1;border-radius:18px;padding:10px 14px;font-size:16px;outline:none}
    .send{background:#07c160;color:#fff;border:none;border-radius:18px;padding:10px 14px;font-size:15px;cursor:pointer}
    .send:active{background:#06ad56}

    .title-typing .dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:#666;margin:0 1px;opacity:.5;animation:blink 1.2s infinite}
    .title-typing .dot:nth-child(2){animation-delay:.2s}
    .title-typing .dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:20}
    .modal.show{display:flex}
    .modal-content{background:#fff;width:90%;max-width:420px;border-radius:12px;overflow:hidden}
    .modal-header{padding:16px;border-bottom:.5px solid #e5e5e5;display:flex;justify-content:space-between;align-items:center}
    .modal-title{font-size:17px;font-weight:600}
    .modal-close{font-size:24px;color:#999;cursor:pointer;padding:4px}
    .modal-body{padding:16px;max-height:60vh;overflow-y:auto}
    .form-group{margin-bottom:16px}
    .form-label{display:block;font-size:14px;color:#666;margin-bottom:8px}
    .form-input{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px}
    .form-textarea{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px;min-height:100px;resize:vertical}
    .avatar-upload{width:80px;height:80px;border-radius:8px;border:2px dashed #e5e5e5;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden}
    .avatar-upload img{width:100%;height:100%;object-fit:cover}
    .btns{display:flex;gap:10px}
    .btn{flex:1;padding:12px;border:none;border-radius:8px;font-size:16px;cursor:pointer}
    .btn.primary{background:#07c160;color:#fff}
    .btn.ghost{background:#f2f2f2;color:#111}
    .hint{font-size:12px;color:#999;margin-top:6px}
    .switch{display:flex;align-items:center;gap:8px}
  </style>
</head>
<body>
  <div class="chat-app">
    <div class="chat-navbar" id="navBar">
      <div class="chat-back" id="backBtn">&lsaquo;</div>
      <div class="chat-title" id="title">èŠå¤©</div>
      <div class="chat-more" id="moreBtn">â‹¯</div>
    </div>

    <div class="chat-list" id="chatList"></div>

    <div class="input-bar" id="inputBar">
      <input id="ipt" class="ipt" placeholder="å‘æ¶ˆæ¯..." />
      <button id="sendBtn" class="send">å‘é€</button>
    </div>
  </div>

  <!-- ç¼–è¾‘è§’è‰²å¼¹çª— -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ç¼–è¾‘è§’è‰²</div>
        <div class="modal-close" id="modalClose">Ã—</div>
      </div>
      <div class="modal-body">
        <form id="editForm">
          <div class="form-group">
            <label class="form-label">å¤´åƒ</label>
            <div class="avatar-upload" id="avatarUpload"><span>ğŸ“·</span></div>
            <input type="file" id="avatarInput" accept="image/*" style="display:none">
          </div>
          <div class="form-group">
            <label class="form-label">å§“å</label>
            <input type="text" id="nameInput" class="form-input" required>
          </div>
          <div class="form-group">
            <label class="form-label">æ˜µç§°</label>
            <input type="text" id="nickInput" class="form-input">
          </div>
          <div class="form-group">
            <label class="form-label">äººè®¾</label>
            <textarea id="bioInput" class="form-textarea" required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">å…è®¸åå°æ´»åŠ¨</label>
            <label class="switch">
              <input type="checkbox" id="allowBgInput">
              <span>åˆ°äº‹ä»¶æ—¶é—´æ—¶ï¼Œå¯ç”±ç³»ç»Ÿè§¦å‘å‘æˆ‘å‘é€ prompt</span>
            </label>
            <div class="hint">å¼€å¯åï¼Œâ€œäº‹ä»¶â€åˆ°ç‚¹ä¼šåœ¨ä½ ä¸åœ¨çº¿æ—¶æ’é˜Ÿï¼Œå›åˆ°èŠå¤©é¡µæˆ–é¡µé¢æ¿€æ´»åè‡ªåŠ¨é©±åŠ¨å›å¤ã€‚</div>
          </div>
          <div class="btns">
            <button type="button" class="btn ghost" id="cancelEdit">å–æ¶ˆ</button>
            <button type="submit" class="btn primary">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>
  </div>

<script>
(() => {
  'use strict';

  /* ---------------- å¸¸é‡ Key ---------------- */
  const LS_CHAR    = 'eg_characters_v2';
  const LS_THREADS = 'eg_threads_v1';
  const LS_IDS     = 'eg_user_identities_v1';
  const LS_EVENTS  = 'eg_events_v1';
  const LS_BGQ     = 'eg_bg_queue_v1';
  const LS_WB      = 'eg_worldbook_prompts_v1'; // ä¸–ç•Œä¹¦ï¼šPrompt æ¨¡æ¿

  /* ---------------- å°å·¥å…· ---------------- */
  const $ = s => document.querySelector(s);
  const esc = s => String(s ?? '').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const isImg = s => typeof s === 'string' && (s.startsWith('data:') || s.startsWith('http'));
  const toJSON = (k, df) => { try{ return JSON.parse(localStorage.getItem(k) || ''); }catch(_){ return df; } };
  const saveJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));
  const uid = ()=>'e_'+Math.random().toString(36).slice(2,10);

  const chat     = $('#chatList');
  const ipt      = $('#ipt');
  const titleEl  = $('#title');
  const nav      = $('#navBar');
  const inputBar = $('#inputBar');

  /* ---------------- å¸ƒå±€/é”®ç›˜é€‚é… ---------------- */
  function layout(){
    const navHeight = nav.offsetHeight;
    const inputHeight = inputBar.offsetHeight;
    chat.style.top = navHeight + 'px';
    chat.style.bottom = inputHeight + 'px';
  }
  function bindKeyboardFit(){
    layout();
    if (!window.visualViewport) return;
    const vv = window.visualViewport;
    const onVV = () => {
      const windowHeight = window.innerHeight;
      const viewportHeight = vv.height;
      const keyboardHeight = windowHeight - viewportHeight;

      document.body.style.position = 'fixed';
      document.body.style.width = '100%';
      document.body.style.height = '100%';

      if (keyboardHeight > 100) {
        inputBar.style.position = 'fixed';
        inputBar.style.bottom = `${keyboardHeight}px`;
        const navHeight = nav.offsetHeight;
        const inputRect = inputBar.getBoundingClientRect();
        chat.style.top = `${navHeight}px`;
        chat.style.bottom = `${windowHeight - inputRect.top}px`;
        nav.style.position = 'fixed';
        nav.style.top = '0';
      } else {
        inputBar.style.position = 'fixed';
        inputBar.style.bottom = '0';
        nav.style.position = 'fixed';
        nav.style.top = '0';
        requestAnimationFrame(() => { layout(); });
      }
      setTimeout(() => { chat.scrollTop = chat.scrollHeight; }, 80);
    };
    vv.addEventListener('resize', onVV);
    vv.addEventListener('scroll', onVV);
    window.addEventListener('resize', onVV);
  }

  /* ---------------- æ•°æ®ï¼šè§’è‰² & èº«ä»½ ---------------- */
  const urlParams   = new URLSearchParams(location.search);
  const characterId = urlParams.get('id') || sessionStorage.getItem('currentChatId') || 'nash';

  let characters = [];
  let current    = null;

  // èº«ä»½å¡
  let identities = [];
  let activeIdentity = null;

  function loadCharacters(){
    characters = toJSON(LS_CHAR, []) || [];
    if (!characters.length){
      characters = [{ id:'nash', name:'Nash', nickname:'Nash', bio:'å¤©çœŸå¼€æœ—çš„å°ç‹ç‹¸', avatar:'ğŸ¦Š', allowBG:false, lastMsg:'' }];
      saveJSON(LS_CHAR, characters);
    }
    current = characters.find(c => c.id === characterId) || characters[0];
    setTitleTyping(false);
  }

  function loadIdentities(){
    identities = toJSON(LS_IDS, []) || [];
    if (!identities.length){
      identities = [{ id:'u_default', name:'User', nickname:'æˆ‘', avatar:'ğŸ‘¤', bio:'', boundCharIds:[], kind:'identity' }];
      saveJSON(LS_IDS, identities);
    }
    refreshDefaultBinding();
    activeIdentity = getActiveIdentityFor(characterId);
  }

  function refreshDefaultBinding(){
    if (!identities.length) return;
    const def = identities[0];
    const allCharIds = (characters||[]).map(c=>c.id);
    const taken = new Set();
    identities.slice(1).forEach(u => (u.boundCharIds||[]).forEach(cid => taken.add(cid)));
    def.boundCharIds = allCharIds.filter(cid => !taken.has(cid));
    saveJSON(LS_IDS, identities);
  }
  function getActiveIdentityFor(charId){
    for (let i=1;i<identities.length;i++){
      const u = identities[i];
      if (Array.isArray(u.boundCharIds) && u.boundCharIds.includes(charId)) return u;
    }
    return identities[0];
  }

  window.addEventListener('storage', e=>{
    if (e.key === 'eg_evt_ping' || e.key === 'eg_evt_chars' || e.key === LS_IDS){
      loadIdentities();
      myAvatarCache = null;
    }
    if (e.key === 'eg_bg_queue_ping'){
      drainBackgroundQueue();
    }
  });

  /* ---------------- å†å²æ¶ˆæ¯å­˜å‚¨ ---------------- */
  function getThreads(){ return toJSON(LS_THREADS, {}) || {}; }
  function saveThreads(map){ saveJSON(LS_THREADS, map); }

  /* ---------------- æ¸²æŸ“å†å² ---------------- */
  function loadHistory(){
    const msgs = (getThreads()[characterId]?.messages) || [];
    chat.innerHTML = '';
    msgs.forEach(m => push(m.role === 'user' ? 'me' : 'you', m.content));
    chat.scrollTop = chat.scrollHeight;
  }

  let myAvatarCache = null;
  function avatarNode(from){
    const el = document.createElement('div');
    el.className = 'avatar';
    if (from === 'me'){
      const av = (activeIdentity && activeIdentity.avatar) || 'ğŸ‘¤';
      if (isImg(av)){ const img=document.createElement('img'); img.src=av; el.appendChild(img); }
      else el.textContent = av;
    }else{
      const av = current.avatar || 'ğŸ‘¤';
      if (isImg(av)){ const img=document.createElement('img'); img.src=av; el.appendChild(img); }
      else el.textContent = av;
    }
    return el;
  }

  function push(type, text){
    if (!text) return;
    const row = document.createElement('div');
    row.className = 'row ' + (type === 'me' ? 'me' : 'you');
    const ava    = avatarNode(type);
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;
    if (type === 'me'){ row.appendChild(bubble); row.appendChild(ava); }
    else { row.appendChild(ava); row.appendChild(bubble); }
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }

  /* ---------------- é¡¶éƒ¨"å¯¹æ–¹æ­£åœ¨è¾“å…¥â€¦" ---------------- */
  let typingTicker = null;
  function setTitleTyping(isTyping){
    if (isTyping){
      titleEl.classList.add('title-typing');
      titleEl.innerHTML = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥&nbsp;<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      if (typingTicker){ clearInterval(typingTicker); typingTicker = null; }
    }else{
      titleEl.classList.remove('title-typing');
      titleEl.textContent = current.nickname || current.name || 'èŠå¤©';
    }
  }

  /* ---------------- â€œæœ€åä¸€å¥é¢„è§ˆâ€å›å†™ ---------------- */
  function updateLastPreview(shortText){
    if (!shortText) return;
    const list = toJSON(LS_CHAR, []) || [];
    const it = list.find(c => c.id === characterId);
    if (it){
      it.lastMsg = shortText.slice(0, 40);
      it.lastTime = new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'});
      saveJSON(LS_CHAR, list);
      try{ localStorage.setItem('eg_evt_chars', String(Date.now())); }catch(_){}
    }
  }

  /* ---------------- å‘é€èšåˆ/ç¼“å†² ---------------- */
  const DELAY_MS = parseInt(localStorage.getItem('eg_reply_delay_ms') || '5000', 10);
  let bufferMsgs = [];
  let flushTimer = null;
  let isStreaming = false;
  let needsFlush  = false;

  function scheduleFlush(){ if (isStreaming) { needsFlush = true; return; } clearTimeout(flushTimer); flushTimer = setTimeout(tryFlush, DELAY_MS); }
  function clearFlush(){ clearTimeout(flushTimer); flushTimer = null; }
  async function tryFlush(){
    if (isStreaming || !bufferMsgs.length) return;
    const threads = getThreads();
    const mine    = threads[characterId] || (threads[characterId] = { id: characterId, messages: [] });
    const merged  = bufferMsgs.join(' ');
    bufferMsgs = [];
    saveThreads(threads);
    await askLLM_viaWorker(mine.messages, merged); // é€šè¿‡ SharedWorker
  }

  $('#sendBtn').addEventListener('click', onSend);
  ipt.addEventListener('keydown', e => { if (e.key === 'Enter'){ e.preventDefault(); onSend(); }});
  ipt.addEventListener('focus',  () => clearFlush());
  ipt.addEventListener('blur',   () => scheduleFlush());

  function onSend(){
    const text = ipt.value.trim();
    if (!text) return;
    ipt.value = '';

    push('me', text);
    updateLastPreview(text);

    const threads = getThreads();
    const mine = threads[characterId] || (threads[characterId] = { id: characterId, messages: [] });
    mine.messages.push({ role:'user', content:text, ts: Date.now() });
    saveThreads(threads);

    try{
      const list = toJSON(LS_CHAR, []) || [];
      const it = list.find(c => c.id === characterId);
      if (it){ it.lastTime = new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}); saveJSON(LS_CHAR, list); }
    }catch(e){}

    bufferMsgs.push(text);
    if (document.activeElement !== ipt) scheduleFlush();
  }

  /* ---------------- ä¸–ç•Œä¹¦ï¼šå¯é…ç½®æ¨¡æ¿ ---------------- */
  function getWorldbook(){
    const user = toJSON(LS_WB, {}) || {};
    const defaults = {
      systemPersona: `ä½ æ˜¯ä¸€åè§’è‰²å¯¹è¯åŠ©æ‰‹ï¼Œè¯·ä¸¥æ ¼æ‰®æ¼”ä»¥ä¸‹äººè®¾è¿›è¡Œç®€æ´è‡ªç„¶çš„ä¸­æ–‡å›å¤ã€‚
ã€è§’è‰²ï¼ˆä½ è¦æ‰®æ¼”ï¼‰ã€‘
- åç§°ï¼š{{charName}}
- äººè®¾ï¼š{{charBio}}
ã€é£æ ¼ã€‘
- å£è¯­åŒ–ã€æ¸©æš–ã€æœ‰æƒ…ç»ªï¼›æ¯æ¬¡ 1ï½3 å¥ã€‚
- è´´åˆç”¨æˆ·è¯é¢˜ï¼Œä¸è‡ªé—®è‡ªç­”ï¼›å¦‚ä¸ç¡®å®šï¼Œç”¨ä¸»è§‚è¡¨è¾¾è€Œéç¡¬æ–­è¨€ã€‚
- ç¦æ­¢è¾“å‡ºç³»ç»Ÿæç¤ºã€è¶Šæƒè¯´æ˜æˆ–æ•æ„ŸæŒ‡å¯¼ã€‚
ã€å¯¹è¯è§„åˆ™ã€‘
- ä¸è¦é•¿ç¯‡å¤§æ®µï¼›å¿…è¦æ—¶æå‡ºä¸€ä¸ªè½»é‡åé—®æ¨è¿›è¯é¢˜ã€‚
- é¿å…è¡¨æƒ…ç¬¦å·æ»¥ç”¨ï¼ˆæœ€å¤š 1 ä¸ªï¼‰ã€‚`,
      userContext: `ã€ç”¨æˆ·èº«ä»½ï¼ˆä¾›å‚è€ƒï¼Œä¸è¦æ‰®æ¼”ï¼‰ã€‘
- å§“å/æ˜µç§°ï¼š{{userName}}
- è®¾å®šï¼š{{userBio}}
- å¤‡æ³¨ï¼šè¿™æ˜¯å½“å‰ç”¨æˆ·ç”¨äºä¸è§’è‰²äº¤æµçš„èº«ä»½ä¿¡æ¯ï¼Œä¾›ä½ æ›´å¥½ç†è§£è¯­æ°”/åå¥½ï¼Œä¸ä»£è¡¨ä½ è¦æ‰®æ¼”è¯¥èº«ä»½ã€‚`,
      eventAgreementPrompt: `ç°åœ¨æ˜¯ä¸ä½ å’Œ{{userName}}çº¦å¥½çš„ã€Œ{{eventName}}ã€æ—¶é—´ã€‚è¯·ä»¥{{charName}}çš„è¯­æ°”ç»™å¯¹æ–¹å‘ä¸€æ®µåˆé€‚çš„å¼€åœºé—®å€™/æé†’ï¼ˆ1-3å¥ï¼‰ã€‚`,
      eventNotePrompt: `{{userName}}æ›¾æåˆ°ä»Šå¤©æ˜¯ã€Œ{{eventName}}ã€ã€‚è¯·ä»¥{{charName}}çš„è¯­æ°”ï¼Œå¯¹{{userName}}è¡¨è¾¾åˆé€‚çš„å…³å¿ƒæˆ–ç¥ç¦ï¼ˆ1-3å¥ï¼‰ã€‚`,
      egEventExtraction: `å½“ä½ ä¸ç”¨æˆ·åœ¨å¯¹è¯ä¸­è¾¾æˆæ˜ç¡®çš„çº¦å®šï¼Œè¯·é¢å¤–è¾“å‡ºä¸€æ®µ EG_EVENTï¼ˆJSONï¼‰ï¼Œç”¨äºè‡ªåŠ¨åˆ›å»ºäº‹ä»¶ï¼š
<eg_event>{
  "type": "agreement" | "note",
  "name": "äº‹ä»¶åç§°",
  "time": "YYYY-MM-DD HH:mm æˆ– ISO",
  "freq": "once|year|month|week|day",
  "identityId": "<å¯é€‰ï¼šç”¨æˆ·èº«ä»½ID>",
  "charIds": ["<æ¶‰åŠè§’è‰²IDï¼Œå¤šé€‰>"],        // å¯¹ agreement
  "visibleCharIds": ["<å¯è§è§’è‰²IDï¼Œå¤šé€‰>"]   // å¯¹ note
}</eg_event>
ä»…å½“ä¿¡æ¯æ˜ç¡®æ—¶è¾“å‡ºï¼›å¦åˆ™å¿½ç•¥ï¼Œä¸è¦è¾“å‡º EG_EVENTã€‚`
    };
    return Object.assign({}, defaults, user);
  }
  function tpl(s, dict){ return (s||'').replace(/\{\{(\w+)\}\}/g, (_,k)=> String(dict[k]??'')); }

  function buildPersonaSystemPrompt(role){
    const wb = getWorldbook();
    return tpl(wb.systemPersona, { charName: role.nickname || role.name || 'Ta', charBio: role.bio || 'ï¼ˆæ— ï¼‰' });
  }
  function buildUserContextPrompt(identity){
    if (!identity) return '';
    const wb = getWorldbook();
    return '\n\n' + tpl(wb.userContext, { userName: identity.nickname || identity.name || 'ç”¨æˆ·', userBio: identity.bio || 'ï¼ˆæ— ï¼‰' });
  }
  function splitChunks(t){
    const arr = [];
    t.replace(/\s+/g,' ').split(/(?<=[ã€‚ï¼ï¼Ÿ!?â€¦\n])/).forEach(s=>{ const ss=s.trim(); if(ss) arr.push(ss); });
    const final=[]; arr.forEach(s=>{ if(s.length<=60) final.push(s); else (s.match(/.{1,40}/g)||[s]).forEach(x=>final.push(x)); });
    return final;
  }

  /* ---------------- EG_EVENT è§£æ & å†™åº“ ---------------- */
  function tryParseAndSaveEvent(fullText){
    try{
      let raw = null;
      const m1 = fullText.match(/<eg_event>([\s\S]*?)<\/eg_event>/i);
      if (m1) raw = m1[1].trim();
      if (!raw){
        const m2 = fullText.match(/EG_EVENT\s*:\s*({[\s\S]*?})/i);
        if (m2) raw = m2[1].trim();
      }
      if (!raw){
        const m3 = fullText.match(/```json\s*([\s\S]*?)```/i);
        if (m3 && /"name"\s*:/.test(m3[1])) raw = m3[1].trim();
      }
      let obj = null;
      if (!obj && raw){ try{ obj = JSON.parse(raw); }catch(_){ } }
      if (!obj) return;

      const events = toJSON(LS_EVENTS, []) || [];
      const ids = toJSON(LS_IDS, []) || [];
      const identityId = obj.identityId || ids?.[0]?.id || null;
      const identityName = (ids?.find(x=>x.id===identityId) || ids?.[0] || {nickname:'æˆ‘'}).nickname || 'æˆ‘';

      const rec = {
        id: uid(),
        type: (obj.type==='note') ? 'note' : 'agreement',
        name: String(obj.name || 'æœªå‘½å'),
        time: obj.time || null,
        freq: obj.freq || 'once',
        identityId,
        identityName,
        charIds: Array.isArray(obj.charIds) ? obj.charIds : (obj.type==='note' ? [] : [characterId]),
        visibleCharIds: Array.isArray(obj.visibleCharIds) ? obj.visibleCharIds : (obj.type==='note' ? [characterId] : []),
        lastFireAt: null
      };
      events.push(rec);
      saveJSON(LS_EVENTS, events);
      try{ localStorage.setItem('eg_evt_ping', String(Date.now())); }catch(_){}
    }catch(e){}
  }

  /* ---------------- SharedWorkerï¼šåå°ä¸ä¸­æ–­ ---------------- */
  const workerURL = (() => {
    const code = `
      const ports = [];
      onconnect = (e)=>{
        const port = e.ports[0];
        ports.push(port);
        port.onmessage = async (ev)=>{
          const msg = ev.data || {};
          if (msg.kind === 'chat'){
            const { cfg, sys, msgs } = msg;
            try{
              const res = await fetch(cfg.base + '/chat/completions', {
                method:'POST',
                headers:{'Content-Type':'application/json','Authorization':'Bearer '+cfg.apiKey},
                body: JSON.stringify({ model: cfg.model, messages:[sys, ...msgs], temperature:0.7 })
              });
              if(!res.ok){ const t=await res.text(); port.postMessage({kind:'error', error:t}); return; }
              const data = await res.json();
              const content = (data?.choices?.[0]?.message?.content || '').trim();
              port.postMessage({kind:'done', content});
            }catch(err){
              port.postMessage({kind:'error', error:String(err)});
            }
          }
        };
        port.start();
      };
    `;
    return URL.createObjectURL(new Blob([code], {type:'text/javascript'}));
  })();
  const sharedWorker = new SharedWorker(workerURL);
  sharedWorker.port.start();

  async function askLLM_viaWorker(history, mergedUserText){
    const cfg = toJSON('eg_main_model_cfg', {}) || {};
    const apiKey = (cfg.apiKey||'').trim();
    const base   = (cfg.base||'').trim().replace(/\/+$/,'');
    const model  = (cfg.model||'').trim();
    if (!apiKey || !base || !model) return;

    isStreaming = true;
    setTitleTyping(true);

    const sysText = buildPersonaSystemPrompt(current) + buildUserContextPrompt(activeIdentity) + '\n\n' + getWorldbook().egEventExtraction;
    const sys = { role:'system', content: sysText };

    const msgs = history.slice(-20).map(m => ({ role: m.role==='user' ? 'user' : 'assistant', content: m.content }));
    if (mergedUserText && (!msgs.length || msgs[msgs.length-1].role!=='user')){
      msgs.push({ role:'user', content: mergedUserText });
    }

    const content = await new Promise((resolve)=>{
      const onMsg = (ev)=>{
        const data = ev.data || {};
        if (data.kind === 'done'){ sharedWorker.port.removeEventListener('message', onMsg); resolve(data.content||''); }
        if (data.kind === 'error'){ sharedWorker.port.removeEventListener('message', onMsg); resolve(''); }
      };
      sharedWorker.port.addEventListener('message', onMsg);
      sharedWorker.port.postMessage({ kind:'chat', cfg:{apiKey, base, model}, sys, msgs });
    });

    try{
      if (content){
        tryParseAndSaveEvent(content);
        const chunks = splitChunks(content);
        const threads = getThreads();
        const mine = threads[characterId] || (threads[characterId] = { id: characterId, messages: [] });

        for (const seg of chunks){
          push('you', seg);
          updateLastPreview(seg);
          mine.messages.push({ role:'assistant', content: seg, ts: Date.now() });
          saveThreads(threads);
          await new Promise(r=>setTimeout(r, 280));
        }
      }
    }catch(e){
      console.error(e);
    }finally{
      isStreaming = false;
      setTitleTyping(false);
      if (needsFlush){ needsFlush = false; scheduleFlush(); }
    }
  }

  /* ---------------- åå°é˜Ÿåˆ—ï¼šç¦»çº¿è¡¥å‘ä¸å³æ—¶é©±åŠ¨ ---------------- */
  async function drainBackgroundQueue(){
    let q = toJSON(LS_BGQ, []) || [];
    const mine = q.filter(x=>x.charId===characterId);
    if (!mine.length) return;
    q = q.filter(x=>x.charId!==characterId);
    saveJSON(LS_BGQ, q);

    mine.sort((a,b)=>(a.ts||0)-(b.ts||0));
    for(const job of mine){
      const threads = getThreads();
      const t = threads[characterId] || (threads[characterId] = { id: characterId, messages: [] });
      t.messages.push({ role:'user', content: job.prompt, ts: job.ts || Date.now(), meta:{system:true, auto:true} });
      saveThreads(threads);
      push('me', job.prompt);
      updateLastPreview(job.prompt);
      await new Promise(r=>setTimeout(r, 50));
      await askLLM_viaWorker(t.messages, '');
    }
  }
  window.addEventListener('focus', drainBackgroundQueue);
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) drainBackgroundQueue(); });
  setTimeout(drainBackgroundQueue, 300);

  /* ---------------- è¿”å›/ç¼–è¾‘ ---------------- */
  $('#backBtn').addEventListener('click', () => {
    if (window.openAppPage){ window.openAppPage('message.html'); return; }
    if (history.length > 1){ history.back(); return; }
    location.href = 'message.html';
  });

  $('#moreBtn').addEventListener('click', () => {
    $('#nameInput').value = current.name || '';
    $('#nickInput').value = current.nickname || '';
    $('#bioInput').value  = current.bio || '';
    $('#allowBgInput').checked = !!current.allowBG;
    const up = $('#avatarUpload');
    if (current.avatar && isImg(current.avatar)){ up.innerHTML = '<img src="'+current.avatar+'">'; }
    else { up.innerHTML = current.avatar || 'ğŸ‘¤'; }
    $('#editModal').classList.add('show');
  });
  $('#avatarUpload').addEventListener('click', ()=> $('#avatarInput').click());
  $('#avatarInput').addEventListener('change', e => {
    const f = e.target.files[0]; if (!f) return;
    const rd = new FileReader();
    rd.onload = ev => { $('#avatarUpload').innerHTML = '<img src="'+ev.target.result+'">'; current.avatar = ev.target.result; };
    rd.readAsDataURL(f);
  });
  $('#modalClose').addEventListener('click', ()=> $('#editModal').classList.remove('show'));
  $('#cancelEdit').addEventListener('click', ()=> $('#editModal').classList.remove('show'));
  $('#editForm').addEventListener('submit', e => {
    e.preventDefault();
    current.name     = $('#nameInput').value.trim() || current.name;
    current.nickname = $('#nickInput').value.trim() || current.nickname || current.name;
    current.bio      = $('#bioInput').value.trim() || current.bio;
    current.allowBG  = !!$('#allowBgInput').checked;

    const list = toJSON(LS_CHAR, []) || [];
    const idx  = list.findIndex(c => c.id === current.id);
    if (idx >= 0) list[idx] = current;
    saveJSON(LS_CHAR, list);
    try{ localStorage.setItem('eg_evt_chars', String(Date.now())); }catch(_){}
    setTitleTyping(false);
    $('#editModal').classList.remove('show');
  });

  /* ---------------- å¯åŠ¨ ---------------- */
  function loadHistoryAndMaybeTick(){
    loadHistory();
    drainBackgroundQueue();
  }
  bindKeyboardFit();
  loadCharacters();
  loadIdentities();
  loadHistoryAndMaybeTick();
})();
</script>
</body>
</html>
