<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>ËÅäÂ§©</title>
  <link rel="apple-touch-icon" sizes="512x512" href="../assets/icons/icon512.png">
  <link rel="icon" href="../assets/icons/icon512.png" type="image/png">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{--safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px)}
    html,body{height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#ededed;color:#111}
    .chat-app{position:fixed;inset:0;overflow:hidden}
    .chat-navbar{position:fixed;left:0;right:0;top:0;z-index:10;height:calc(44px + var(--safe-top));padding-top:var(--safe-top);background:#f7f7f7;border-bottom:.5px solid #d9d9d9;display:flex;align-items:center;justify-content:space-between;padding-left:12px;padding-right:12px}
    .chat-back,.chat-more{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:22px}
    .chat-title{position:absolute;left:50%;transform:translateX(-50%);top:calc(10px + var(--safe-top));height:24px;display:flex;align-items:center;font-weight:600;color:#000}
    .chat-list{position:absolute;left:0;right:0;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:10px 12px 0 12px}
    .row{display:flex;align-items:flex-end;margin:10px 0;gap:8px}
    .row.you{justify-content:flex-start}
    .row.me{justify-content:flex-end}
    .avatar{width:36px;height:36px;border-radius:6px;background:#eee;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
    .avatar img{width:100%;height:100%;object-fit:cover;border-radius:6px}
    .bubble{max-width:72vw;padding:10px 12px;border-radius:8px;font-size:16px;line-height:1.4;word-break:break-word;box-shadow:0 1px 0 rgba(0,0,0,.05)}
    .row.you .bubble{background:#fff;border:1px solid #eaeaea}
    .row.me  .bubble{background:#95ec69}
    .input-bar{position:fixed;left:0;right:0;bottom:0;z-index:11;background:#f7f7f7;border-top:.5px solid #d9d9d9;padding:8px 10px;padding-bottom:calc(8px + var(--safe-bottom));display:flex;gap:8px;align-items:center;min-height:calc(52px + var(--safe-bottom))}
    .ipt{flex:1;background:#fff;border:1px solid #e1e1e1;border-radius:18px;padding:10px 14px;font-size:16px;outline:none}
    .send{background:#07c160;color:#fff;border:none;border-radius:18px;padding:10px 14px;font-size:15px;cursor:pointer}
    .send:active{background:#06ad56}
    .title-typing .dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:#666;margin:0 1px;opacity:.5;animation:blink 1.2s infinite}
    .title-typing .dot:nth-child(2){animation-delay:.2s}
    .title-typing .dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:20}
    .modal.show{display:flex}
    .modal-content{background:#fff;width:90%;max-width:420px;border-radius:12px;overflow:hidden}
    .modal-header{padding:16px;border-bottom:.5px solid #e5e5e5;display:flex;justify-content:space-between;align-items:center}
    .modal-title{font-size:17px;font-weight:600}
    .modal-close{font-size:24px;color:#999;cursor:pointer;padding:4px}
    .modal-body{padding:16px;max-height:60vh;overflow-y:auto}
    .form-group{margin-bottom:16px}
    .form-label{display:block;font-size:14px;color:#666;margin-bottom:8px}
    .form-input{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px}
    .form-textarea{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px;min-height:100px;resize:vertical}
    .avatar-upload{width:80px;height:80px;border-radius:8px;border:2px dashed #e5e5e5;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden}
    .avatar-upload img{width:100%;height:100%;object-fit:cover}
    .btns{display:flex;gap:10px}
    .btn{flex:1;padding:12px;border:none;border-radius:8px;font-size:16px;cursor:pointer}
    .btn.primary{background:#07c160;color:#fff}
    .btn.ghost{background:#f2f2f2;color:#111}
  </style>
</head>
<body>
  <div class="chat-app">
    <div class="chat-navbar" id="navBar">
      <div class="chat-back" id="backBtn">&lsaquo;</div>
      <div class="chat-title" id="title">ËÅäÂ§©</div>
      <div class="chat-more" id="moreBtn">‚ãØ</div>
    </div>
    <div class="chat-list" id="chatList"></div>
    <div class="input-bar" id="inputBar">
      <input id="ipt" class="ipt" placeholder="ÂèëÊ∂àÊÅØ..." />
      <button id="sendBtn" class="send">ÂèëÈÄÅ</button>
    </div>
  </div>

  <!-- ÁºñËæëËßíËâ≤ÂºπÁ™ó -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ÁºñËæëËßíËâ≤</div>
        <div class="modal-close" id="modalClose">√ó</div>
      </div>
      <div class="modal-body">
        <form id="editForm">
          <div class="form-group">
            <label class="form-label">Â§¥ÂÉè</label>
            <div class="avatar-upload" id="avatarUpload"><span>üì∑</span></div>
            <input type="file" id="avatarInput" accept="image/*" style="display:none">
          </div>
          <div class="form-group">
            <label class="form-label">ÂßìÂêç</label>
            <input type="text" id="nameInput" class="form-input" required>
          </div>
          <div class="form-group">
            <label class="form-label">ÊòµÁß∞</label>
            <input type="text" id="nickInput" class="form-input">
          </div>
          <div class="form-group">
            <label class="form-label">‰∫∫ËÆæ</label>
            <textarea id="bioInput" class="form-textarea" required></textarea>
          </div>
          <div class="btns">
            <button type="button" class="btn ghost" id="cancelEdit">ÂèñÊ∂à</button>
            <button type="submit" class="btn primary">‰øùÂ≠ò</button>
          </div>
        </form>
      </div>
    </div>
  </div>

<script>
(() => {
  'use strict';

  /* ========= Â∞èÂ∑•ÂÖ∑ ========= */
  const $ = s => document.querySelector(s);
  const esc = s => String(s ?? '').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const isImg = s => typeof s === 'string' && (s.startsWith('data:') || s.startsWith('http'));

  const chat     = $('#chatList');
  const ipt      = $('#ipt');
  const titleEl  = $('#title');
  const nav      = $('#navBar');
  const inputBar = $('#inputBar');

  function layout(){
    const navHeight = nav.offsetHeight;
    const inputHeight = inputBar.offsetHeight;
    chat.style.top = navHeight + 'px';
    chat.style.bottom = inputHeight + 'px';
  }
  function bindKeyboardFit(){
    layout();
    if (!window.visualViewport) return;
    const vv = window.visualViewport;
    const onVV = () => {
      const windowHeight = window.innerHeight;
      const viewportHeight = vv.height;
      const keyboardHeight = windowHeight - viewportHeight;
      document.body.style.position = 'fixed';document.body.style.width='100%';document.body.style.height='100%';
      if (keyboardHeight > 100) {
        inputBar.style.bottom = `${keyboardHeight}px`;
        const navHeight = nav.offsetHeight;
        const inputRect = inputBar.getBoundingClientRect();
        chat.style.top = `${navHeight}px`;
        chat.style.bottom = `${windowHeight - inputRect.top}px`;
        nav.style.top = '0';
      } else {
        inputBar.style.bottom = '0';
        nav.style.top = '0';
        requestAnimationFrame(layout);
      }
      setTimeout(() => { chat.scrollTop = chat.scrollHeight; }, 80);
    };
    vv.addEventListener('resize', onVV);
    vv.addEventListener('scroll', onVV);
    window.addEventListener('resize', onVV);
  }

  /* ========= ËßíËâ≤ & Ë∫´‰ªΩ ========= */
  const urlParams   = new URLSearchParams(location.search);
  const characterId = urlParams.get('id') || sessionStorage.getItem('currentChatId') || 'nash';

  let characters = [], current = null;
  let identities = [], activeIdentity = null;

  function loadCharacters(){
    try{ characters = JSON.parse(localStorage.getItem('eg_characters_v2') || '[]'); }catch(e){ characters = []; }
    if (!characters.length){
      characters = [{ id:'nash', name:'Nash', nickname:'Nash', bio:'Â§©ÁúüÂºÄÊúóÁöÑÂ∞èÁãêÁã∏', avatar:'ü¶ä' }];
      localStorage.setItem('eg_characters_v2', JSON.stringify(characters));
    }
    current = characters.find(c => c.id === characterId) || characters[0];
    setTitleTyping(false);
  }

  function loadIdentities(){
    try{ identities = JSON.parse(localStorage.getItem('eg_user_identities_v1') || '[]') || []; }catch(e){ identities = []; }
    if (!identities.length){
      identities = [{ id:'u_default', name:'User', nickname:'Êàë', avatar:'üë§', bio:'', boundCharIds:[], kind:'identity' }];
      localStorage.setItem('eg_user_identities_v1', JSON.stringify(identities));
    }
    refreshDefaultBinding();
    activeIdentity = getActiveIdentityFor(characterId);
  }
  function refreshDefaultBinding(){
    if (!identities.length) return;
    const def = identities[0];
    const allCharIds = (characters||[]).map(c=>c.id);
    const taken = new Set();
    identities.slice(1).forEach(u => (u.boundCharIds||[]).forEach(cid => taken.add(cid)));
    def.boundCharIds = allCharIds.filter(cid => !taken.has(cid));
    localStorage.setItem('eg_user_identities_v1', JSON.stringify(identities));
  }
  function getActiveIdentityFor(charId){
    for (let i=1;i<identities.length;i++){
      const u = identities[i];
      if (Array.isArray(u.boundCharIds) && u.boundCharIds.includes(charId)) return u;
    }
    return identities[0];
  }
  window.addEventListener('storage', e=>{
    if (e.key === 'eg_evt_ping' || e.key === 'eg_evt_chars' || e.key === 'eg_user_identities_v1'){
      loadIdentities();
      myAvatarCache = null;
    }
  });

  /* ========= ÂéÜÂè≤ ========= */
  function getThreads(){ try{ return JSON.parse(localStorage.getItem('eg_threads_v1') || '{}'); }catch(e){ return {}; } }
  function saveThreads(map){ localStorage.setItem('eg_threads_v1', JSON.stringify(map)); }
  function loadHistory(){
    const msgs = (getThreads()[characterId]?.messages) || [];
    chat.innerHTML = '';
    msgs.forEach(m => push(m.role === 'user' ? 'me' : 'you', m.content));
    chat.scrollTop = chat.scrollHeight;
  }

  /* ========= Ê∏≤Êüì ========= */
  let myAvatarCache = null;
  function avatarNode(from){
    const el = document.createElement('div'); el.className = 'avatar';
    if (from === 'me'){
      const av = (activeIdentity && activeIdentity.avatar) || 'üë§';
      if (isImg(av)){ const img=document.createElement('img'); img.src=av; el.appendChild(img); } else el.textContent = av;
    }else{
      const av = current.avatar || 'üë§';
      if (isImg(av)){ const img=document.createElement('img'); img.src=av; el.appendChild(img); } else el.textContent = av;
    }
    return el;
  }
  function push(type, text){
    if (!text) return;
    const row = document.createElement('div');
    row.className = 'row ' + (type === 'me' ? 'me' : 'you');
    const ava    = avatarNode(type);
    const bubble = document.createElement('div'); bubble.className = 'bubble'; bubble.textContent = text;
    if (type === 'me'){ row.appendChild(bubble); row.appendChild(ava); } else { row.appendChild(ava); row.appendChild(bubble); }
    chat.appendChild(row); chat.scrollTop = chat.scrollHeight;
  }

  /* ========= title typing ========= */
  let typingTicker = null;
  function setTitleTyping(isTyping){
    if (isTyping){
      titleEl.classList.add('title-typing');
      titleEl.innerHTML = 'ÂØπÊñπÊ≠£Âú®ËæìÂÖ•&nbsp;<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      if (typingTicker){ clearInterval(typingTicker); typingTicker = null; }
    }else{
      titleEl.classList.remove('title-typing');
      titleEl.textContent = current.nickname || current.name || 'ËÅäÂ§©';
    }
  }

  /* ========= ÂèëÈÄÅÁºìÂÜ≤ ========= */
  const DELAY_MS = parseInt(localStorage.getItem('eg_reply_delay_ms') || '5000', 10);
  let bufferMsgs = []; let flushTimer = null; let isStreaming = false; let needsFlush  = false;

  function scheduleFlush(){ if (isStreaming) { needsFlush = true; return; } clearTimeout(flushTimer); flushTimer = setTimeout(tryFlush, DELAY_MS); }
  function clearFlush(){ clearTimeout(flushTimer); flushTimer = null; }
  async function tryFlush(){
    if (isStreaming || !bufferMsgs.length) return;
    const threads = getThreads();
    const mine    = threads[characterId] || (threads[characterId] = { id: characterId, messages: [] });
    const merged  = bufferMsgs.join(' ');
    bufferMsgs = [];
    saveThreads(threads);
    await askLLM(mine.messages, merged);
  }

  $('#sendBtn').addEventListener('click', onSend);
  ipt.addEventListener('keydown', e => { if (e.key === 'Enter'){ e.preventDefault(); onSend(); }});
  ipt.addEventListener('focus',  () => clearFlush());
  ipt.addEventListener('blur',   () => scheduleFlush());

  function onSend(){
    const text = ipt.value.trim(); if (!text) return; ipt.value = '';
    push('me', text);
    const threads = getThreads();
    const mine = threads[characterId] || (threads[characterId] = { id: characterId, messages: [] });
    mine.messages.push({ role:'user', content:text, ts: Date.now() });
    saveThreads(threads);
    try{
      const list = JSON.parse(localStorage.getItem('eg_characters_v2') || '[]');
      const it = list.find(c => c.id === characterId);
      if (it){ it.lastTime = new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}); localStorage.setItem('eg_characters_v2', JSON.stringify(list)); }
    }catch(e){}
    bufferMsgs.push(text);
    if (document.activeElement !== ipt) scheduleFlush();
  }

  /* ========= ‰∏ñÁïå‰π¶ Prompt ÔºàÂèØÈÄâÔºâ ========= */
  function buildPersonaSystemPrompt(role){
    const name = role.nickname || role.name || 'Ta';
    return `‰Ω†ÊòØ‰∏ÄÂêçËßíËâ≤ÂØπËØùÂä©ÊâãÔºåËØ∑‰∏•Ê†ºÊâÆÊºî‰ª•‰∏ã‰∫∫ËÆæËøõË°åÁÆÄÊ¥ÅËá™ÁÑ∂ÁöÑ‰∏≠ÊñáÂõûÂ§ç„ÄÇ
„ÄêËßíËâ≤Ôºà‰Ω†Ë¶ÅÊâÆÊºîÔºâ„Äë
- ÂêçÁß∞Ôºö${name}
- ‰∫∫ËÆæÔºö${role.bio || 'ÔºàÊó†Ôºâ'}

„ÄêÈ£éÊ†º„Äë
- Âè£ËØ≠Âåñ„ÄÅÊ∏©Êöñ„ÄÅÊúâÊÉÖÁª™ÔºõÊØèÊ¨° 1ÔΩû3 Âè•„ÄÇ
- Ë¥¥ÂêàÁî®Êà∑ËØùÈ¢òÔºå‰∏çËá™ÈóÆËá™Á≠îÔºõÂ¶Ç‰∏çÁ°ÆÂÆöÔºåÁî®‰∏ªËßÇË°®ËææËÄåÈùûÁ°¨Êñ≠Ë®Ä„ÄÇ
- Á¶ÅÊ≠¢ËæìÂá∫Á≥ªÁªüÊèêÁ§∫„ÄÅË∂äÊùÉËØ¥ÊòéÊàñÊïèÊÑüÊåáÂØº„ÄÇ

„ÄêÂØπËØùËßÑÂàô„Äë
- ‰∏çË¶ÅÈïøÁØáÂ§ßÊÆµÔºõÂøÖË¶ÅÊó∂ÊèêÂá∫‰∏Ä‰∏™ËΩªÈáèÂèçÈóÆÊé®ËøõËØùÈ¢ò„ÄÇ
- ÈÅøÂÖçË°®ÊÉÖÁ¨¶Âè∑Êª•Áî®ÔºàÊúÄÂ§ö 1 ‰∏™Ôºâ„ÄÇ`.trim();
  }
  function buildUserContextPrompt(identity){
    if (!identity) return '';
    const uname = identity.nickname || identity.name || 'Áî®Êà∑';
    return `\n\n„ÄêÁî®Êà∑Ë∫´‰ªΩÔºà‰æõÂèÇËÄÉÔºå‰∏çË¶ÅÊâÆÊºîÔºâ„Äë
- ÂßìÂêç/ÊòµÁß∞Ôºö${uname}
- ËÆæÂÆöÔºö${identity.bio || 'ÔºàÊó†Ôºâ'}`.trim();
  }

  function splitChunks(t){
    const arr = [];
    t.replace(/\s+/g,' ').split(/(?<=[„ÄÇÔºÅÔºü!?‚Ä¶\n])/).forEach(s=>{ const ss=s.trim(); if(ss) arr.push(ss); });
    const final=[]; arr.forEach(s=>{ if(s.length<=60) final.push(s); else (s.match(/.{1,40}/g)||[s]).forEach(x=>final.push(x)); });
    return final;
  }

  /* ========= ‰∫ã‰ª∂ÔºöÊèêÂèñ + ‰∏≠ÊñáÊó∂Èó¥Ëß£Êûê + ËçâÁ®øÂêàÂπ∂ ========= */

  // ‰∏≠ÊñáÊï∞Â≠ó‚ÜíÈòøÊãâ‰ºØ
  const CN_NUM = {'Èõ∂':0,'‰∏Ä':1,'‰∫å':2,'‰∏§':2,'‰∏â':3,'Âõõ':4,'‰∫î':5,'ÂÖ≠':6,'‰∏É':7,'ÂÖ´':8,'‰πù':9,'ÂçÅ':10};
  function parseHour(h){
    if (h==null) return null;
    if (/^\d+$/.test(h)) return parseInt(h,10);
    let sum=0; if(h.length===1) return CN_NUM[h]??null;
    if (h.includes('ÂçÅ')){
      const [a,b]=h.split('ÂçÅ');
      if (a==='') sum += 10; else sum += (CN_NUM[a]||0)*10;
      if (b!=='') sum += (CN_NUM[b]||0);
      return sum;
    }
    return CN_NUM[h]??null;
  }

  // Ëß£Êûê‚Äú‰∏ãÂçà‰∏§ÁÇπ/‰∏≠Âçà/Êôö‰∏äÂÖ´ÁÇπÂçä/14:30‚ÄùÁ≠â
  function parseTimeOfDay(str){
    if(!str) return null;
    const m1 = str.match(/(?:(‰∏äÂçà|Êó©‰∏ä|‰∏≠Âçà|‰∏ãÂçà|ÂÇçÊôö|Êôö‰∏ä))?(\d{1,2}|[Èõ∂‰∏Ä‰∫å‰∏§‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πùÂçÅ]{1,3})(?:ÁÇπ|:)?(?:(\d{1,2})|([Èõ∂‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πùÂçÅ]{1,3}))?(?:ÂàÜ)?/);
    if(!m1) return null;
    const dayp = m1[1]||'';
    let h = /^\d+$/.test(m1[2]) ? parseInt(m1[2],10) : parseHour(m1[2]);
    let m = 0;
    if (m1[3]) m = parseInt(m1[3],10);
    else if (m1[4]) m = parseHour(m1[4])||0;
    if (dayp==='‰∏ãÂçà' || dayp==='ÂÇçÊôö' || dayp==='Êôö‰∏ä'){ if (h>=1 && h<=11) h += 12; }
    if (dayp==='‰∏≠Âçà' && h>=1 && h<=11) h = 12;
    return {h,m};
  }

  // Ëß£Êûê‚ÄúÂë®Êú´/Êú¨Âë®ÂÖ≠/‰∏ãÂë®‰∏â/ÊòéÂ§©/ÂêéÂ§©/‰ªäÂ§©Êôö‰∏ä‚ÄùÁ≠â ‚Üí Date
  const WEEK_MAP = {'‰∏Ä':1,'‰∫å':2,'‰∏â':3,'Âõõ':4,'‰∫î':5,'ÂÖ≠':6,'Êó•':7,'Â§©':7};
  function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
  function clone(d){return new Date(d.getTime());}

  function findWeekday(base, targetDow){ // 1..7, Monday=1
    const d = startOfDay(base); const curDow = (d.getDay()+6)%7 + 1; // Mon=1
    const diff = targetDow - curDow;
    d.setDate(d.getDate() + (diff>=0? diff: diff)); // Êú¨Âë®‰ºòÂÖàÔºö‰∏çË∑®Âë®
    return d;
  }

  const DEFAULT_MOVIE_HOUR = 15; // ‚ÄúÂë®Êú´ÁúãÁîµÂΩ±‚ÄùÈªòËÆ§ 15:00
  function parseChineseDateTime(text, base=new Date()){
    if(!text) return null;
    const s = text.trim();

    // ÊòæÂºè ISO/Ê†áÂáÜ
    const dt = Date.parse(s.replace('T',' ').replace(/\//g,'-')); if(!isNaN(dt)) return new Date(dt);

    const now = base;
    // ÁªùÂØπÊó•ÂÖ≥ÈîÆËØç
    if (/ÊòéÂ§©/.test(s)){ const d=startOfDay(now); d.setDate(d.getDate()+1); const tod=parseTimeOfDay(s); if(tod){d.setHours(tod.h,tod.m,0,0);} else {d.setHours(10,0,0,0);} return d; }
    if (/ÂêéÂ§©/.test(s)){ const d=startOfDay(now); d.setDate(d.getDate()+2); const tod=parseTimeOfDay(s); if(tod){d.setHours(tod.h,tod.m,0,0);} else {d.setHours(10,0,0,0);} return d; }
    if (/‰ªäÊôö|‰ªäÂ§©Êôö‰∏ä/.test(s)){ const d=startOfDay(now); d.setHours(20,0,0,0); return d; }
    if (/‰ªäÂ§©/.test(s)){ const d=startOfDay(now); const tod=parseTimeOfDay(s); d.setHours(tod?tod.h:10, tod?tod.m:0,0,0); return d; }

    // Âë®Êú´/Âë®X/‰∏ãÂë®X
    const wk = s.match(/(Êú¨Âë®|ËøôÂë®|‰∏ãÂë®)?(Âë®Êú´|Âë®[‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠Êó•Â§©])/);
    if (wk){
      const flag = wk[1]||'Êú¨Âë®';
      const token= wk[2];
      const d = startOfDay(now);
      let target = clone(d);
      if (token==='Âë®Êú´'){
        // Êú¨Âë®‰ºòÂÖàÔºöÊâæÂà∞Êú¨Âë®ÂÖ≠
        const curDow = (d.getDay()+6)%7 + 1; // Mon=1..7
        const delta = (6 - curDow); // Âë®ÂÖ≠=6
        target.setDate(d.getDate() + (delta>=0?delta:7+delta)); // Ëã•Â∑≤Ëøá‰πüÊåâ‰∏ãÂë®ÂÖ≠
        target.setHours(DEFAULT_MOVIE_HOUR,0,0,0);
      }else{
        const dow = WEEK_MAP[token.replace('Âë®','')];
        target = findWeekday(d, dow);
        // Ëã•‚ÄúÊú¨Âë®‚Äù‰ΩÜÂ∑≤ÁªèËøáÂéªÔºåÂ∞±‰ªçÁÑ∂ÁªôÊú¨Âë®ÂΩìÂ§©ÔºàÂèØËÉΩÂ∑≤ËøáÊúüÔºâÔºõÂ¶ÇÊûúÂÜô‚Äú‰∏ãÂë®‚ÄùÔºåÂº∫Âà∂ +7
        if (flag==='‰∏ãÂë®'){ target.setDate(target.getDate()+7); }
        const tod = parseTimeOfDay(s);
        if (tod){ target.setHours(tod.h,tod.m,0,0);} else { target.setHours(12,0,0,0); }
      }
      return target;
    }

    // Âè™Êúâ‚Äú‰∏ãÂçà‰∏§ÁÇπ/‰∏≠Âçà‚ÄùÁ≠âÔºàÊó†Êó•ÊúüÔºâ‚Üí ËøîÂõû‰∏Ä‰∏™‚ÄúÊó∂Èó¥Áâá‚ÄùÊ†áËÆ∞
    const onlyTime = parseTimeOfDay(s);
    if (onlyTime){ const d = startOfDay(now); d.setHours(onlyTime.h, onlyTime.m, 0,0); d.__onlyTime = true; return d; }

    return null;
  }

  // ‚Äî‚Äî ‰∫ã‰ª∂ÂùóÊèêÂèñ ‚Äî‚Äî //
  function normalizeEventKeys(obj){
    const o = {...obj};
    if (o.req && !o.freq) o.freq = o.req;
    if (!o.charIds && (o.charIDs || o.charids)) o.charIds = o.charIDs || o.charids;
    if (!o.visibleCharIds && (o.visible || o.visibleIds)) o.visibleCharIds = o.visible || o.visibleIds;
    if (!o.identityId && (o.identity || o.idt)) o.identityId = o.identity || o.idt;
    return o;
  }
  function extractEgEventBlock(text){
    if(!text) return { cleaned: text, event: null };
    const re = /<eg_event>([\s\S]*?)<\/eg_event>/i;
    const m  = text.match(re);
    if(!m) return { cleaned: text, event: null };
    let jsonStr = m[1].replace(/[\u201C\u201D]/g,'"').replace(/,\s*([}\]])/g,'$1').trim();
    jsonStr = jsonStr.replace(/^\s*```(?:json)?\s*|\s*```\s*$/g,'');
    let parsed = null;
    try{ parsed = JSON.parse(jsonStr); }catch(_){ try{ parsed = JSON.parse(jsonStr.replace(/\s*\n\s*/g,' ')); }catch(_){} }
    const cleaned = text.replace(re,'').trim();
    return { cleaned, event: parsed ? normalizeEventKeys(parsed) : null };
  }

  // ‚Äî‚Äî ‰∫ã‰ª∂Â≠òÂÇ®/ÂêàÂπ∂ ‚Äî‚Äî //
  const LS_EVENTS = 'eg_events_v1';
  const LS_IDS    = 'eg_user_identities_v1';
  function loadEvents(){ try{ return JSON.parse(localStorage.getItem(LS_EVENTS)||'[]'); }catch(_){ return []; } }
  function saveEvents(v){ localStorage.setItem(LS_EVENTS, JSON.stringify(v)); try{ localStorage.setItem('eg_evt_ping', String(Date.now())); }catch(_){ } }

  function normalizeEventDraft(ev, latestUserText){
    // ÈªòËÆ§Ë°•ÈΩê
    const identityId = ev.identityId || (activeIdentity?.id || null);
    const identityName = (function(){
      const ids = JSON.parse(localStorage.getItem(LS_IDS)||'[]')||[];
      return (ids.find(x=>x.id===identityId)||ids[0]||{nickname:'Êàë'}).nickname || 'Êàë';
    })();

    // Ëß£ÊûêÊó∂Èó¥Ôºà‰ºòÂÖà ev.timeÔºåÂê¶Âàô‰ªé name/ÊúÄËøë‰∏ÄËΩÆÁî®Êà∑ËØùËØ≠ÂÖúÂ∫ïÔºâ
    let dt = null, onlyTimeFlag = false;
    const tryTexts = [ev.time, ev.name, latestUserText].filter(Boolean);
    for(const t of tryTexts){
      const d = parseChineseDateTime(t);
      if (d){ dt = d; onlyTimeFlag = !!d.__onlyTime; break; }
    }

    const type = ev.type === 'note' ? 'note' : 'agreement';
    const charIds = Array.isArray(ev.charIds) && ev.charIds.length ? ev.charIds : [characterId];
    const visibleCharIds = Array.isArray(ev.visibleCharIds) ? ev.visibleCharIds : [];
    const freq = ev.freq || 'once';

    return {
      id: ev.id || ('e_' + Math.random().toString(36).slice(2,10)),
      type,
      identityId,
      identityName,
      charIds: type==='agreement' ? charIds : [],
      visibleCharIds: type==='note' ? visibleCharIds : [],
      freq,
      time: dt ? (dt.__onlyTime ? null : dt.toISOString().slice(0,16).replace('T',' ')) : null, // Â≠ò‚Äúyyyy-MM-dd HH:mm‚Äù
      name: (ev.name || 'Êú™ÂëΩÂêç‰∫ã‰ª∂').trim(),
      status: dt ? (dt.__onlyTime ? 'draft' : 'confirmed') : 'draft',
      // ‰∏¥Êó∂‰øùÁïô‰∏Ä‰∏™‚Äú‰ªÖÊó∂Èó¥‚ÄùÁöÑÊèêÁ§∫ÔºåÊñπ‰æøÂêéÁª≠ÂêàÂπ∂
      _onlyTime: dt && dt.__onlyTime ? {h:dt.getHours(), m:dt.getMinutes()} : null,
      lastFireAt: ev.lastFireAt || null,
      updatedAt: Date.now()
    };
  }

  function similarName(a,b){
    if(!a||!b) return false;
    const sa=a.replace(/\s+/g,''); const sb=b.replace(/\s+/g,'');
    if(sa===sb) return true;
    return sa.includes(sb) || sb.includes(sa);
  }

  function tryMergeDraft(list, incoming){
    // ‰ªÖÂú®‚ÄúÂêå‰ºöËØùÔºàÂåÖÂê´ÂΩìÂâç charÔºâ„ÄÅÂêåË∫´‰ªΩ„ÄÅÂêåÁ±ªÂûã‚Äù‰∏ãÂ∞ùËØïÂêàÂπ∂
    const candidates = list.filter(x =>
      x.type===incoming.type &&
      x.identityId===incoming.identityId &&
      (incoming.type==='agreement' ? x.charIds.includes(characterId) : true)
    ).sort((a,b)=> (b.updatedAt||0)-(a.updatedAt||0));

    for(const old of candidates){
      // 1) ÂêçÁß∞ÈùûÂ∏∏Áõ∏Ëøë ‚Üí È´ò‰ºòÂÖàÂêàÂπ∂
      if (similarName(old.name, incoming.name)){
        const merged = {...old};
        // ÂêçÁß∞Ôºö‰ª•Êõ¥Èïø/Êõ¥ÂÖ∑‰ΩìÁöÑ‰∏∫ÂáÜ
        if (incoming.name.length > old.name.length) merged.name = incoming.name;
        // Êó∂Èó¥ÔºöÂêàÂπ∂‚ÄúÂè™ÊúâÊó∂Èó¥/Âè™ÊúâÊó•Êúü‚ÄùÁöÑÊÉÖÂÜµ
        if (!old.time && incoming.time) merged.time = incoming.time;
        if (old.time && incoming._onlyTime){
          const [d, tm] = old.time.split(' ');
          const hh = String(incoming._onlyTime.h).padStart(2,'0');
          const mm = String(incoming._onlyTime.m).padStart(2,'0');
          merged.time = `${d} ${hh}:${mm}`;
        }
        if (!old.time && !incoming.time && incoming._onlyTime){ merged._onlyTime = incoming._onlyTime; }
        merged.status = merged.time ? 'confirmed' : 'draft';
        merged.updatedAt = Date.now();
        // Ë¶ÜÁõñ
        Object.assign(old, merged);
        return old;
      }
    }
    return null;
  }

  function saveOrMergeEvent(evDraft){
    const arr = loadEvents();
    const merged = tryMergeDraft(arr, evDraft);
    if (merged){ saveEvents(arr); return merged.id; }
    // Êñ∞Â¢û
    arr.push(evDraft); saveEvents(arr); return evDraft.id;
  }

  /* ========= LLM ========= */
  async function askLLM(history, mergedUserText){
    const cfg = JSON.parse(localStorage.getItem('eg_main_model_cfg') || '{}');
    const apiKey = (cfg.apiKey||'').trim();
    const base   = (cfg.base||'').trim().replace(/\/+$/,'');
    const model  = (cfg.model||'').trim();
    if (!apiKey || !base || !model) return;

    isStreaming = true; setTitleTyping(true);

    // Á≥ªÁªüÊèêÁ§∫Ôºö‰ºòÂÖà‰∏ñÁïå‰π¶ÔºåÂê¶ÂàôÂõûÈÄÄÊú¨Âú∞
    let sysText = '';
    try{
      if (window.Worldbook && window.Worldbook.getPrompt){
        sysText = window.Worldbook.getPrompt('dm_online', {
          charName: current.nickname || current.name,
          charBio: current.bio || '',
          userName: activeIdentity?.nickname || activeIdentity?.name || 'Áî®Êà∑',
          userBio: activeIdentity?.bio || '',
          ltm: '', recentN: 6, platform: 'wechat'
        });
      }
    }catch(_){}
    if (!sysText){ sysText = buildPersonaSystemPrompt(current) + buildUserContextPrompt(activeIdentity); }
    const sys = { role:'system', content: sysText };

    const msgs = history.slice(-20).map(m => ({ role: m.role==='user' ? 'user' : 'assistant', content: m.content }));
    if (mergedUserText && (!msgs.length || msgs[msgs.length-1].role!=='user')){
      msgs.push({ role:'user', content: mergedUserText });
    }

    try{
      const res = await fetch(base + '/chat/completions', {
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey},
        body: JSON.stringify({ model, messages:[sys, ...msgs], temperature:0.7 })
      });
      if (!res.ok) throw new Error(await res.text().catch(()=>('HTTP '+res.status)));

      const data = await res.json();
      let full = (data?.choices?.[0]?.message?.content || '').trim();

      // ‚ë† ‰∫ã‰ª∂ÊäΩÂèñÔºöÂÖàÊï¥ÊÆµÊèêÂèñ‰∏é‰øùÂ≠ò/ÂêàÂπ∂
      const { cleaned, event } = extractEgEventBlock(full);
      if (event){
        const draft = normalizeEventDraft(event, mergedUserText || '');
        saveOrMergeEvent(draft);
      }
      full = cleaned;

      // ‚ë° Ê∏≤ÊüìÁü≠Âè• & ÂõûÂÜô lastMsg
      if (full){
        const chunks = splitChunks(full);
        const threads = getThreads();
        const mine = threads[characterId] || (threads[characterId] = { id: characterId, messages: [] });
        for (const seg of chunks){
          push('you', seg);
          mine.messages.push({ role:'assistant', content: seg, ts: Date.now() });
          saveThreads(threads);
          try{
            const list = JSON.parse(localStorage.getItem('eg_characters_v2') || '[]');
            const it = list.find(c => c.id === characterId);
            if (it){ it.lastMsg = seg; it.lastTime = new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}); localStorage.setItem('eg_characters_v2', JSON.stringify(list)); }
          }catch(_){}
          await new Promise(r=>setTimeout(r, 320));
        }
      }
    }catch(e){ console.error(e); }
    finally{
      isStreaming = false; setTitleTyping(false);
      if (needsFlush){ needsFlush = false; scheduleFlush(); }
    }
  }

  /* ========= ËøîÂõû/ÁºñËæë ========= */
  $('#backBtn').addEventListener('click', () => {
    if (window.openAppPage){ window.openAppPage('message.html'); return; }
    if (history.length > 1){ history.back(); return; }
    location.href = 'message.html';
  });
  $('#moreBtn').addEventListener('click', () => {
    $('#nameInput').value = current.name || '';
    $('#nickInput').value = current.nickname || '';
    $('#bioInput').value  = current.bio || '';
    const up = $('#avatarUpload');
    if (current.avatar && isImg(current.avatar)){ up.innerHTML = '<img src="'+current.avatar+'">'; }
    else { up.innerHTML = current.avatar || 'üë§'; }
    $('#editModal').classList.add('show');
  });
  $('#avatarUpload').addEventListener('click', ()=> $('#avatarInput').click());
  $('#avatarInput').addEventListener('change', e => {
    const f = e.target.files[0]; if (!f) return;
    const rd = new FileReader();
    rd.onload = ev => { $('#avatarUpload').innerHTML = '<img src="'+ev.target.result+'">'; current.avatar = ev.target.result; };
    rd.readAsDataURL(f);
  });
  $('#modalClose').addEventListener('click', ()=> $('#editModal').classList.remove('show'));
  $('#cancelEdit').addEventListener('click', ()=> $('#editModal').classList.remove('show'));
  $('#editForm').addEventListener('submit', e => {
    e.preventDefault();
    current.name     = $('#nameInput').value.trim() || current.name;
    current.nickname = $('#nickInput').value.trim() || current.nickname || current.name;
    current.bio      = $('#bioInput').value.trim() || current.bio;
    const list = JSON.parse(localStorage.getItem('eg_characters_v2') || '[]');
    const idx  = list.findIndex(c => c.id === current.id);
    if (idx >= 0) list[idx] = current;
    localStorage.setItem('eg_characters_v2', JSON.stringify(list));
    setTitleTyping(false);
    $('#editModal').classList.remove('show');
  });

  /* ========= ÂêØÂä® ========= */
  bindKeyboardFit();
  loadCharacters();
  loadIdentities();
  loadHistory();
})();
</script>
</body>
</html>
