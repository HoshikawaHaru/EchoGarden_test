<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
<title>èŠå¤©</title>
<style>
:root{ --safe-top: env(safe-area-inset-top,0px); --safe-bottom: env(safe-area-inset-bottom,0px);}
html,body{height:100%;margin:0;background:#ededed;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;}
.nav{position:sticky;top:0;z-index:5;background:#f7f7f7;border-bottom:.5px solid #d9d9d9;
  height:calc(44px + var(--safe-top)); padding-top:var(--safe-top);
  display:flex; align-items:center; justify-content:center;}
.nav .back{position:absolute;left:8px;bottom:8px;padding:8px;border-radius:10px}
.nav .back:active{background:rgba(0,0,0,.06)}
.nav h1{margin:0 40px 6px;font-size:17px;font-weight:600}

.chat{padding:10px 12px 90px; overflow-y:auto; height:calc(100vh - 44px - var(--safe-top));}
.item{display:flex; margin:10px 0; align-items:flex-end;}
.item.me{justify-content:flex-end}
.avatar{width:36px;height:36px;border-radius:6px;background:#ccc;flex:0 0 36px;display:flex;align-items:center;justify-content:center;font-size:20px}
.bubble{max-width:72%; padding:8px 10px; border-radius:6px; line-height:1.35; font-size:15px; box-shadow:0 1px 0 rgba(0,0,0,.05)}
.item.me .bubble{background:#9fe86d}
.item.you .bubble{background:#fff}

.inputbar{
  position:fixed; left:0; right:0; bottom:0; z-index:6; background:#f7f7f7; border-top:.5px solid #d9d9d9;
  padding:8px 8px calc(8px + var(--safe-bottom));
  display:flex; gap:8px; align-items:center;
}
.inputbar input{
  flex:1; border:0; background:#fff; border-radius:18px; padding:10px 14px; font-size:16px;
}
.send{border:0; background:#34c759; color:#fff; border-radius:14px; padding:8px 14px; font-weight:600}
.send:active{filter:brightness(.95)}
</style>
</head>
<body>
  <div class="nav">
    <button class="back" id="backBtn">â—€</button>
    <h1 id="title">åŠ è½½ä¸­...</h1>
  </div>

  <div class="chat" id="chatList"></div>

  <div class="inputbar">
    <input id="ipt" placeholder="å‘æ¶ˆæ¯â€¦"/>
    <button class="send" id="btnSend">å‘é€</button>
  </div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const chat = $('#chatList');
  const ipt  = $('#ipt');
  const title = $('#title');

  // å…¼å®¹å®¹å™¨/URL/sessionStorage ä¸‰ç§æ¥æº
const q = (document.getElementById('app-container')?.dataset?.query) || '';
const idFromContainer = q ? new URLSearchParams(q).get('id') : null;
const idFromUrl = new URLSearchParams(location.search).get('id');
const chatId = idFromContainer || idFromUrl || sessionStorage.getItem('currentChatId') || 'nash';


  // è¯»å–è§’è‰²ä¿¡æ¯
  let currentCharacter = null;
  try {
    const stored = localStorage.getItem('eg_characters_v2');
    if (stored) {
      const characters = JSON.parse(stored);
      currentCharacter = characters.find(c => c.id === chatId);
    }
  } catch(e) {
    console.error('è¯»å–è§’è‰²å¤±è´¥:', e);
  }

  // è®¾ç½®æ ‡é¢˜
  if (currentCharacter) {
    title.textContent = currentCharacter.nickname || currentCharacter.name;
  } else {
    title.textContent = 'èŠå¤©';
  }

  function scrollBottom(){ chat.scrollTop = chat.scrollHeight; }
  
  function push(type, text){
    const el = document.createElement('div');
    el.className = 'item '+ (type==='me'?'me':'you');
    
    // æ˜¾ç¤ºè§’è‰²å¤´åƒ
    let avatarContent = '';
    if (type === 'you' && currentCharacter) {
      const av = currentCharacter.avatar || 'ğŸ‘¤';
      if (av.startsWith('data:') || av.startsWith('http')) {
        avatarContent = `<img src="${av}" style="width:100%;height:100%;border-radius:6px;object-fit:cover;">`;
      } else {
        avatarContent = av;
      }
    }
    
    el.innerHTML = (type==='me'
      ? `<div class="bubble">${escapeHtml(text)}</div><div class="avatar">ğŸ‘¤</div>`
      : `<div class="avatar">${avatarContent}</div><div class="bubble">${escapeHtml(text)}</div>`);
    chat.appendChild(el);
    scrollBottom();
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // è¿”å›
  $('#backBtn').onclick = function(){
    if (history.length > 1) history.back();
    else location.href = './message.html';
  };

  // è¯»å–è®¾ç½®
  const cfg = JSON.parse(localStorage.getItem('eg_main_model_cfg') || '{}');
  const base = (cfg.base||'').replace(/\/+$/,'');
  const key  = cfg.apiKey||'';
  const model= cfg.model||'gpt-4o-mini';

  async function callLLM(userText){
    // 1) OpenAI å…¼å®¹
    if(base && key){
      try{
        const systemPrompt = currentCharacter 
          ? `ä½ æ˜¯${currentCharacter.nickname || currentCharacter.name}ã€‚äººè®¾ï¼š${currentCharacter.bio}ã€‚è¯·å§‹ç»ˆä¿æŒè¿™ä¸ªäººè®¾æ¥å›å¤ã€‚`
          : 'ä½ æ˜¯å‹å¥½ã€æœ‰ç‚¹æ´»æ³¼çš„èŠå¤©åŠ©ç†ã€‚';
        
        const r = await fetch(base + '/chat/completions',{
          method:'POST',
          headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
          body: JSON.stringify({
            model,
            messages:[{role:'system',content:systemPrompt},{role:'user',content:userText}]
          })
        });
        if(!r.ok) throw new Error('HTTP '+r.status);
        const j = await r.json();
        const txt = j.choices?.[0]?.message?.content?.trim();
        if (txt) return txt;
        throw new Error('ç©ºå“åº”');
      }catch(e){
        console.error('APIè°ƒç”¨å¤±è´¥:', e);
      }
    }
    // 2) æœ¬åœ° mock
    const openings = ['å“å‘€ï¼','æ”¶åˆ°ï½','åœ¨çš„åœ¨çš„ï¼','å—¯å—¯ï½'];
    return openings[Math.floor(Math.random()*openings.length)] + ' ' + userText.slice(0, 80);
  }

  async function send(){
    const text = ipt.value.trim();
    if(!text) return;
    ipt.value = '';
    push('me', text);
    
    try {
      const reply = await callLLM(text);
      push('you', reply);
    } catch(e) {
      push('you', 'æŠ±æ­‰ï¼Œå‡ºäº†ç‚¹é—®é¢˜...');
    }
  }

  $('#btnSend').onclick = send;
  ipt.addEventListener('keydown', e=>{ if(e.key==='Enter') send(); });

  // æ¬¢è¿æ¶ˆæ¯
  if (currentCharacter) {
    const welcomeMsg = `å—¨ï¼æˆ‘æ˜¯ ${currentCharacter.nickname}ï½ç°åœ¨å°±å¯ä»¥ç›´æ¥èŠå¤©å•¦ã€‚`;
    push('you', welcomeMsg);
  } else {
    push('you', 'ä½ å¥½ï¼æˆ‘åœ¨è¿™é‡Œï½');
  }

})();
</script>
</body>
</html>
