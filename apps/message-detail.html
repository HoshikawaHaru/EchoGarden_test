<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>聊天</title>
<link rel="apple-touch-icon" sizes="512x512" href="../assets/icons/icon512.png">
<link rel="icon" href="../assets/icons/icon512.png" type="image/png">
<style>
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  :root{--safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px)}
  html,body{height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#ededed;color:#111}
  .chat-app{position:fixed;inset:0;overflow:hidden}

  /* 顶栏 */
  .chat-navbar{
    position:fixed;left:0;right:0;top:0;z-index:1000;
    height:calc(44px + var(--safe-top)); padding-top:var(--safe-top);
    background:#f7f7f7;border-bottom:.5px solid #d9d9d9;
    display:flex;align-items:center;justify-content:space-between;padding:0 12px
  }
  .chat-back,.chat-more{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .chat-title{position:absolute;left:50%;transform:translateX(-50%);top:calc(10px + var(--safe-top));height:24px;display:flex;align-items:center;font-weight:600;color:#000}

  /* 列表位于顶栏与输入区之间 */
  .chat-list{
    position:fixed;left:0;right:0;z-index:1;
    top:calc(44px + var(--safe-top));
    bottom:calc(56px + var(--safe-bottom));
    overflow-y:auto;-webkit-overflow-scrolling:touch;padding:10px 12px 0 12px
  }
  .row{display:flex;align-items:flex-end;margin:10px 0;gap:8px}
  .row.you{justify-content:flex-start}
  .row.me{justify-content:flex-end}
  .avatar{width:36px;height:36px;border-radius:6px;background:#eee;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
  .avatar img{width:100%;height:100%;object-fit:cover;border-radius:6px}
  .bubble{max-width:72vw;padding:10px 12px;border-radius:8px;font-size:16px;line-height:1.4;word-break:break-word;box-shadow:0 1px 0 rgba(0,0,0,.05)}
  .row.you .bubble{background:#fff;border:1px solid #eaeaea}
  .row.me  .bubble{background:#95ec69}

  /* 居中提示（时间/戳一戳） */
  .center-tip{display:flex;justify-content:center;color:#9b9b9b;font-size:12px;margin:8px 0}

  /* 输入区 */
  .input-bar{
    position:fixed;left:0;right:0;bottom:0;z-index:1000;
    background:#f7f7f7;border-top:.5px solid #d9d9d9;
    padding:8px 10px; padding-bottom:calc(8px + var(--safe-bottom));
    display:flex;gap:8px;align-items:center;min-height:calc(56px + var(--safe-bottom))
  }
  .ipt-wrap{position:relative;flex:1;display:flex;align-items:center}
  .ipt{
    flex:1;background:#fff;border:1px solid #e1e1e1;border-radius:18px;
    padding:10px 48px 10px 48px; font-size:16px; outline:none
  }
  /* 左侧“＋”与右侧“表情”——线条图标，无外圈 */
  .btn-plus,.btn-emoji{
    position:absolute;top:50%;transform:translateY(-50%);background:transparent;border:0;cursor:pointer;
    width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center
  }
  .btn-plus{left:6px}
  .btn-emoji{right:6px}
  .btn-plus svg,.btn-emoji svg{width:24px;height:24px;stroke:#111}

  .send{background:#07c160;color:#fff;border:none;border-radius:18px;padding:10px 14px;font-size:15px;cursor:pointer}
  .send:active{background:#06ad56}

  /* 展开面板（＋） */
  .quick-panel{position:absolute;bottom:56px;left:10px;background:#fff;border:1px solid #e5e5e5;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);display:none;flex-direction:column;min-width:160px;overflow:hidden;z-index:1200}
  .quick-panel.show{display:flex}
  .quick-item{display:flex;align-items:center;gap:8px;padding:10px 12px;cursor:pointer}
  .quick-item:hover{background:#f7f7f7}
  .quick-item svg{width:18px;height:18px;stroke:#111}

  /* 表情面板（贴纸） */
  .sticker-panel{position:fixed;left:0;right:0;bottom:calc(56px + var(--safe-bottom));background:#fff;border-top:1px solid #e5e5e5;display:none;z-index:1100}
  .sticker-panel.show{display:block}
  .sticker-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;padding:10px}
  .sticker-grid img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px;border:1px solid #eee;cursor:pointer}
  .sticker-toolbar{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;border-top:1px solid #eee}
  .sticker-upload{padding:6px 10px;border:1px solid #e5e5e5;border-radius:8px;background:#fafafa;cursor:pointer}

  /* 红包卡片（微信风） */
  .redpack{background:#ff9f3f;color:#fff;border-radius:10px;padding:12px 14px;min-width:220px;max-width:72vw;position:relative}
  .row.me .redpack{border-top-right-radius:0}
  .row.you .redpack{border-top-left-radius:0}
  .redpack .rp-title{font-size:16px;font-weight:600;margin-left:42px}
  .redpack .rp-sub{opacity:.9;font-size:12px;margin-left:42px;margin-top:6px}
  .rp-icon{position:absolute;left:12px;top:12px;width:28px;height:28px;border-radius:6px;background:#e65f2b;
    display:flex;align-items:center;justify-content:center}
  .rp-icon::after{content:'¥';color:#ffdb76;font-weight:700}

  /* 弹窗通用 */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:1300}
  .modal.show{display:flex}
  .modal-content{background:#fff;width:90%;max-width:420px;border-radius:12px;overflow:hidden}
  .modal-header{padding:16px;border-bottom:.5px solid #e5e5e5;display:flex;justify-content:space-between;align-items:center}
  .modal-title{font-size:17px;font-weight:600}
  .modal-close{font-size:24px;color:#999;cursor:pointer;padding:4px}
  .modal-body{padding:16px;max-height:60vh;overflow-y:auto}
  .form-group{margin-bottom:14px}
  .form-label{display:block;font-size:14px;color:#666;margin-bottom:6px}
  .form-input{width:100%;padding:10px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px}
  .form-textarea{width:100%;padding:10px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px;min-height:80px;resize:vertical}

  .btns{display:flex;gap:10px;margin-top:10px}
  .btn{flex:1;padding:12px;border:none;border-radius:8px;font-size:16px;cursor:pointer}
  .btn.primary{background:#07c160;color:#fff}
  .btn.ghost{background:#f2f2f2;color:#111}

  .title-typing .dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:#666;margin:0 1px;opacity:.5;animation:blink 1.2s infinite}
  .title-typing .dot:nth-child(2){animation-delay:.2s}
  .title-typing .dot:nth-child(3){animation-delay:.4s}
  @keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}
</style>
</head>
<body>
<div class="chat-app">
  <!-- 顶栏 -->
  <div class="chat-navbar" id="navBar">
    <div class="chat-back" id="backBtn" aria-label="返回">
      <svg viewBox="0 0 24 24" fill="none"><path d="M15 6L9 12L15 18" stroke="#111" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </div>
    <div class="chat-title" id="title">聊天</div>
    <div class="chat-more" id="moreBtn" aria-label="编辑">
      <svg viewBox="0 0 24 24" fill="none"><circle cx="5" cy="12" r="1.6" fill="#111"/><circle cx="12" cy="12" r="1.6" fill="#111"/><circle cx="19" cy="12" r="1.6" fill="#111"/></svg>
    </div>
  </div>

  <!-- 消息列表 -->
  <div class="chat-list" id="chatList"></div>

  <!-- 表情（贴纸） -->
  <div class="sticker-panel" id="stickerPanel">
    <div class="sticker-grid" id="stickerGrid"></div>
    <div class="sticker-toolbar">
      <span style="font-size:12px;color:#666">我的表情包</span>
      <label class="sticker-upload">上传<input type="file" id="stickerInput" accept="image/*" style="display:none"></label>
    </div>
  </div>

  <!-- 输入区 -->
  <div class="input-bar" id="inputBar">
    <div class="ipt-wrap">
      <button id="plusBtn" class="btn-plus" aria-label="更多">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="#111" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
      <input id="ipt" class="ipt" placeholder="发消息..." />
      <button id="emojiBtn" class="btn-emoji" aria-label="表情">
        <svg viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="9" stroke="#111" stroke-width="1.8"/>
          <circle cx="9" cy="10" r="1.2" fill="#111"/><circle cx="15" cy="10" r="1.2" fill="#111"/>
          <path d="M8 14c1.4 2.2 6.6 2.2 8 0" stroke="#111" stroke-width="1.8" stroke-linecap="round"/>
        </svg>
      </button>
      <!-- plus 面板 -->
      <div class="quick-panel" id="quickPanel">
        <div class="quick-item" id="actRegenerate">
          <svg viewBox="0 0 24 24" fill="none"><path d="M21 12a9 9 0 1 1-2.64-6.36" stroke="#111" stroke-width="1.6" stroke-linecap="round"/><path d="M21 4v5h-5" stroke="#111" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span>回复重新生成</span>
        </div>
        <div class="quick-item" id="actNudge">
          <svg viewBox="0 0 24 24" fill="none"><path d="M12 3v18M5 12h14" stroke="#111" stroke-width="1.6" stroke-linecap="round"/></svg>
          <span>戳一戳</span>
        </div>
        <div class="quick-item" id="actRedpack">
          <svg viewBox="0 0 24 24" fill="none"><rect x="4" y="4" width="16" height="16" rx="2" stroke="#111" stroke-width="1.6"/><circle cx="12" cy="12" r="3.2" stroke="#111" stroke-width="1.6"/></svg>
          <span>发红包</span>
        </div>
      </div>
    </div>
    <button id="sendBtn" class="send">发送</button>
  </div>
</div>

<!-- 编辑角色 -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">编辑角色</div>
      <div class="modal-close" id="modalClose">×</div>
    </div>
    <div class="modal-body">
      <form id="editForm">
        <div class="form-group">
          <label class="form-label">头像</label>
          <div class="avatar-upload" id="avatarUpload"><span>📷</span></div>
          <input type="file" id="avatarInput" accept="image/*" style="display:none">
        </div>
        <div class="form-group">
          <label class="form-label">姓名</label>
          <input type="text" id="nameInput" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">昵称</label>
          <input type="text" id="nickInput" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">人设</label>
          <textarea id="bioInput" class="form-textarea" required></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">行为</label>
          <label style="display:flex;align-items:center;gap:8px;color:#666;">
            <input type="checkbox" id="bgSwitch">
            <span>允许后台活动（到事件时间自动发消息）</span>
          </label>
        </div>
        <div class="btns">
          <button type="button" class="btn ghost" id="cancelEdit">取消</button>
          <button type="submit" class="btn primary">保存</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 红包弹窗 -->
<div class="modal" id="redpackModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">发送红包</div>
      <div class="modal-close" id="rpClose">×</div>
    </div>
    <div class="modal-body">
      <form id="rpForm">
        <div class="form-group">
          <label class="form-label">金额（元）</label>
          <input id="rpAmount" class="form-input" type="number" inputmode="decimal" step="0.01" min="0.01" placeholder="例如 8.88" required>
        </div>
        <div class="form-group">
          <label class="form-label">祝福语（可选）</label>
          <input id="rpBless" class="form-input" placeholder="如：生日快乐">
        </div>
        <div class="btns">
          <button type="button" class="btn ghost" id="rpCancel">取消</button>
          <button type="submit" class="btn primary">发送</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(() => {
  'use strict';
  const $ = s => document.querySelector(s);
  const esc = s => String(s ?? '').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const isImg = s => typeof s === 'string' && (s.startsWith('data:') || s.startsWith('http'));

  const chat = $('#chatList'); const ipt = $('#ipt'); const titleEl = $('#title');
  const characterId = new URLSearchParams(location.search).get('id') || sessionStorage.getItem('currentChatId') || 'nash';

  /* -------- 角色/身份 -------- */
  let characters = []; let current=null; let identities=[]; let activeIdentity=null;

  function loadCharacters(){
    try{ characters = JSON.parse(localStorage.getItem('eg_characters_v2')||'[]'); }catch(e){ characters=[]; }
    if(!characters.length){
      characters=[{id:'nash',name:'Nash',nickname:'Nash',bio:'天真开朗的小狐狸',avatar:'🦊',allowBG:true}];
      localStorage.setItem('eg_characters_v2', JSON.stringify(characters));
    }
    current = characters.find(c=>c.id===characterId) || characters[0];
  }
  function loadIdentities(){
    try{ identities = JSON.parse(localStorage.getItem('eg_user_identities_v1')||'[]')||[]; }catch(e){ identities=[]; }
    if(!identities.length){
      identities=[{id:'u_default',kind:'identity',name:'User',nickname:'我',avatar:'👤',bio:'',boundCharIds:[]}];
      localStorage.setItem('eg_user_identities_v1', JSON.stringify(identities));
    }
    // 默认身份绑定未占用角色
    const def=identities[0]; const all=(characters||[]).map(c=>c.id);
    const taken=new Set(); identities.slice(1).forEach(u=>(u.boundCharIds||[]).forEach(id=>taken.add(id)));
    def.boundCharIds = all.filter(id=>!taken.has(id));
    localStorage.setItem('eg_user_identities_v1', JSON.stringify(identities));
    activeIdentity = identities.find((u,i)=>i>0 && (u.boundCharIds||[]).includes(characterId)) || identities[0];
  }
  window.addEventListener('storage', e=>{
    if (['eg_user_identities_v1','eg_evt_ping','eg_evt_chars'].includes(e.key||'')) loadIdentities();
  });

  /* -------- 贴纸库 -------- */
  const LS_STICKERS='eg_stickers_v1';
  const loadStickers=()=>{ try{ return JSON.parse(localStorage.getItem(LS_STICKERS)||'[]')||[]; }catch(_){return[];} };
  const saveStickers=a=> localStorage.setItem(LS_STICKERS, JSON.stringify(a));
  function renderStickers(){
    const g=$('#stickerGrid'); const arr=loadStickers();
    g.innerHTML = arr.map((src,i)=>`<img src="${src}" data-i="${i}">`).join('') || '<div style="color:#999;padding:10px">暂无表情，点击右侧上传</div>';
    g.querySelectorAll('img').forEach(img=>{
      img.onclick = ()=>{ push('me','[表情]'); appendUserMsg('[贴纸]', {img:img.src}); };
    });
  }
  $('#stickerInput').addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f) return;
    const rd=new FileReader(); rd.onload=ev=>{ const arr=loadStickers(); arr.unshift(ev.target.result); saveStickers(arr); renderStickers(); }; rd.readAsDataURL(f);
  });

  /* -------- 历史 -------- */
  function getThreads(){ try{ return JSON.parse(localStorage.getItem('eg_threads_v1')||'{}'); }catch(e){ return {}; } }
  function saveThreads(map){ localStorage.setItem('eg_threads_v1', JSON.stringify(map)); }
  function loadHistory(){
    const msgs=(getThreads()[characterId]?.messages)||[];
    chat.innerHTML='';
    let lastTsDay='';
    msgs.forEach(m=>{
      if(m.meta?.center){
        centerTip(m.content);
        return;
      }
      const who = m.role==='user' ? 'me' : 'you';
      push(who, m.content, m);
    });
    chat.scrollTop=chat.scrollHeight;
  }

  function avatarNode(from){
    const el=document.createElement('div'); el.className='avatar';
    const av = (from==='me') ? (activeIdentity?.avatar||'👤') : (current?.avatar||'👤');
    if(isImg(av)){ const img=document.createElement('img'); img.src=av; el.appendChild(img); } else el.textContent=av;
    return el;
  }

  function push(type, text, meta){
    if(!text) return;
    const row=document.createElement('div'); row.className='row '+(type==='me'?'me':'you');
    const ava=avatarNode(type);
    const bubble=document.createElement('div');
    // 红包显示
    if(meta && meta.meta && meta.meta.redpack){
      bubble.className='redpack';
      bubble.innerHTML = `<div class="rp-icon"></div><div class="rp-title">${esc(meta.meta.redpack.bless||'红包')}</div><div class="rp-sub">微信红包 · ¥${esc(meta.meta.redpack.amount)}</div>`;
    }else{
      bubble.className='bubble'; bubble.textContent=text;
    }
    if(type==='me'){ row.appendChild(bubble); row.appendChild(ava); } else { row.appendChild(ava); row.appendChild(bubble); }
    chat.appendChild(row); chat.scrollTop=chat.scrollHeight;
  }
  function centerTip(text){
