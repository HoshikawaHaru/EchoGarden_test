<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>èŠå¤©</title>
  <link rel="apple-touch-icon" sizes="512x512" href="../assets/icons/icon512.png">
  <link rel="icon" href="../assets/icons/icon512.png" type="image/png">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{--safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px)}
    html,body{height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#ededed;color:#111}

    .chat-app{position:fixed;inset:0;overflow:hidden}

    /* é¡¶æ ï¼ˆæé«˜å±‚çº§ï¼Œé¿å…è¢«åˆ—è¡¨è¦†ç›–ï¼‰ */
    .chat-navbar{
      position:fixed;left:0;right:0;top:0;
      height:calc(44px + var(--safe-top));
      padding-top:var(--safe-top);
      background:#f7f7f7;border-bottom:.5px solid #d9d9d9;
      display:flex;align-items:center;justify-content:space-between;
      padding-left:12px;padding-right:12px;
      z-index:1000;
    }
    .chat-back,.chat-more{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .icon-ellipses{width:24px;height:24px}
    .chat-title{position:absolute;left:50%;transform:translateX(-50%);top:calc(10px + var(--safe-top));height:24px;display:flex;align-items:center;font-weight:600;color:#000}

    /* åˆ—è¡¨å›ºå®šåœ¨å¯¼èˆªä¸è¾“å…¥åŒºä¹‹é—´ï¼Œé¿å…è¦†ç›–å¯¼èˆª */
    .chat-list{
      position:fixed;left:0;right:0;
      top:calc(44px + var(--safe-top));
      bottom:calc(56px + var(--safe-bottom));
      overflow-y:auto;-webkit-overflow-scrolling:touch;
      padding:10px 12px 0 12px; z-index:1;
    }
    .row{display:flex;align-items:flex-end;margin:10px 0;gap:8px}
    .row.you{justify-content:flex-start}
    .row.me{justify-content:flex-end}
    .avatar{width:36px;height:36px;border-radius:6px;background:#eee;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
    .avatar img{width:100%;height:100%;object-fit:cover;border-radius:6px}
    .bubble{max-width:72vw;padding:10px 12px;border-radius:8px;font-size:16px;line-height:1.4;word-break:break-word;box-shadow:0 1px 0 rgba(0,0,0,.05)}
    .row.you .bubble{background:#fff;border:1px solid #eaeaea}
    .row.me  .bubble{background:#95ec69}

    /* åº•éƒ¨è¾“å…¥åŒºï¼ˆæé«˜å±‚çº§ï¼‰ */
    .input-bar{
      position:fixed;left:0;right:0;bottom:0;
      background:#f7f7f7;border-top:.5px solid #d9d9d9;
      padding:8px 10px;padding-bottom:calc(8px + var(--safe-bottom));
      display:flex;gap:8px;align-items:center;min-height:calc(56px + var(--safe-bottom));
      z-index:1000;
    }
    .ipt-wrap{position:relative;flex:1;display:flex;align-items:center;gap:8px}
    .ipt{flex:1;background:#fff;border:1px solid #e1e1e1;border-radius:18px;padding:10px 14px 10px 44px;font-size:16px;outline:none}
    .send{background:#07c160;color:#fff;border:none;border-radius:18px;padding:10px 14px;font-size:15px;cursor:pointer}
    .send:active{background:#06ad56}

    /* å·¦ä¾§â€œï¼‹â€æŒ‰é’®ï¼ˆé»‘è‰²çº¿æ¡ã€åœ†è¾¹æ¡†ï¼‰ */
    .btn-plus{
      position:absolute;left:8px;display:inline-flex;align-items:center;justify-content:center;
      width:28px;height:28px;border:1.5px solid #111;border-radius:999px;background:#fff;cursor:pointer
    }
    .btn-plus svg{width:16px;height:16px;stroke:#111}
    /* å³ä¾§â€œè¡¨æƒ…â€çº¿æ¡æŒ‰é’®ï¼ˆé¢œæ–‡å­—æ ·å¼ï¼‰ */
    .btn-emoji{
      position:absolute;right:8px;display:inline-flex;align-items:center;justify-content:center;
      width:28px;height:28px;border:1.5px solid #111;border-radius:999px;background:#fff;cursor:pointer
    }
    .btn-emoji svg{width:16px;height:16px;stroke:#111}

    /* å±•å¼€é¢æ¿ï¼ˆï¼‹åŠŸèƒ½ï¼‰ */
    .quick-panel{position:absolute;bottom:56px;left:10px;background:#fff;border:1px solid #e5e5e5;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);display:none;flex-direction:column;min-width:150px;overflow:hidden;z-index:1200}
    .quick-panel.show{display:flex}
    .quick-item{display:flex;align-items:center;gap:8px;padding:10px 12px;cursor:pointer}
    .quick-item:hover{background:#f7f7f7}
    .quick-item svg{width:18px;height:18px;stroke:#111}

    /* è¡¨æƒ…ï¼ˆè´´çº¸ï¼‰é€‰æ‹©å™¨ */
    .sticker-panel{position:fixed;left:0;right:0;bottom:calc(56px + var(--safe-bottom));background:#fff;border-top:1px solid #e5e5e5;display:none;z-index:1100}
    .sticker-panel.show{display:block}
    .sticker-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;padding:10px}
    .sticker-grid img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px;border:1px solid #eee;cursor:pointer}
    .sticker-toolbar{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;border-top:1px solid #eee}
    .sticker-upload{padding:6px 10px;border:1px solid #e5e5e5;border-radius:8px;background:#fafafa;cursor:pointer}

    .title-typing .dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:#666;margin:0 1px;opacity:.5;animation:blink 1.2s infinite}
    .title-typing .dot:nth-child(2){animation-delay:.2s}
    .title-typing .dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}

    /* å¼¹çª— */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:1300}
    .modal.show{display:flex}
    .modal-content{background:#fff;width:90%;max-width:420px;border-radius:12px;overflow:hidden}
    .modal-header{padding:16px;border-bottom:.5px solid #e5e5e5;display:flex;justify-content:space-between;align-items:center}
    .modal-title{font-size:17px;font-weight:600}
    .modal-close{font-size:24px;color:#999;cursor:pointer;padding:4px}
    .modal-body{padding:16px;max-height:60vh;overflow-y:auto}
    .form-group{margin-bottom:16px}
    .form-label{display:block;font-size:14px;color:#666;margin-bottom:8px}
    .form-input{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px}
    .form-textarea{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px;min-height:100px;resize:vertical}
    .avatar-upload{width:80px;height:80px;border-radius:8px;border:2px dashed #e5e5e5;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden}
    .avatar-upload img{width:100%;height:100%;object-fit:cover}
    .btns{display:flex;gap:10px}
    .btn{flex:1;padding:12px;border:none;border-radius:8px;font-size:16px;cursor:pointer}
    .btn.primary{background:#07c160;color:#fff}
    .btn.ghost{background:#f2f2f2;color:#111}
    .switch{display:inline-flex;align-items:center;gap:8px;color:#666}
  </style>
</head>
<body>
  <div class="chat-app">
    <div class="chat-navbar" id="navBar">
      <div class="chat-back" id="backBtn" aria-label="è¿”å›">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M15 6L9 12L15 18" stroke="#111" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
      <div class="chat-title" id="title">èŠå¤©</div>
      <div class="chat-more" id="moreBtn" aria-label="ç¼–è¾‘">
        <svg class="icon-ellipses" viewBox="0 0 24 24" fill="none"><circle cx="5" cy="12" r="1.6" fill="#111"/><circle cx="12" cy="12" r="1.6" fill="#111"/><circle cx="19" cy="12" r="1.6" fill="#111"/></svg>
      </div>
    </div>

    <div class="chat-list" id="chatList"></div>

    <!-- è¡¨æƒ…ï¼ˆè´´çº¸ï¼‰ -->
    <div class="sticker-panel" id="stickerPanel">
      <div class="sticker-grid" id="stickerGrid"></div>
      <div class="sticker-toolbar">
        <span style="font-size:12px;color:#666">æˆ‘çš„è¡¨æƒ…åŒ…</span>
        <label class="sticker-upload">ä¸Šä¼ <input type="file" id="stickerInput" accept="image/*" style="display:none"></label>
      </div>
    </div>

    <div class="input-bar" id="inputBar">
      <div class="ipt-wrap">
        <button id="plusBtn" class="btn-plus" aria-label="æ›´å¤š">
          <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="#111" stroke-width="1.5" fill="none"/><path d="M12 7v10M7 12h10" stroke="#111" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>
        <input id="ipt" class="ipt" placeholder="å‘æ¶ˆæ¯..." />
        <button id="emojiBtn" class="btn-emoji" aria-label="è¡¨æƒ…">
          <svg viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="#111" stroke-width="1.5" fill="none"/>
            <circle cx="9" cy="10" r="1" fill="#111"/><circle cx="15" cy="10" r="1" fill="#111"/>
            <path d="M8 14c1.2 2 6.8 2 8 0" stroke="#111" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <!-- å±•å¼€åŠŸèƒ½é¢æ¿ -->
        <div class="quick-panel" id="quickPanel">
          <div class="quick-item" id="actRegenerate">
            <svg viewBox="0 0 24 24" fill="none"><path d="M21 12a9 9 0 1 1-2.64-6.36" stroke="#111" stroke-width="1.6" stroke-linecap="round"/><path d="M21 4v5h-5" stroke="#111" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span>å›å¤é‡æ–°ç”Ÿæˆ</span>
          </div>
          <div class="quick-item" id="actNudge">
            <svg viewBox="0 0 24 24" fill="none"><path d="M12 3v18M5 12h14" stroke="#111" stroke-width="1.6" stroke-linecap="round"/></svg>
            <span>æˆ³ä¸€æˆ³</span>
          </div>
          <div class="quick-item" id="actRedpack">
            <svg viewBox="0 0 24 24" fill="none"><rect x="4" y="4" width="16" height="16" rx="2" stroke="#111" stroke-width="1.6"/><circle cx="12" cy="12" r="3.2" stroke="#111" stroke-width="1.6"/></svg>
            <span>å‘çº¢åŒ…</span>
          </div>
        </div>
      </div>
      <button id="sendBtn" class="send">å‘é€</button>
    </div>
  </div>

  <!-- ç¼–è¾‘è§’è‰²å¼¹çª—ï¼ˆå«â€œå…è®¸åå°æ´»åŠ¨â€ï¼‰ -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ç¼–è¾‘è§’è‰²</div>
        <div class="modal-close" id="modalClose">Ã—</div>
      </div>
      <div class="modal-body">
        <form id="editForm">
          <div class="form-group">
            <label class="form-label">å¤´åƒ</label>
            <div class="avatar-upload" id="avatarUpload"><span>ğŸ“·</span></div>
            <input type="file" id="avatarInput" accept="image/*" style="display:none">
          </div>
          <div class="form-group">
            <label class="form-label">å§“å</label>
            <input type="text" id="nameInput" class="form-input" required>
          </div>
          <div class="form-group">
            <label class="form-label">æ˜µç§°</label>
            <input type="text" id="nickInput" class="form-input">
          </div>
          <div class="form-group">
            <label class="form-label">äººè®¾</label>
            <textarea id="bioInput" class="form-textarea" required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">è¡Œä¸º</label>
            <label class="switch">
              <input type="checkbox" id="bgSwitch">
              <span>å…è®¸åå°æ´»åŠ¨ï¼ˆåˆ°äº‹ä»¶æ—¶é—´è‡ªåŠ¨å‘æ¶ˆæ¯ï¼‰</span>
            </label>
          </div>
          <div class="btns">
            <button type="button" class="btn ghost" id="cancelEdit">å–æ¶ˆ</button>
            <button type="submit" class="btn primary">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>
  </div>

<script>
(() => {
  'use strict';

  const $ = s => document.querySelector(s);
  const esc = s => String(s ?? '').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const isImg = s => typeof s === 'string' && (s.startsWith('data:') || s.startsWith('http'));

  const chat     = $('#chatList');
  const ipt      = $('#ipt');
  const titleEl  = $('#title');

  const characterId = new URLSearchParams(location.search).get('id') || sessionStorage.getItem('currentChatId') || 'nash';

  /* ---------------- è§’è‰²/èº«ä»½ ---------------- */
  let characters = []; let current = null;
  let identities = []; let activeIdentity = null;

  function loadCharacters(){
    try{ characters = JSON.parse(localStorage.getItem('eg_characters_v2')||'[]'); }catch(e){ characters=[]; }
    if(!characters.length){
      characters=[{id:'nash',name:'Nash',nickname:'Nash',bio:'å¤©çœŸå¼€æœ—çš„å°ç‹ç‹¸',avatar:'ğŸ¦Š',allowBG:true}];
      localStorage.setItem('eg_characters_v2', JSON.stringify(characters));
    }
    current = characters.find(c=>c.id===characterId) || characters[0];
  }
  function loadIdentities(){
    try{ identities = JSON.parse(localStorage.getItem('eg_user_identities_v1')||'[]')||[]; }catch(e){ identities=[]; }
    if(!identities.length){
      identities=[{id:'u_default',name:'User',nickname:'æˆ‘',avatar:'ğŸ‘¤',bio:'',boundCharIds:[],kind:'identity'}];
      localStorage.setItem('eg_user_identities_v1', JSON.stringify(identities));
    }
    // é»˜è®¤èº«ä»½ç»‘å®šæœªå ç”¨è§’è‰²
    const def=identities[0]; const all=(characters||[]).map(c=>c.id);
    const taken=new Set(); identities.slice(1).forEach(u=>(u.boundCharIds||[]).forEach(id=>taken.add(id)));
    def.boundCharIds = all.filter(id=>!taken.has(id));
    localStorage.setItem('eg_user_identities_v1', JSON.stringify(identities));

    // æ‰¾åˆ°å½“å‰è§’è‰²çš„ç”Ÿæ•ˆèº«ä»½
    activeIdentity = identities.find((u,i)=>i>0 && (u.boundCharIds||[]).includes(characterId)) || identities[0];
  }
  window.addEventListener('storage', e=>{
    if (['eg_user_identities_v1','eg_evt_ping','eg_evt_chars'].includes(e.key||'')) loadIdentities();
  });

  /* ---------------- è´´çº¸åº“ ---------------- */
  const LS_STICKERS='eg_stickers_v1';
  function loadStickers(){ try{ return JSON.parse(localStorage.getItem(LS_STICKERS)||'[]')||[]; }catch(e){ return []; } }
  function saveStickers(a){ localStorage.setItem(LS_STICKERS, JSON.stringify(a)); }
  function renderStickers(){
    const g=$('#stickerGrid'); const arr=loadStickers();
    g.innerHTML = arr.map((src,i)=>`<img src="${src}" data-i="${i}">`).join('') || '<div style="color:#999;padding:10px">æš‚æ— è¡¨æƒ…ï¼Œç‚¹å‡»å³ä¾§ä¸Šä¼ </div>';
    g.querySelectorAll('img').forEach(img=>{
      img.onclick = ()=>{ push('me', '[è¡¨æƒ…]'); sendSticker(img.src); };
    });
  }
  $('#stickerInput').addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f) return;
    const rd=new FileReader(); rd.onload=ev=>{
      const arr=loadStickers(); arr.unshift(ev.target.result); saveStickers(arr); renderStickers();
    }; rd.readAsDataURL(f);
  });
  function sendSticker(src){
    // ä»¥æ¶ˆæ¯å†™å…¥
    const threads=getThreads(); const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
    mine.messages.push({role:'user',content:'[è´´çº¸]',img:src,ts:Date.now()});
    saveThreads(threads);
    // UI ç®€åŒ–ä¸ºæ–‡å­—æç¤ºï¼ŒçœŸè¦å±•ç¤ºå›¾å¯æ‰©å±• bubble å›¾ç‰‡
  }

  /* ---------------- å†å² ---------------- */
  function getThreads(){ try{ return JSON.parse(localStorage.getItem('eg_threads_v1')||'{}'); }catch(e){ return {}; } }
  function saveThreads(map){ localStorage.setItem('eg_threads_v1', JSON.stringify(map)); }

  function loadHistory(){
    const msgs=(getThreads()[characterId]?.messages)||[];
    chat.innerHTML='';
    msgs.forEach(m=>{
      const who = m.role==='user' ? 'me' : 'you';
      push(who, m.content);
    });
    chat.scrollTop = chat.scrollHeight;
  }

  function avatarNode(from){
    const el=document.createElement('div'); el.className='avatar';
    const av = (from==='me') ? (activeIdentity?.avatar||'ğŸ‘¤') : (current?.avatar||'ğŸ‘¤');
    if(isImg(av)){ const img=document.createElement('img'); img.src=av; el.appendChild(img); }
    else el.textContent = av;
    return el;
  }

  function push(type, text){
    if(!text) return;
    const row=document.createElement('div'); row.className='row '+(type==='me'?'me':'you');
    const ava=avatarNode(type);
    const bubble=document.createElement('div'); bubble.className='bubble'; bubble.textContent=text;
    if(type==='me'){ row.appendChild(bubble); row.appendChild(ava); } else { row.appendChild(ava); row.appendChild(bubble); }
    chat.appendChild(row); chat.scrollTop=chat.scrollHeight;
  }

  /* ---------------- æ­£åœ¨è¾“å…¥æç¤º ---------------- */
  let typingTicker=null;
  function setTitleTyping(on){
    if(on){
      titleEl.classList.add('title-typing');
      titleEl.innerHTML='å¯¹æ–¹æ­£åœ¨è¾“å…¥&nbsp;<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      if(typingTicker){ clearInterval(typingTicker); typingTicker=null; }
    }else{
      titleEl.classList.remove('title-typing');
      titleEl.textContent = current.nickname || current.name || 'èŠå¤©';
    }
  }

  /* ---------------- å‘é€ä¸å»¶è¿Ÿèšåˆ ---------------- */
  const DELAY_MS = parseInt(localStorage.getItem('eg_reply_delay_ms') || '5000',10);
  let bufferMsgs=[]; let flushTimer=null; let isStreaming=false; let needsFlush=false;

  function scheduleFlush(){ if(isStreaming){ needsFlush=true; return; } clearTimeout(flushTimer); flushTimer=setTimeout(tryFlush, DELAY_MS); }
  function clearFlush(){ clearTimeout(flushTimer); flushTimer=null; }
  async function tryFlush(extraUserHint=''){
    if(isStreaming || (!bufferMsgs.length && !extraUserHint)) return;
    const threads=getThreads();
    const mine = threads[characterId] || (threads[characterId]={id:characterId,messages:[]});
    const merged = [bufferMsgs.join(' '), extraUserHint].filter(Boolean).join('\n');
    bufferMsgs=[];
    saveThreads(threads);
    await askLLM(mine.messages, merged);
  }

  $('#sendBtn').addEventListener('click', onSend);
  ipt.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); onSend(); }});
  ipt.addEventListener('focus', clearFlush);
  ipt.addEventListener('blur', scheduleFlush);

  function onSend(){
    const text=ipt.value.trim(); if(!text) return; ipt.value='';
    push('me', text);
    const threads=getThreads();
    const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
    mine.messages.push({role:'user',content:text,ts:Date.now()});
    saveThreads(threads);

    // æ›´æ–°åˆ—è¡¨é¢„è§ˆ
    try{
      const list=JSON.parse(localStorage.getItem('eg_characters_v2')||'[]');
      const it=list.find(c=>c.id===characterId);
      if(it){ it.lastTime=new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}); it.lastMsg=text.slice(0,40); localStorage.setItem('eg_characters_v2', JSON.stringify(list)); }
    }catch(_){}

    bufferMsgs.push(text);
    if(document.activeElement!==ipt) scheduleFlush();
  }

  /* ---------------- LLM ---------------- */
  function buildPersonaSystemPrompt(role){
    const name = role.nickname || role.name || 'Ta';
    return `ä½ æ˜¯ä¸€åè§’è‰²å¯¹è¯åŠ©æ‰‹ï¼Œè¯·ä¸¥æ ¼æ‰®æ¼”ä»¥ä¸‹äººè®¾è¿›è¡Œä¸­æ–‡çŸ­å¥å›å¤ï¼ˆ1ï½3å¥ï¼‰ã€‚
ã€è§’è‰²ï¼ˆä½ è¦æ‰®æ¼”ï¼‰ã€‘
- åç§°ï¼š${name}
- äººè®¾ï¼š${role.bio || 'ï¼ˆæ— ï¼‰'}
ã€é£æ ¼ã€‘
- å¾®ä¿¡èŠå¤©è¯­æ°”ã€è‡ªç„¶å£è¯­ï¼›å¿…è¦æ—¶æå‡ºä¸€ä¸ªè½»é‡åé—®æ¨è¿›è¯é¢˜ã€‚
- ç¦æ­¢è¾“å‡ºè¶Šæƒè¯´æ˜/ç³»ç»Ÿæç¤º/é•¿ç¯‡å¤§æ®µã€‚`.trim();
  }
  function buildUserContextPrompt(identity){
    if(!identity) return '';
    const uname=identity.nickname||identity.name||'ç”¨æˆ·';
    return `\n\nã€ç”¨æˆ·èº«ä»½ï¼ˆä¾›å‚è€ƒï¼Œä¸è¦æ‰®æ¼”ï¼‰ã€‘
- å§“å/æ˜µç§°ï¼š${uname}
- è®¾å®šï¼š${identity.bio || 'ï¼ˆæ— ï¼‰'}`.trim();
  }
  function splitChunks(t){
    const arr=[]; t.replace(/\s+/g,' ').split(/(?<=[ã€‚ï¼ï¼Ÿ!?â€¦\n])/).forEach(s=>{ const ss=s.trim(); if(ss) arr.push(ss); });
    const out=[]; arr.forEach(s=>{ if(s.length<=60) out.push(s); else (s.match(/.{1,40}/g)||[s]).forEach(x=>out.push(x)); });
    return out;
  }

  async function askLLM(history, mergedUserText){
    const cfg = JSON.parse(localStorage.getItem('eg_main_model_cfg') || '{}');
    const apiKey = (cfg.apiKey||'').trim();
    const base   = (cfg.base||'').trim().replace(/\/+$/,'');
    const model  = (cfg.model||'').trim();
    if(!apiKey || !base || !model) return;

    isStreaming=true; setTitleTyping(true);

    const sys = { role:'system', content: buildPersonaSystemPrompt(current) + buildUserContextPrompt(activeIdentity) };
    const msgs = history.slice(-20).map(m=>({role:m.role==='user'?'user':'assistant',content:m.content}));
    if(mergedUserText && (!msgs.length || msgs[msgs.length-1].role!=='user')) msgs.push({role:'user',content:mergedUserText});

    try{
      const res = await fetch(base+'/chat/completions',{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey},
        body: JSON.stringify({model, messages:[sys,...msgs], temperature:0.7})
      });
      if(!res.ok) throw new Error(await res.text().catch(()=>('HTTP '+res.status)));
      const data=await res.json();
      const full=(data?.choices?.[0]?.message?.content||'').trim();
      if(full){
        const chunks=splitChunks(full); const threads=getThreads();
        const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
        for(const seg of chunks){
          push('you', seg);
          mine.messages.push({role:'assistant',content:seg,ts:Date.now()});
          saveThreads(threads);
          await new Promise(r=>setTimeout(r,320));
        }
      }
    }catch(e){ console.error(e); }
    finally{
      isStreaming=false; setTitleTyping(false);
      if(needsFlush){ needsFlush=false; scheduleFlush(); }
    }
  }

  /* ---------------- é¡¶éƒ¨æŒ‰é’®/ç¼–è¾‘ ---------------- */
  $('#backBtn').addEventListener('click', ()=>{
    if (window.openAppPage){ window.openAppPage('message.html'); return; }
    if (history.length>1){ history.back(); return; }
    location.href='message.html';
  });

  $('#moreBtn').addEventListener('click', ()=>{
    $('#nameInput').value = current.name || '';
    $('#nickInput').value = current.nickname || '';
    $('#bioInput').value  = current.bio || '';
    $('#bgSwitch').checked = !!current.allowBG;
    const up = $('#avatarUpload');
    if (current.avatar && isImg(current.avatar)){ up.innerHTML = '<img src="'+current.avatar+'">'; }
    else { up.innerHTML = current.avatar || 'ğŸ‘¤'; }
    $('#editModal').classList.add('show');
  });
  $('#avatarUpload').addEventListener('click', ()=> $('#avatarInput').click());
  $('#avatarInput').addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f) return;
    const rd=new FileReader(); rd.onload=ev=>{ $('#avatarUpload').innerHTML='<img src="'+ev.target.result+'">'; current.avatar=ev.target.result; }; rd.readAsDataURL(f);
  });
  $('#modalClose').addEventListener('click', ()=> $('#editModal').classList.remove('show'));
  $('#cancelEdit').addEventListener('click', ()=> $('#editModal').classList.remove('show'));
  $('#editForm').addEventListener('submit', e=>{
    e.preventDefault();
    current.name=$('#nameInput').value.trim()||current.name;
    current.nickname=$('#nickInput').value.trim()||current.nickname||current.name;
    current.bio=$('#bioInput').value.trim()||current.bio;
    current.allowBG=$('#bgSwitch').checked;

    const list=JSON.parse(localStorage.getItem('eg_characters_v2')||'[]');
    const idx=list.findIndex(c=>c.id===current.id);
    if(idx>=0) list[idx]=current;
    localStorage.setItem('eg_characters_v2', JSON.stringify(list));
    $('#editModal').classList.remove('show');
    // æ›´æ–°æ ‡é¢˜
    setTitleTyping(false);
  });

  /* ---------------- å¿«æ·é¢æ¿ & è¡¨æƒ… ---------------- */
  const quick=$('#quickPanel');
  $('#plusBtn').addEventListener('click', (e)=>{
    e.stopPropagation();
    quick.classList.toggle('show');
    $('#stickerPanel').classList.remove('show');
  });
  document.addEventListener('click', ()=> quick.classList.remove('show'));

  // é‡æ–°ç”Ÿæˆï¼šéµå¾ª DELAY_MSï¼Œå¹¶åŠ â€œæ¢ä¸€ç§è¯´æ³•â€çš„æç¤º
  $('#actRegenerate').addEventListener('click', ()=>{
    quick.classList.remove('show');
    const hint = 'ï¼ˆé‡æ–°ç”Ÿæˆï¼‰è¯·æ¢ä¸€ç§è¯´æ³•ï¼Œé¿å…é‡å¤ï¼Œç”¨ä¸åŒæƒ…ç»ª/è§’åº¦ï¼Œä½†ä¿æŒ 1ï½3 å¥ã€å¾®ä¿¡å¼ç®€çŸ­ã€‚';
    scheduleFlush();  // æŒ‰å»¶è¿Ÿæ¥
    setTimeout(()=> tryFlush(hint), DELAY_MS);  // ç¡®ä¿æŒ‰è®¾å®šå»¶è¿Ÿè§¦å‘
  });
  $('#actNudge').addEventListener('click', ()=>{
    quick.classList.remove('show');
    push('me','ã€æˆ³ä¸€æˆ³ã€‘');
    const threads=getThreads(); const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
    mine.messages.push({role:'user',content:'ï¼ˆç”¨æˆ·æˆ³äº†ä½ ä¸€ä¸‹ï¼‰',ts:Date.now()}); saveThreads(threads);
    bufferMsgs.push('ï¼ˆç”¨æˆ·æˆ³äº†ä½ ä¸€ä¸‹ï¼‰'); scheduleFlush();
  });
  $('#actRedpack').addEventListener('click', ()=>{
    quick.classList.remove('show');
    push('me','[çº¢åŒ…]'); // ç®€ç‰ˆå ä½
  });

  $('#emojiBtn').addEventListener('click', ()=>{
    const p=$('#stickerPanel'); const show=!p.classList.contains('show');
    $('#quickPanel').classList.remove('show');
    p.classList.toggle('show', show);
    if(show) renderStickers();
  });

  /* ---------------- å¯åŠ¨ ---------------- */
  function boot(){
    loadCharacters(); loadIdentities();
    setTitleTyping(false);
    loadHistory();
  }
  boot();
})();
</script>
</body>
</html>
