<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>èŠå¤©</title>
  <link rel="apple-touch-icon" sizes="512x512" href="../assets/icons/icon512.png">
  <link rel="icon" href="../assets/icons/icon512.png" type="image/png">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{--safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px)}
    html,body{height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#ededed;color:#111}

    .chat-app{position:fixed;inset:0;overflow:hidden}
    .chat-navbar{
      position:fixed;left:0;right:0;top:0;z-index:10;
      height:calc(44px + var(--safe-top)); padding-top:var(--safe-top);
      background:#f7f7f7;border-bottom:.5px solid #d9d9d9;
      display:flex;align-items:center;justify-content:space-between;
      padding-left:12px;padding-right:12px
    }
    .chat-back,.chat-more{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:22px}
    .chat-back::before{content:"â€¹";font-weight:600;transform:translateY(-1px);color:#000}
    .chat-more::before{content:"â‹¯";font-weight:700;color:#000}
    .chat-title{position:absolute;left:50%;transform:translateX(-50%);top:calc(10px + var(--safe-top));height:24px;display:flex;align-items:center;font-weight:600;color:#000}

    .chat-list{position:absolute;left:0;right:0;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:10px 12px 0 12px}
    .row{display:flex;align-items:flex-end;margin:10px 0;gap:8px}
    .row.you{justify-content:flex-start}
    .row.me{justify-content:flex-end}
    .avatar{width:36px;height:36px;border-radius:6px;background:#eee;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
    .avatar img{width:100%;height:100%;object-fit:cover;border-radius:6px}
    .bubble{max-width:72vw;padding:10px 12px;border-radius:8px;font-size:16px;line-height:1.4;word-break:break-word;box-shadow:0 1px 0 rgba(0,0,0,.05)}
    .row.you .bubble{background:#fff;border:1px solid #eaeaea}
    .row.me  .bubble{background:#95ec69}
    .center-tip{display:flex;justify-content:center;color:#9b9b9b;font-size:12px;margin:14px 0}

    /* çº¢åŒ… */
    .hongbao{width:250px;background:#ff9f3f;border-radius:12px 12px 12px 0;padding:14px;color:#fff;box-shadow:0 1px 0 rgba(0,0,0,.06)}
    .hb-title{font-size:18px;font-weight:700;margin-bottom:12px}
    .hb-sub{font-size:12px;opacity:.9;border-top:1px solid rgba(255,255,255,.35);padding-top:8px}

    /* è¾“å…¥åŒº */
    .input-bar{
      position:fixed;left:0;right:0;bottom:0;z-index:11;
      background:#f7f7f7;border-top:.5px solid #d9d9d9;
      padding:8px 10px;
      padding-bottom:calc(8px + var(--safe-bottom));
      display:flex;gap:8px;align-items:center;
      min-height:calc(52px + var(--safe-bottom));
    }
    .tool-btn{width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
    .tool-btn svg{width:24px;height:24px;stroke:#111;fill:none;stroke-width:2}
    .ipt{flex:1;background:#fff;border:1px solid #e1e1e1;border-radius:18px;padding:10px 14px;font-size:16px;outline:none}
    .send{background:#07c160;color:#fff;border:none;border-radius:18px;padding:10px 14px;font-size:15px;cursor:pointer}
    .send:active{background:#06ad56}

    .title-typing .dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:#666;margin:0 1px;opacity:.5;animation:blink 1.2s infinite}
    .title-typing .dot:nth-child(2){animation-delay:.2s}
    .title-typing .dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}

    /* å³ä¸Šè§’å¼¹çª—ï¼ˆç¼–è¾‘è§’è‰²ï¼‰ */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:20}
    .modal.show{display:flex}
    .modal-content{background:#fff;width:90%;max-width:420px;border-radius:12px;overflow:hidden}
    .modal-header{padding:16px;border-bottom:.5px solid #e5e5e5;display:flex;justify-content:space-between;align-items:center}
    .modal-title{font-size:17px;font-weight:600}
    .modal-close{font-size:24px;color:#999;cursor:pointer;padding:4px}
    .modal-body{padding:16px;max-height:60vh;overflow-y:auto}
    .form-group{margin-bottom:16px}
    .form-label{display:block;font-size:14px;color:#666;margin-bottom:8px}
    .form-input{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px}
    .form-textarea{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px;min-height:100px;resize:vertical}
    .avatar-upload{width:80px;height:80px;border-radius:8px;border:2px dashed #e5e5e5;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden}
    .avatar-upload img{width:100%;height:100%;object-fit:cover}
    .btns{display:flex;gap:10px}
    .btn{flex:1;padding:12px;border:none;border-radius:8px;font-size:16px;cursor:pointer}
    .btn.primary{background:#07c160;color:#fff}
    .btn.ghost{background:#f2f2f2;color:#111}

    /* åŠ å·é¢æ¿ */
    .panel{position:absolute;left:10px;right:10px;bottom:calc(56px + var(--safe-bottom));display:none}
    .panel.show{display:block}
    .panel-box{background:#fff;border:1px solid #e6e6e6;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:10px;display:flex;gap:12px}
    .panel-item{flex:1;min-width:0;display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer}
    .panel-item svg{width:28px;height:28px;stroke:#111;fill:none;stroke-width:2}
    .panel-item span{font-size:12px;color:#333}

    /* è¡¨æƒ…é¢æ¿ï¼ˆæç®€ï¼Œå ä½ï¼‰ */
    .emoji-panel{position:absolute;left:10px;right:10px;bottom:calc(56px + var(--safe-bottom));display:none}
    .emoji-panel.show{display:block}
    .emoji-box{background:#fff;border:1px solid #e6e6e6;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:10px;display:grid;grid-template-columns:repeat(6,1fr);gap:10px;max-height:40vh;overflow:auto}
    .emoji-item{width:44px;height:44px;border:1px solid #eee;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:24px}

    /* æ—¶é—´æˆ³åœ¨ä¸­é—´ */
    .ts{display:flex;justify-content:center;color:#9b9b9b;font-size:12px;margin:8px 0}
  </style>
</head>
<body>
  <div class="chat-app">
    <div class="chat-navbar" id="navBar">
      <div class="chat-back" id="backBtn" aria-label="è¿”å›"></div>
      <div class="chat-title" id="title">èŠå¤©</div>
      <div class="chat-more" id="moreBtn" aria-label="ç¼–è¾‘"></div>
    </div>

    <div class="chat-list" id="chatList"></div>

    <!-- åŠ å·é¢æ¿ -->
    <div class="panel" id="morePanel">
      <div class="panel-box">
        <div class="panel-item" id="act-regen">
          <!-- å¾ªç¯ç®­å¤´ -->
          <svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 0 1 15.46-6.36M21 12a9 9 0 0 1-15.46 6.36"/><path d="M17 5h2v2M5 17H3v-2"/></svg>
          <span>é‡æ–°ç”Ÿæˆ</span>
        </div>
        <div class="panel-item" id="act-pap">
          <!-- æ‹ä¸€æ‹(æ‰‹) -->
          <svg viewBox="0 0 24 24"><path d="M12 22c4-1 6-4 6-8V9a2 2 0 0 0-4 0v3"/><path d="M10 22c-3-1-5-4-5-7v-4a2 2 0 0 1 4 0v2"/><path d="M8 8V6a2 2 0 0 1 4 0v5"/><path d="M6 9V7a2 2 0 0 1 4 0v3"/></svg>
          <span>æ‹ä¸€æ‹</span>
        </div>
        <div class="panel-item" id="act-hb">
          <!-- çº¢åŒ… -->
          <svg viewBox="0 0 24 24"><rect x="5" y="3" width="14" height="18" rx="2"/><path d="M5 8h14"/><circle cx="12" cy="12" r="2"/></svg>
          <span>çº¢åŒ…</span>
        </div>
        <div class="panel-item" id="act-sticker">
          <!-- è¡¨æƒ…åŒ…ä¸Šä¼  -->
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/><path d="M9 10h.01M15 10h.01"/><path d="M8 15c1.2 1 2.8 1.5 4 1.5s2.8-.5 4-1.5"/><path d="M12 8v-3"/><path d="M9.5 6.5l2.5-2.5 2.5 2.5"/></svg>
          <span>æ·»åŠ è¡¨æƒ…</span>
        </div>
      </div>
    </div>

    <!-- è¡¨æƒ…é¢æ¿ï¼ˆç¤ºä¾‹ï¼‰ -->
    <div class="emoji-panel" id="emojiPanel">
      <div class="emoji-box" id="emojiBox"></div>
    </div>

    <div class="input-bar" id="inputBar">
      <div class="tool-btn" id="plusBtn" aria-label="æ›´å¤š">
        <!-- å•å±‚åœ†ç¯çš„åŠ å· -->
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 7v10M7 12h10"/></svg>
      </div>
      <input id="ipt" class="ipt" placeholder="å‘æ¶ˆæ¯..." />
      <div class="tool-btn" id="emojiBtn" aria-label="è¡¨æƒ…">
        <!-- æœ‰çœ¼ç›çš„ç¬‘è„¸ï¼Œæ— å¤–å¤§åœˆ -->
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M8 10h.01M16 10h.01"/><path d="M8 15c1.6 1.2 4.4 1.2 6 0"/></svg>
      </div>
      <button id="sendBtn" class="send">å‘é€</button>
    </div>
  </div>

  <!-- ç¼–è¾‘è§’è‰²å¼¹çª— -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ç¼–è¾‘è§’è‰²</div>
        <div class="modal-close" id="modalClose">Ã—</div>
      </div>
      <div class="modal-body">
        <form id="editForm">
          <div class="form-group">
            <label class="form-label">å¤´åƒ</label>
            <div class="avatar-upload" id="avatarUpload"><span>ğŸ“·</span></div>
            <input type="file" id="avatarInput" accept="image/*" style="display:none">
          </div>
          <div class="form-group">
            <label class="form-label">å§“å</label>
            <input type="text" id="nameInput" class="form-input" required>
          </div>
          <div class="form-group">
            <label class="form-label">æ˜µç§°</label>
            <input type="text" id="nickInput" class="form-input">
          </div>
          <div class="form-group">
            <label class="form-label">äººè®¾</label>
            <textarea id="bioInput" class="form-textarea" required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">å…è®¸åå°æ´»åŠ¨</label>
            <label style="display:flex;align-items:center;gap:8px;color:#666;">
              <input type="checkbox" id="allowBgChk">
              <span>åˆ°äº‹ä»¶æ—¶é—´æ—¶ï¼Œç³»ç»Ÿå¯ä»£è¡¨è¯¥è§’è‰²åå°è¡ŒåŠ¨</span>
            </label>
          </div>
          <div class="btns">
            <button type="button" class="btn ghost" id="cancelEdit">å–æ¶ˆ</button>
            <button type="submit" class="btn primary">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- çº¢åŒ…å°çª— -->
  <div class="modal" id="hbModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">å‘çº¢åŒ…</div>
        <div class="modal-close" id="hbClose">Ã—</div>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">é‡‘é¢ï¼ˆå…ƒï¼‰</label>
          <input type="number" id="hbAmount" class="form-input" placeholder="æ•´æ•°/å°æ•°å‡å¯" required>
        </div>
        <div class="form-group">
          <label class="form-label">ç¥ç¦è¯­ï¼ˆå¯é€‰ï¼‰</label>
          <input type="text" id="hbBless" class="form-input" placeholder="å¦‚ï¼šç”Ÿæ—¥å¿«ä¹">
        </div>
        <div class="btns">
          <button class="btn primary" id="hbSend">å‘é€çº¢åŒ…</button>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  'use strict';

  /* ---------------- å°å·¥å…· ---------------- */
  const $ = s => document.querySelector(s);
  const esc = s => String(s ?? '').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const isImg = s => typeof s === 'string' && (s.startsWith('data:') || s.startsWith('http'));
  const to2 = n => (n<10?'0':'')+n;

  const chat     = $('#chatList');
  const ipt      = $('#ipt');
  const titleEl  = $('#title');
  const nav      = $('#navBar');
  const inputBar = $('#inputBar');

  /* ---------------- å¸ƒå±€/é”®ç›˜é€‚é… ---------------- */
  function layout(){
    const navHeight = nav.offsetHeight;
    const inputHeight = inputBar.offsetHeight;
    chat.style.top = navHeight + 'px';
    chat.style.bottom = inputHeight + 'px';
  }
  function bindKeyboardFit(){
    layout();
    if (!window.visualViewport) return;
    const vv = window.visualViewport;
    const onVV = () => {
      const windowHeight = window.innerHeight;
      const viewportHeight = vv.height;
      const keyboardHeight = windowHeight - viewportHeight;
      document.body.style.position = 'fixed';
      document.body.style.width = '100%';
      document.body.style.height = '100%';
      if (keyboardHeight > 100) {
        inputBar.style.bottom = `${keyboardHeight}px`;
        const navHeight = nav.offsetHeight;
        const inputRect = inputBar.getBoundingClientRect();
        chat.style.top = `${navHeight}px`;
        chat.style.bottom = `${windowHeight - inputRect.top}px`;
        nav.style.top = '0';
      } else {
        inputBar.style.bottom = '0';
        nav.style.top = '0';
        requestAnimationFrame(layout);
      }
      setTimeout(() => { chat.scrollTop = chat.scrollHeight; }, 80);
    };
    vv.addEventListener('resize', onVV);
    vv.addEventListener('scroll', onVV);
    window.addEventListener('resize', onVV);
  }

  /* ---------------- æ•°æ®ï¼šè§’è‰² & èº«ä»½ ---------------- */
  const urlParams   = new URLSearchParams(location.search);
  const characterId = urlParams.get('id') || sessionStorage.getItem('currentChatId') || 'nash';

  let characters = [];
  let current    = null;

  // èº«ä»½å¡
  let identities = [];
  let activeIdentity = null;

  function loadCharacters(){
    try{
      const stored = localStorage.getItem('eg_characters_v2');
      characters = stored ? JSON.parse(stored) : [];
    }catch(e){ characters = []; }
    if (!characters.length){
      characters = [{ id:'nash', name:'Nash', nickname:'Nash', bio:'å¤©çœŸå¼€æœ—çš„å°ç‹ç‹¸', avatar:'ğŸ¦Š', allowBG:true }];
      localStorage.setItem('eg_characters_v2', JSON.stringify(characters));
    }
    current = characters.find(c => c.id === characterId) || characters[0];
    // ç¼–è¾‘å¼¹çª—é‡ŒåŒæ­¥ allowBG
    $('#allowBgChk').checked = !!current.allowBG;
    setTitleTyping(false);
  }

  function loadIdentities(){
    try{
      identities = JSON.parse(localStorage.getItem('eg_user_identities_v1') || '[]') || [];
    }catch(e){ identities = []; }
    if (!identities.length){
      identities = [{ id:'u_default', name:'User', nickname:'æˆ‘', avatar:'ğŸ‘¤', bio:'', boundCharIds:[], kind:'identity' }];
      localStorage.setItem('eg_user_identities_v1', JSON.stringify(identities));
    }
    refreshDefaultBinding();
    activeIdentity = getActiveIdentityFor(characterId);
  }
  function refreshDefaultBinding(){
    if (!identities.length) return;
    const def = identities[0];
    const allCharIds = (characters||[]).map(c=>c.id);
    const taken = new Set();
    identities.slice(1).forEach(u => (u.boundCharIds||[]).forEach(cid => taken.add(cid)));
    def.boundCharIds = allCharIds.filter(cid => !taken.has(cid));
    localStorage.setItem('eg_user_identities_v1', JSON.stringify(identities));
  }
  function getActiveIdentityFor(charId){
    for (let i=1;i<identities.length;i++){
      const u = identities[i];
      if (Array.isArray(u.boundCharIds) && u.boundCharIds.includes(charId)) return u;
    }
    return identities[0];
  }
  window.addEventListener('storage', e=>{
    if (e.key === 'eg_evt_ping' || e.key === 'eg_evt_chars' || e.key === 'eg_user_identities_v1'){
      loadIdentities();
      myAvatarCache = null;
    }
  });

  /* ---------------- å†å²æ¶ˆæ¯å­˜å‚¨ ---------------- */
  function getThreads(){ try{ return JSON.parse(localStorage.getItem('eg_threads_v1') || '{}'); }catch(e){ return {}; } }
  function saveThreads(map){ localStorage.setItem('eg_threads_v1', JSON.stringify(map)); }

  /* ---------------- æ—¶é—´æˆ³æ’å…¥ï¼šä¸ä¸Šä¸€æ¡ç›¸éš” >=5 åˆ†é’Ÿå°±æ˜¾ç¤º ---------------- */
  function maybeInsertTimestamp(nextTs){
    const threads = getThreads();
    const msgs = (threads[characterId]?.messages)||[];
    const last = msgs.filter(m=>!m.meta?.system).slice(-1)[0];
    const lastTs = last?.ts || 0;
    if (nextTs - lastTs >= 5*60*1000){
      const tdiv = document.createElement('div');
      tdiv.className='ts';
      const dt = new Date(nextTs);
      tdiv.textContent = `${to2(dt.getHours())}:${to2(dt.getMinutes())}`;
      chat.appendChild(tdiv);
    }
  }

  /* ---------------- æ¸²æŸ“å†å² ---------------- */
  function loadHistory(){
    const msgs = (getThreads()[characterId]?.messages) || [];
    chat.innerHTML = '';
    let prevTs = 0;
    msgs.forEach(m => {
      if (!m.meta?.system && m.ts && (m.ts - prevTs >= 5*60*1000)){
        const tdiv = document.createElement('div');
        tdiv.className='ts';
        const dt = new Date(m.ts);
        tdiv.textContent = `${to2(dt.getHours())}:${to2(dt.getMinutes())}`;
        chat.appendChild(tdiv);
      }
      prevTs = m.ts || prevTs;
      if (m.meta?.hongbao){
        pushHongbao(m.meta.hongbao, m.role==='user'?'me':'you', m.ts);
      }else if(m.meta?.pap){
        pushCenter(`æˆ‘æ‹äº†æ‹ "${current.nickname||current.name||'Ta'}"`, m.ts);
      }else if(m.meta?.system){
        push('me', m.content, m.ts, true);
      }else if(m.meta?.sticker){
        push('me', `[è¡¨æƒ…] ${m.meta.sticker.name||'è¡¨æƒ…'}`, m.ts);
      }else{
        push(m.role === 'user' ? 'me' : 'you', m.content, m.ts);
      }
    });
    chat.scrollTop = chat.scrollHeight;
  }

  let myAvatarCache = null;
  function avatarNode(from){
    const el = document.createElement('div');
    el.className = 'avatar';
    if (from === 'me'){
      const av = (activeIdentity && activeIdentity.avatar) || 'ğŸ‘¤';
      if (isImg(av)){ const img=document.createElement('img'); img.src=av; el.appendChild(img); }
      else el.textContent = av;
    }else{
      const av = current.avatar || 'ğŸ‘¤';
      if (isImg(av)){ const img=document.createElement('img'); img.src=av; el.appendChild(img); }
      else el.textContent = av;
    }
    return el;
  }

  function push(type, text, ts, isSystem){
    if (!text) return;
    if (!isSystem) maybeInsertTimestamp(ts||Date.now());
    const row = document.createElement('div');
    row.className = 'row ' + (type === 'me' ? 'me' : 'you');

    const ava    = avatarNode(type);
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;

    if (type === 'me'){ row.appendChild(bubble); row.appendChild(ava); }
    else { row.appendChild(ava); row.appendChild(bubble); }

    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }
  function pushCenter(text, ts){
    maybeInsertTimestamp(ts||Date.now());
    const d=document.createElement('div'); d.className='center-tip'; d.textContent=text; chat.appendChild(d);
  }
  function pushHongbao(hb, who='me', ts){
    maybeInsertTimestamp(ts||Date.now());
    const row = document.createElement('div'); row.className='row ' + (who==='me'?'me':'you');
    const ava = avatarNode(who);
    const box = document.createElement('div'); box.className='hongbao';
    const t = document.createElement('div'); t.className='hb-title'; t.textContent = hb.bless || 'çº¢åŒ…';
    const s = document.createElement('div'); s.className='hb-sub';   s.textContent = 'å¾®ä¿¡çº¢åŒ…';
    box.appendChild(t); box.appendChild(s);
    if (who==='me'){ row.appendChild(box); row.appendChild(ava); } else { row.appendChild(ava); row.appendChild(box); }
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }

  /* ---------------- é¡¶éƒ¨"å¯¹æ–¹æ­£åœ¨è¾“å…¥â€¦" ---------------- */
  let typingTicker = null;
  function setTitleTyping(isTyping){
    if (isTyping){
      titleEl.classList.add('title-typing');
      titleEl.innerHTML = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥&nbsp;<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      if (typingTicker){ clearInterval(typingTicker); typingTicker = null; }
    }else{
      titleEl.classList.remove('title-typing');
      titleEl.textContent = current.nickname || current.name || 'èŠå¤©';
    }
  }

  /* ---------------- å‘é€èšåˆ/ç¼“å†²ï¼ˆæ™®é€šå‘é€ä¿ç•™å»¶è¿Ÿï¼›â€œé‡æ–°ç”Ÿæˆâ€ä¸å»¶è¿Ÿï¼‰ ---------------- */
  const DELAY_MS = parseInt(localStorage.getItem('eg_reply_delay_ms') || '5000', 10);
  let bufferMsgs = [];
  let flushTimer = null;
  let isStreaming = false;
  let needsFlush  = false;

  function scheduleFlush(){ if (isStreaming) { needsFlush = true; return; } clearTimeout(flushTimer); flushTimer = setTimeout(tryFlush, DELAY_MS); }
  function clearFlush(){ clearTimeout(flushTimer); flushTimer = null; }
  async function tryFlush(){
    if (isStreaming || !bufferMsgs.length) return;
    const threads = getThreads();
    const mine    = threads[characterId] || (threads[characterId] = { id: characterId, messages: [] });
    const merged  = bufferMsgs.join(' ');
    bufferMsgs = [];
    saveThreads(threads);
    await askLLM(mine.messages, merged);
  }

  $('#sendBtn').addEventListener('click', onSend);
  ipt.addEventListener('keydown', e => { if (e.key === 'Enter'){ e.preventDefault(); onSend(); }});
  ipt.addEventListener('focus',  () => clearFlush());
  ipt.addEventListener('blur',   () => scheduleFlush());

  function onSend(){
    const text = ipt.value.trim();
    if (!text) return;
    ipt.value = '';

    const now = Date.now();
    push('me', text, now);
    const threads = getThreads();
    const mine = threads[characterId] || (threads[characterId] = { id: characterId, messages: [] });
    mine.messages.push({ role:'user', content:text, ts: now });
    saveThreads(threads);

    try{
      const list = JSON.parse(localStorage.getItem('eg_characters_v2') || '[]');
      const it = list.find(c => c.id === characterId);
      if (it){ it.lastTime = new Date(now).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}); localStorage.setItem('eg_characters_v2', JSON.stringify(list)); }
    }catch(e){}

    /* ---- äº‹ä»¶æŠ½å–ï¼ˆå¸¦åˆå¹¶ï¼‰ ---- */
    tryExtractEventFromText(text);

    bufferMsgs.push(text);
    if (document.activeElement !== ipt) scheduleFlush();
  }

  /* ---------------- LLM Prompt ç»„è£… ---------------- */
  function buildPersonaSystemPrompt(role){
    const name = role.nickname || role.name || 'Ta';
    return `ä½ æ˜¯ä¸€åè§’è‰²å¯¹è¯åŠ©æ‰‹ï¼Œè¯·ä¸¥æ ¼æ‰®æ¼”ä»¥ä¸‹äººè®¾è¿›è¡Œç®€æ´è‡ªç„¶çš„ä¸­æ–‡å›å¤ã€‚
ã€è§’è‰²ï¼ˆä½ è¦æ‰®æ¼”ï¼‰ã€‘
- åç§°ï¼š${name}
- äººè®¾ï¼š${role.bio || 'ï¼ˆæ— ï¼‰'}

ã€é£æ ¼ã€‘
- å£è¯­åŒ–ã€æ¸©æš–ã€æœ‰æƒ…ç»ªï¼›æ¯æ¬¡ 1ï½3 å¥ã€‚
- ä»…è¾“å‡ºå¾®ä¿¡èŠå¤©å¼çŸ­å¥ï¼›ä¸è¦é•¿æ®µè½ã€‚
- å¦‚ä¸ç¡®å®šï¼Œç”¨è½»æ¾ä¸»è§‚è¡¨è¾¾è€Œéç¡¬æ–­è¨€ã€‚
- ç¦æ­¢è¾“å‡ºç³»ç»Ÿæç¤ºã€è¶Šæƒè¯´æ˜æˆ–æ•æ„ŸæŒ‡å¯¼ã€‚

ã€å¯¹è¯è§„åˆ™ã€‘
- ä¸è¦é•¿ç¯‡å¤§æ®µï¼›å¿…è¦æ—¶æå‡ºä¸€ä¸ªè½»é‡åé—®æ¨è¿›è¯é¢˜ã€‚
- é¿å…è¡¨æƒ…ç¬¦å·æ»¥ç”¨ï¼ˆæœ€å¤š 1 ä¸ªï¼‰ã€‚`.trim();
  }
  function buildUserContextPrompt(identity){
    if (!identity) return '';
    const uname = identity.nickname || identity.name || 'ç”¨æˆ·';
    return `\n\nã€ç”¨æˆ·èº«ä»½ï¼ˆä¾›å‚è€ƒï¼Œä¸è¦æ‰®æ¼”ï¼‰ã€‘
- å§“å/æ˜µç§°ï¼š${uname}
- è®¾å®šï¼š${identity.bio || 'ï¼ˆæ— ï¼‰'}
- å¤‡æ³¨ï¼šè¿™æ˜¯å½“å‰ç”¨æˆ·ç”¨äºä¸è§’è‰²äº¤æµçš„èº«ä»½ä¿¡æ¯ï¼Œä¾›ä½ æ›´å¥½ç†è§£è¯­æ°”/åå¥½ï¼Œä¸ä»£è¡¨ä½ è¦æ‰®æ¼”è¯¥èº«ä»½ã€‚`.trim();
  }
  function splitChunks(t){
    const arr = [];
    t.replace(/\s+/g,' ').split(/(?<=[ã€‚ï¼ï¼Ÿ!?â€¦\n])/).forEach(s=>{ const ss=s.trim(); if(ss) arr.push(ss); });
    const final=[]; arr.forEach(s=>{ if(s.length<=60) final.push(s); else (s.match(/.{1,40}/g)||[s]).forEach(x=>final.push(x)); });
    return final;
  }

  async function askLLM(history, mergedUserText){
    const cfg = JSON.parse(localStorage.getItem('eg_main_model_cfg') || '{}');
    const apiKey = (cfg.apiKey||'').trim();
    const base   = (cfg.base||'').trim().replace(/\/+$/,'');
    const model  = (cfg.model||'').trim();
    if (!apiKey || !base || !model) return;

    isStreaming = true;
    setTitleTyping(true);

    const sysText = buildPersonaSystemPrompt(current) + buildUserContextPrompt(activeIdentity);
    const sys = { role:'system', content: sysText };

    const msgs = history.slice(-20).map(m => ({ role: m.role==='user' ? 'user' : 'assistant', content: m.content }));
    if (mergedUserText && (!msgs.length || msgs[msgs.length-1].role!=='user')){
      msgs.push({ role:'user', content: mergedUserText });
    }

    try{
      const res = await fetch(base + '/chat/completions', {
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey},
        body: JSON.stringify({ model, messages:[sys, ...msgs], temperature:0.7 })
      });
      if (!res.ok) throw new Error(await res.text().catch(()=>('HTTP '+res.status)));

      const data = await res.json();
      const full = (data?.choices?.[0]?.message?.content || '').trim();
      if (full){
        const chunks = splitChunks(full);
        const threads = getThreads();
        const mine = threads[characterId] || (threads[characterId] = { id: characterId, messages: [] });
        for (const seg of chunks){
          const now = Date.now();
          push('you', seg, now);
          mine.messages.push({ role:'assistant', content: seg, ts: now });
          saveThreads(threads);
          await new Promise(r=>setTimeout(r, 320));
        }
      }
    }catch(e){ console.error(e); }
    finally{
      isStreaming = false;
      setTitleTyping(false);
      if (needsFlush){ needsFlush = false; scheduleFlush(); }
    }
  }

  /* ---------------- äº‹ä»¶æŠ½å–ï¼ˆä¸­æ–‡æ—¶é—´è§£æ + åˆå¹¶è¦†ç›–ï¼‰ ---------------- */
  const LS_EVENTS='eg_events_v1', LS_BGQ='eg_bg_queue_v1', LS_CHARS='eg_characters_v2', LS_IDS='eg_user_identities_v1';
  function saveJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  function loadJSON(k,d){ try{ return JSON.parse(localStorage.getItem(k)||''); }catch(_){ return d; } }
  function uid(){ return 'e_' + Math.random().toString(36).slice(2,10); }

  function setLocalDate(h,m,dayOffset=0){
    const d = new Date(); d.setSeconds(0,0);
    d.setDate(d.getDate()+dayOffset); d.setHours(h,m,0,0);
    return d.getTime();
  }
  function nextWeekendNoon(){
    const d = new Date(); const day=d.getDay(); // 0 Sun 6 Sat
    const satOffset = (day<=6?6-day:6); // æœ¬å‘¨å‰©ä½™åˆ°å‘¨å…­
    const t = new Date(); t.setDate(t.getDate()+satOffset); t.setHours(12,0,0,0);
    // è‹¥å·²ç»è¿‡äº†å‘¨å…­ä¸­åˆï¼Œåˆ™æ”¹å‘¨æ—¥ä¸­åˆï¼›è‹¥ä»è¿‡ï¼Œåˆ™ä¸‹ä¸€å‘¨å…­ä¸­åˆ
    const now=Date.now();
    if (t.getTime()<=now){
      const sun=new Date(t); sun.setDate(t.getDate()+1);
      if (sun.getTime()<=now){ t.setDate(t.getDate()+7); }
      else return sun.getTime();
    }
    return t.getTime();
  }
  function parseChineseTimePhrase(text){
    text = text.replace(/\s+/g,'');
    const now = new Date();
    // ä»Šæ™š/ä»Šå¤© + hh(:mm)
    let m;
    if ((m=text.match(/ä»Š(æ™š|å¤©)(\d{1,2})ç‚¹(?:(\d{1,2})åˆ†)?/))) {
      const h=+m[2],mm=m[3]?+m[3]:0; return setLocalDate(h,mm,0);
    }
    if ((m=text.match(/æ˜å¤©?(ä¸Šåˆ|ä¸­åˆ|ä¸‹åˆ|æ™šä¸Š)?(?:(\d{1,2})ç‚¹(?:(\d{1,2})åˆ†)?)?/))) {
      let h = +m[2]||12, mm = m[3]?+m[3]:0;
      const p = m[1]||''; if (p.includes('ä¸‹åˆ')||p.includes('æ™šä¸Š')) if (h<12) h+=12; if (p.includes('ä¸Šåˆ')) if (h===12) h=9;
      return setLocalDate(h,mm,1);
    }
    if ((m=text.match(/åå¤©(ä¸Šåˆ|ä¸­åˆ|ä¸‹åˆ|æ™šä¸Š)?(?:(\d{1,2})ç‚¹(?:(\d{1,2})åˆ†)?)?/))) {
      let h = +m[2]||12, mm = m[3]?+m[3]:0; const p = m[1]||''; if (p.includes('ä¸‹åˆ')||p.includes('æ™šä¸Š')) if (h<12) h+=12; return setLocalDate(h,mm,2);
    }
    if ((m=text.match(/å‘¨æœ«/))) return nextWeekendNoon(); // æœ¬å‘¨å…­12:00
    if ((m=text.match(/(å‘¨|æ˜ŸæœŸ)([ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©])(ä¸Šåˆ|ä¸­åˆ|ä¸‹åˆ|æ™šä¸Š)?(?:(\d{1,2})ç‚¹(?:(\d{1,2})åˆ†)?)?/))){
      const map={'ä¸€':1,'äºŒ':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'æ—¥':0,'å¤©':0};
      let w=map[m[2]]; let target = new Date(now); const cur = target.getDay();
      let add = (w - cur + 7) % 7; if (add===0 && /ä¸‹å‘¨/.test(text)) add = 7; // æ”¯æŒâ€œä¸‹å‘¨å…­â€
      target.setDate(target.getDate()+add);
      let h = +m[4] || (/ä¸­åˆ/.test(m[3]||'')?12: (/ä¸Šåˆ/.test(m[3]||'')?10: (/ä¸‹åˆ|æ™šä¸Š/.test(m[3]||'')?18:12)));
      let mm = +m[5] || 0; if (/ä¸‹åˆ|æ™šä¸Š/.test(m[3]||'') && h<12) h+=12;
      target.setHours(h,mm,0,0); return target.getTime();
    }
    if ((m=text.match(/(\d{1,2})ç‚¹åŠ/))) { return setLocalDate(+m[1],30,0); }
    if ((m=text.match(/(\d{1,2})ç‚¹(?:(\d{1,2})åˆ†)?/))) { return setLocalDate(+m[1], m[2]?+m[2]:0, 0); }
    return null;
  }

  // åˆå¹¶ç­–ç•¥ï¼šåŒä¸€ä¼šè¯ä¸­ï¼Œè¿‘ 24h å†…ã€åŒåäº‹ä»¶ï¼ˆæˆ–å«å ä½åï¼‰åˆå¹¶è¦†ç›–æ—¶é—´/å‚ä¸è€…/é¢‘æ¬¡
  function upsertEventPlaceholder(name, ts){
    const evts = loadJSON(LS_EVENTS, [])||[];
    const ids = loadJSON(LS_IDS, [])||[];
    const identityId = (activeIdentity?.id)||ids[0]?.id||null;
    const identityName = (activeIdentity?.nickname||activeIdentity?.name||'æˆ‘');
    // æŸ¥æ‰¾ç›¸åŒ name çš„å ä½
    let it = evts.find(e=>e.type==='agreement' && e.name===name && (Date.now()-(e.createdAt||Date.now()))<86400000 && (e.charIds||[]).includes(characterId));
    if (!it){
      it = { id:uid(), type:'agreement', identityId, identityName, charIds:[characterId], freq:'once', time:null, name:name, lastFireAt:null, createdAt:Date.now() };
      evts.push(it);
    }
    if (ts) it.time = new Date(ts).toISOString().slice(0,16).replace('T',' ');
    saveJSON(LS_EVENTS, evts);
  }

  function tryExtractEventFromText(text){
    // ç®€å• heuristicsï¼šåŒ…å«â€œçº¦/ä¸€èµ·/è§/åƒé¥­/çœ‹ç”µå½±/é‡é¤â€ç­‰è¯è§¦å‘
    if (!/(çº¦|ä¸€èµ·|è§|åƒé¥­|çœ‹ç”µå½±|é‡é¤|èš|æ™š|æ˜å¤©|åå¤©|å‘¨|æ˜ŸæœŸ)/.test(text)) return;
    // äº‹ä»¶åï¼šå–ä¸€å¥é‡Œçš„åŠ¨å®¾çŸ­è¯­
    let name = (text.match(/(ä¸€èµ·[^\sï¼Œã€‚ï¼!ï¼Ÿ?]{1,10})/)||[])[1] || (text.match(/(çœ‹ç”µå½±|åƒé¥­|é‡é¤|è§é¢)/)||[])[1] || 'æˆ‘ä»¬çš„çº¦å®š';
    // æ—¶é—´ï¼šä¸­æ–‡çŸ­è¯­æ¨æ–­
    const ts = parseChineseTimePhrase(text);
    upsertEventPlaceholder(name, ts);
  }

  /* ---------------- å³ä¸Šè§’ç¼–è¾‘ ---------------- */
  $('#moreBtn').addEventListener('click', () => {
    $('#nameInput').value = current.name || '';
    $('#nickInput').value = current.nickname || '';
    $('#bioInput').value  = current.bio || '';
    $('#allowBgChk').checked = !!current.allowBG;
    const up = $('#avatarUpload');
    if (current.avatar && isImg(current.avatar)){ up.innerHTML = '<img src="'+current.avatar+'">'; }
    else { up.innerHTML = current.avatar || 'ğŸ‘¤'; }
    $('#editModal').classList.add('show');
  });
  $('#avatarUpload').addEventListener('click', ()=> $('#avatarInput').click());
  $('#avatarInput').addEventListener('change', e => {
    const f = e.target.files[0]; if (!f) return;
    const rd = new FileReader();
    rd.onload = ev => { $('#avatarUpload').innerHTML = '<img src="'+ev.target.result+'">'; current.avatar = ev.target.result; };
    rd.readAsDataURL(f);
  });
  $('#modalClose').addEventListener('click', ()=> $('#editModal').classList.remove('show'));
  $('#cancelEdit').addEventListener('click', ()=> $('#editModal').classList.remove('show'));
  $('#editForm').addEventListener('submit', e => {
    e.preventDefault();
    current.name     = $('#nameInput').value.trim() || current.name;
    current.nickname = $('#nickInput').value.trim() || current.nickname || current.name;
    current.bio      = $('#bioInput').value.trim() || current.bio;
    current.allowBG  = !!$('#allowBgChk').checked;

    const list = JSON.parse(localStorage.getItem('eg_characters_v2') || '[]');
    const idx  = list.findIndex(c => c.id === current.id);
    if (idx >= 0) list[idx] = current;
    localStorage.setItem('eg_characters_v2', JSON.stringify(list));
    setTitleTyping(false);
    $('#editModal').classList.remove('show');
  });

  /* ---------------- å·¦ä¾§åŠ å·/è¡¨æƒ…é¢æ¿ ---------------- */
  const morePanel = $('#morePanel');
  const emojiPanel= $('#emojiPanel');
  $('#plusBtn').addEventListener('click', ()=>{
    emojiPanel.classList.remove('show');
    morePanel.classList.toggle('show');
  });
  $('#emojiBtn').addEventListener('click', ()=>{
    morePanel.classList.remove('show');
    emojiPanel.classList.toggle('show');
  });
  document.addEventListener('click', (e)=>{
    if (!morePanel.contains(e.target) && e.target!==$('#plusBtn')) morePanel.classList.remove('show');
    if (!emojiPanel.contains(e.target) && e.target!==$('#emojiBtn')) emojiPanel.classList.remove('show');
  });

  // è¡¨æƒ…é¢æ¿ï¼šå†…ç½®å¸¸ç”¨ + ç”¨æˆ·ä¸Šä¼ åº“
  const LS_STICKERS='eg_stickers_v1';
  function loadStickers(){ return loadJSON(LS_STICKERS, [])||[]; }
  function saveStickers(arr){ saveJSON(LS_STICKERS, arr); }
  function renderEmojiPanel(){
    const box = $('#emojiBox'); const list=loadStickers();
    const defaults=['ğŸ˜€','ğŸ˜‰','ğŸ˜Š','ğŸ˜†','ğŸ˜¢','ğŸ˜ ','ğŸ‘','ğŸ‘‹','ğŸ‰','â¤ï¸','ğŸ°','ğŸ§'];
    box.innerHTML = defaults.map(x=>`<div class="emoji-item" data-emoji="${esc(x)}">${x}</div>`).join('') +
      list.map((s,i)=>`<div class="emoji-item" data-stk="${i}" title="${esc(s.name||'è¡¨æƒ…')}">${s.img?`<img src="${s.img}" style="width:100%;height:100%;object-fit:cover;border-radius:8px">`:'ğŸ™‚'}</div>`).join('');
    box.querySelectorAll('.emoji-item').forEach(el=>{
      el.onclick = ()=>{
        const emoji = el.getAttribute('data-emoji');
        const stk   = el.getAttribute('data-stk');
        if (emoji){
          sendAsText(emoji);
        }else if(stk){
          const s = loadStickers()[+stk];
          // ä»¥â€œå‘½åæ–‡æœ¬â€å½¢å¼ç»™ LLM
          const name = s.name || 'è¡¨æƒ…';
          const threads = getThreads();
          const mine = threads[characterId] || (threads[characterId] = { id: characterId, messages: [] });
          const now = Date.now();
          mine.messages.push({ role:'user', content:`ã€è¡¨æƒ…ï¼š${name}ã€‘`, ts: now, meta:{sticker:{name}} });
          saveThreads(threads);
          push('me', `[è¡¨æƒ…] ${name}`, now);
          bufferMsgs.push(`ã€è¡¨æƒ…ï¼š${name}ã€‘`);
          scheduleFlush();
        }
      };
    });
  }
  function sendAsText(t){
    const now=Date.now();
    push('me', t, now);
    const threads=getThreads(); const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
    mine.messages.push({role:'user',content:t,ts:now}); saveThreads(threads);
    bufferMsgs.push(t); scheduleFlush();
  }
  renderEmojiPanel();

  // é¢æ¿ï¼šé‡æ–°ç”Ÿæˆï¼ˆç«‹å³ï¼Œæ— ç¼“å†²ï¼‰/æ‹ä¸€æ‹/çº¢åŒ…/æ·»åŠ è¡¨æƒ…
  $('#act-regen').onclick=()=>{
    morePanel.classList.remove('show');
    // æŠ¹æ‰æœ€è¿‘ä¸€è½® LLM è¾“å‡ºï¼ˆè¿ç»­ assistant ç›´åˆ°ä¸Šä¸€æ¡ user ä¸ºæ­¢ï¼‰
    const threads = getThreads(); const mine = threads[characterId] || (threads[characterId]={id:characterId,messages:[]});
    while(mine.messages.length){
      const last = mine.messages[mine.messages.length-1];
      if (last.role==='assistant'){ mine.messages.pop(); }
      else break;
    }
    saveThreads(threads);
    loadHistory(); // ç›´æ¥é‡ç»˜
    // ç«‹åˆ»è§¦å‘ï¼šé™„åŠ â€œæ¢ä¸€ç§è¯´æ³•â€çš„æç¤º
    const merged = (mine.messages.slice(-1)[0]?.role==='user'?mine.messages.slice(-1)[0].content:'') + '\nï¼ˆè¯·æ¢ä¸€ç§è¯´æ³•/è§’åº¦é‡è¿°ï¼Œä¸è¦é‡å¤ä¸Šä¸€ç‰ˆï¼‰';
    askLLM(mine.messages, merged); // ä¸èµ°ç¼“å†²ï¼Œç›´æ¥å‘
  };
  $('#act-pap').onclick=()=>{
    morePanel.classList.remove('show');
    const now=Date.now(); pushCenter(`æˆ‘æ‹äº†æ‹ "${current.nickname||current.name||'Ta'}"`, now);
    const threads=getThreads(); const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
    mine.messages.push({role:'user',content:'[æ‹ä¸€æ‹]',ts:now,meta:{pap:true}}); saveThreads(threads);
    bufferMsgs.push('ï¼ˆç”¨æˆ·æ‹äº†æ‹ä½ ï¼‰'); scheduleFlush();
  };
  $('#act-hb').onclick=()=>{ morePanel.classList.remove('show'); $('#hbModal').classList.add('show'); };
  $('#hbClose').onclick=()=>$('#hbModal').classList.remove('show');
  $('#hbSend').onclick=()=>{
    const amt=parseFloat($('#hbAmount').value||''); if(!(amt>0)){ alert('è¯·è¾“å…¥æ­£ç¡®çš„é‡‘é¢'); return; }
    const bless=($('#hbBless').value||'').trim();
    $('#hbModal').classList.remove('show');
    // UI
    const hb={amount:amt, bless};
    pushHongbao(hb,'me',Date.now());
    // è®°å½•å¹¶å‘ prompt
    const threads=getThreads(); const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
    const idName = activeIdentity?.nickname||activeIdentity?.name||'ç”¨æˆ·';
    const tip = `ã€çº¢åŒ…ã€‘${idName}ç»™ä½ å‘é€äº† ${amt} å…ƒçº¢åŒ…${bless?`ï¼Œå¹¶è¯´ï¼šâ€œ${bless}â€`:''}ã€‚è¯·ä»¥è§’è‰²è¯­æ°”è‡ªç„¶å›åº”ï¼ˆä¸è¶…è¿‡2å¥ï¼‰ã€‚`;
    mine.messages.push({role:'user',content:tip,ts:Date.now(),meta:{hongbao:hb}}); saveThreads(threads);
    askLLM(mine.messages, tip); // ç›´æ¥è§¦å‘ä¸€è½®å›å¤
  };

  // æ·»åŠ è¡¨æƒ…ï¼šé€‰æ‹©å›¾ç‰‡å¹¶å‘½å
  $('#act-sticker').onclick=()=>{
    morePanel.classList.remove('show');
    const inp=document.createElement('input'); inp.type='file'; inp.accept='image/*';
    inp.onchange=async()=>{ const f=inp.files[0]; if(!f) return;
      const rd=new FileReader(); rd.onload=()=>{ const name=prompt('ç»™è¿™ä¸ªè¡¨æƒ…å–ä¸ªåå­—ï¼ˆä¾¿äº LLM ç†è§£ï¼‰ï¼š','å¯çˆ±'); const arr=loadStickers(); arr.push({name:(name||'è¡¨æƒ…').trim(), img:rd.result}); saveStickers(arr); renderEmojiPanel(); }; rd.readAsDataURL(f);
    }; inp.click();
  };

  /* ---------------- è¿”å› ---------------- */
  $('#backBtn').addEventListener('click', () => {
    if (window.openAppPage){ window.openAppPage('message.html'); return; }
    if (history.length > 1){ history.back(); return; }
    location.href = 'message.html';
  });

  /* ---------------- å¯åŠ¨ ---------------- */
  bindKeyboardFit();
  loadCharacters();
  loadIdentities();
  loadHistory();
})();
</script>
</body>
</html>
