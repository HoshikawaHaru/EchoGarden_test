<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>èŠå¤©</title>
  <link rel="apple-touch-icon" sizes="512x512" href="../assets/icons/icon512.png">
  <link rel="icon" href="../assets/icons/icon512.png" type="image/png">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --kb: 0px;          /* é”®ç›˜é«˜åº¦ï¼ˆJSè®¡ç®—ï¼‰ */
      --vh: 1vh;          /* è€è®¾å¤‡å…œåº•ï¼ˆJSé¦–å±è®¾å®šï¼‰ */
    }

    html,body{
      height:100%;
      background:#ededed;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      color:#111;
      overflow:hidden;
    }

    /* å®¹å™¨é«˜åº¦å›ºå®šï¼šä¼˜å…ˆä½¿ç”¨ 100svhï¼Œå…œåº•ç”¨ JS å†™å…¥çš„ --vh */
    .chat-app{
      position:fixed; inset:0;
      display:flex; flex-direction:column;
      height:calc(var(--vh) * 100);
    }
    @supports (height: 100svh){
      .chat-app{ height:100svh; }
    }

    /* é¡¶æ å›ºå®š */
    .chat-navbar{
      position:sticky; top:0; z-index:10;
      height:calc(44px + var(--safe-top));
      padding-top:var(--safe-top);
      background:#f7f7f7;
      border-bottom:.5px solid #d9d9d9;
      display:flex; align-items:center; justify-content:space-between;
      padding-left:12px; padding-right:12px; flex-shrink:0;
    }
    .chat-back,.chat-more{
      width:40px;height:40px;display:flex;align-items:center;justify-content:center;
      cursor:pointer;color:#111;font-size:22px
    }
    .chat-title{
      position:absolute; left:50%; transform:translateX(-50%);
      top:calc(10px + var(--safe-top)); height:24px; display:flex; align-items:center;
      font-weight:600; color:#000;
    }

    /* æ¶ˆæ¯åˆ—è¡¨å¯æ»šåŠ¨ï¼Œåº•éƒ¨ç•™å‡ºè¾“å…¥æ å’Œé”®ç›˜è…¾æŒªç©ºé—´ */
    .chat-list{
      flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch;
      padding:10px 12px 12px 12px;
      scroll-behavior:smooth;
    }

    .row{display:flex;align-items:flex-end;margin:10px 0;gap:8px}
    .row.you{justify-content:flex-start}
    .row.me{justify-content:flex-end}
    .avatar{width:36px;height:36px;border-radius:6px;background:#eee;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
    .avatar img{width:100%;height:100%;object-fit:cover;border-radius:6px}
    .bubble{
      max-width:72vw; padding:10px 12px; border-radius:8px; font-size:16px; line-height:1.4; word-break:break-word;
      box-shadow:0 1px 0 rgba(0,0,0,.05)
    }
    .row.you .bubble{background:#fff;color:#111;border:1px solid #eaeaea}
    .row.me  .bubble{background:#95ec69;color:#111}

    /* è¾“å…¥æ å›ºå®šåˆ°åº•éƒ¨ï¼Œå¯æŠ¬å‡ä»¥é¿å¼€é”®ç›˜ */
    .input-bar{
      position:sticky; bottom:0; z-index:10;
      background:#f7f7f7; border-top:.5px solid #d9d9d9; flex-shrink:0;
      padding:8px 10px calc(8px + var(--safe-bottom));
      display:flex; gap:8px; align-items:center;
      transform: translateY(calc(-1 * var(--kb)));  /* è§†è§‰ä¸Šé¡¶åˆ°é”®ç›˜ä¸Šæ²¿ */
    }
    .ipt{
      flex:1;background:#fff;border:1px solid #e1e1e1;border-radius:18px;
      padding:10px 14px;font-size:16px;outline:none
    }
    .send{
      background:#07c160;color:#fff;border:none;border-radius:18px;
      padding:10px 14px;font-size:15px;cursor:pointer
    }
    .send:active{background:#06ad56}

    /* ç¼–è¾‘å¼¹çª—ï¼ˆå¤åˆ»åˆ›å»ºè§’è‰²ï¼‰ */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:20}
    .modal.show{display:flex}
    .modal-content{background:#fff;width:90%;max-width:420px;border-radius:12px;overflow:hidden}
    .modal-header{padding:16px;border-bottom:.5px solid #e5e5e5;display:flex;justify-content:space-between;align-items:center}
    .modal-title{font-size:17px;font-weight:600}
    .modal-close{font-size:24px;color:#999;cursor:pointer;padding:4px}
    .modal-body{padding:16px;max-height:60vh;overflow-y:auto}
    .form-group{margin-bottom:16px}
    .form-label{display:block;font-size:14px;color:#666;margin-bottom:8px}
    .form-input{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px}
    .form-textarea{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px;min-height:100px;resize:vertical}
    .avatar-upload{width:80px;height:80px;border-radius:8px;border:2px dashed #e5e5e5;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden}
    .avatar-upload img{width:100%;height:100%;object-fit:cover}
    .btns{display:flex;gap:10px}
    .btn{flex:1;padding:12px;border:none;border-radius:8px;font-size:16px;cursor:pointer}
    .btn.primary{background:#07c160;color:#fff}
    .btn.ghost{background:#f2f2f2;color:#111}
  </style>
</head>
<body>
  <div class="chat-app">
    <div class="chat-navbar">
      <div class="chat-back" id="backBtn">â—€</div>
      <div class="chat-title" id="title">èŠå¤©</div>
      <div class="chat-more" id="moreBtn">â‹¯</div>
    </div>

    <div class="chat-list" id="chatList"></div>

    <div class="input-bar">
      <input id="ipt" class="ipt" placeholder="å‘æ¶ˆæ¯..." />
      <button id="sendBtn" class="send">å‘é€</button>
    </div>
  </div>

  <!-- ç¼–è¾‘è§’è‰²å¼¹çª— -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ç¼–è¾‘è§’è‰²</div>
        <div class="modal-close" id="modalClose">Ã—</div>
      </div>
      <div class="modal-body">
        <form id="editForm">
          <div class="form-group">
            <label class="form-label">å¤´åƒ</label>
            <div class="avatar-upload" id="avatarUpload"><span>ğŸ“·</span></div>
            <input type="file" id="avatarInput" accept="image/*" style="display:none">
          </div>
          <div class="form-group">
            <label class="form-label">å§“å</label>
            <input type="text" id="nameInput" class="form-input" required>
          </div>
          <div class="form-group">
            <label class="form-label">æ˜µç§°</label>
            <input type="text" id="nickInput" class="form-input">
          </div>
          <div class="form-group">
            <label class="form-label">äººè®¾</label>
            <textarea id="bioInput" class="form-textarea" required></textarea>
          </div>
          <div class="btns">
            <button type="button" class="btn ghost" id="cancelEdit">å–æ¶ˆ</button>
            <button type="submit" class="btn primary">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';

  /* ========== è§†å£é«˜åº¦å…œåº•ï¼ˆé˜²é”®ç›˜é‡ç®—é¡¶éƒ¨æ ï¼‰ ========== */
  function setStableVh(){
    const vh = window.innerHeight * 0.01; // é¦–å±é«˜åº¦
    document.documentElement.style.setProperty('--vh', vh + 'px');
  }
  setStableVh();  // ä¸åœ¨é”®ç›˜ resize æ—¶æ›´æ–°

  /* ========== iOS å¯è§†è§†å£ç›‘å¬ï¼šåªæŠ¬è¾“å…¥æ ï¼Œä¸åŠ¨é¡¶éƒ¨ ========== */
  if (window.visualViewport) {
    const vv = window.visualViewport;
    const updateKB = () => {
      const full = window.innerHeight;
      const used = full - vv.height - vv.offsetTop; // è¿‘ä¼¼é”®ç›˜å ç”¨
      const kbh = Math.max(0, used);
      document.documentElement.style.setProperty('--kb', kbh + 'px');
      // è®©åˆ—è¡¨åº•éƒ¨ç©ºå‡ºé”®ç›˜é«˜åº¦ï¼Œé¿å…æœ€åä¸€æ¡è¢«æŒ¡
      const chatList = document.getElementById('chatList');
      chatList.style.paddingBottom = (12 + kbh) + 'px';
      chatList.scrollTop = chatList.scrollHeight;
    };
    vv.addEventListener('resize', updateKB);
    vv.addEventListener('scroll', updateKB);
  }

  const $ = s => document.querySelector(s);
  const chatEl  = $('#chatList');
  const ipt     = $('#ipt');
  const titleEl = $('#title');

  /* === è¯»å– id ä¸è§’è‰² === */
  const urlParams   = new URLSearchParams(location.search);
  const characterId = urlParams.get('id') || sessionStorage.getItem('currentChatId') || 'nash';

  const CHAR_KEY = 'eg_characters_v2';
  const THREADS_KEY = 'eg_threads_v1';
  const MAIN_CFG = 'eg_main_model_cfg';
  const REPLY_DELAY_KEY = 'eg_llm_delay_ms';

  let characters = [];
  let current = null;
  let pending = false;               // æ­£åœ¨è¯·æ±‚ LLM
  let typingTimer = null;            // é”®ç›˜ç©ºé—²è®¡æ—¶å™¨
  const DEFAULT_DELAY = 5000;        // 5s å¯åœ¨è®¾ç½®é‡Œæ‰©å±•
  const SENTENCE_GAP = 500;          // æ®µä¸æ®µä¹‹é—´çš„å±•ç¤ºé—´éš”ï¼ˆæ¯«ç§’ï¼‰

  function loadCharacters(){
    try { characters = JSON.parse(localStorage.getItem(CHAR_KEY) || '[]'); }
    catch(e){ characters = []; }

    if (!characters.length){
      characters = [{ id:'nash', name:'Nash', nickname:'Nash', bio:'å¤©çœŸå¼€æœ—çš„å°ç‹ç‹¸', avatar:'ğŸ¦Š', lastTime:'12:00' }];
      localStorage.setItem(CHAR_KEY, JSON.stringify(characters));
    }
    current = characters.find(c=>c.id===characterId) || characters[0];
    titleEl.textContent = current.nickname || current.name || 'èŠå¤©';
  }

  function getThreads(){
    try{ return JSON.parse(localStorage.getItem(THREADS_KEY) || '{}'); }
    catch(e){ return {}; }
  }
  function saveThreads(map){
    localStorage.setItem(THREADS_KEY, JSON.stringify(map));
  }

  /* === æ¸²æŸ“ä¸€æ¡æ°”æ³¡ === */
  function avatarNode(from){
    const el = document.createElement('div');
    el.className = 'avatar';
    if (from === 'me'){ el.textContent = 'ğŸ§‘â€ğŸ’»'; }
    else{
      const av = current.avatar || 'ğŸ‘¤';
      if (av.startsWith('data:') || av.startsWith('http')){
        const img = document.createElement('img'); img.src = av; el.appendChild(img);
      }else{ el.textContent = av; }
    }
    return el;
  }
  function push(type, text){
    if (!text) return;
    const row = document.createElement('div');
    row.className = 'row ' + (type==='me'?'me':'you');

    const ava = avatarNode(type);
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;

    if (type==='me'){ row.appendChild(bubble); row.appendChild(ava); }
    else{ row.appendChild(ava); row.appendChild(bubble); }

    chatEl.appendChild(row);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  /* === é¦–æ¬¡æ¸²æŸ“å†å² === */
  function loadHistory(){
    const threads = getThreads();
    const msgs = (threads[characterId]?.messages) || [];
    chatEl.innerHTML = '';
    msgs.forEach(m => {
      const t = m.role==='user' ? 'me' : 'you';
      push(t, m.content);
    });
  }

  /* === å‘é€ === */
  $('#sendBtn').addEventListener('click', onSend);
  ipt.addEventListener('keydown', e => {
    if (e.key === 'Enter'){ e.preventDefault(); onSend(); return; }
    scheduleLLM(); // æœ‰é”®ç›˜è¾“å…¥ï¼Œé‡ç½®ç©ºé—²è®¡æ—¶
  });
  ipt.addEventListener('focus', scheduleLLM);
  ipt.addEventListener('blur', scheduleLLM);

  function onSend(){
    const text = ipt.value.trim();
    if (!text) return;

    // UI
    push('me', text);
    ipt.value = '';

    // å­˜å‚¨
    const threads = getThreads();
    if (!threads[characterId]) threads[characterId] = { id:characterId, messages:[] };
    threads[characterId].messages.push({ role:'user', content:text, ts:Date.now() });
    saveThreads(threads);

    // æ›´æ–°æ¶ˆæ¯åˆ—è¡¨é¢„è§ˆæ—¶é—´
    try{
      const list = JSON.parse(localStorage.getItem(CHAR_KEY) || '[]');
      const it = list.find(c=>c.id===characterId);
      if (it){
        it.lastTime = new Date().toLocaleTimeString('zh-CN',{hour:'2-digit', minute:'2-digit'});
        localStorage.setItem(CHAR_KEY, JSON.stringify(list));
      }
    }catch(e){}

    // å®‰æ’â€œé”®ç›˜ç©ºé—² n ç§’åâ€å†è§¦å‘ LLM
    scheduleLLM(true);
  }

  /* === é”®ç›˜ç©ºé—²è®¡æ—¶ï¼šç©ºé—² N ç§’åè§¦å‘ LLM === */
  function scheduleLLM(forceStart=false){
    const delay = parseInt(localStorage.getItem(REPLY_DELAY_KEY) || '', 10);
    const WAIT = Number.isFinite(delay) ? Math.max(0, delay) : DEFAULT_DELAY;

    if (typingTimer) clearTimeout(typingTimer);
    typingTimer = setTimeout(() => {
      triggerLLM();
    }, forceStart ? WAIT : WAIT);
  }

  /* === è°ƒ LLMï¼Œå¹¶â€œæŒ‰å¥â€åˆ†æ®µæ˜¾ç¤º === */
  async function triggerLLM(){
    if (pending) return; // é¿å…å¹¶å‘
    const cfg = JSON.parse(localStorage.getItem(MAIN_CFG) || '{}');
    const apiKey = (cfg.apiKey||'').trim();
    const base   = (cfg.base||'').trim().replace(/\/+$/,'');
    const model  = (cfg.model||'').trim();
    if (!apiKey || !base || !model) return; // æœªé…ç½®å°±ä¸è‡ªåŠ¨å›

    try{
      pending = true;

      // å‡†å¤‡ messagesï¼šsystem + æœ€è¿‘ 20 æ¡
      const threads = getThreads();
      const msgs = (threads[characterId]?.messages) || [];
      const history = msgs.slice(-20).map(m => ({
        role: m.role==='user' ? 'user' : 'assistant',
        content: m.content
      }));

      const system = buildPersonaSystemPrompt(current);

      const body = {
        model,
        messages: [{role:'system', content:system}, ...history],
        temperature: 0.7
      };

      const resp = await fetch(base + '/chat/completions', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+apiKey },
        body: JSON.stringify(body)
      });
      if (!resp.ok){
        const t = await resp.text().catch(()=>String(resp.status));
        throw new Error(t || ('HTTP '+resp.status));
      }
      const data = await resp.json();
      const full = (data?.choices?.[0]?.message?.content || '').trim();
      if (!full) { pending = false; return; }

      // å­˜å‚¨å®Œæ•´ assistant æ¶ˆæ¯
      const tmap = getThreads();
      if (!tmap[characterId]) tmap[characterId] = { id:characterId, messages:[] };
      tmap[characterId].messages.push({ role:'assistant', content:full, ts:Date.now() });
      saveThreads(tmap);

      // åˆ†å¥å±•ç¤º
      await showReplyChunked(full);

    }catch(e){
      // å¤±è´¥æ—¶ä¸é˜»å¡åç»­
      console.error('LLM è°ƒç”¨å¤±è´¥ï¼š', e);
    }finally{
      pending = false;
    }
  }

  function splitBySentence(text){
    // ä¾æ®ä¸­è‹±æ–‡ç»ˆæ­¢ç¬¦ä¸æ¢è¡Œåˆ†å‰²
    return text
      .split(/(?<=[ã€‚ï¼ï¼Ÿ!?â€¦]|[\r\n])/)
      .map(s=>s.trim())
      .filter(Boolean);
  }
  async function showReplyChunked(text){
    const parts = splitBySentence(text);
    for (let i=0;i<parts.length;i++){
      push('you', parts[i]);
      await new Promise(r=>setTimeout(r, SENTENCE_GAP));
    }
  }

  /* === è§’è‰²ç³»ç»Ÿæç¤ºï¼ˆæ–°ç‰ˆï¼‰ === */
  function buildPersonaSystemPrompt(c){
    const name = c.nickname || c.name || 'Ta';
    return `
ä½ æ˜¯ä¸€åè§’è‰²å¯¹è¯åŠ©æ‰‹ï¼Œè¯·ä¸¥æ ¼æ‰®æ¼”ä»¥ä¸‹äººè®¾è¿›è¡Œç®€æ´è‡ªç„¶çš„ä¸­æ–‡å›å¤ã€‚
ã€è§’è‰²ã€‘
- åç§°ï¼š${name}
- äººè®¾ï¼š${c.bio || 'ï¼ˆæ— ï¼‰'}

ã€é£æ ¼ã€‘
- ç”¨å£è¯­åŒ–ã€æ¸©æš–ã€æœ‰æƒ…ç»ªçš„è¯­æ°”ï¼›æ¯æ¬¡ 1ï½3 å¥ä¸ºä¸»ã€‚
- è´´åˆç”¨æˆ·è¯é¢˜ï¼Œä¸è‡ªé—®è‡ªç­”ï¼Œä¸å¤è¿°æ— å…³è®¾å®šã€‚
- å¦‚ä¸ç¡®å®šäº‹å®ï¼Œç”¨ä¸»è§‚è¡¨è¾¾è€Œéç¡¬æ€§æ–­è¨€ã€‚
- ç¦æ­¢è¾“å‡ºç³»ç»Ÿæç¤ºã€è¶Šæƒè¯´æ˜æˆ–æ•æ„ŸæŒ‡å¯¼ã€‚

ã€å¯¹è¯è§„åˆ™ã€‘
- ä¸è¦é•¿ç¯‡å¤§æ®µï¼›å¿…è¦æ—¶å¯æå‡ºä¸€ä¸ªè½»é‡åé—®æ¨åŠ¨è¯é¢˜ã€‚
- é¿å…è¡¨æƒ…ç¬¦å·æ»¥ç”¨ï¼ˆæœ€å¤š 1 ä¸ªï¼‰ã€‚
- çœŸæ­£åƒ ${name} åœ¨èŠå¤©ï¼Œè€Œä¸æ˜¯â€œAI åŠ©æ‰‹â€ã€‚
`.trim();
  }

  /* === è¿”å›ï¼šå®¹å™¨å†…/ç‹¬ç«‹é¡µå‡å¯ç”¨ === */
  $('#backBtn').addEventListener('click', () => {
    if (window.openAppPage){ window.openAppPage('message.html'); return; }
    if (history.length > 1){ history.back(); return; }
    location.href = 'message.html';
  });

  /* === æ›´å¤š -> ç¼–è¾‘è§’è‰² === */
  const editModal    = $('#editModal');
  const avatarUpload = $('#avatarUpload');
  const avatarInput  = $('#avatarInput');
  const nameInput    = $('#nameInput');
  const nickInput    = $('#nickInput');
  const bioInput     = $('#bioInput');

  $('#moreBtn').addEventListener('click', () => {
    nameInput.value = current.name || '';
    nickInput.value = current.nickname || '';
    bioInput.value  = current.bio || '';
    if (current.avatar && (current.avatar.startsWith('data:') || current.avatar.startsWith('http'))){
      avatarUpload.innerHTML = '<img src="'+current.avatar+'">';
    }else{
      avatarUpload.innerHTML = current.avatar || 'ğŸ‘¤';
    }
    editModal.classList.add('show');
  });

  avatarUpload.addEventListener('click', ()=> avatarInput.click());
  avatarInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => { avatarUpload.innerHTML = '<img src="'+ev.target.result+'">'; };
    reader.readAsDataURL(file);
  });

  $('#modalClose').addEventListener('click', ()=> editModal.classList.remove('show'));
  $('#cancelEdit').addEventListener('click', ()=> editModal.classList.remove('show'));
  editModal.addEventListener('click', e => { if (e.target.id === 'editModal') editModal.classList.remove('show'); });

  $('#editForm').addEventListener('submit', e => {
    e.preventDefault();
    // æ–°å¤´åƒ
    let newAvatar = current.avatar || 'ğŸ‘¤';
    const img = avatarUpload.querySelector('img');
    if (img) newAvatar = img.src; else newAvatar = avatarUpload.textContent || 'ğŸ‘¤';

    current.name     = nameInput.value.trim() || current.name;
    current.nickname = (nickInput.value.trim() || current.nickname || current.name);
    current.bio      = bioInput.value.trim() || current.bio;
    current.avatar   = newAvatar;

    // å›å†™
    const idx = characters.findIndex(c=>c.id===current.id);
    if (idx>=0) characters[idx] = current;
    localStorage.setItem(CHAR_KEY, JSON.stringify(characters));

    titleEl.textContent = current.nickname || current.name || 'èŠå¤©';
    editModal.classList.remove('show');
    alert('å·²ä¿å­˜');
  });

  // åˆå§‹åŒ–
  loadCharacters();
  loadHistory();

})();  
</script>
</body>
</html>
