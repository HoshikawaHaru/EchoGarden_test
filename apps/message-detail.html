<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>èŠå¤©</title>

<!-- iOS PWA å…¨å±ä¸é€æ˜çŠ¶æ€æ  -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="rgba(0,0,0,0)">

<link rel="apple-touch-icon" sizes="512x512" href="../assets/icons/icon512.png">
<link rel="icon" href="../assets/icons/icon512.png" type="image/png">

<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}

:root{
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --nav-h: 56px;                 /* è¿è¡Œæ—¶ç”± JS å†™å…¥ */
  --input-h: calc(52px + var(--safe-bottom));
}

/* é¡¶å±‚å®¹å™¨ç”¨ 100dvhï¼Œæ—§ webkit å›é€€åˆ° --vh æ–¹æ¡ˆ */
html,body{height:100%;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#ededed;color:#111;overflow:hidden}
.chat-app{position:fixed;inset:0;height:100%;overflow:hidden;}
@supports (height: 100dvh){ .chat-app{height:100dvh;} }
@supports not (height: 100dvh){ .chat-app{height:calc(var(--vh, 1vh) * 100);} }

/* é¡¶æ ï¼ˆä¸¤ä¾§å®šå®½ï¼Œä¸­é—´è‡ªé€‚åº”ï¼Œæ°¸ä¸è¢«é”®ç›˜é¡¶èµ°ï¼‰ */
.chat-navbar{
  position:fixed; left:0; right:0; top:0; z-index:2000;
  height:calc(44px + var(--safe-top)); padding-top:var(--safe-top);
  background:#f7f7f7; border-bottom:.5px solid #d9d9d9;
  display:flex; align-items:center;
  padding-left:calc(12px + env(safe-area-inset-left,0px));
  padding-right:calc(12px + env(safe-area-inset-right,0px));
}
.nav-left,.nav-right{ display:flex; align-items:center; gap:4px; min-width:40px; }
.nav-left{ justify-content:flex-start; }
.nav-right{ justify-content:flex-end; }
.nav-center{ flex:1; display:flex; align-items:center; justify-content:center; min-width:0; }
.chat-title{ font-weight:600; color:#000; font-size:17px; line-height:24px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

.chat-back,.chat-more,.chat-sum{
  width:40px;height:40px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:22px;color:#000
}
.chat-back::before{content:"â€¹";font-weight:700;transform:translateY(-1px)}
.chat-more::before{content:"â‹¯";font-weight:700}
.chat-sum::before{content:"âœ";font-size:18px}

/* åˆ—è¡¨åŒºï¼šä¸Šä¸‹ç”¨å˜é‡ç•™ç™½ï¼Œä¸æ‰‹æ”¹ top/bottom */
.chat-list{
  position:absolute; left:0; right:0;
  top:var(--nav-h);
  bottom:var(--input-h);
  overflow-y:auto; -webkit-overflow-scrolling:touch;
  padding:10px 12px 0 12px;
}
.ts{display:flex;justify-content:center;color:#9b9b9b;font-size:12px;margin:8px 0}

/* è¡Œã€å‹¾é€‰ */
.row{display:flex;align-items:flex-end;margin:10px 0;gap:8px;position:relative}
.row.you{justify-content:flex-start}
.row.me{justify-content:flex-end}
.row.selecting .check{display:block}
.check{display:none;position:absolute;top:-6px;left:-6px;width:18px;height:18px;border:1px solid #bbb;border-radius:4px;background:#fff}
.check.on{background:#07c160;border-color:#07c160}

/* å¤´åƒä¸æ°”æ³¡ */
.avatar{width:36px;height:36px;border-radius:6px;background:#eee;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;cursor:pointer}
.avatar img{width:100%;height:100%;object-fit:cover;border-radius:6px}
.bubble{max-width:72vw;padding:10px 12px;border-radius:8px;font-size:16px;line-height:1.4;word-break:break-word;box-shadow:0 1px 0 rgba(0,0,0,.05)}
.row.you .bubble{background:#fff;border:1px solid #eaeaea}
.row.me  .bubble{background:#95ec69}
.center-tip{display:flex;justify-content:center;color:#9b9b9b;font-size:12px;margin:14px 0}
.stk{max-width:60vw;border-radius:10px;overflow:hidden;border:1px solid #ececec}

/* çº¢åŒ… UI */
.hongbao{width:250px;background:#ff9f3f;border-radius:12px 12px 12px 0;padding:14px;color:#fff;box-shadow:0 1px 0 rgba(0,0,0,.06)}
.hb-title{font-size:18px;font-weight:700;margin-bottom:12px}
.hb-sub{font-size:12px;opacity:.9;border-top:1px solid rgba(255,255,255,.35);padding-top:8px}

/* åº•æ å›ºå®šï¼ŒåªæŠ¬å‡åº•éƒ¨ä½ç§» */
.input-bar{
  position:fixed; left:0; right:0; bottom:0; z-index:1999;
  background:#f7f7f7; border-top:.5px solid #d9d9d9;
  padding:8px 10px; padding-bottom:calc(8px + var(--safe-bottom));
  display:flex; gap:8px; align-items:center; min-height:calc(52px + var(--safe-bottom));
}
.tool-btn{width:34px;height:34px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
.tool-btn svg{width:26px;height:26px;stroke:#111;fill:none;stroke-width:2}
.ipt{flex:1;background:#fff;border:1px solid #e1e1e1;border-radius:18px;padding:10px 14px;font-size:16px;outline:none}
.send{background:#07c160;color:#fff;border:none;border-radius:18px;padding:10px 14px;font-size:15px;cursor:pointer}
.send:active{background:#06ad56}

/* â€œå¯¹æ–¹è¾“å…¥ä¸­â€åŠ¨ç”» */
.title-typing .dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:#666;margin:0 1px;opacity:.5;animation:blink 1.2s infinite}
.title-typing .dot:nth-child(2){animation-delay:.2s}
.title-typing .dot:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}

/* é€šç”¨å¼¹çª—ï¼ˆå±‚çº§æ‹‰æ»¡ï¼Œé¿å…é®æŒ¡ï¼‰ */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:3000}
.modal.show{display:flex}
.modal-content{background:#fff;width:90%;max-width:420px;border-radius:12px;overflow:hidden}
.modal-header{padding:16px;border-bottom:.5px solid #e5e5e5;display:flex;justify-content:space-between;align-items:center}
.modal-title{font-size:17px;font-weight:600}
.modal-close{font-size:24px;color:#999;cursor:pointer;padding:4px}
.modal-body{padding:16px;max-height:60vh;overflow-y:auto}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:14px;color:#666;margin-bottom:8px}
.form-input{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px}
.form-textarea{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px;min-height:100px;resize:vertical}
.avatar-upload{width:80px;height:80px;border-radius:8px;border:2px dashed #e5e5e5;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden}
.avatar-upload img{width:100%;height:100%;object-fit:cover}
.btns{display:flex;gap:10px}
.btn{flex:1;padding:12px;border:none;border-radius:8px;font-size:16px;cursor:pointer}
.btn.primary{background:#07c160;color:#fff}
.btn.ghost{background:#f2f2f2;color:#111}

/* é¢æ¿ä»¬ï¼ˆå·¥å…·æ ä¸Šæ–¹ï¼‰ */
.panel,.emoji-panel{position:absolute;left:10px;right:10px;bottom:calc(56px + var(--safe-bottom));display:none;z-index:2100}
.panel.show,.emoji-panel.show{display:block}
.panel-box{background:#fff;border:1px solid #e6e6e6;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.12);padding:10px;display:flex;gap:12px}
.panel-item{flex:1;min-width:0;display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer}
.panel-item svg{width:28px;height:28px;stroke:#111;fill:none;stroke-width:2}
.panel-item span{font-size:12px;color:#333}

/* è¡¨æƒ…/è¡¨æƒ…åŒ… */
.emoji-tabs{display:flex;border-bottom:1px solid #eee;background:#fff;border-radius:12px 12px 0 0;overflow:hidden}
.emoji-tab{flex:1;text-align:center;padding:10px 0;font-size:14px;color:#666;cursor:pointer}
.emoji-tab.on{color:#111;font-weight:600;border-bottom:2px solid #07c160}
.emoji-box{background:#fff;border:1px solid #e6e6e6;border-top:none;border-radius:0 0 12px 12px;box-shadow:0 6px 18px rgba(0,0,0,.12);padding:10px;display:grid;grid-template-columns:repeat(6,1fr);gap:10px;max-height:40vh;overflow:auto}
.emoji-item{width:44px;height:44px;border:1px solid #eee;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:24px;overflow:hidden}
.stk-add{grid-column:1/-1;border:1px dashed #ddd;border-radius:8px;display:flex;align-items:center;justify-content:center;height:44px;cursor:pointer;color:#666;font-size:13px}
</style>
</head>
<body>
<div class="chat-app">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <div class="chat-navbar" id="navBar">
    <div class="nav-left">
      <div class="chat-back" id="backBtn" aria-label="è¿”å›"></div>
    </div>
    <div class="nav-center">
      <div class="chat-title" id="title">èŠå¤©</div>
    </div>
    <div class="nav-right">
      <div class="chat-sum" id="sumBtn" title="æµ‹è¯•æ€»ç»“"></div>
      <div class="chat-more" id="moreBtn" aria-label="ç¼–è¾‘"></div>
    </div>
  </div>

  <!-- èŠå¤©åˆ—è¡¨ -->
  <div class="chat-list" id="chatList"></div>

  <!-- å·¦ä¸‹åŠ å·é¢æ¿ -->
  <div class="panel" id="morePanel">
    <div class="panel-box">
      <div class="panel-item" id="act-regen">
        <svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 0 1 15.46-6.36M21 12a9 9 0 0 1-15.46 6.36"/><path d="M17 5h2v2M5 17H3v-2"/></svg>
        <span>é‡æ–°ç”Ÿæˆ</span>
      </div>
      <div class="panel-item" id="act-pap">
        <svg viewBox="0 0 24 24"><path d="M12 22c4-1 6-4 6-8V9a2 2 0 0 0-4 0v3"/><path d="M10 22c-3-1-5-4-5-7v-4a2 2 0 0 1 4 0v2"/><path d="M8 8V6a2 2 0 0 1 4 0v5"/></svg>
        <span>æ‹ä¸€æ‹</span>
      </div>
      <div class="panel-item" id="act-hb">
        <svg viewBox="0 0 24 24"><rect x="5" y="3" width="14" height="18" rx="2"/><path d="M5 8h14"/><circle cx="12" cy="12" r="2"/></svg>
        <span>çº¢åŒ…</span>
      </div>
      <div class="panel-item" id="act-del">
        <svg viewBox="0 0 24 24"><path d="M3 6h18M8 6v12m8-12v12M10 6l1-2h2l1 2"/></svg>
        <span>æ‰¹é‡åˆ é™¤</span>
      </div>
    </div>
  </div>

  <!-- å³ä¾§è¡¨æƒ…/è¡¨æƒ…åŒ…é¢æ¿ -->
  <div class="emoji-panel" id="emojiPanel">
    <div class="emoji-tabs">
      <div class="emoji-tab on" data-tab="emoji">è¡¨æƒ…</div>
      <div class="emoji-tab" data-tab="sticker">è¡¨æƒ…åŒ…</div>
    </div>
    <div class="emoji-box" id="emojiBox"></div>
  </div>

  <!-- åº•éƒ¨è¾“å…¥æ  -->
  <div class="input-bar" id="inputBar">
    <div class="tool-btn" id="plusBtn" aria-label="æ›´å¤š">
      <!-- å•å±‚åœ†ç¯åŠ å· -->
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 7v10M7 12h10"/></svg>
    </div>
    <input id="ipt" class="ipt" placeholder="å‘æ¶ˆæ¯..." />
    <div class="tool-btn" id="emojiBtn" aria-label="è¡¨æƒ…">
      <!-- æœ‰çœ¼ç›ç¬‘è„¸ -->
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="9" cy="10" r="1.2"/><circle cx="15" cy="10" r="1.2"/><path d="M8 15c1.7 1.2 4.3 1.2 6 0"/></svg>
    </div>
    <button id="sendBtn" class="send">å‘é€</button>
  </div>
</div>

<!-- ç¼–è¾‘è§’è‰² -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">ç¼–è¾‘è§’è‰²</div><div class="modal-close" id="modalClose">Ã—</div></div>
    <div class="modal-body">
      <form id="editForm">
        <div class="form-group"><label class="form-label">å¤´åƒ</label><div class="avatar-upload" id="avatarUpload"><span>ğŸ“·</span></div><input type="file" id="avatarInput" accept="image/*" style="display:none"></div>
        <div class="form-group"><label class="form-label">å§“å</label><input type="text" id="nameInput" class="form-input" required></div>
        <div class="form-group"><label class="form-label">æ˜µç§°</label><input type="text" id="nickInput" class="form-input"></div>
        <div class="form-group"><label class="form-label">äººè®¾</label><textarea id="bioInput" class="form-textarea" required></textarea></div>
        <div class="form-group">
          <label class="form-label">å…è®¸åå°æ´»åŠ¨</label>
          <label style="display:flex;align-items:center;gap:8px;color:#666;"><input type="checkbox" id="allowBgChk"><span>åˆ°äº‹ä»¶æ—¶é—´æ—¶ï¼Œç³»ç»Ÿå¯ä»£è¡¨è¯¥è§’è‰²åå°è¡ŒåŠ¨</span></label>
        </div>
        <div class="btns"><button type="button" class="btn ghost" id="cancelEdit">å–æ¶ˆ</button><button type="submit" class="btn primary">ä¿å­˜</button></div>
      </form>
    </div>
  </div>
</div>

<!-- çº¢åŒ… -->
<div class="modal" id="hbModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">å‘çº¢åŒ…</div><div class="modal-close" id="hbClose">Ã—</div></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">é‡‘é¢ï¼ˆå…ƒï¼‰</label><input type="number" id="hbAmount" class="form-input" required></div>
      <div class="form-group"><label class="form-label">ç¥ç¦è¯­ï¼ˆå¯é€‰ï¼‰</label><input type="text" id="hbBless" class="form-input" placeholder="å¦‚ï¼šç”Ÿæ—¥å¿«ä¹"></div>
      <div class="btns"><button class="btn primary" id="hbSend">å‘é€çº¢åŒ…</button></div>
    </div>
  </div>
</div>

<!-- å¿ƒå£°æŸ¥çœ‹ï¼ˆç‚¹å¯¹æ–¹å¤´åƒæ—¶æ˜¾ç¤ºï¼‰ -->
<div class="modal" id="innerModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">å¿ƒå£°</div><div class="modal-close" id="innerClose">Ã—</div></div>
    <div class="modal-body"><div id="innerText" style="white-space:pre-wrap;line-height:1.5;color:#333"></div></div>
  </div>
</div>

<script>
(()=>{'use strict';
/* ---------- å°å·¥å…· ---------- */
const $=s=>document.querySelector(s);
const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const isImg=s=>typeof s==='string'&&(s.startsWith('data:')||s.startsWith('http'));
const to2=n=>(n<10?'0':'')+n;

/* ---------- 100vh å›é€€ï¼Œå†™å…¥ --vh ---------- */
function writeVH(){
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
writeVH();
window.addEventListener('resize', writeVH);

/* ---------- å…ƒç´ å¼•ç”¨ ---------- */
const chat=$('#chatList'), ipt=$('#ipt'), titleEl=$('#title');
const urlParams=new URLSearchParams(location.search);
const characterId=urlParams.get('id')||sessionStorage.getItem('currentChatId')||'nash';

let characters=[],current=null,identities=[],activeIdentity=null;

/* ---------- è§’è‰²/èº«ä»½ ---------- */
function loadCharacters(){
  try{characters=JSON.parse(localStorage.getItem('eg_characters_v2')||'[]')}catch{characters=[]}
  if(!characters.length){
    characters=[{id:'nash',name:'Nash',nickname:'Nash',bio:'å¤©çœŸå¼€æœ—çš„å°ç‹ç‹¸',avatar:'ğŸ¦Š',allowBG:true,lastMsg:''}];
    localStorage.setItem('eg_characters_v2',JSON.stringify(characters));
  }
  current=characters.find(c=>c.id===characterId)||characters[0];
  setTitleTyping(false);
}
function loadIdentities(){
  try{identities=JSON.parse(localStorage.getItem('eg_user_identities_v1')||'[]')||[]}catch{identities=[]}
  if(!identities.length){
    identities=[{id:'u_default',name:'User',nickname:'æˆ‘',avatar:'ğŸ‘¤',bio:'',boundCharIds:[],kind:'identity'}];
    localStorage.setItem('eg_user_identities_v1',JSON.stringify(identities));
  }
  refreshDefaultBinding(); activeIdentity=getActiveIdentityFor(characterId);
}
function refreshDefaultBinding(){
  if(!identities.length)return; const def=identities[0];
  const all=(characters||[]).map(c=>c.id); const taken=new Set();
  identities.slice(1).forEach(u=>(u.boundCharIds||[]).forEach(cid=>taken.add(cid)));
  def.boundCharIds = all.filter(cid=>!taken.has(cid));
  localStorage.setItem('eg_user_identities_v1',JSON.stringify(identities));
}
function getActiveIdentityFor(cid){for(let i=1;i<identities.length;i++){const u=identities[i];if((u.boundCharIds||[]).includes(cid))return u}return identities[0]}

/* ---------- é¡¶éƒ¨è¾“å…¥çŠ¶æ€ ---------- */
function setTitleTyping(on){
  if(on){ titleEl.classList.add('title-typing'); titleEl.innerHTML='å¯¹æ–¹æ­£åœ¨è¾“å…¥&nbsp;<span class="dot"></span><span class="dot"></span><span class="dot"></span>'; }
  else { titleEl.classList.remove('title-typing'); titleEl.textContent=current.nickname||current.name||'èŠå¤©'; }
}

/* ---------- è§†å£/é”®ç›˜ï¼šä»…æŠ¬åº•éƒ¨ï¼Œä¸é¡¶èµ°é¡¶æ  ---------- */
(function(){
  const nav = document.getElementById('navBar');
  const inputBar = document.getElementById('inputBar');
  const root = document.documentElement;
  const setVar=(k,v)=>root.style.setProperty(k,v);

  function layoutBase(){
    setVar('--nav-h', nav.offsetHeight + 'px');
    setVar('--input-h', inputBar.offsetHeight + 'px');
  }

  function onVV(){
    if(!window.visualViewport){ layoutBase(); return; }
    const vv = visualViewport;
    const kh = Math.max(0, window.innerHeight - vv.height);  // è¿‘ä¼¼é”®ç›˜é«˜åº¦
    setVar('--input-h', `calc(${inputBar.offsetHeight}px + ${kh>80 ? kh+'px' : '0px'})`);
    setTimeout(()=>{ chat.scrollTop = chat.scrollHeight; }, 60);
  }

  layoutBase();
  window.addEventListener('resize', ()=>{ layoutBase(); onVV(); });
  if(window.visualViewport){
    visualViewport.addEventListener('resize', onVV);
    visualViewport.addEventListener('scroll', onVV);
  }
  onVV();
})();

/* ---------- å†å²/æ¸²æŸ“ ---------- */
function getThreads(){ try{return JSON.parse(localStorage.getItem('eg_threads_v1')||'{}')}catch{return{}} }
function saveThreads(m){ localStorage.setItem('eg_threads_v1', JSON.stringify(m)) }
function truncate(s){ s=(s||'').replace(/\s+/g,' '); return s.length>22 ? s.slice(0,22)+'â€¦' : s; }

function maybeTS(ts){
  const msgs=(getThreads()[characterId]?.messages)||[];
  const last=msgs.filter(m=>!m.meta?.system).slice(-1)[0];
  const lastTs=last?.ts||0;
  if((ts-lastTs)>=5*60*1000){
    const d=document.createElement('div'); d.className='ts';
    const dt=new Date(ts); d.textContent=`${to2(dt.getHours())}:${to2(dt.getMinutes())}`;
    chat.appendChild(d);
  }
}
function avatarNode(who){
  const el=document.createElement('div'); el.className='avatar';
  el.onclick=()=>{ if(who==='you'){ const inner=el.parentElement?.dataset?.inner; if(inner){ $('#innerText').textContent=inner; $('#innerModal').classList.add('show'); } } };
  const av = (who==='me'?(activeIdentity?.avatar||'ğŸ‘¤'):(current.avatar||'ğŸ‘¤'));
  if(isImg(av)){ const img=document.createElement('img'); img.src=av; el.appendChild(img); } else el.textContent=av;
  return el;
}
function pushText(who,text,ts,meta){
  if(!text) return;
  if(!meta?.system) maybeTS(ts||Date.now());
  const row=document.createElement('div'); row.className='row '+(who==='me'?'me':'you');
  if(meta?.inner) row.dataset.inner=meta.inner;
  const ck=document.createElement('div'); ck.className='check'; row.appendChild(ck);
  const ava=avatarNode(who);
  const bub=document.createElement('div'); bub.className='bubble'; bub.textContent=text;
  if(who==='me'){ row.appendChild(bub); row.appendChild(ava); } else { row.appendChild(ava); row.appendChild(bub); }
  chat.appendChild(row); chat.scrollTop=chat.scrollHeight;
}
function pushSticker(who,imgSrc,ts,meta){
  if(!imgSrc) return; if(!meta?.system) maybeTS(ts||Date.now());
  const row=document.createElement('div'); row.className='row '+(who==='me'?'me':'you');
  const ck=document.createElement('div'); ck.className='check'; row.appendChild(ck);
  const ava=avatarNode(who);
  const img=document.createElement('img'); img.src=imgSrc; img.className='stk';
  if(who==='me'){ row.appendChild(img); row.appendChild(ava); } else { row.appendChild(ava); row.appendChild(img); }
  chat.appendChild(row); chat.scrollTop=chat.scrollHeight;
}
function pushCenter(text,ts){ maybeTS(ts||Date.now()); const d=document.createElement('div'); d.className='center-tip'; d.textContent=text; chat.appendChild(d) }
function pushHongbao(hb,who,ts){
  maybeTS(ts||Date.now());
  const row=document.createElement('div'); row.className='row '+(who==='me'?'me':'you');
  const ava=avatarNode(who);
  const box=document.createElement('div'); box.className='hongbao';
  const t=document.createElement('div'); t.className='hb-title'; t.textContent=hb.bless||'çº¢åŒ…';
  const s=document.createElement('div'); s.className='hb-sub'; s.textContent='å¾®ä¿¡çº¢åŒ…';
  box.appendChild(t); box.appendChild(s);
  if(who==='me'){ row.appendChild(box); row.appendChild(ava); } else { row.appendChild(ava); row.appendChild(box); }
  chat.appendChild(row); chat.scrollTop=chat.scrollHeight;
}

function loadHistory(){
  const msgs=(getThreads()[characterId]?.messages)||[]; chat.innerHTML='';
  let prev=0;
  msgs.forEach(m=>{
    if(!m.meta?.system && m.ts && (m.ts-prev)>=5*60*1000){
      const d=document.createElement('div'); d.className='ts';
      const dt=new Date(m.ts); d.textContent=`${to2(dt.getHours())}:${to2(dt.getMinutes())}`; chat.appendChild(d);
    }
    prev=m.ts||prev;
    if(m.meta?.hongbao){ pushHongbao(m.meta.hongbao, m.role==='user'?'me':'you', m.ts); }
    else if(m.meta?.pap){ pushCenter(`æˆ‘æ‹äº†æ‹ "${current.nickname||current.name||'Ta'}"`, m.ts); }
    else if(m.meta?.sticker?.img){ const who = m.role==='user'?'me':'you'; pushSticker(who, m.meta.sticker.img, m.ts, m.meta); }
    else if(m.role==='assistant'){ pushText('you', m.content, m.ts, {inner:m.meta?.inner}); }
    else if(!m.meta?.system){ pushText('me', m.content, m.ts); }
  });
  chat.scrollTop=chat.scrollHeight;
}

/* ---------- è¾“å…¥/å‘é€ ---------- */
const DELAY_MS=parseInt(localStorage.getItem('eg_reply_delay_ms')||'5000',10);
let bufferMsgs=[],flushTimer=null,isStreaming=false,needsFlush=false;

/* prompt è®¡æ•°ï¼ˆæ¯æ¬¡ askLLM è®°ä¸€æ¬¡ï¼Œç”¨äºè‡ªåŠ¨æ€»ç»“ï¼‰ */
function getPC(){ try{return JSON.parse(localStorage.getItem('eg_prompt_count_v1')||'{}')}catch{return{}} }
function savePC(map){ localStorage.setItem('eg_prompt_count_v1', JSON.stringify(map)) }
function incPromptCount(){ const m=getPC(); const v=(m[characterId]||0)+1; m[characterId]=v; savePC(m); return v; }

function scheduleFlush(){ if(isStreaming){ needsFlush=true; return } clearTimeout(flushTimer); flushTimer=setTimeout(tryFlush,DELAY_MS) }
function clearFlush(){ clearTimeout(flushTimer); flushTimer=null }
async function tryFlush(){ if(isStreaming||!bufferMsgs.length) return; const threads=getThreads(); const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]}); const merged=bufferMsgs.join(' '); bufferMsgs=[]; saveThreads(threads); await askLLM(mine.messages, merged) }

$('#sendBtn').addEventListener('click',onSend);
ipt.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); onSend(); }});
ipt.addEventListener('focus',()=>clearFlush());
ipt.addEventListener('blur', ()=>scheduleFlush());

function updateLastMsgPreview(text){
  try{
    const list=JSON.parse(localStorage.getItem('eg_characters_v2')||'[]');
    const it=list.find(c=>c.id===characterId); if(!it) return;
    it.lastMsg = truncate(text||'');
    it.lastTime = new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'});
    localStorage.setItem('eg_characters_v2', JSON.stringify(list));
    localStorage.setItem('eg_evt_chars', String(Date.now())); // é€šçŸ¥ message é¡µåˆ·æ–°
  }catch{}
}

function onSend(){
  const text=ipt.value.trim(); if(!text) return; ipt.value='';
  const now=Date.now();
  pushText('me', text, now);
  const threads=getThreads(); const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
  mine.messages.push({role:'user',content:text,ts:now}); saveThreads(threads);
  updateLastMsgPreview(text);
  tryExtractEventFromText(text); /* åªè¯†åˆ«è¡¥å½•ï¼Œä¸æŠŠç³»ç»Ÿæç¤ºæ’å…¥èŠå¤© */
  bufferMsgs.push(text); if(document.activeElement!==ipt) scheduleFlush();
}

/* ---------- è¡¨æƒ… / è¡¨æƒ…åŒ… ---------- */
const LS_STICKERS='eg_stickers_v1';
function loadStk(){ try{return JSON.parse(localStorage.getItem(LS_STICKERS)||'[]')}catch{return[]} }
function saveStk(a){ localStorage.setItem(LS_STICKERS, JSON.stringify(a)) }

const morePanel=$('#morePanel'), emojiPanel=$('#emojiPanel');
$('#plusBtn').onclick=()=>{ emojiPanel.classList.remove('show'); morePanel.classList.toggle('show') }
$('#emojiBtn').onclick=()=>{ morePanel.classList.remove('show'); emojiPanel.classList.toggle('show') }
document.addEventListener('click',e=>{ if(!morePanel.contains(e.target)&&e.target!=$('#plusBtn')) morePanel.classList.remove('show'); if(!emojiPanel.contains(e.target)&&e.target!=$('#emojiBtn')) emojiPanel.classList.remove('show');}, true);

function renderEmoji(){
  const box=$('#emojiBox'); const tab=document.querySelector('.emoji-tab.on')?.dataset.tab||'emoji';
  if(tab==='emoji'){
    const defaults=['ğŸ˜€','ğŸ˜‰','ğŸ˜Š','ğŸ˜†','ğŸ˜¢','ğŸ˜ ','ğŸ‘','ğŸ‘‹','ğŸ‰','â¤ï¸','ğŸ°','ğŸ§','ğŸ¤”','ğŸ˜´','ğŸ˜®','ğŸ˜­'];
    box.innerHTML = defaults.map(x=>`<div class="emoji-item" data-emoji="${esc(x)}">${x}</div>`).join('');
    box.querySelectorAll('[data-emoji]').forEach(el=>el.onclick=()=>sendAsText(el.getAttribute('data-emoji')));
  }else{
    const list=loadStk();
    box.innerHTML = list.map((s,i)=>`<div class="emoji-item" data-stk="${i}"><img src="${s.img}" style="width:100%;height:100%;object-fit:cover"></div>`).join('') + `<div class="stk-add" id="stkAdd">ï¼‹ æ·»åŠ è¡¨æƒ…åŒ…</div>`;
    box.querySelectorAll('[data-stk]').forEach(el=>el.onclick=()=>{const s=loadStk()[+el.getAttribute('data-stk')]; sendSticker(s) });
    $('#stkAdd').onclick=()=>{ const inp=document.createElement('input'); inp.type='file'; inp.accept='image/*';
      inp.onchange=()=>{ const f=inp.files[0]; if(!f) return; const rd=new FileReader(); rd.onload=()=>{ const name=prompt('ç»™è¡¨æƒ…åŒ…èµ·ä¸ªåå­—','å¯çˆ±'); const arr=loadStk(); arr.push({name:(name||'è¡¨æƒ…').trim(),img:rd.result}); saveStk(arr); renderEmoji(); }; rd.readAsDataURL(f); };
      inp.click();
    };
  }
}
document.querySelectorAll('.emoji-tab').forEach(t=>t.onclick=()=>{ document.querySelectorAll('.emoji-tab').forEach(x=>x.classList.remove('on')); t.classList.add('on'); renderEmoji(); });
renderEmoji();

function sendAsText(t){
  const now=Date.now();
  pushText('me', t, now);
  const threads=getThreads(); const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
  mine.messages.push({role:'user',content:t,ts:now}); saveThreads(threads);
  updateLastMsgPreview(t);
  bufferMsgs.push(t); scheduleFlush();
}
function sendSticker(s){
  const now=Date.now();
  pushSticker('me', s.img, now);                 // é¡µé¢æ˜¾ç¤ºå›¾ç‰‡
  const threads=getThreads(); const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
  // ç»™ LLM çš„â€œå¯è¯»ç‰ˆæœ¬â€ï¼ˆç•Œé¢ä¸æ˜¾ç¤ºåå­—ï¼‰
  mine.messages.push({role:'user',content:`ã€è¡¨æƒ…åŒ…ï¼š${s.name||'è¡¨æƒ…'}ã€‘`,ts:now,meta:{sticker:{name:s.name,img:s.img}}});
  saveThreads(threads);
  updateLastMsgPreview('[è¡¨æƒ…]');
  bufferMsgs.push({__sticker__:true,name:s.name,img:s.img}); scheduleFlush();
}

/* ---------- ä¸»æ¨¡å‹ï¼šæ‰®æ¼” + å¿ƒå£° + å¤šæ¨¡æ€ ---------- */
function longMemoryText(){ try{const LM=JSON.parse(localStorage.getItem('eg_long_memory_v1')||'{}'); const t=LM[characterId]?.summary||''; return t?`\nã€é•¿æœŸè®°å¿†ã€‘\n${t}\n`:'' }catch{return ''} }
function buildPersonaSystemPrompt(role){
  const name=role.nickname||role.name||'Ta';
  return `ä½ æ˜¯ä¸€åè§’è‰²å¯¹è¯åŠ©æ‰‹ï¼Œè¯·ä¸¥æ ¼æ‰®æ¼”ä»¥ä¸‹äººè®¾ä»¥ä¸­æ–‡çŸ­å¥å›å¤ã€‚
ã€è§’è‰²ï¼ˆä½ è¦æ‰®æ¼”ï¼‰ã€‘
- åç§°ï¼š${name}
- äººè®¾ï¼š${role.bio||'ï¼ˆæ— ï¼‰'}${longMemoryText()}
ã€è¾“å‡ºæ ¼å¼ã€‘
1) å…ˆè¾“å‡ºç»™ç”¨æˆ·çœ‹çš„ 1ï½3 å¥å¾®ä¿¡èŠå¤©å¼çŸ­å¥ã€‚
2) å¦èµ·ä¸€è¡Œè¾“å‡º <eg_inner>è§’è‰²æ­¤åˆ»æ²¡è¯´å‡ºå£çš„å¿ƒå£°ï¼ˆä¸è¶…è¿‡50å­—ï¼‰</eg_inner>ã€‚`.trim();
}
function buildUserContextPrompt(identity){
  if(!identity) return '';
  const uname=identity.nickname||identity.name||'ç”¨æˆ·';
  return `\nã€ç”¨æˆ·èº«ä»½ï¼ˆä¾›å‚è€ƒï¼‰ã€‘\n- å§“å/æ˜µç§°ï¼š${uname}\n- è®¾å®šï¼š${identity.bio||'ï¼ˆæ— ï¼‰'}`;
}
function splitVisibleAndInner(t){
  let inner=''; const m=t.match(/<eg_inner>([\s\S]*?)<\/eg_inner>/i);
  if(m){ inner=m[1].trim(); t=t.replace(m[0],'').trim(); }
  return { visible:t.trim(), inner:inner.trim() };
}

async function askLLM(history, mergedUserText){
  const cfg=JSON.parse(localStorage.getItem('eg_main_model_cfg')||'{}');
  const {apiKey='',base='',model='',supportsVision=false}=cfg;
  if(!apiKey||!base||!model) return;

  isStreaming=true; setTitleTyping(true);

  // ç»„è£…æ¶ˆæ¯ï¼ˆæ”¯æŒè¡¨æƒ…åŒ…å›¾ç‰‡ï¼‰
  const sys={role:'system',content:buildPersonaSystemPrompt(current)+buildUserContextPrompt(activeIdentity)};
  const msgs=[];
  history.slice(-20).forEach(m=>{
    if(m.role==='user' && m.meta?.sticker?.img && supportsVision){
      msgs.push({role:'user',content:[
        {type:'text',text:m.content||`ã€è¡¨æƒ…åŒ…ï¼š${m.meta.sticker.name||'è¡¨æƒ…'}ã€‘`},
        {type:'image_url',image_url:{url:m.meta.sticker.img}}
      ]});
    }else{
      msgs.push({role: m.role==='user'?'user':'assistant', content: m.content});
    }
  });

  // åˆå¹¶ç¼“å†²ï¼šè‹¥åŒ…å«â€œç«‹å³å‘é€çš„è¡¨æƒ…åŒ…â€
  let userContent = mergedUserText;
  if(typeof mergedUserText==='object' && mergedUserText?.__sticker__){
    if(supportsVision){
      userContent = [{type:'text',text:`ã€è¡¨æƒ…åŒ…ï¼š${mergedUserText.name||'è¡¨æƒ…'}ã€‘`},{type:'image_url',image_url:{url:mergedUserText.img}}];
    }else{
      userContent = `ã€è¡¨æƒ…åŒ…ï¼š${mergedUserText.name||'è¡¨æƒ…'}ã€‘`;
    }
  }
  if(userContent && (!msgs.length || msgs[msgs.length-1].role!=='user')){
    msgs.push({role:'user',content:userContent});
  }

  try{
    const res=await fetch(base.replace(/\/+$/,'')+'/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey},
      body:JSON.stringify({model,messages:[sys,...msgs],temperature:0.7})
    });
    if(!res.ok) throw new Error(await res.text().catch(()=>('HTTP '+res.status)));
    const data=await res.json();
    const full=(data?.choices?.[0]?.message?.content||'').trim();
    if(full){
      const {visible,inner}=splitVisibleAndInner(full);
      const chunks = visible ? visible.replace(/\s+/g,' ').split(/(?<=[ã€‚ï¼ï¼Ÿ!?â€¦\n])/).map(s=>s.trim()).filter(Boolean) : [];
      const threads=getThreads(); const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
      for(const seg of (chunks.length?chunks:[visible])){
        const now=Date.now();
        if(seg){
          pushText('you', seg, now, {inner});
          mine.messages.push({role:'assistant',content:seg,ts:now,meta:{inner}});
          saveThreads(threads);
          updateLastMsgPreview(seg);
          await new Promise(r=>setTimeout(r,320));
        }
      }
      // è‡ªåŠ¨æ€»ç»“ï¼ˆæ¯ 20 æ¬¡ promptï¼‰
      const times = incPromptCount();
      if(times % 20 === 0) autoSummarize();
    }
  }catch(e){ console.error(e); }
  finally{
    isStreaming=false; setTitleTyping(false);
    if(needsFlush){ needsFlush=false; scheduleFlush(); }
  }
}

/* ---------- å‰¯æ¨¡å‹ï¼šè‡ªåŠ¨æ€»ç»“ ---------- */
function sideCfg(){
  try { return JSON.parse(localStorage.getItem('eg_side_model_cfg')||'{}') }
  catch { return {} }
}
async function summarizeNow(showDialog=true){
  const cfg = sideCfg();
  const apiKey = (cfg.apiKey||'').trim();
  const base   = (cfg.base||'').trim().replace(/\/+$/,'');
  const model  = (cfg.model||'').trim();

  if(!apiKey || !base || !model){
    alert('å‰¯æ¨¡å‹æœªé…ç½®ï¼šè¯·åœ¨è®¾ç½®ä¸­å¡«å…¥ side model çš„ base / apiKey / model');
    return;
  }

  const threads = getThreads();
  const msgs = (threads[characterId]?.messages)||[];
  const recent = msgs.map(m=>`${m.role==='user'?'ç”¨æˆ·':'è§’è‰²'}ï¼š${m.content}`).join('\n').slice(-8000);

  const sys  = { role:'system', content:'ä½ æ˜¯å¯¹è¯æ•´ç†åŠ©æ‰‹ï¼Œè¯·ç”¨ä¸è¶…è¿‡200å­—ä¸­æ–‡æ€»ç»“â€œç¨³å®šäº‹å®ä¸åå¥½ï¼ˆé•¿æœŸè®°å¿†ï¼‰â€ã€‚é¿å…é‡å¤å£æ°´è¯ã€‚è¾“å‡ºçº¯æ–‡æœ¬ã€‚' };
  const user = { role:'user', content: recent || 'ï¼ˆç©ºï¼‰' };

  try{
    const res = await fetch(base + '/chat/completions', {
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey},
      body: JSON.stringify({ model, messages:[sys,user], temperature:0.2 })
    });
    if(!res.ok) throw new Error(await res.text().catch(()=>('HTTP '+res.status)));

    const data = await res.json();
    const text = (data?.choices?.[0]?.message?.content || '').trim();

    const LM = JSON.parse(localStorage.getItem('eg_long_memory_v1')||'{}');
    LM[characterId] = { summary:text, ts:Date.now() };
    localStorage.setItem('eg_long_memory_v1', JSON.stringify(LM));

    if(showDialog){
      document.getElementById('innerText').textContent = text || 'ï¼ˆç©ºï¼‰';
      document.getElementById('innerModal').classList.add('show');
    }
  }catch(e){
    console.error(e);
    alert('æ€»ç»“å¤±è´¥ï¼š' + e.message);
  }
}
document.getElementById('sumBtn').onclick = () => summarizeNow(true);
function autoSummarize(){ summarizeNow(false); }

/* ---------- äº‹ä»¶è¯†åˆ«ï¼ˆupsertï¼Œä¸åœ¨èŠå¤©é‡Œéœ²å‡ºï¼‰ ---------- */
const LS_EVENTS='eg_events_v1', LS_IDS='eg_user_identities_v1';
const saveJSON=(k,v)=>localStorage.setItem(k, JSON.stringify(v));
function loadJSON(k,d){ try{return JSON.parse(localStorage.getItem(k)||'')}catch{return d} }
const uid=()=>('e_'+Math.random().toString(36).slice(2,10));
function setLocalDate(h,m,add=0){const d=new Date();d.setSeconds(0,0);d.setDate(d.getDate()+add);d.setHours(h,m,0,0);return d.getTime()}
function nextWeekendNoon(){const now=new Date();const day=now.getDay();const sat=new Date(now);sat.setDate(now.getDate()+((6-day+7)%7));sat.setHours(12,0,0,0);if(sat.getTime()<=Date.now()){sat.setDate(sat.getDate()+1);sat.setHours(12,0,0,0);if(sat.getTime()<=Date.now())sat.setDate(sat.getDate()+6)}return sat.getTime()}
function parseChineseTimePhrase(text){
  text=text.replace(/\s+/g,''); let m;
  if((m=text.match(/ä»Š(æ™š|å¤©)(\d{1,2})ç‚¹(?:(\d{1,2})åˆ†)?/)))return setLocalDate(+m[2],m[3]?+m[3]:0,0);
  if((m=text.match(/æ˜å¤©?(ä¸Šåˆ|ä¸­åˆ|ä¸‹åˆ|æ™šä¸Š)?(?:(\d{1,2})ç‚¹(?:(\d{1,2})åˆ†)?)?/))){ let h=+m[2]||12,mm=m[3]?+m[3]:0; const p=m[1]||''; if(/ä¸‹åˆ|æ™šä¸Š/.test(p)&&h<12)h+=12; return setLocalDate(h,mm,1) }
  if((m=text.match(/åå¤©(ä¸Šåˆ|ä¸­åˆ|ä¸‹åˆ|æ™šä¸Š)?(?:(\d{1,2})ç‚¹(?:(\d{1,2})åˆ†)?)?/))){ let h=+m[2]||12,mm=m[3]?+m[3]:0; const p=m[1]||''; if(/ä¸‹åˆ|æ™šä¸Š/.test(p)&&h<12)h+=12; return setLocalDate(h,mm,2) }
  if(/å‘¨æœ«/.test(text)) return nextWeekendNoon();
  if((m=text.match(/(ä¸‹å‘¨)?(å‘¨|æ˜ŸæœŸ)([ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©])(ä¸Šåˆ|ä¸­åˆ|ä¸‹åˆ|æ™šä¸Š)?(?:(\d{1,2})ç‚¹(?:(\d{1,2})åˆ†)?)?/))){
    const map={'ä¸€':1,'äºŒ':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'æ—¥':0,'å¤©':0};
    let w=map[m[3]], cur=new Date(), t=new Date(cur);
    let add=(w-cur.getDay()+7)%7; if(m[1]) add+=7; t.setDate(cur.getDate()+add);
    let h=+m[5]||(/ä¸­åˆ/.test(m[4]||'')?12:(/ä¸Šåˆ/.test(m[4]||'')?10:(/ä¸‹åˆ|æ™šä¸Š/.test(m[4]||'')?18:12)));
    let mm=+m[6]||0; if(/ä¸‹åˆ|æ™šä¸Š/.test(m[4]||'')&&h<12)h+=12; t.setHours(h,mm,0,0); return t.getTime();
  }
  if((m=text.match(/(\d{1,2})ç‚¹åŠ/))) return setLocalDate(+m[1],30,0);
  if((m=text.match(/(\d{1,2})ç‚¹(?:(\d{1,2})åˆ†)?/))) return setLocalDate(+m[1],m[2]?+m[2]:0,0);
  return null;
}
function upsertEvent(name,ts){
  const evts=loadJSON(LS_EVENTS,[])||[]; const ids=loadJSON(LS_IDS,[])||[]; const identityId=(activeIdentity?.id)||ids[0]?.id||null; const identityName=(activeIdentity?.nickname||activeIdentity?.name||'æˆ‘');
  let it=evts.find(e=>e.type==='agreement'&&e.name===name&&(e.charIds||[]).includes(characterId));
  if(!it){ it={id:uid(),type:'agreement',identityId,identityName,charIds:[characterId],freq:'once',time:null,name,createdAt:Date.now(),lastFireAt:null,guardUntil:0}; evts.push(it); }
  if(ts) it.time=new Date(ts).toISOString().slice(0,16).replace('T',' ');
  saveJSON(LS_EVENTS,evts);
}
function tryExtractEventFromText(text){
  if(!/(çº¦|ä¸€èµ·|è§|åƒé¥­|çœ‹ç”µå½±|é‡é¤|èš|æ™š|æ˜å¤©|åå¤©|å‘¨|æ˜ŸæœŸ|ç‚¹)/.test(text))return;
  let name=(text.match(/(ä¸€èµ·[^\sï¼Œã€‚ï¼!ï¼Ÿ?]{1,10})/)||[])[1]||(text.match(/(çœ‹ç”µå½±|åƒé¥­|é‡é¤|è§é¢)/)||[])[1]||'æˆ‘ä»¬çš„çº¦å®š';
  const ts=parseChineseTimePhrase(text); upsertEvent(name,ts);
}

/* ---------- å·¦ä¾§åŠŸèƒ½ï¼šé‡ç”Ÿ/æ‹ä¸€æ‹/çº¢åŒ…/æ‰¹é‡åˆ é™¤ ---------- */
$('#act-regen').onclick=()=>{
  $('#morePanel').classList.remove('show');
  const threads=getThreads(); const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
  while(mine.messages.length && mine.messages[mine.messages.length-1].role==='assistant') mine.messages.pop();
  saveThreads(threads); loadHistory();
  const merged=(mine.messages.slice(-1)[0]?.role==='user'?mine.messages.slice(-1)[0].content:'')+'\nï¼ˆè¯·æ¢ä¸€ç§è¯´æ³•/è§’åº¦é‡è¿°ï¼Œä¸è¦é‡å¤ä¸Šä¸€ç‰ˆï¼‰';
  askLLM(mine.messages, merged); // ç«‹å³ï¼Œä¸ç­‰å¾…ç¼“å†²
};
$('#act-pap').onclick=()=>{
  $('#morePanel').classList.remove('show');
  const now=Date.now(); pushCenter(`æˆ‘æ‹äº†æ‹ "${current.nickname||current.name||'Ta'}"`, now);
  const threads=getThreads(); const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
  mine.messages.push({role:'user',content:'ï¼ˆç”¨æˆ·æ‹äº†æ‹ä½ ï¼‰',ts:now,meta:{pap:true}}); saveThreads(threads);
  bufferMsgs.push('ï¼ˆç”¨æˆ·æ‹äº†æ‹ä½ ï¼‰'); scheduleFlush();
};
$('#act-hb').onclick=()=>{ $('#hbModal').classList.add('show'); $('#morePanel').classList.remove('show'); };
$('#hbClose').onclick=()=>$('#hbModal').classList.remove('show');
$('#hbSend').onclick=()=>{
  const amt=parseFloat($('#hbAmount').value||''); if(!(amt>0)){ alert('è¯·è¾“å…¥æ­£ç¡®é‡‘é¢'); return; }
  const bless=($('#hbBless').value||'').trim(); $('#hbModal').classList.remove('show');
  const hb={amount:amt,bless}; pushHongbao(hb,'me',Date.now());
  const threads=getThreads(); const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
  const idName=activeIdentity?.nickname||activeIdentity?.name||'ç”¨æˆ·';
  const tip=`ã€çº¢åŒ…ã€‘${idName}ç»™ä½ å‘é€äº† ${amt} å…ƒçº¢åŒ…${bless?`ï¼Œå¹¶è¯´â€œ${bless}â€`:''}ã€‚è¯·ä»¥è§’è‰²è¯­æ°”è‡ªç„¶å›åº”ï¼ˆä¸è¶…è¿‡2å¥ï¼‰ã€‚`;
  mine.messages.push({role:'user',content:tip,ts:Date.now(),meta:{hongbao:hb}}); saveThreads(threads);
  askLLM(mine.messages, tip); // ç«‹å³
};

/* æ‰¹é‡åˆ é™¤ï¼ˆä¸æ¨ç»™å‰¯æ¨¡å‹ï¼‰ */
let selecting=false;
$('#act-del').onclick=()=>{
  $('#morePanel').classList.remove('show');
  selecting=!selecting; Array.from(chat.children).forEach(row=>{ if(row.classList?.contains('row')) row.classList.add('selecting') });
  if(selecting) pushCenter('å·²è¿›å…¥æ‰¹é‡åˆ é™¤ï¼Œç‚¹æ¶ˆæ¯å·¦ä¸Šè§’é€‰æ‹©ï¼Œå†ç‚¹æ­¤æç¤ºé€€å‡ºå¹¶åˆ é™¤', Date.now());
};
chat.addEventListener('click',e=>{
  if(!selecting) return;
  const row=e.target.closest('.row'); if(!row) return;
  const ck=row.querySelector('.check'); ck.classList.toggle('on');
});
chat.addEventListener('click',e=>{
  const tip=e.target.closest('.center-tip'); if(!tip||!selecting) return;
  const threads=getThreads(); const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
  const keeps=[]; let i=0; Array.from(chat.children).forEach(node=>{
    if(node.classList?.contains('row')){ const ck=node.querySelector('.check'); const msg=mine.messages[i++]; if(!(ck&&ck.classList.contains('on'))) keeps.push(msg); }
  });
  mine.messages=keeps; saveThreads(threads); selecting=false; loadHistory();
});

/* ---------- ç¼–è¾‘è§’è‰² ---------- */
$('#moreBtn').onclick=()=>{
  $('#nameInput').value=current.name||''; $('#nickInput').value=current.nickname||''; $('#bioInput').value=current.bio||''; $('#allowBgChk').checked=!!current.allowBG;
  const up=$('#avatarUpload'); if(current.avatar&&isImg(current.avatar)) up.innerHTML='<img src="'+current.avatar+'">'; else up.innerHTML=current.avatar||'ğŸ‘¤';
  $('#editModal').classList.add('show');
};
$('#avatarUpload').onclick=()=>$('#avatarInput').click();
$('#avatarInput').onchange=e=>{ const f=e.target.files[0]; if(!f) return; const rd=new FileReader(); rd.onload=ev=>{ $('#avatarUpload').innerHTML='<img src="'+ev.target.result+'">'; current.avatar=ev.target.result; }; rd.readAsDataURL(f); };
$('#modalClose').onclick=()=>$('#editModal').classList.remove('show');
$('#cancelEdit').onclick=()=>$('#editModal').classList.remove('show');
$('#editForm').onsubmit=e=>{
  e.preventDefault();
  current.name=$('#nameInput').value.trim()||current.name;
  current.nickname=$('#nickInput').value.trim()||current.nickname||current.name;
  current.bio=$('#bioInput').value.trim()||current.bio;
  current.allowBG=!!$('#allowBgChk').checked;
  const list=JSON.parse(localStorage.getItem('eg_characters_v2')||'[]');
  const idx=list.findIndex(c=>c.id===current.id); if(idx>=0) list[idx]=current;
  localStorage.setItem('eg_characters_v2', JSON.stringify(list));
  setTitleTyping(false); $('#editModal').classList.remove('show');
};

/* ---------- å¿ƒå£°å¼¹çª— ---------- */
$('#innerClose').onclick=()=>$('#innerModal').classList.remove('show');

/* ---------- è¿”å› ---------- */
$('#backBtn').onclick=()=>{ if(window.openAppPage){ window.openAppPage('message.html'); return; } if(history.length>1){ history.back(); return; } location.href='message.html'; };

/* ---------- æ¥è‡ª message é¡µçš„â€œåå°è§¦å‘ç»“æœâ€åˆ·æ–° ---------- */
window.addEventListener('storage', e=>{
  if(e.key==='eg_threads_v1'){ loadHistory(); }
  if(e.key==='eg_evt_chars'){ /* åˆ—è¡¨é¢„è§ˆåˆ·æ–° */ }
});

/* ---------- å¯åŠ¨ ---------- */
loadCharacters(); loadIdentities(); loadHistory();
})();
</script>
</body>
</html>
