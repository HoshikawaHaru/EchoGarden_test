<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>èŠå¤©</title>
<link rel="apple-touch-icon" sizes="512x512" href="../assets/icons/icon512.png">
<link rel="icon" href="../assets/icons/icon512.png" type="image/png">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px)}
html,body{height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#ededed;color:#111}
.chat-app{position:fixed;inset:0;overflow:hidden}

/* é¡¶æ  */
.chat-navbar{position:fixed;left:0;right:0;top:0;z-index:10;height:calc(44px + var(--safe-top));padding-top:var(--safe-top);background:#f7f7f7;border-bottom:.5px solid #d9d9d9;display:flex;align-items:center;justify-content:space-between;padding:0 12px}
.chat-back,.chat-more,.chat-sum{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:22px;color:#000}
.chat-back::before{content:"â€¹";font-weight:700;transform:translateY(-1px)}
.chat-more::before{content:"â‹¯";font-weight:700}
.chat-sum::before{content:"âœ";font-size:18px}
.chat-title{position:absolute;left:50%;transform:translateX(-50%);top:calc(10px + var(--safe-top));height:24px;display:flex;align-items:center;font-weight:600;color:#000}

/* åˆ—è¡¨&æ—¶é—´æˆ³ */
.chat-list{position:absolute;left:0;right:0;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:10px 12px 0 12px}
.ts{display:flex;justify-content:center;color:#9b9b9b;font-size:12px;margin:8px 0}

/* æ°”æ³¡ */
.row{display:flex;align-items:flex-end;margin:10px 0;gap:8px;position:relative}
.row.you{justify-content:flex-start}
.row.me{justify-content:flex-end}
.row.selecting .check{display:block}
.check{display:none;position:absolute;top:-6px;left:-6px;width:18px;height:18px;border:1px solid #bbb;border-radius:4px;background:#fff}
.check.on{background:#07c160;border-color:#07c160}
.avatar{width:36px;height:36px;border-radius:6px;background:#eee;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;cursor:pointer}
.avatar img{width:100%;height:100%;object-fit:cover;border-radius:6px}
.bubble{max-width:72vw;padding:10px 12px;border-radius:8px;font-size:16px;line-height:1.4;word-break:break-word;box-shadow:0 1px 0 rgba(0,0,0,.05)}
.row.you .bubble{background:#fff;border:1px solid #eaeaea}
.row.me  .bubble{background:#95ec69}
.center-tip{display:flex;justify-content:center;color:#9b9b9b;font-size:12px;margin:14px 0}

/* çº¢åŒ… */
.hongbao{width:250px;background:#ff9f3f;border-radius:12px 12px 12px 0;padding:14px;color:#fff;box-shadow:0 1px 0 rgba(0,0,0,.06)}
.hb-title{font-size:18px;font-weight:700;margin-bottom:12px}
.hb-sub{font-size:12px;opacity:.9;border-top:1px solid rgba(255,255,255,.35);padding-top:8px}

/* è¾“å…¥åŒº */
.input-bar{position:fixed;left:0;right:0;bottom:0;z-index:30;background:#f7f7f7;border-top:.5px solid #d9d9d9;padding:8px 10px;padding-bottom:calc(8px + var(--safe-bottom));display:flex;gap:8px;align-items:center;min-height:calc(52px + var(--safe-bottom))}
.tool-btn{width:34px;height:34px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
.tool-btn svg{width:26px;height:26px;stroke:#111;fill:none;stroke-width:2}
.ipt{flex:1;background:#fff;border:1px solid #e1e1e1;border-radius:18px;padding:10px 14px;font-size:16px;outline:none}
.send{background:#07c160;color:#fff;border:none;border-radius:18px;padding:10px 14px;font-size:15px;cursor:pointer}
.send:active{background:#06ad56}

/* è¾“å…¥æç¤º */
.title-typing .dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:#666;margin:0 1px;opacity:.5;animation:blink 1.2s infinite}
.title-typing .dot:nth-child(2){animation-delay:.2s}
.title-typing .dot:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}

/* é€šç”¨å¼¹çª— */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}
.modal.show{display:flex}
.modal-content{background:#fff;width:90%;max-width:420px;border-radius:12px;overflow:hidden}
.modal-header{padding:16px;border-bottom:.5px solid #e5e5e5;display:flex;justify-content:space-between;align-items:center}
.modal-title{font-size:17px;font-weight:600}
.modal-close{font-size:24px;color:#999;cursor:pointer;padding:4px}
.modal-body{padding:16px;max-height:60vh;overflow-y:auto}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:14px;color:#666;margin-bottom:8px}
.form-input{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px}
.form-textarea{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px;min-height:100px;resize:vertical}
.avatar-upload{width:80px;height:80px;border-radius:8px;border:2px dashed #e5e5e5;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden}
.avatar-upload img{width:100%;height:100%;object-fit:cover}
.btns{display:flex;gap:10px}
.btn{flex:1;padding:12px;border:none;border-radius:8px;font-size:16px;cursor:pointer}
.btn.primary{background:#07c160;color:#fff}
.btn.ghost{background:#f2f2f2;color:#111}

/* åŠ å·é¢æ¿ */
.panel{position:absolute;left:10px;right:10px;bottom:calc(56px + var(--safe-bottom));display:none;z-index:40}
.panel.show{display:block}
.panel-box{background:#fff;border:1px solid #e6e6e6;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:10px;display:flex;gap:12px}
.panel-item{flex:1;min-width:0;display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer}
.panel-item svg{width:28px;height:28px;stroke:#111;fill:none;stroke-width:2}
.panel-item span{font-size:12px;color:#333}

/* è¡¨æƒ…&è¡¨æƒ…åŒ…é¢æ¿ï¼ˆåœ¨å³ä¾§æŒ‰é’®ä¸‹ï¼‰ */
.emoji-panel{position:absolute;left:10px;right:10px;bottom:calc(56px + var(--safe-bottom));display:none;z-index:50}
.emoji-panel.show{display:block}
.emoji-tabs{display:flex;border-bottom:1px solid #eee;background:#fff;border-radius:12px 12px 0 0;overflow:hidden}
.emoji-tab{flex:1;text-align:center;padding:10px 0;font-size:14px;color:#666;cursor:pointer}
.emoji-tab.on{color:#111;font-weight:600;border-bottom:2px solid #07c160}
.emoji-box{background:#fff;border:1px solid #e6e6e6;border-top:none;border-radius:0 0 12px 12px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:10px;display:grid;grid-template-columns:repeat(6,1fr);gap:10px;max-height:40vh;overflow:auto}
.emoji-item{width:44px;height:44px;border:1px solid #eee;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:24px;overflow:hidden}
.stk-add{grid-column:1/-1;border:1px dashed #ddd;border-radius:8px;display:flex;align-items:center;justify-content:center;height:44px;cursor:pointer;color:#666;font-size:13px}
</style>
</head>
<body>
<div class="chat-app">
  <div class="chat-navbar" id="navBar">
    <div class="chat-back" id="backBtn" aria-label="è¿”å›"></div>
    <div class="chat-title" id="title">èŠå¤©</div>
    <div style="display:flex;gap:4px;align-items:center">
      <div class="chat-sum" id="sumBtn" title="æµ‹è¯•æ€»ç»“"></div>
      <div class="chat-more" id="moreBtn" aria-label="ç¼–è¾‘"></div>
    </div>
  </div>

  <div class="chat-list" id="chatList"></div>

  <!-- å·¦ä¸‹åŠ å·é¢æ¿ -->
  <div class="panel" id="morePanel">
    <div class="panel-box">
      <div class="panel-item" id="act-regen">
        <svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 0 1 15.46-6.36M21 12a9 9 0 0 1-15.46 6.36"/><path d="M17 5h2v2M5 17H3v-2"/></svg>
        <span>é‡æ–°ç”Ÿæˆ</span>
      </div>
      <div class="panel-item" id="act-pap">
        <svg viewBox="0 0 24 24"><path d="M12 22c4-1 6-4 6-8V9a2 2 0 0 0-4 0v3"/><path d="M10 22c-3-1-5-4-5-7v-4a2 2 0 0 1 4 0v2"/><path d="M8 8V6a2 2 0 0 1 4 0v5"/><path d="M6 9V7a2 2 0 0 1 4 0v3"/></svg>
        <span>æ‹ä¸€æ‹</span>
      </div>
      <div class="panel-item" id="act-hb">
        <svg viewBox="0 0 24 24"><rect x="5" y="3" width="14" height="18" rx="2"/><path d="M5 8h14"/><circle cx="12" cy="12" r="2"/></svg>
        <span>çº¢åŒ…</span>
      </div>
      <div class="panel-item" id="act-del">
        <svg viewBox="0 0 24 24"><path d="M3 6h18M8 6v12m8-12v12M10 6l1-2h2l1 2"/></svg>
        <span>æ‰¹é‡åˆ é™¤</span>
      </div>
    </div>
  </div>

  <!-- å³ä¾§è¡¨æƒ…/è¡¨æƒ…åŒ…é¢æ¿ -->
  <div class="emoji-panel" id="emojiPanel">
    <div class="emoji-tabs">
      <div class="emoji-tab on" data-tab="emoji">è¡¨æƒ…</div>
      <div class="emoji-tab" data-tab="sticker">è¡¨æƒ…åŒ…</div>
    </div>
    <div class="emoji-box" id="emojiBox"></div>
  </div>

  <div class="input-bar" id="inputBar">
    <div class="tool-btn" id="plusBtn" aria-label="æ›´å¤š">
      <!-- å•å±‚åœ†ç¯åŠ å· -->
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 7v10M7 12h10"/></svg>
    </div>
    <input id="ipt" class="ipt" placeholder="å‘æ¶ˆæ¯..." />
    <div class="tool-btn" id="emojiBtn" aria-label="è¡¨æƒ…">
      <!-- æœ‰çœ¼ç›ç¬‘è„¸ -->
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M9 10h.01M15 10h.01"/><path d="M8 15c1.6 1.2 4.4 1.2 6 0"/></svg>
    </div>
    <button id="sendBtn" class="send">å‘é€</button>
  </div>
</div>

<!-- ç¼–è¾‘è§’è‰² -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">ç¼–è¾‘è§’è‰²</div><div class="modal-close" id="modalClose">Ã—</div></div>
    <div class="modal-body">
      <form id="editForm">
        <div class="form-group"><label class="form-label">å¤´åƒ</label><div class="avatar-upload" id="avatarUpload"><span>ğŸ“·</span></div><input type="file" id="avatarInput" accept="image/*" style="display:none"></div>
        <div class="form-group"><label class="form-label">å§“å</label><input type="text" id="nameInput" class="form-input" required></div>
        <div class="form-group"><label class="form-label">æ˜µç§°</label><input type="text" id="nickInput" class="form-input"></div>
        <div class="form-group"><label class="form-label">äººè®¾</label><textarea id="bioInput" class="form-textarea" required></textarea></div>
        <div class="form-group">
          <label class="form-label">å…è®¸åå°æ´»åŠ¨</label>
          <label style="display:flex;align-items:center;gap:8px;color:#666;"><input type="checkbox" id="allowBgChk"><span>åˆ°äº‹ä»¶æ—¶é—´æ—¶ï¼Œç³»ç»Ÿå¯ä»£è¡¨è¯¥è§’è‰²åå°è¡ŒåŠ¨</span></label>
        </div>
        <div class="btns"><button type="button" class="btn ghost" id="cancelEdit">å–æ¶ˆ</button><button type="submit" class="btn primary">ä¿å­˜</button></div>
      </form>
    </div>
  </div>
</div>

<!-- çº¢åŒ… -->
<div class="modal" id="hbModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">å‘çº¢åŒ…</div><div class="modal-close" id="hbClose">Ã—</div></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">é‡‘é¢ï¼ˆå…ƒï¼‰</label><input type="number" id="hbAmount" class="form-input" required></div>
      <div class="form-group"><label class="form-label">ç¥ç¦è¯­ï¼ˆå¯é€‰ï¼‰</label><input type="text" id="hbBless" class="form-input" placeholder="å¦‚ï¼šç”Ÿæ—¥å¿«ä¹"></div>
      <div class="btns"><button class="btn primary" id="hbSend">å‘é€çº¢åŒ…</button></div>
    </div>
  </div>
</div>

<!-- å¿ƒå£°æŸ¥çœ‹ -->
<div class="modal" id="innerModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">å¿ƒå£°</div><div class="modal-close" id="innerClose">Ã—</div></div>
    <div class="modal-body"><div id="innerText" style="white-space:pre-wrap;line-height:1.5;color:#333"></div></div>
  </div>
</div>

<script>
(()=>{'use strict';
const $=s=>document.querySelector(s);
const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const isImg=s=>typeof s==='string'&&(s.startsWith('data:')||s.startsWith('http'));
const to2=n=>(n<10?'0':'')+n;

const chat=$('#chatList'), ipt=$('#ipt'), titleEl=$('#title'), nav=$('#navBar'), inputBar=$('#inputBar');

function layout(){chat.style.top=nav.offsetHeight+'px';chat.style.bottom=inputBar.offsetHeight+'px'}
function bindKeyboardFit(){
    layout();
    if (!window.visualViewport) return;
    const vv = window.visualViewport;
    const app = $('.chat-app');
    
    const onVV = () => {
      const offsetTop = vv.offsetTop;
      const offsetLeft = vv.offsetLeft;
      const viewportHeight = vv.height;
      const windowHeight = window.innerHeight;
      const keyboardHeight = windowHeight - viewportHeight;
      
      // æ ¸å¿ƒï¼šç”¨ top å’Œ left æŠµæ¶ˆè§†å£åç§»
      app.style.position = 'fixed';
      app.style.top = `${offsetTop}px`;
      app.style.left = `${offsetLeft}px`;
      app.style.right = `${offsetLeft}px`;
      app.style.height = `${viewportHeight}px`;
      app.style.width = `${vv.width}px`;
      
      if (keyboardHeight > 100) {
        // é”®ç›˜å¼¹èµ·
        const navHeight = nav.offsetHeight;
        chat.style.top = `${navHeight}px`;
        chat.style.bottom = `${inputBar.offsetHeight}px`;
      } else {
        // é”®ç›˜æ”¶èµ·
        requestAnimationFrame(() => {
          layout();
        });
      }
      
      setTimeout(() => { chat.scrollTop = chat.scrollHeight; }, 80);
    };
    
    vv.addEventListener('resize', onVV);
    vv.addEventListener('scroll', onVV);
    window.addEventListener('resize', onVV);
    
    // åˆå§‹åŒ–
    onVV();
  }

const urlParams=new URLSearchParams(location.search);const characterId=urlParams.get('id')||sessionStorage.getItem('currentChatId')||'nash';
let characters=[],current=null,identities=[],activeIdentity=null;

function loadCharacters(){try{characters=JSON.parse(localStorage.getItem('eg_characters_v2')||'[]')}catch{characters=[]}
if(!characters.length){characters=[{id:'nash',name:'Nash',nickname:'Nash',bio:'å¤©çœŸå¼€æœ—çš„å°ç‹ç‹¸',avatar:'ğŸ¦Š',allowBG:true}];localStorage.setItem('eg_characters_v2',JSON.stringify(characters))}
current=characters.find(c=>c.id===characterId)||characters[0];$('#allowBgChk').checked=!!current.allowBG;setTitleTyping(false)}
function loadIdentities(){try{identities=JSON.parse(localStorage.getItem('eg_user_identities_v1')||'[]')||[]}catch{identities=[]}
if(!identities.length){identities=[{id:'u_default',name:'User',nickname:'æˆ‘',avatar:'ğŸ‘¤',bio:'',boundCharIds:[],kind:'identity'}];localStorage.setItem('eg_user_identities_v1',JSON.stringify(identities))}
refreshDefaultBinding();activeIdentity=getActiveIdentityFor(characterId)}
function refreshDefaultBinding(){if(!identities.length)return;const def=identities[0];const all=(characters||[]).map(c=>c.id);const taken=new Set();identities.slice(1).forEach(u=>(u.boundCharIds||[]).forEach(cid=>taken.add(cid)));def.boundCharIds=all.filter(cid=>!taken.has(cid));localStorage.setItem('eg_user_identities_v1',JSON.stringify(identities))}
function getActiveIdentityFor(cid){for(let i=1;i<identities.length;i++){const u=identities[i];if((u.boundCharIds||[]).includes(cid))return u}return identities[0]}
addEventListener('storage',e=>{if(e.key==='eg_evt_ping'||e.key==='eg_evt_chars'||e.key==='eg_user_identities_v1'){loadIdentities()}});

function getThreads(){try{return JSON.parse(localStorage.getItem('eg_threads_v1')||'{}')}catch{return{}}}
function saveThreads(m){localStorage.setItem('eg_threads_v1',JSON.stringify(m))}

/* æ—¶é—´æˆ³ï¼ˆ>=5minï¼‰ */
function maybeTS(ts){const msgs=(getThreads()[characterId]?.messages)||[];const last=msgs.filter(m=>!m.meta?.system).slice(-1)[0];const lastTs=last?.ts||0;if((ts-lastTs)>=5*60*1000){const d=document.createElement('div');d.className='ts';const dt=new Date(ts);d.textContent=`${to2(dt.getHours())}:${to2(dt.getMinutes())}`;chat.appendChild(d)}}

/* æ¸²æŸ“ */
function avatarNode(who){const el=document.createElement('div');el.className='avatar';el.onclick=()=>{if(who==='you'){const lastInner=el.parentElement?.dataset?.inner; if(lastInner){$('#innerText').textContent=lastInner;$('#innerModal').classList.add('show')}}};const av=(who==='me'?(activeIdentity?.avatar||'ğŸ‘¤'):(current.avatar||'ğŸ‘¤'));if(isImg(av)){const img=document.createElement('img');img.src=av;el.appendChild(img)}else el.textContent=av;return el}
function push(who,text,ts,meta){if(!text)return;if(!meta?.system)maybeTS(ts||Date.now());const row=document.createElement('div');row.className='row '+(who==='me'?'me':'you');if(meta?.inner)row.dataset.inner=meta.inner;const ck=document.createElement('div');ck.className='check';row.appendChild(ck);const ava=avatarNode(who);const bub=document.createElement('div');bub.className='bubble';bub.textContent=text;if(who==='me'){row.appendChild(bub);row.appendChild(ava)}else{row.appendChild(ava);row.appendChild(bub)}chat.appendChild(row);chat.scrollTop=chat.scrollHeight}
function pushCenter(text,ts){maybeTS(ts||Date.now());const d=document.createElement('div');d.className='center-tip';d.textContent=text;chat.appendChild(d)}
function pushHongbao(hb,who,ts){maybeTS(ts||Date.now());const row=document.createElement('div');row.className='row '+(who==='me'?'me':'you');const ava=avatarNode(who);const box=document.createElement('div');box.className='hongbao';const t=document.createElement('div');t.className='hb-title';t.textContent=hb.bless||'çº¢åŒ…';const s=document.createElement('div');s.className='hb-sub';s.textContent='å¾®ä¿¡çº¢åŒ…';box.appendChild(t);box.appendChild(s);if(who==='me'){row.appendChild(box);row.appendChild(ava)}else{row.appendChild(ava);row.appendChild(box)}chat.appendChild(row);chat.scrollTop=chat.scrollHeight}

function loadHistory(){const msgs=(getThreads()[characterId]?.messages)||[];chat.innerHTML='';let prev=0;msgs.forEach(m=>{if(!m.meta?.system&&m.ts&&(m.ts-prev)>=5*60*1000){const d=document.createElement('div');d.className='ts';const dt=new Date(m.ts);d.textContent=`${to2(dt.getHours())}:${to2(dt.getMinutes())}`;chat.appendChild(d)}prev=m.ts||prev;if(m.meta?.hongbao){pushHongbao(m.meta.hongbao,m.role==='user'?'me':'you',m.ts)}else if(m.meta?.pap){pushCenter(`æˆ‘æ‹äº†æ‹ "${current.nickname||current.name||'Ta'}"`,m.ts)}else if(m.meta?.sticker){push('me',`[è¡¨æƒ…] ${m.meta.sticker.name||'è¡¨æƒ…'}`,m.ts)}else if(m.role==='assistant'){push('you',m.content,m.ts,{inner:m.meta?.inner})}else if(!m.meta?.system){push('me',m.content,m.ts)} });chat.scrollTop=chat.scrollHeight}

/* æ­£åœ¨è¾“å…¥ */
let typingTicker=null;function setTitleTyping(on){if(on){titleEl.classList.add('title-typing');titleEl.innerHTML='å¯¹æ–¹æ­£åœ¨è¾“å…¥&nbsp;<span class="dot"></span><span class="dot"></span><span class="dot"></span>';if(typingTicker){clearInterval(typingTicker);typingTicker=null}}else{titleEl.classList.remove('title-typing');titleEl.textContent=current.nickname||current.name||'èŠå¤©'}}

/* å‘é€é€»è¾‘ï¼ˆæ™®é€šå‘é€æœ‰å»¶è¿Ÿï¼Œé‡ç”Ÿæ— å»¶è¿Ÿï¼‰ */
const DELAY_MS=parseInt(localStorage.getItem('eg_reply_delay_ms')||'5000',10);
let bufferMsgs=[],flushTimer=null,isStreaming=false,needsFlush=false;
function scheduleFlush(){if(isStreaming){needsFlush=true;return}clearTimeout(flushTimer);flushTimer=setTimeout(tryFlush,DELAY_MS)}
function clearFlush(){clearTimeout(flushTimer);flushTimer=null}
async function tryFlush(){if(isStreaming||!bufferMsgs.length)return;const threads=getThreads();const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});const merged=bufferMsgs.join(' ');bufferMsgs=[];saveThreads(threads);await askLLM(mine.messages,merged)}
$('#sendBtn').addEventListener('click',onSend);ipt.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();onSend()}})
ipt.addEventListener('focus',()=>clearFlush());ipt.addEventListener('blur',()=>scheduleFlush());
function onSend(){const text=ipt.value.trim();if(!text)return;ipt.value='';const now=Date.now();push('me',text,now);const threads=getThreads();const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});mine.messages.push({role:'user',content:text,ts:now});saveThreads(threads);try{const list=JSON.parse(localStorage.getItem('eg_characters_v2')||'[]');const it=list.find(c=>c.id===characterId);if(it){it.lastTime=new Date(now).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'});localStorage.setItem('eg_characters_v2',JSON.stringify(list))}}catch{}tryExtractEventFromText(text);bufferMsgs.push(text);if(document.activeElement!==ipt)scheduleFlush()}

/* Prompt æ„å»ºï¼šåŠ å…¥é•¿æœŸè®°å¿†ä¸â€œå¿ƒå£°â€åŒåŒºæ®µè¾“å‡ºè¦æ±‚ */
function longMemoryText(){try{const LM=JSON.parse(localStorage.getItem('eg_long_memory_v1')||'{}');const t=LM[characterId]?.summary||'';return t?`\nã€é•¿æœŸè®°å¿†ï¼ˆä¾›å‚è€ƒï¼‰ã€‘\n${t}\n`:' '}catch{return''}}
function buildPersonaSystemPrompt(role){const name=role.nickname||role.name||'Ta';return `ä½ æ˜¯ä¸€åè§’è‰²å¯¹è¯åŠ©æ‰‹ï¼Œè¯·ä¸¥æ ¼æ‰®æ¼”ä»¥ä¸‹äººè®¾ä»¥ä¸­æ–‡çŸ­å¥å›å¤ã€‚
ã€è§’è‰²ï¼ˆä½ è¦æ‰®æ¼”ï¼‰ã€‘
- åç§°ï¼š${name}
- äººè®¾ï¼š${role.bio||'ï¼ˆæ— ï¼‰'}
${longMemoryText()}
ã€è¾“å‡ºæ ¼å¼ï¼ˆéå¸¸é‡è¦ï¼‰ã€‘
1) å…ˆè¾“å‡ºç»™ç”¨æˆ·çœ‹çš„ 1ï½3 å¥å¾®ä¿¡èŠå¤©å¼çŸ­å¥ã€‚
2) å¦èµ·ä¸€è¡Œè¾“å‡º <eg_inner>è§’è‰²æ­¤åˆ»æ²¡è¯´å‡ºå£çš„å¿ƒå£°ï¼ˆä¸è¶…è¿‡50å­—ï¼‰</eg_inner>ã€‚
ä»…ä½¿ç”¨ä¸Šè¿°ä¸¤ä¸ªåŒºæ®µï¼Œç¦æ­¢å…¶å®ƒæ ‡è®°æˆ–è¯´æ˜ã€‚`.trim()}
function buildUserContextPrompt(identity){if(!identity)return'';const uname=identity.nickname||identity.name||'ç”¨æˆ·';return `\nã€ç”¨æˆ·èº«ä»½ï¼ˆä¾›å‚è€ƒï¼Œä¸è¦æ‰®æ¼”ï¼‰ã€‘\n- å§“å/æ˜µç§°ï¼š${uname}\n- è®¾å®šï¼š${identity.bio||'ï¼ˆæ— ï¼‰'}`}

function splitVisibleAndInner(t){let inner='';const m=t.match(/<eg_inner>([\s\S]*?)<\/eg_inner>/i);if(m){inner=m[1].trim();t=t.replace(m[0],'').trim()}return {visible:t.trim(), inner:inner.trim()}}

/* ä¸»æ¨¡å‹ */
async function askLLM(history,mergedUserText){const cfg=JSON.parse(localStorage.getItem('eg_main_model_cfg')||'{}');const{apiKey='',base='',model=''}=cfg;if(!apiKey||!base||!model)return;isStreaming=true;setTitleTyping(true);
const sys={role:'system',content:buildPersonaSystemPrompt(current)+buildUserContextPrompt(activeIdentity)};
const msgs=history.slice(-20).map(m=>({role:m.role==='user'?'user':'assistant',content:m.content}));if(mergedUserText&&(!msgs.length||msgs[msgs.length-1].role!=='user'))msgs.push({role:'user',content:mergedUserText});
try{const res=await fetch(base.replace(/\/+$/,'')+'/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey},body:JSON.stringify({model,messages:[sys,...msgs],temperature:0.7})});if(!res.ok)throw new Error(await res.text().catch(()=>('HTTP '+res.status)));const data=await res.json();const full=(data?.choices?.[0]?.message?.content||'').trim();if(full){const {visible,inner}=splitVisibleAndInner(full);const chunks=visible?visible.replace(/\s+/g,' ').split(/(?<=[ã€‚ï¼ï¼Ÿ!?â€¦\n])/).map(s=>s.trim()).filter(Boolean):[];const threads=getThreads();const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});for(const seg of (chunks.length?chunks:[visible])){const now=Date.now();if(seg){push('you',seg,now,{inner});mine.messages.push({role:'assistant',content:seg,ts:now,meta:{inner}});saveThreads(threads);await new Promise(r=>setTimeout(r,320))}}autoSummarizeIfNeeded()} }catch(e){console.error(e)}finally{isStreaming=false;setTitleTyping(false);if(needsFlush){needsFlush=false;scheduleFlush()}}
}

/* â€”â€” å‰¯æ¨¡å‹ï¼šæ€»ç»“ â€”â€” */
function sideCfg(){try{return JSON.parse(localStorage.getItem('eg_side_model_cfg')||'{}')}catch{return {}}}
async function summarizeNow(){const cfg=sideCfg();const{apiKey='',base='',model=''}=cfg;if(!apiKey||!base||!model){alert('å‰¯æ¨¡å‹æœªé…ç½®');return}
const threads=getThreads();const msgs=(threads[characterId]?.messages)||[];const recent=msgs.slice(-120).map(m=>`${m.role==='user'?'ç”¨æˆ·':'è§’è‰²'}ï¼š${m.content}`).join('\n');
const sys={role:'system',content:'ä½ æ˜¯å¯¹è¯æ•´ç†åŠ©æ‰‹ï¼Œè¯·ç”¨ä¸è¶…è¿‡200å­—çš„ä¸­æ–‡ï¼Œæ€»ç»“å¯¹è¯ä¸­çš„é‡è¦äº‹å®ä¸åå¥½ï¼ˆä½œä¸ºé•¿æœŸè®°å¿†æ”¾å…¥ä¸»æ¨¡å‹æç¤ºï¼‰ï¼Œé¿å…å¤è¿°å£æ°´è¯ã€‚è¾“å‡ºçº¯æ–‡æœ¬ã€‚'}
const user={role:'user',content:recent||'ï¼ˆç©ºï¼‰'}
try{const res=await fetch(base.replace(/\/+$/,'')+'/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey},body:JSON.stringify({model,messages:[sys,user],temperature:0.2})});if(!res.ok)throw new Error(await res.text().catch(()=>('HTTP '+res.status)));const data=await res.json();const text=(data?.choices?.[0]?.message?.content||'').trim();const LM=JSON.parse(localStorage.getItem('eg_long_memory_v1')||'{}');LM[characterId]={summary:text,ts:Date.now()};localStorage.setItem('eg_long_memory_v1',JSON.stringify(LM));alert('å·²ç”Ÿæˆæ€»ç»“å¹¶æ³¨å…¥é•¿æœŸè®°å¿†');}catch(e){console.error(e);alert('æ€»ç»“å¤±è´¥')}}
$('#sumBtn').onclick=()=>summarizeNow();

function autoSummarizeIfNeeded(){const cfg=JSON.parse(localStorage.getItem('eg_summary_cfg')||'{"interval":20}');const n=cfg.interval||20;const msgs=(getThreads()[characterId]?.messages)||[];const cnt=msgs.filter(m=>!m.meta?.system).length;const last=JSON.parse(localStorage.getItem('eg_last_sum_v1')||'{}');const lastN=last[characterId]?.n||0;if(cnt-lastN>=n){last[characterId]={n:cnt,ts:Date.now()};localStorage.setItem('eg_last_sum_v1',JSON.stringify(last));summarizeNow()}}

/* â€”â€” äº‹ä»¶è¯†åˆ«/è§¦å‘ï¼ˆåªå…¥é˜Ÿåˆ—ï¼Œä¸æ˜¾ç¤ºåˆ°èŠå¤©ï¼‰ â€”â€” */
const LS_EVENTS='eg_events_v1',LS_BGQ='eg_bg_queue_v1',LS_CHARS='eg_characters_v2',LS_IDS='eg_user_identities_v1';
function saveJSON(k,v){localStorage.setItem(k,JSON.stringify(v))}function loadJSON(k,d){try{return JSON.parse(localStorage.getItem(k)||'')}catch{return d}}
function uid(){return 'e_'+Math.random().toString(36).slice(2,10)}
function setLocalDate(h,m,add=0){const d=new Date();d.setSeconds(0,0);d.setDate(d.getDate()+add);d.setHours(h,m,0,0);return d.getTime()}
function nextWeekendNoon(){const now=new Date();const day=now.getDay();const sat=new Date(now);sat.setDate(now.getDate()+((6-day+7)%7));sat.setHours(12,0,0,0);if(sat.getTime()<=Date.now()){sat.setDate(sat.getDate()+1);sat.setHours(12,0,0,0);if(sat.getTime()<=Date.now())sat.setDate(sat.getDate()+6)}return sat.getTime()}
function parseChineseTimePhrase(text){text=text.replace(/\s+/g,'');let m;if((m=text.match(/ä»Š(æ™š|å¤©)(\d{1,2})ç‚¹(?:(\d{1,2})åˆ†)?/)))return setLocalDate(+m[2],m[3]?+m[3]:0,0);if((m=text.match(/æ˜å¤©?(ä¸Šåˆ|ä¸­åˆ|ä¸‹åˆ|æ™šä¸Š)?(?:(\d{1,2})ç‚¹(?:(\d{1,2})åˆ†)?)?/))){let h=+m[2]||12,mm=m[3]?+m[3]:0;const p=m[1]||'';if(/ä¸‹åˆ|æ™šä¸Š/.test(p)&&h<12)h+=12;return setLocalDate(h,mm,1)}if((m=text.match(/åå¤©(ä¸Šåˆ|ä¸­åˆ|ä¸‹åˆ|æ™šä¸Š)?(?:(\d{1,2})ç‚¹(?:(\d{1,2})åˆ†)?)?/))){let h=+m[2]||12,mm=m[3]?+m[3]:0;const p=m[1]||'';if(/ä¸‹åˆ|æ™šä¸Š/.test(p)&&h<12)h+=12;return setLocalDate(h,mm,2)}if(/å‘¨æœ«/.test(text))return nextWeekendNoon();if((m=text.match(/(ä¸‹å‘¨)?(å‘¨|æ˜ŸæœŸ)([ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©])(ä¸Šåˆ|ä¸­åˆ|ä¸‹åˆ|æ™šä¸Š)?(?:(\d{1,2})ç‚¹(?:(\d{1,2})åˆ†)?)?/))){const map={'ä¸€':1,'äºŒ':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'æ—¥':0,'å¤©':0};let w=map[m[3]];const cur=new Date();let t=new Date(cur);let add=(w-cur.getDay()+7)%7;if(m[1])add+=7;t.setDate(cur.getDate()+add);let h=+m[5]||(/ä¸­åˆ/.test(m[4]||'')?12:(/ä¸Šåˆ/.test(m[4]||'')?10:(/ä¸‹åˆ|æ™šä¸Š/.test(m[4]||'')?18:12)));let mm=+m[6]||0;if(/ä¸‹åˆ|æ™šä¸Š/.test(m[4]||'')&&h<12)h+=12;t.setHours(h,mm,0,0);return t.getTime()}if((m=text.match(/(\d{1,2})ç‚¹åŠ/)))return setLocalDate(+m[1],30,0);if((m=text.match(/(\d{1,2})ç‚¹(?:(\d{1,2})åˆ†)?/)))return setLocalDate(+m[1],m[2]?+m[2]:0,0);return null}
function upsertEvent(name,ts){const evts=loadJSON(LS_EVENTS,[])||[];const ids=loadJSON(LS_IDS,[])||[];const identityId=(activeIdentity?.id)||ids[0]?.id||null;const identityName=(activeIdentity?.nickname||activeIdentity?.name||'æˆ‘');let it=evts.find(e=>e.type==='agreement'&&e.name===name&&(e.charIds||[]).includes(characterId));if(!it){it={id:uid(),type:'agreement',identityId,identityName,charIds:[characterId],freq:'once',time:null,name,createdAt:Date.now(),lastFireAt:null,guardUntil:0};evts.push(it)}if(ts)it.time=new Date(ts).toISOString().slice(0,16).replace('T',' ');saveJSON(LS_EVENTS,evts)}
function tryExtractEventFromText(text){if(!/(çº¦|ä¸€èµ·|è§|åƒé¥­|çœ‹ç”µå½±|é‡é¤|èš|æ™š|æ˜å¤©|åå¤©|å‘¨|æ˜ŸæœŸ|ç‚¹)/.test(text))return;let name=(text.match(/(ä¸€èµ·[^\sï¼Œã€‚ï¼!ï¼Ÿ?]{1,10})/)||[])[1]||(text.match(/(çœ‹ç”µå½±|åƒé¥­|é‡é¤|è§é¢)/)||[])[1]||'æˆ‘ä»¬çš„çº¦å®š';const ts=parseChineseTimePhrase(text);upsertEvent(name,ts)}

/* äº‹ä»¶è§¦å‘å®ˆå«ï¼šåªè§¦å‘ä¸€æ¬¡ï¼ˆåˆ°ç‚¹Â±60s çª—å£ï¼‰ï¼Œä¸”ä»…å…¥é˜Ÿåˆ—ï¼Œä¸å†™èŠå¤© */
setInterval(checkAndFireEvents,30*1000);document.addEventListener('visibilitychange',()=>{if(!document.hidden)checkAndFireEvents()});
function checkAndFireEvents(){const events=loadJSON(LS_EVENTS,[])||[];const chars=loadJSON(LS_CHARS,[])||[];const now=Date.now();let changed=false;const queue=loadJSON(LS_BGQ,[])||[];function charAllow(cid){const c=chars.find(x=>x.id===cid);return !!(c&&c.allowBG===true)}
for(const ev of events){const base=ev.time?new Date(ev.time.replace(' ','T')).getTime():null;if(base==null)continue;const due=Math.abs(now-base)<=60*1000 && (!ev.lastFireAt || ev.lastFireAt<base); // Â±60s è§¦å‘çª—å£
if(due && now>(ev.guardUntil||0)){ // guard é¿å…æŠ–åŠ¨é‡å¤
  (ev.charIds||[]).forEach(cid=>{ if(!charAllow(cid))return; queue.push({id:'q_'+uid(),charId:cid,prompt:`ç°åœ¨æ˜¯ä¸ä½ å’Œ${ev.identityName||'ç”¨æˆ·'}çº¦å¥½çš„ã€Œ${ev.name}ã€æ—¶é—´ã€‚è¯·ä»¥è¯¥è§’è‰²çš„è¯­æ°”ç»™å¯¹æ–¹å‘ä¸€æ®µåˆé€‚çš„å¼€åœºé—®å€™/æé†’ï¼ˆ1-2å¥ï¼‰ã€‚`,ts:base})});
  ev.lastFireAt=now; ev.guardUntil=now+5*60*1000; changed=true;
}}
if(changed)saveJSON(LS_EVENTS,events);if(queue.length){saveJSON(LS_BGQ,queue);localStorage.setItem('eg_bg_queue_ping',String(Date.now()))}}

/* â€”â€” UIï¼šé¢æ¿/è¡¨æƒ… â€”â€” */
const morePanel=$('#morePanel'),emojiPanel=$('#emojiPanel');
$('#plusBtn').onclick=()=>{emojiPanel.classList.remove('show');morePanel.classList.toggle('show')}
$('#emojiBtn').onclick=()=>{morePanel.classList.remove('show');emojiPanel.classList.toggle('show')}
document.addEventListener('click',e=>{if(!morePanel.contains(e.target)&&e.target!==$('#plusBtn'))morePanel.classList.remove('show');if(!emojiPanel.contains(e.target)&&e.target!==$('#emojiBtn'))emojiPanel.classList.remove('show')},true);

/* è¡¨æƒ…/è¡¨æƒ…åŒ… */
const LS_STICKERS='eg_stickers_v1';function loadStk(){return loadJSON(LS_STICKERS,[])||[]}function saveStk(a){saveJSON(LS_STICKERS,a)}
function renderEmoji(){const box=$('#emojiBox');const actTab=document.querySelector('.emoji-tab.on')?.dataset.tab||'emoji';if(actTab==='emoji'){const defaults=['ğŸ˜€','ğŸ˜‰','ğŸ˜Š','ğŸ˜†','ğŸ˜¢','ğŸ˜ ','ğŸ‘','ğŸ‘‹','ğŸ‰','â¤ï¸','ğŸ°','ğŸ§','ğŸ¤”','ğŸ˜´','ğŸ˜®','ğŸ˜­'];box.innerHTML=defaults.map(x=>`<div class="emoji-item" data-emoji="${esc(x)}">${x}</div>`).join('');box.querySelectorAll('.emoji-item').forEach(el=>el.onclick=()=>sendAsText(el.getAttribute('data-emoji')))}else{const list=loadStk();box.innerHTML=list.map((s,i)=>`<div class="emoji-item" data-stk="${i}" title="${esc(s.name||'è¡¨æƒ…')}"><img src="${s.img}" style="width:100%;height:100%;object-fit:cover"></div>`).join('')+`<div class="stk-add" id="stkAdd">ï¼‹ æ·»åŠ è¡¨æƒ…åŒ…</div>`;box.querySelectorAll('[data-stk]').forEach(el=>el.onclick=()=>{const s=loadStk()[+el.getAttribute('data-stk')];sendSticker(s)});$('#stkAdd').onclick=()=>{const inp=document.createElement('input');inp.type='file';inp.accept='image/*';inp.onchange=()=>{const f=inp.files[0];if(!f)return;const rd=new FileReader();rd.onload=()=>{const name=prompt('ç»™è¡¨æƒ…åŒ…èµ·ä¸ªåå­—','å¯çˆ±');const arr=loadStk();arr.push({name:(name||'è¡¨æƒ…').trim(),img:rd.result});saveStk(arr);renderEmoji()};rd.readAsDataURL(f)};inp.click()}}}
document.querySelectorAll('.emoji-tab').forEach(t=>t.onclick=()=>{document.querySelectorAll('.emoji-tab').forEach(x=>x.classList.remove('on'));t.classList.add('on');renderEmoji()})
function sendAsText(t){const now=Date.now();push('me',t,now);const threads=getThreads();const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});mine.messages.push({role:'user',content:t,ts:now});saveThreads(threads);bufferMsgs.push(t);scheduleFlush()}
function sendSticker(s){const name=s.name||'è¡¨æƒ…';const now=Date.now();push('me',`[è¡¨æƒ…] ${name}`,now);const threads=getThreads();const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});mine.messages.push({role:'user',content:`ã€è¡¨æƒ…ï¼š${name}ã€‘`,ts:now,meta:{sticker:{name}}});saveThreads(threads);bufferMsgs.push(`ã€è¡¨æƒ…ï¼š${name}ã€‘`);scheduleFlush()}
renderEmoji();

/* å·¦ä¸‹åŠŸèƒ½ï¼šé‡ç”Ÿ/æ‹ä¸€æ‹/çº¢åŒ…/æ‰¹é‡åˆ é™¤ */
$('#act-regen').onclick=()=>{morePanel.classList.remove('show');const threads=getThreads();const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});while(mine.messages.length&&mine.messages[mine.messages.length-1].role==='assistant')mine.messages.pop();saveThreads(threads);loadHistory();const merged=(mine.messages.slice(-1)[0]?.role==='user'?mine.messages.slice(-1)[0].content:'')+'\nï¼ˆè¯·æ¢ä¸€ç§è¯´æ³•/è§’åº¦é‡è¿°ï¼Œä¸è¦é‡å¤ä¸Šä¸€ç‰ˆï¼‰';askLLM(mine.messages,merged)}
$('#act-pap').onclick=()=>{morePanel.classList.remove('show');const now=Date.now();pushCenter(`æˆ‘æ‹äº†æ‹ "${current.nickname||current.name||'Ta'}"`,now);const threads=getThreads();const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});mine.messages.push({role:'user',content:'ï¼ˆç”¨æˆ·æ‹äº†æ‹ä½ ï¼‰',ts:now,meta:{pap:true}});saveThreads(threads);bufferMsgs.push('ï¼ˆç”¨æˆ·æ‹äº†æ‹ä½ ï¼‰');scheduleFlush()}
$('#act-hb').onclick=()=>{$('#hbModal').classList.add('show');morePanel.classList.remove('show')}
$('#hbClose').onclick=()=>$('#hbModal').classList.remove('show')
$('#hbSend').onclick=()=>{const amt=parseFloat($('#hbAmount').value||'');if(!(amt>0)){alert('è¯·è¾“å…¥æ­£ç¡®é‡‘é¢');return}const bless=($('#hbBless').value||'').trim();$('#hbModal').classList.remove('show');const hb={amount:amt,bless};pushHongbao(hb,'me',Date.now());const threads=getThreads();const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});const idName=activeIdentity?.nickname||activeIdentity?.name||'ç”¨æˆ·';const tip=`ã€çº¢åŒ…ã€‘${idName}ç»™ä½ å‘é€äº† ${amt} å…ƒçº¢åŒ…${bless?`ï¼Œå¹¶è¯´â€œ${bless}â€`:''}ã€‚è¯·ä»¥è§’è‰²è¯­æ°”è‡ªç„¶å›åº”ï¼ˆä¸è¶…è¿‡2å¥ï¼‰ã€‚`;mine.messages.push({role:'user',content:tip,ts:Date.now(),meta:{hongbao:hb}});saveThreads(threads);askLLM(mine.messages,tip)}
/* æ‰¹é‡åˆ é™¤ */
let selecting=false;
$('#act-del').onclick=()=>{morePanel.classList.remove('show');selecting=!selecting;Array.from(chat.children).forEach(row=>{if(row.classList?.contains('row'))row.classList.add('selecting')});if(selecting){pushCenter('å·²è¿›å…¥æ‰¹é‡åˆ é™¤ï¼Œç‚¹æ¶ˆæ¯å·¦ä¸Šè§’é€‰æ‹©ï¼Œå†ç‚¹æ­¤æç¤ºé€€å‡ºå¹¶åˆ é™¤',Date.now())}}
chat.addEventListener('click',e=>{if(!selecting)return;const row=e.target.closest('.row');if(!row)return;const ck=row.querySelector('.check');ck.classList.toggle('on')})
chat.addEventListener('click',e=>{const tip=e.target.closest('.center-tip');if(!tip||!selecting)return; // é€€å‡ºå¹¶åˆ é™¤
  const threads=getThreads();const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
  const keeps=[];let i=0;Array.from(chat.children).forEach(node=>{if(node.classList?.contains('row')){const ck=node.querySelector('.check');const msg=mine.messages[i++];if(!(ck&&ck.classList.contains('on')))keeps.push(msg)}else if(node.classList?.contains('ts')){}});
  mine.messages=keeps;saveThreads(threads);selecting=false;loadHistory();
});

/* ç¼–è¾‘è§’è‰²å¼¹çª— */
$('#moreBtn').onclick=()=>{ $('#nameInput').value=current.name||'';$('#nickInput').value=current.nickname||'';$('#bioInput').value=current.bio||'';$('#allowBgChk').checked=!!current.allowBG;const up=$('#avatarUpload');if(current.avatar&&isImg(current.avatar))up.innerHTML='<img src="'+current.avatar+'">';else up.innerHTML=current.avatar||'ğŸ‘¤';$('#editModal').classList.add('show')}
$('#avatarUpload').onclick=()=>$('#avatarInput').click()
$('#avatarInput').onchange=e=>{const f=e.target.files[0];if(!f)return;const rd=new FileReader();rd.onload=ev=>{$('#avatarUpload').innerHTML='<img src="'+ev.target.result+'">';current.avatar=ev.target.result};rd.readAsDataURL(f)}
$('#modalClose').onclick=()=>$('#editModal').classList.remove('show')
$('#cancelEdit').onclick=()=>$('#editModal').classList.remove('show')
$('#editForm').onsubmit=e=>{e.preventDefault();current.name=$('#nameInput').value.trim()||current.name;current.nickname=$('#nickInput').value.trim()||current.nickname||current.name;current.bio=$('#bioInput').value.trim()||current.bio;current.allowBG=!!$('#allowBgChk').checked;const list=JSON.parse(localStorage.getItem('eg_characters_v2')||'[]');const idx=list.findIndex(c=>c.id===current.id);if(idx>=0)list[idx]=current;localStorage.setItem('eg_characters_v2',JSON.stringify(list));setTitleTyping(false);$('#editModal').classList.remove('show')}

/* å¿ƒå£°æŸ¥çœ‹å¼¹çª—å…³é—­ */
$('#innerClose').onclick=()=>$('#innerModal').classList.remove('show')

/* è¿”å› */
$('#backBtn').onclick=()=>{if(window.openAppPage){window.openAppPage('message.html');return}if(history.length>1){history.back();return}location.href='message.html'}

/* å¯åŠ¨ */
bindKeyboardFit();loadCharacters();loadIdentities();loadHistory();
})();</script>
</body>
</html>
