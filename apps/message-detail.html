<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>èŠå¤©</title>
<link rel="apple-touch-icon" sizes="512x512" href="../assets/icons/icon512.png">
<link rel="icon" href="../assets/icons/icon512.png" type="image/png">
<style>
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  :root{--safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px)}
  html,body{height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#ededed;color:#111}

  .chat-app{position:fixed;inset:0;overflow:hidden;background:#ededed}

  /* é¡¶æ ï¼ˆå›ºå®šä¸æµ®åŠ¨ï¼‰ */
  .chat-navbar{
    position:fixed;left:0;right:0;top:0;z-index:100;
    height:calc(44px + var(--safe-top)); padding-top:var(--safe-top);
    background:#f7f7f7;border-bottom:.5px solid #d9d9d9;
    display:flex;align-items:center;justify-content:space-between;
    padding-left:8px;padding-right:8px
  }
  .nav-left,.nav-right{width:96px;display:flex;align-items:center;gap:6px}
  .chat-back,.chat-more{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .icon-ellipsis{width:22px;height:22px;display:block}
  .chat-title{position:absolute;left:50%;transform:translateX(-50%);top:calc(10px + var(--safe-top));height:24px;display:flex;align-items:center;font-weight:600;color:#000}

  /* èŠå¤©åˆ—è¡¨ */
  .chat-list{position:absolute;left:0;right:0;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:10px 12px 0 12px}
  .row{display:flex;align-items:flex-end;margin:10px 0;gap:8px}
  .row.you{justify-content:flex-start}
  .row.me{justify-content:flex-end}
  .row.center{justify-content:center}
  .center-note{font-size:13px;color:#909090;background:transparent;padding:6px 10px;border-radius:6px}

  .avatar{width:36px;height:36px;border-radius:6px;background:#eee;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
  .avatar img{width:100%;height:100%;object-fit:cover;border-radius:6px}
  .bubble{max-width:72vw;padding:10px 12px;border-radius:8px;font-size:16px;line-height:1.4;word-break:break-word;box-shadow:0 1px 0 rgba(0,0,0,.05)}
  .row.you .bubble{background:#fff;border:1px solid #eaeaea}
  .row.me  .bubble{background:#95ec69}

  /* å›¾ç‰‡/è´´çº¸ */
  .bubble.img{padding:4px;background:transparent;border:none;box-shadow:none}
  .bubble.img img{max-width:220px;border-radius:8px;display:block}

  /* çº¢åŒ…æ°”æ³¡ï¼ˆä»¿å¾®ä¿¡ï¼‰ */
  .redpack{background:#ff9f33;color:#fff;border-radius:12px;min-width:200px;max-width:280px;box-shadow:0 2px 0 rgba(0,0,0,.03)}
  .redpack .rp-hd{display:flex;gap:10px;align-items:center;padding:12px 14px 8px}
  .redpack .rp-icon{width:36px;height:36px;border-radius:6px;background:#ff6a00;display:flex;align-items:center;justify-content:center}
  .redpack .rp-icon:before{content:"Â¥";display:block;color:#ffd966;font-weight:700}
  .redpack .rp-title{font-size:17px;font-weight:700}
  .redpack .rp-ft{font-size:12px;opacity:.9;padding:8px 14px;border-top:1px solid rgba(255,255,255,.25)}
  .row.me .redpack{background:#ff9f33} .row.you .redpack{background:#ff9f33}

  /* åº•æ ï¼ˆå›ºå®šä¸æµ®åŠ¨ï¼‰ */
  .input-bar{
    position:fixed;left:0;right:0;bottom:0;z-index:90;
    background:#f7f7f7;border-top:.5px solid #d9d9d9;
    padding:8px 10px;padding-bottom:calc(8px + var(--safe-bottom));
    display:flex;gap:8px;align-items:center;min-height:calc(52px + var(--safe-bottom));
  }
  .tool-btn,.emoji-btn{width:32px;height:32px;display:flex;align-items:center;justify-content:center;border:none;background:transparent;cursor:pointer}
  .icon-plus,.icon-emoji{width:26px;height:26px;stroke:#111;stroke-width:2;fill:none}
  .ipt{flex:1;background:#fff;border:1px solid #e1e1e1;border-radius:18px;padding:10px 14px;font-size:16px;outline:none}
  .send{background:#07c160;color:#fff;border:none;border-radius:18px;padding:10px 14px;font-size:15px;cursor:pointer}
  .send:active{background:#06ad56}

  .title-typing .dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:#666;margin:0 1px;opacity:.5;animation:blink 1.2s infinite}
  .title-typing .dot:nth-child(2){animation-delay:.2s}
  .title-typing .dot:nth-child(3){animation-delay:.4s}
  @keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}

  /* é¢æ¿ / å¼¹çª— */
  .panel{position:fixed;left:0;right:0;bottom:calc(52px + var(--safe-bottom) + 8px);z-index:80;display:none}
  .panel.show{display:block}
  .panel-inner{margin:0 12px;background:#fff;border:1px solid #e6e6e6;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);overflow:hidden}
  .action-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:12px}
  .action{display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer}
  .action svg{width:28px;height:28px;stroke:#111;stroke-width:2;fill:none}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:200}
  .modal.show{display:flex}
  .modal-content{background:#fff;width:90%;max-width:420px;border-radius:12px;overflow:hidden}
  .modal-header{padding:16px;border-bottom:.5px solid #e5e5e5;display:flex;justify-content:space-between;align-items:center}
  .modal-title{font-size:17px;font-weight:600}
  .modal-close{font-size:24px;color:#999;cursor:pointer;padding:4px}
  .modal-body{padding:16px;max-height:60vh;overflow-y:auto}
  .form-group{margin-bottom:16px}
  .form-label{display:block;font-size:14px;color:#666;margin-bottom:8px}
  .form-input{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px}
  .form-textarea{width:100%;padding:12px;border:1px solid #e5e5e5;border-radius:8px;font-size:16px;min-height:100px;resize:vertical}
  .btns{display:flex;gap:10px}
  .btn{flex:1;padding:12px;border:none;border-radius:8px;font-size:16px;cursor:pointer}
  .btn.primary{background:#07c160;color:#fff}
  .btn.ghost{background:#f2f2f2;color:#111}

  /* ç¼–è¾‘è§’è‰²å¼¹çª—é‡Œâ€œåå°æ´»åŠ¨â€å¼€å…³è¡Œ */
  .switch-line{display:flex;align-items:center;gap:10px}
  .switch-line input{transform:scale(1.2)}
  /* è¡¨æƒ…é¢æ¿ */
  .emoji-panel .panel-inner{padding:10px}
  .stickers{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
  .stickers img{width:60px;height:60px;border-radius:8px;object-fit:cover;cursor:pointer}
  .upload-sticker{margin-top:10px}
</style>
</head>
<body>
<div class="chat-app">
  <!-- é¡¶æ  -->
  <div class="chat-navbar" id="navBar">
    <div class="nav-left">
      <div class="chat-back" id="backBtn">
        <svg class="icon-plus" viewBox="0 0 24 24" style="transform:rotate(45deg)"><path d="M12 4 L12 20"></path><path d="M4 12 L20 12"></path></svg>
      </div>
    </div>
    <div class="chat-title" id="title">èŠå¤©</div>
    <div class="nav-right">
      <div class="chat-more" id="moreBtn">
        <svg class="icon-ellipsis" viewBox="0 0 24 24"><circle cx="5" cy="12" r="2" fill="#111"/><circle cx="12" cy="12" r="2" fill="#111"/><circle cx="19" cy="12" r="2" fill="#111"/></svg>
      </div>
    </div>
  </div>

  <!-- åˆ—è¡¨ -->
  <div class="chat-list" id="chatList"></div>

  <!-- åŠŸèƒ½é¢æ¿ï¼ˆåŠ å·ï¼‰ -->
  <div class="panel" id="toolPanel">
    <div class="panel-inner">
      <div class="action-grid">
        <div class="action" id="actRegen" title="é‡æ–°ç”Ÿæˆ">
          <svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 1 3 6"/><path d="M3 12H8M3 12V7"></path></svg>
          <small>é‡æ–°ç”Ÿæˆ</small>
        </div>
        <div class="action" id="actNudge" title="æˆ³ä¸€æˆ³">
          <svg viewBox="0 0 24 24"><path d="M8 12h8M5 12a7 7 0 0 1 14 0 7 7 0 0 1-14 0z"></path></svg>
          <small>æˆ³ä¸€æˆ³</small>
        </div>
        <div class="action" id="actRedpack" title="å‘çº¢åŒ…">
          <svg viewBox="0 0 24 24"><rect x="4" y="3" width="16" height="18" rx="2"></rect><path d="M4 9h16"></path><path d="M8 7h8"></path></svg>
          <small>å‘çº¢åŒ…</small>
        </div>
      </div>
    </div>
  </div>

  <!-- è¡¨æƒ…/è´´çº¸é¢æ¿ -->
  <div class="panel emoji-panel" id="emojiPanel">
    <div class="panel-inner">
      <div class="stickers" id="stickerBox"></div>
      <div class="upload-sticker">
        <input type="file" id="stickerInput" accept="image/*" hidden>
        <button class="btn ghost" id="btnUploadSticker">ä¸Šä¼ è´´çº¸</button>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨ -->
  <div class="input-bar" id="inputBar">
    <button class="tool-btn" id="toolBtn" aria-label="æ›´å¤š">
      <svg class="icon-plus" viewBox="0 0 24 24"><path d="M12 4 L12 20"></path><path d="M4 12 L20 12"></path></svg>
    </button>
    <input id="ipt" class="ipt" placeholder="å‘æ¶ˆæ¯..." />
    <button class="emoji-btn" id="emojiBtn" aria-label="è¡¨æƒ…">
      <svg class="icon-emoji" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="9"></circle>
        <circle cx="9" cy="10" r="1.2"></circle>
        <circle cx="15" cy="10" r="1.2"></circle>
        <path d="M8 14c1.2 1 2.4 1.5 4 1.5s2.8-.5 4-1.5"></path>
      </svg>
    </button>
    <button id="sendBtn" class="send">å‘é€</button>
  </div>
</div>

<!-- ç¼–è¾‘è§’è‰²å¼¹çª—ï¼ˆå«â€œå…è®¸åå°æ´»åŠ¨â€ï¼‰ -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">ç¼–è¾‘è§’è‰²</div>
      <div class="modal-close" id="modalClose">Ã—</div>
    </div>
    <div class="modal-body">
      <form id="editForm">
        <div class="form-group">
          <label class="form-label">å¤´åƒ</label>
          <div class="avatar-upload" id="avatarUpload" style="width:80px;height:80px;border:2px dashed #e5e5e5;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden"><span>ğŸ“·</span></div>
          <input type="file" id="avatarInput" accept="image/*" style="display:none">
        </div>
        <div class="form-group">
          <label class="form-label">å§“å</label>
          <input type="text" id="nameInput" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">æ˜µç§°</label>
          <input type="text" id="nickInput" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">äººè®¾</label>
          <textarea id="bioInput" class="form-textarea" required></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">åå°æ´»åŠ¨</label>
          <div class="switch-line">
            <input type="checkbox" id="bgSwitch">
            <span>å…è®¸è¯¥è§’è‰²åœ¨äº‹ä»¶æ—¶é—´åå°è¡ŒåŠ¨</span>
          </div>
        </div>
        <div class="btns">
          <button type="button" class="btn ghost" id="cancelEdit">å–æ¶ˆ</button>
          <button type="submit" class="btn primary">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- çº¢åŒ…å¼¹çª— -->
<div class="modal" id="rpModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">å‘çº¢åŒ…</div>
      <div class="modal-close" id="rpClose">Ã—</div>
    </div>
    <div class="modal-body">
      <form id="rpForm">
        <div class="form-group">
          <label class="form-label">é‡‘é¢ï¼ˆå…ƒï¼‰</label>
          <input type="number" step="0.01" min="0.01" id="rpAmount" class="form-input" placeholder="å¦‚ 8.88" required>
        </div>
        <div class="form-group">
          <label class="form-label">ç¥ç¦è¯­ï¼ˆé€‰å¡«ï¼‰</label>
          <input type="text" id="rpBless" class="form-input" placeholder="å¦‚ ç”Ÿæ—¥å¿«ä¹">
        </div>
        <div class="btns">
          <button type="button" class="btn ghost" id="rpCancel">å–æ¶ˆ</button>
          <button type="submit" class="btn primary">å‘é€</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(() => {
  'use strict';

  /* ---------- DOM refs ---------- */
  const $ = s => document.querySelector(s);
  const chat     = $('#chatList');
  const ipt      = $('#ipt');
  const titleEl  = $('#title');
  const nav      = $('#navBar');
  const inputBar = $('#inputBar');
  const toolPanel= $('#toolPanel');
  const emojiPanel= $('#emojiPanel');
  const stickerBox= $('#stickerBox');

  /* ---------- å¸ƒå±€ ---------- */
  function layout(){
    const navHeight = nav.offsetHeight;
    const inputHeight = inputBar.offsetHeight;
    chat.style.top = navHeight + 'px';
    chat.style.bottom = inputHeight + 'px';
  }
  window.addEventListener('resize', layout);
  window.addEventListener('orientationchange', layout);

  /* ---------- å·¥å…· ---------- */
  const esc = s => String(s ?? '').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const isImg = s => typeof s === 'string' && (s.startsWith('data:') || s.startsWith('http'));

  const urlParams   = new URLSearchParams(location.search);
  const characterId = urlParams.get('id') || sessionStorage.getItem('currentChatId') || 'nash';

  function loadJSON(k, df){ try{ const t=localStorage.getItem(k); return t?JSON.parse(t):df; }catch(e){ return df; } }
  function saveJSON(k, v){ localStorage.setItem(k, JSON.stringify(v)); }

  /* ---------- æ•°æ®ï¼šè§’è‰² / èº«ä»½ ---------- */
  let characters = loadJSON('eg_characters_v2', []);
  if (!characters.length){
    characters = [{ id:'nash', name:'Nash', nickname:'Nash', bio:'å¤©çœŸå¼€æœ—çš„å°ç‹ç‹¸', avatar:'ğŸ¦Š' }];
    saveJSON('eg_characters_v2', characters);
  }
  let current = characters.find(c=>c.id===characterId) || characters[0];

  let identities = loadJSON('eg_user_identities_v1', []);
  if (!identities.length){
    identities=[{id:'u_default',kind:'identity',name:'User',nickname:'æˆ‘',avatar:'ğŸ‘¤',bio:'',boundCharIds:[]}];
    saveJSON('eg_user_identities_v1', identities);
  }
  function getActiveIdentityFor(charId){
    for (let i=1;i<identities.length;i++){
      const u=identities[i]; if((u.boundCharIds||[]).includes(charId)) return u;
    }
    return identities[0];
  }
  let activeIdentity = getActiveIdentityFor(characterId);

  /* ---------- å¤´åƒ ---------- */
  function avatarNode(from){
    const el = document.createElement('div'); el.className='avatar';
    const av = (from==='me') ? (activeIdentity.avatar||'ğŸ‘¤') : (current.avatar||'ğŸ‘¤');
    if (isImg(av)){ const img=document.createElement('img'); img.src=av; el.appendChild(img); } else el.textContent=av;
    return el;
  }

  /* ---------- æ¸²æŸ“ä¸æ¶ˆæ¯å†™å…¥ ---------- */
  function pushSide(type, content, options={}){
    // type: 'me' | 'you' | 'center'
    if(type==='center'){
      const row=document.createElement('div'); row.className='row center';
      const span=document.createElement('div'); span.className='center-note'; span.textContent=content;
      row.appendChild(span); chat.appendChild(row); chat.scrollTop=chat.scrollHeight; return row;
    }
    const row=document.createElement('div'); row.className='row '+type;
    const ava=avatarNode(type);
    const bubble=document.createElement('div');
    if(options.kind==='image'){
      bubble.className='bubble img';
      const img=new Image(); img.src=content; bubble.appendChild(img);
    }else if(options.kind==='redpack'){
      bubble.className='redpack';
      bubble.innerHTML = `
        <div class="rp-hd">
          <div class="rp-icon"></div>
          <div class="rp-title">${esc(options.title||'çº¢åŒ…')}</div>
        </div>
        <div class="rp-ft">å¾®ä¿¡çº¢åŒ…</div>`;
    }else{
      bubble.className='bubble'; bubble.textContent=content;
    }
    if(type==='me'){ row.appendChild(bubble); row.appendChild(ava); }
    else{ row.appendChild(ava); row.appendChild(bubble); }
    chat.appendChild(row); chat.scrollTop=chat.scrollHeight; return row;
  }

  /* ---------- å†å² ---------- */
  const threadsKey='eg_threads_v1';
  function getThreads(){ return loadJSON(threadsKey, {}); }
  function saveThreads(m){ saveJSON(threadsKey, m); }
  function loadHistory(){
    const msgs = (getThreads()[characterId]?.messages) || [];
    chat.innerHTML='';
    let lastTs = 0;
    msgs.forEach(m=>{
      if(m.role==='center'){ pushSide('center', m.content); }
      else pushSide(m.role==='user'?'me':'you', m.content, m.meta);
      lastTs = m.ts||lastTs;
    });
    chat.scrollTop=chat.scrollHeight;
  }

  /* ---------- é¡¶éƒ¨çŠ¶æ€ ---------- */
  function setTitleTyping(isTyping){
    if(isTyping){
      titleEl.classList.add('title-typing');
      titleEl.innerHTML='å¯¹æ–¹æ­£åœ¨è¾“å…¥&nbsp;<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
    }else{
      titleEl.classList.remove('title-typing');
      titleEl.textContent = current.nickname || current.name || 'èŠå¤©';
    }
  }

  /* ---------- LLM ---------- */
  function buildPersonaSystemPrompt(role){
    const name = role.nickname||role.name||'Ta';
    return `ä½ æ˜¯ä¸€åè§’è‰²å¯¹è¯åŠ©æ‰‹ï¼Œè¯·ä¸¥æ ¼æ‰®æ¼”ä»¥ä¸‹äººè®¾è¿›è¡Œè‡ªç„¶ä¸­æ–‡å›å¤ã€‚
ã€è§’è‰²ï¼ˆä½ è¦æ‰®æ¼”ï¼‰ã€‘
- åç§°ï¼š${name}
- äººè®¾ï¼š${role.bio||'ï¼ˆæ— ï¼‰'}
ã€é£æ ¼ã€‘å£è¯­åŒ–ã€æ¸©æš–ï¼›æ¯æ¬¡ 1ï½3 å¥ï¼›å‚è€ƒå¾®ä¿¡çŸ­å¥ï¼›é¿å…æœºæ¢°é‡å¤ã€‚`;
  }
  function buildUserContextPrompt(identity){
    if(!identity) return ''; const uname=identity.nickname||identity.name||'ç”¨æˆ·';
    return `\n\nã€ç”¨æˆ·èº«ä»½ï¼ˆä¾›å‚è€ƒï¼‰ã€‘
- å§“å/æ˜µç§°ï¼š${uname}
- è®¾å®šï¼š${identity.bio||'ï¼ˆæ— ï¼‰'}`;
  }
  function splitChunks(t){
    const arr=[]; t.replace(/\s+/g,' ').split(/(?<=[ã€‚ï¼ï¼Ÿ!?â€¦\n])/).forEach(s=>{ s=s.trim(); if(s) arr.push(s); });
    const out=[]; arr.forEach(s=>{ if(s.length<=60) out.push(s); else (s.match(/.{1,40}/g)||[s]).forEach(x=>out.push(x)); });
    return out;
  }

  async function askLLM(history, mergedUserText, extraUserHint){
    const cfg = loadJSON('eg_main_model_cfg', {});
    const apiKey=(cfg.apiKey||'').trim(); const base=(cfg.base||'').trim().replace(/\/+$/,''); const model=(cfg.model||'').trim();
    if(!apiKey||!base||!model) return;

    setTitleTyping(true);

    const sys = { role:'system', content: buildPersonaSystemPrompt(current)+buildUserContextPrompt(activeIdentity) };
    const msgs = history.slice(-20).map(m=>({ role:m.role==='user'?'user':'assistant', content:m.content }));
    if(mergedUserText){ msgs.push({ role:'user', content: mergedUserText + (extraUserHint?('\n\n'+extraUserHint):'') }); }

    try{
      const res=await fetch(base+'/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey},body:JSON.stringify({model, messages:[sys,...msgs], temperature:0.8})});
      if(!res.ok) throw new Error(await res.text().catch(()=>('HTTP '+res.status)));
      const data=await res.json();
      const full=(data?.choices?.[0]?.message?.content||'').trim(); if(!full) return;
      const chunks=splitChunks(full);
      const threads=getThreads(); const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
      for(const seg of chunks){
        pushSide('you', seg);
        mine.messages.push({ role:'assistant', content:seg, ts:Date.now() });
        saveThreads(threads);
        await new Promise(r=>setTimeout(r, 280));
      }
      // æ›´æ–°åˆ—è¡¨â€œæœ€åä¸€å¥â€
      try{
        const list=loadJSON('eg_characters_v2',[]); const it=list.find(c=>c.id===characterId);
        if(it){ it.lastMsg=chunks[chunks.length-1]||it.lastMsg||''; it.lastTime=new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}); saveJSON('eg_characters_v2',list); }
      }catch(_){}
    }catch(e){ console.error(e); }
    finally{ setTitleTyping(false); }
  }

  /* ---------- å‘é€/ç¼“å†²ï¼ˆé»˜è®¤ä¾æ—§æœ‰å»¶è¿Ÿï¼Œä½†ã€é‡æ–°ç”Ÿæˆã€‘ä¸èµ°å»¶è¿Ÿï¼‰ ---------- */
  const DELAY_MS = parseInt(localStorage.getItem('eg_reply_delay_ms') || '5000', 10);
  let bufferMsgs=[]; let flushTimer=null; let isStreaming=false; let needsFlush=false;

  function scheduleFlush(){ if(isStreaming){ needsFlush=true; return; } clearTimeout(flushTimer); flushTimer=setTimeout(tryFlush, DELAY_MS); }
  function clearFlush(){ clearTimeout(flushTimer); flushTimer=null; }
  async function tryFlush(){
    if(isStreaming||!bufferMsgs.length) return;
    const merged=bufferMsgs.join(' '); bufferMsgs=[];
    const threads=getThreads(); const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
    saveThreads(threads);
    await askLLM(mine.messages, merged);
  }

  $('#sendBtn').addEventListener('click', onSend);
  ipt.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); onSend(); }});
  ipt.addEventListener('focus', ()=>clearFlush());
  ipt.addEventListener('blur', ()=>scheduleFlush());

  function onSend(){
    const text=ipt.value.trim(); if(!text) return; ipt.value='';
    pushSide('me', text);
    const threads=getThreads(); const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
    mine.messages.push({ role:'user', content:text, ts:Date.now() }); saveThreads(threads);
    // æ›´æ–°åˆ—è¡¨â€œæœ€åä¸€å¥â€
    try{ const list=loadJSON('eg_characters_v2',[]); const it=list.find(c=>c.id===characterId); if(it){ it.lastMsg=text; it.lastTime=new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}); saveJSON('eg_characters_v2',list);} }catch(_){}
    bufferMsgs.push(text);
    if (document.activeElement !== ipt) scheduleFlush();
  }

  /* ---------- é‡æ–°ç”Ÿæˆï¼ˆç«‹åˆ»æ‰§è¡Œ + æ¸…ç†æœ€è¿‘ä¸€æ¬¡åŠ©æ‰‹è¾“å‡ºï¼‰ ---------- */
  function regenNow(){
    // 1) åˆ é™¤æœ€è¿‘ä¸€æ¬¡ assistant è¾“å‡ºï¼ˆè¿ç»­åˆ†æ®µä¸€èµ·åˆ ï¼‰
    const threads=getThreads(); const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
    let i=mine.messages.length-1;
    // ä»å°¾éƒ¨å›æº¯ï¼Œè¿ç»­ assistant å—åˆ é™¤åˆ°ä¸Šä¸€ä¸ª user ä¸ºæ­¢ï¼ˆä½†ä¸åˆ  userï¼‰
    while(i>=0 && mine.messages[i].role==='assistant'){ mine.messages.splice(i,1); i--; }
    saveThreads(threads);
    // åŒæ­¥ UIï¼šæŠŠå°¾éƒ¨è¿ç»­çš„ you æ³¡æ³¡åˆ æ‰
    for(let j=chat.children.length-1;j>=0;j--){
      const row=chat.children[j]; if(row && row.classList && row.classList.contains('row') && row.classList.contains('you')){ chat.removeChild(row); } else if(row.classList.contains('row') && row.classList.contains('me')){ break; }
    }
    // 2) ç«‹åˆ»å‘èµ·è¯·æ±‚ï¼Œé™„åŠ â€œæ¢ä¸€ç§æ–¹å¼â€çš„æç¤º
    const lastUser = [...mine.messages].reverse().find(m=>m.role==='user');
    const userText = lastUser ? lastUser.content : '';
    const hint = 'ï¼ˆè¯·æ¢ä¸€ç§è¡¨è¾¾æ–¹å¼ï¼Œé¿å…å¤è¿°ä¸Šä¸€ç‰ˆï¼šå¯è°ƒæ•´è¯­æ°”/è¯æ±‡/èŠ‚å¥ï¼Œä»ä¿æŒ 1ï½3 å¥çš„å¾®ä¿¡å¼çŸ­å¥ã€‚ï¼‰';
    askLLM(mine.messages, userText, hint);
  }

  /* ---------- æˆ³ä¸€æˆ³ ---------- */
  function sendNudge(fromWho='me'){
    const who = fromWho==='me' ? (current.nickname||current.name||'Ta') : (activeIdentity.nickname||activeIdentity.name||'æˆ‘');
    const txt = fromWho==='me' ? `æˆ‘æ‹äº†æ‹â€œ${who}â€` : `${who}æ‹äº†æ‹æˆ‘`;
    pushSide('center', txt);
    const threads=getThreads(); const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
    mine.messages.push({ role:'center', content:txt, ts:Date.now() }); saveThreads(threads);
  }

  /* ---------- çº¢åŒ… ---------- */
  function sendRedpack(amount, bless){
    // UI å¡ç‰‡ï¼ˆè‡ªå·±å‘ï¼‰
    pushSide('me', '', {kind:'redpack', title: bless || 'çº¢åŒ…'});
    const threads=getThreads(); const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
    mine.messages.push({ role:'user', content:`[çº¢åŒ…] ${bless||''}`, ts:Date.now(), meta:{kind:'redpack', amount, bless} });
    saveThreads(threads);
    // è§¦å‘ LLMï¼šå‘Šè¯‰è§’è‰²æ”¶åˆ°äº†çº¢åŒ…
    const uname = activeIdentity.nickname||activeIdentity.name||'ç”¨æˆ·';
    const cname = current.nickname||current.name||'ä½ ';
    const prompt = `${uname}ç»™${cname}å‘äº†${amount}å…ƒçº¢åŒ…${bless?('ï¼Œå¹¶è¯´â€œ'+bless+'â€'):''}ã€‚è¯·ä»¥${cname}çš„è¯­æ°”ç»™${uname}ä¸€ä¸ªç®€çŸ­è‡ªç„¶çš„å›åº”ï¼ˆ1ï½2å¥ï¼‰ã€‚`;
    askLLM(mine.messages, '', prompt);
  }

  /* ---------- è´´çº¸ ---------- */
  function renderStickers(){
    const arr=loadJSON('eg_stickers_v1', []);
    stickerBox.innerHTML = arr.map((src,i)=>`<img src="${src}" data-i="${i}">`).join('') || '<div style="color:#999;padding:8px">æš‚æ— è´´çº¸ï¼Œå…ˆä¸Šä¼ å§</div>';
    stickerBox.querySelectorAll('img').forEach(img=>{
      img.onclick=()=>{
        const src=img.src;
        pushSide('me', src, {kind:'image'});
        const threads=getThreads(); const mine=threads[characterId]||(threads[characterId]={id:characterId,messages:[]});
        mine.messages.push({ role:'user', content:src, ts:Date.now(), meta:{kind:'image'} }); saveThreads(threads);
        // å¯é€‰æ‹©ä¸è§¦å‘ LLM æˆ–è§¦å‘ç®€çŸ­ååº”ï¼š
        scheduleFlush();
      };
    });
  }

  /* ---------- äº¤äº’ ---------- */
  // é¡¶éƒ¨
  $('#backBtn').addEventListener('click', ()=>{
    if (window.openAppPage){ window.openAppPage('message.html'); return; }
    if (history.length > 1){ history.back(); return; }
    location.href='message.html';
  });
  $('#moreBtn').addEventListener('click', ()=>{
    $('#nameInput').value=current.name||'';
    $('#nickInput').value=current.nickname||'';
    $('#bioInput').value=current.bio||'';
    const up=$('#avatarUpload');
    if (isImg(current.avatar)) up.innerHTML='<img src="'+current.avatar+'" style="width:100%;height:100%;object-fit:cover">';
    else up.innerHTML = current.avatar||'ğŸ‘¤';
    $('#bgSwitch').checked = !!current.allowBG;   // â˜… æ¢å¤åå°æ´»åŠ¨
    $('#editModal').classList.add('show');
  });
  $('#avatarUpload').addEventListener('click', ()=>$('#avatarInput').click());
  $('#avatarInput').addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f) return;
    const rd=new FileReader(); rd.onload=ev=>{ $('#avatarUpload').innerHTML='<img src="'+ev.target.result+'">'; current.avatar=ev.target.result; }; rd.readAsDataURL(f);
  });
  $('#modalClose').addEventListener('click', ()=>$('#editModal').classList.remove('show'));
  $('#cancelEdit').addEventListener('click', ()=>$('#editModal').classList.remove('show'));
  $('#editForm').addEventListener('submit', e=>{
    e.preventDefault();
    current.name=$('#nameInput').value.trim()||current.name;
    current.nickname=$('#nickInput').value.trim()||current.nickname||current.name;
    current.bio=$('#bioInput').value.trim()||current.bio;
    current.allowBG = $('#bgSwitch').checked;     // â˜… ä¿å­˜
    const list=loadJSON('eg_characters_v2',[]); const idx=list.findIndex(c=>c.id===current.id);
    if(idx>=0) list[idx]=current; saveJSON('eg_characters_v2',list);
    $('#editModal').classList.remove('show');
    setTitleTyping(false);
  });

  // å·¥å…·é¢æ¿
  function toggleToolPanel(on){ toolPanel.classList.toggle('show', on!==undefined?on:!toolPanel.classList.contains('show')); emojiPanel.classList.remove('show'); }
  function toggleEmojiPanel(on){ emojiPanel.classList.toggle('show', on!==undefined?on:!emojiPanel.classList.contains('show')); toolPanel.classList.remove('show'); if(emojiPanel.classList.contains('show')) renderStickers(); }
  $('#toolBtn').addEventListener('click', ()=>toggleToolPanel());
  $('#emojiBtn').addEventListener('click', ()=>toggleEmojiPanel());

  // é¢æ¿ actions
  $('#actRegen').addEventListener('click', ()=>{ toggleToolPanel(false); regenNow(); });
  $('#actNudge').addEventListener('click', ()=>{ toggleToolPanel(false); sendNudge('me'); });
  $('#actRedpack').addEventListener('click', ()=>{ toggleToolPanel(false); $('#rpModal').classList.add('show'); });

  // è´´çº¸ä¸Šä¼ 
  $('#btnUploadSticker').addEventListener('click', ()=>$('#stickerInput').click());
  $('#stickerInput').addEventListener('change', async e=>{
    const f=e.target.files[0]; if(!f) return; const rd=new FileReader(); rd.onload=ev=>{
      const arr=loadJSON('eg_stickers_v1',[]); arr.unshift(ev.target.result); saveJSON('eg_stickers_v1',arr); renderStickers();
    }; rd.readAsDataURL(f);
  });

  // çº¢åŒ…è¡¨å•
  $('#rpClose').addEventListener('click', ()=>$('#rpModal').classList.remove('show'));
  $('#rpCancel').addEventListener('click', ()=>$('#rpModal').classList.remove('show'));
  $('#rpForm').addEventListener('submit', e=>{
    e.preventDefault();
    const amount=parseFloat($('#rpAmount').value); if(!(amount>0)) return;
    const bless=$('#rpBless').value.trim();
    $('#rpModal').classList.remove('show');
    sendRedpack(amount.toFixed(2), bless);
    $('#rpAmount').value=''; $('#rpBless').value='';
  });

  // ç‚¹å‡»ç©ºç™½å…³é—­é¢æ¿
  document.addEventListener('click', e=>{
    const inBar = e.target.closest('#inputBar'); const inPanel = e.target.closest('.panel-inner')||e.target.closest('.modal-content')||e.target.closest('#toolBtn')||e.target.closest('#emojiBtn');
    if(!inBar && !inPanel){ toolPanel.classList.remove('show'); emojiPanel.classList.remove('show'); }
  });

  /* ---------- å¯åŠ¨ ---------- */
  layout();
  setTitleTyping(false);
  loadHistory();
})();
</script>
</body>
</html>
